# *** PREAMBULO R *** -------------------------------------------------------
setwd("d:/tesis0001/bases.preparadas")

library(data.table) ;    library(plyr)    ;    library(reshape2) 
library(RColorBrewer)  ;  library(ggplot2)   ;  library(car) 
  library(directlabels);   library(ggtern)
library(ggthemes) ;  library(scales);      library(prettyR) 
library(stringr)  ;    library(xlsx)  ;    require(Rcpp) 
library(minpack.lm)   ;    library(bit64);    require(RCurl) 
library(grid)    ;    library(ggsubplot)   ;   library(FactoMineR)  
library(MASS);    library(splines)   ;   library(gtable)
library(rgeos)    ;     library(rgdal)      ;   library(maptools) 
library(spdep)     ;  library(spatstat) 
library(raster)  ;      library(maps)
library(gridExtra)    ;  library(micromap)
library(Hmisc)   ; library(xtable)
library(dplyr); library(car)

# Funcion separar etiquetas en gráficos xy 
if (getRversion() >= '2.15.1') {
  globalVariables("wt")
}
FFieldPtRep <- function(coords,
                        rep.fact = 20,
                        rep.dist.lmt = 10,
                        attr.fact = 0.2,
                        adj.max = 0.1,
                        adj.lmt = 0.5,
                        iter.max = 10000) {  
  # Returns:
  #   coordinates of the points at completion of the simulation  
  if (length(dim(coords)) != 2) {
    stop("FFieldPtRep: dim(coords) must be 2\n")    
  }
  if (ncol(coords) < 2) {
    stop("FFieldPtRep: ncol(coords) must be >= 2\n")    
  }
  if (nrow(coords) < 2) {
    stop("FFieldPtRep: nrow(coords) must be >= 2\n")    
  }  
  coords <- as.data.frame(coords)
  colnames(coords)[(1:2)] <- c("x", "y")  
  coords.orig <- coords
  
  FVCalc <- function(vects.x, 
                     vects.y, 
                     f.fact, 
                     f.type = "invsq") {
    # Force vector calculation common code  
    
    d.sq <- (vects.x ^ 2 + vects.y ^ 2)
    d <- sqrt(d.sq)    
    # Normalize the vectors
    vects.x <- vects.x / d
    vects.y <- vects.y / d    
    # Get the force vector matrices
    if (f.type == "invsq") {
      d.sq[d >= rep.dist.lmt] <- Inf
      vect.f.x <- vects.x / d.sq * f.fact
      vect.f.y <- vects.y / d.sq * f.fact  
    } else if (f.type == "lin") {
      vect.f.x <- vects.x * d * f.fact
      vect.f.y <- vects.y * d * f.fact    
    } else {
      stop("FFieldPtRep: Unexpected f.type\n")
    }    
    # Remove NaNs that occur when d == 0 
    # (occuring when calculating the repulsion of point
    # and itself and the attraction of point at the origin and the origin).
    vect.f.x[is.na(vect.f.x)] <- 0
    vect.f.y[is.na(vect.f.y)] <- 0    
    # Combine the force vectors acting upon each point
    f.vect <- cbind(colSums(vect.f.x), colSums(vect.f.y))
    return (f.vect)
  }  
  iter <- 0  
  repeat {    
    # Calculate repulsion forces.
    # Direction is from other points to a given point.
    vects.x <- apply(coords, 1, function(c) (c[1] - coords$x))
    vects.y <- apply(coords, 1, function(c) (c[2] - coords$y))    
    f.rep.v <- FVCalc(vects.x = vects.x, 
                      vects.y = vects.y, 
                      f.fact = rep.fact, 
                      f.type = "invsq")    
    # Calculate attraction forces.
    # Direction is from each point to its original position.
    vects.orig <- coords.orig - coords
    f.attr.v <- FVCalc(vects.x = t(as.matrix(vects.orig$x)), 
                       vects.y = t(as.matrix(vects.orig$y)), 
                       f.fact = attr.fact, 
                       f.type = "lin")    
    # Combine the forces.
    f.v <- f.rep.v + f.attr.v
    if (all(abs(f.v) <= adj.lmt)) {
      break()
    }    
    # Adjust the coordinates    
    mv.vect <- apply(f.v, 
                     c(1, 2), 
                     function(x) sign(x) * min(abs(x), adj.max))    
    coords <- coords + mv.vect    
    
    if ((iter <- iter + 1) > iter.max) {
      warning("FFieldPtRep: Maximum iterations exceeded ",
              "without convergence.\n")
      break()
    }
  }
  return(coords)
}

colorRampPalette(c('#aec7e8', '#1f77b4'))(5)
# ***TRANSICION MORTALIDAD*** -------------------------------------------------------------


# ALC Etapas transición demográfica 1950 2010 --------------------------------------------------------------------
alcmap <- map_data("world")
alcmap <- subset(alcmap, region %in% c("Nicaragua", "Mexico", "Costa Rica", 
                                       "Colombia", "Ecuador", "Guatemala"  ,
                                       "Venezuela", "Argentina", "Brazil",  
                                       "El Salvador", "Chile", "Peru",
                                       "Uruguay", "Paraguay", "Panama",
                                       "Bolivia", "Cuba", "Dominican Republic",
                                       "Haiti"))

bdtr <- read.xlsx2(file = "etapas.transicion.xlsx",  sheetName = "Sheet1")
bdtr$Etapa <- factor(bdtr$Etapa, levels = c( "Incipiente", "Moderada", "Plena",
                                             "Avanzada","Muy avanzada" ) )

sizet <- 8

# D62728 red 1f77b4 azul
colorRampPalette(c('#1f77b4','#D62728'))(5) %>% dput(.)

go <- ggplot(bdtr, aes(map_id = region)) + 
  geom_map(aes(fill = Etapa), map = alcmap) + expand_limits(x =  alcmap$long, y = alcmap$lat) +
  facet_wrap( ~ Periodo) +  coord_fixed() +
  scale_fill_manual(values = c("#d7191c", "#fdae61", "#ffffbf", "#abd9e9", "#2c7bb6")) +
  theme_bw() +  
  theme(axis.text = element_blank(),         axis.title = element_blank(),
        legend.title = element_blank(),        axis.ticks = element_blank(),
        legend.position = "bottom", panel.grid.minor=element_blank(), 
        panel.grid.major= element_blank(),  
        strip.background = element_rect(colour = 'white', fill = 'white'  ),
        legend.text = element_text(size = sizet, family="Helvetica"),
        strip.text.x = element_text(size = sizet + 1, family="Helvetica"),
        panel.border = element_rect(colour = 'white'),
        panel.margin = unit(0, "lines"),
        legend.background = element_rect(colour = "white")   ) + coord_quickmap() 

pdf(file = "map01_etapas_transicion_demografica.pdf", width = 6, height = 3, family="Helvetica")
print(go)
dev.off() 

data.table(bdtr)[Etapa=="Avanzada",]
data.table(bdtr)[Etapa=="Muy avanzada",]
data.table(bdtr)[Etapa=="Plena" & Periodo == '2005 A 2010',]
data.table(bdtr)[Etapa=="Moderada" & Periodo == '2005 A 2010',]


# ALC COL Crecimiento natural poblacion  -----------------------------------------------------------
tr <- read.xlsx2(file = "alc.trancision.xlsx",   sheetName = "resumen")
names(tr) <- c("Area","Periodo", "Año", "Variante","tbm","tbn","tcn", "tnm")

tr$tbm <- as.numeric(as.character(tr$tbm));     tr$tbn <- as.numeric(as.character(tr$tbn))
tr$tcn <- as.numeric(as.character(tr$tcn));     tr$Año <- as.numeric(as.character(tr$Año))
tr$tnm <- as.numeric(as.character(tr$tnm))
sizet <- 11.5

p1 <- ggplot() +  
  geom_vline(xintercept = seq(1950, 2030, 5), colour = '#f0f0f0', linetype = '22') + 
  geom_hline(yintercept = seq(0, 50, 2.5), colour = '#f0f0f0', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2030, 10), colour = '#EAEAEA', linetype = '22') + 
  geom_hline(yintercept = seq(0, 50, 5), colour = '#EAEAEA', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2030, 20), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = seq(0, 50, 10), colour = '#E4E4E4', linetype = '22') +
  geom_line(data = tr, aes(x = Año, y = tbm, group = Area), colour = "red", size = 2) +
  geom_text(data = tr,subset = .(Año == 1952.5), aes(x = Año,y = tbm , label = "TBM") , 
            colour = "red", vjust = -1, size = 4 ) +
  geom_line(data = tr, aes(x = Año, y = tbn, group = Area), colour = "darkgreen", size = 2) +
  geom_text(data = tr,subset = .(Año == 1952.5), aes(x = Año, y = tbn , label = "TBN"), 
            colour = "darkgreen", vjust = -1, size = 4  ) +
  ylab("Tasa por mil") + ylim(-5,50) +   theme(legend.position = "none") + 
  scale_x_continuous(limits = c(1950,2030),              breaks = seq(1950, 2030, 20)  ) +
  geom_line(data = tr, aes(x = Año, y = tcn, group = Area),      colour = "orange", size = 2) +
  geom_text(data = tr,subset = .(Año == 1952.5), 
            aes(x = Año,y = tcn , label = "TCN") ,  colour = "orange", vjust = -1, size = 4  ) +
  theme_bw(base_size = 12, base_family="Helvetica") +
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        plot.title = element_text(size = sizet + 2, family="Helvetica"),
        panel.grid = element_blank() ) + ggtitle("América Latina y el Caribe")


tr <- read.xlsx2(file = "col.transicion.xlsx",   sheetName = "resumen")
names(tr) <- c("Area","Periodo", "Año", "Variante","tbm","tbn","tcn", "tnm")

tr$tbm <- as.numeric(as.character(tr$tbm));     tr$tbn <- as.numeric(as.character(tr$tbn))
tr$tcn <- as.numeric(as.character(tr$tcn));     tr$Año <- as.numeric(as.character(tr$Año))
tr$tnm <- as.numeric(as.character(tr$tnm))

p2 <- ggplot() +  
  geom_vline(xintercept = seq(1950, 2030, 5), colour = '#f0f0f0', linetype = '22') + 
  geom_hline(yintercept = seq(0, 50, 2.5), colour = '#f0f0f0', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2030, 10), colour = '#EAEAEA', linetype = '22') + 
  geom_hline(yintercept = seq(0, 50, 5), colour = '#EAEAEA', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2030, 20), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = seq(0, 50, 10), colour = '#E4E4E4', linetype = '22') +
  geom_line(data = tr, aes(x = Año, y = tbm, group = Area), colour = "red", size = 2) +
  geom_text(data = tr,subset = .(Año == 1952.5), aes(x = Año,y = tbm , label = "TBM") , 
            colour = "red", vjust = -1, size = 4 ) +
  geom_line(data = tr, aes(x = Año, y = tbn, group = Area), colour = "darkgreen", size = 2) +
  geom_text(data = tr,subset = .(Año == 1952.5), aes(x = Año, y = tbn , label = "TBN"), 
            colour = "darkgreen", vjust = -.7, size = 4  ) +
  ylab("Tasa por mil") + ylim(-5,50) +   theme(legend.position = "none") + 
  scale_x_continuous(limits = c(1950,2030), breaks = seq(1950, 2030, 20)) +
  geom_line(data = tr, aes(x = Año, y = tcn, group = Area),      colour = "orange", size = 2) +
  geom_text(data = tr,subset = .(Año == 1952.5), 
            aes(x = Año,y = tcn , label = "TCN") ,  colour = "orange", vjust = -1, size = 4  ) +
  theme_bw(base_size = 12, base_family="Helvetica" ) +
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        plot.title = element_text(size = sizet + 2, family="Helvetica"),
        panel.grid = element_blank() ) + ggtitle("Colombia")

grid.newpage()
pdf(file = "gr01_alc_col_evolucion_tasa_crecimiento.pdf",   width = 8, height = 5.5,
    family="Helvetica")
print(grid.arrange(p1, p2, ncol = 2) )
dev.off() 

#  ALC Bono demográfico por pais  ----------------------------------------------------------------
fb <- read.xlsx2(file = "fases.bono.dem.xlsx",   sheetName = "resumen")

fb$p1 <- as.numeric(as.character(fb$p1));    fb$p2 <- as.numeric(as.character(fb$p2))
fb$p3 <- as.numeric(as.character(fb$p3));    fb$p4 <- as.numeric(as.character(fb$p4))

fb <- fb[order(-fb$p4),];   fb$C2 <- factor(fb$Country, as.character(fb$Country))

sizet <- 13

p <- ggplot(data = na.omit(fb)) +   
  geom_segment(aes(x = p1, xend = p2,y = C2, yend = C2, group = 1, colour = "Etapa 1"), size = 7.5) +
  geom_segment(aes(x = p2, xend = p3,y = C2, yend = C2, group = 1, colour = "Etapa 2"), size = 7.5) +
  geom_segment(aes(x = p3, xend = p4,y = C2, yend = C2, group = 1, colour = "Etapa 3"), size = 7.5) +
  theme_bw(base_size = 12, base_family = "Helvetica") + xlab("Año") + ylab("País") +   
  scale_colour_manual(name = "Etapas del bono",
                      values = c("Etapa 1" = "#2c7bb6", "Etapa 2"="#ffffbf",
                                 "Etapa 3"="#d7191c")) +
  scale_x_continuous( breaks = seq(1960, 2070, 10 ) ) +
  geom_vline(xintercept = seq(1960, 2070, 10 ), colour = 'white', linetype = 'solid', size = .2) +
  annotate('rect',  ymin = 11.5, ymax = 12.5, xmin = -Inf, xmax = Inf,    alpha = .15 ) +
  theme(legend.position="bottom", 
        axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica",
                                   face = c(rep('plain', 11) , 'bold', rep('plain', 7) ) ),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.text = element_text(size = sizet, family="Helvetica"),
        legend.title = element_text(size = sizet, family="Helvetica", face = 'plain'),
        panel.grid = element_blank() )         

pdf(file = "gr02_alc_etapas_bono_demografico.pdf",       width = 8, height = 6, family = "Helvetica")
print(p)
dev.off()  

# ALC Caracterización epidemiológica y e0 2004 --------------------------------------------------------------------
alcmap <- map_data("world")
alcmap <- subset(alcmap, region %in% c('Argentina'  ,'Bahamas'  , 'Barbados'	,'Belize'	,
                                       'Bolivia'	, 'Brazil'	,   'Chile'	,'Colombia'	,
                                       'Costa Rica'	,'Cuba'	,  'Dominica'	,'Dominican Republic'	,
                                       'Ecuador'	,   'El Salvador'	,   'Grenada'	,  'Guatemala'	,
                                       'Haiti'	, 'Honduras'	, 'Jamaica'	, 'Mexico'	,
                                       'Nicaragua'	,  'Panama'	,   'Paraguay'	,  'Peru'	,
                                       'Saint Lucia'	,    'Suriname'	,   'Tobago'	,  'Trinidad'	,
                                       'Uruguay'	,    'Venezuela'))

bdtr <- read.xlsx2(file = "etapaS.transepi.xlsx",  sheetName = "Sheet1")

sizet <- 11.5

# dput(unique(bdtr$Grupo))

bdtr$Grupo <- factor(bdtr$Grupo, levels = c( "Transmisibles","Cardiovasculares", "Externas", 
                                             "Neoplasias") )

p1 <-  ggplot(bdtr, aes(map_id = region)) +   geom_map(aes(fill = Grupo), map = alcmap) +
  expand_limits(x =  alcmap$long, y = alcmap$lat) +  theme_bw() +
  scale_fill_manual(values = c( "#e31a1c","#fdbf6f","#fb9a99",   "#ff7f00")) + coord_fixed() +
  theme_bw(base_size = sizet, base_family = "Helvetica") +
  theme(strip.background = element_rect(fill="#f0f0f0"),
        axis.text = element_blank(),         axis.title = element_blank(),
        legend.title = element_blank(),        axis.ticks = element_blank(),
        legend.position = "bottom", panel.grid = element_blank(),
        legend.text = element_text(size = sizet, family="Helvetica")) +
  guides(fill = guide_legend(nrow = 2)) + ggtitle('Causa de muerte característica') + coord_quickmap()

alcmap <- map_data("world")
alcmap <- subset(alcmap, region %in% c('Argentina'  ,'Bahamas'  ,  'Barbados'  ,'Belize'	,
                                       'Bolivia'	, 'Brazil'	,  'Chile'	,'Colombia'	,
                                       'Costa Rica'	,'Cuba'	,  'Dominica'	,'Dominican Republic'	,
                                       'Ecuador'	,   'El Salvador'	,  'Grenada'	,  'Guatemala'	,
                                       'Haiti'	, 'Honduras'	,   'Jamaica'	, 'Mexico'	,
                                       'Nicaragua'	,  'Panama'	,   'Paraguay'	,  'Peru'	,
                                       'Saint Lucia'	,    'Suriname'	,  'Tobago'	,  'Trinidad'	,
                                       'Uruguay'	,    'Venezuela'))

bdtr <- read.xlsx2(file = "etapaS.transepi.xlsx",  sheetName = "E0")
bdtr$E0 <- as.numeric(as.character(bdtr$E0))

p2 <-  ggplot(bdtr, aes(map_id = region)) + geom_map(aes(fill = E0), map = alcmap) +
  expand_limits(x =  alcmap$long, y = alcmap$lat) + theme_bw(base_size = sizet, base_family = "Helvetica") +
  coord_fixed() +
  scale_fill_gradient(low = "#ccece6", high = "#00441b",  guide = "colorbar") + 
  theme(axis.text = element_blank(), 
        axis.title = element_blank(),
        legend.title = element_blank(),
        axis.ticks = element_blank(), 
        legend.text = element_text(size = sizet, family="Helvetica"),
        legend.position = "bottom", 
        panel.grid=element_blank()) + ggtitle('Esperanza de vida al nacer') + coord_quickmap()

pdf(file = "map02_alc_caracterizacion_epidemiologica_e0_2004.pdf",   width = 8, height = 5,
    family="Helvetica" )
grid.newpage()
grid.draw(cbind(ggplotGrob(p1), ggplotGrob(p2), size="first"))
dev.off()  

# ***DETERMINANTES MORTALIDAD*** -------------------------------------------------------------


# ALC Cocientes mortalidad 1950 2010 ------------------------------------------------
mah <- read.xlsx2(file =  "alc.wpp.xlsx",sheetName = "h")
mam <- read.xlsx2(file =  "alc.wpp.xlsx",sheetName = "m")

mah$sexo <- "H" ; mam$sexo <- "M";    ma <- rbind(mah, mam)

ma$Age..x. <- as.numeric(as.character(ma$Age..x.))
ma$Age.interval..n.  <- as.numeric(as.character(ma$Age.interval..n.))

setnames(ma, "Number.of.deaths.d.x.n.", "dxn")
setnames(ma, "Major.area..region..country.or.area..",  "Pais")
setnames(ma, "Age..x.",  "Edad")
setnames(ma, "Age.interval..n.", "Intervalo")
setnames(ma, "Probability.of.dying.q.x.n.", "qxn")
setnames(ma, "Central.death.rate.m.x.n.", "mxn")

mas <- subset(ma,  Period %in%    c("1950-1955", "1980-1985"  ,"2005-2010") & Edad != 85)

mas$clase <- mas$Edad + (mas$Intervalo) / 2;    mas$dxn <- as.numeric(as.character(mas$dxn)) 
mas$qxn <- as.numeric(as.character(mas$qxn)) ;    mas$mxn <- as.numeric(as.character(mas$mxn)) 

sizet <- 11

ggobj <- ggplot(mas, aes(x = clase, y = qxn, colour = sexo, linetype = sexo, size = sexo)) +
  geom_vline(xintercept = seq(0, 80, 5), colour = '#f0f0f0', linetype = '22') +   
  geom_vline(xintercept = seq(0, 80, 10), colour = '#EAEAEA', linetype = '22') +   
  geom_vline(xintercept = seq(0, 80, 20), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = c(.001, .001, .01, .1, 1), colour = '#E4E4E4', linetype = '22') +  
  geom_line() +   facet_wrap( ~ Period  , ncol = 10 ) + 
  theme(axis.text.x = element_text(angle = 90)) + 
  xlab("Edad") +   scale_colour_manual(name = "",values = c("#4292c6","red"),
                                       guide = guide_legend(direction = 'vertical',keywidth = 3) ) +
  scale_linetype_manual(name = "",values = c("71", "3131") ,
                        guide = guide_legend(direction = 'vertical',keywidth = 3)) +
  scale_size_manual(name = "",values = c(2, 2),
                    guide = guide_legend(direction = 'vertical', keywidth = 3) ) +
  ylab( expression( log(paste( ""[n], q[x] ) )  ) )+ 
  scale_x_continuous(breaks = seq(0, 80, 20), expand=c(0.2, 0.2) ) +
  scale_y_log10(expand = c(.15,.15), breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x)) ) +
  theme_bw(base_size = sizet, base_family = "Helvetica") +
  theme(strip.background = element_rect(fill="white"), legend.position = 'right',
        axis.title.y=element_text(size = sizet, vjust = 0.9), 
        axis.title.x=element_text(size = sizet, vjust = 0.1),
        axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"), 
        legend.text = element_text(size = sizet, family="Helvetica"),
        strip.text.x = element_text(size = sizet + 1, family="Helvetica"),
        panel.margin = unit(0, "lines"),
        panel.grid = element_blank()
  ) + annotation_logticks(sides = "l")

cairo_pdf(file = "gr04_qxn_alc_edad_sexo_1950_2010.pdf" , width = 8, height = 3.1, family = "Helvetica")
print(ggobj) 
dev.off()


#  ALC Esperanza vida varias edades 1952 2007 -------------------------------------------------------------
mah <- read.xlsx2(file =  "alc.wpp.xlsx",sheetName = "h")
mam <- read.xlsx2(file =  "alc.wpp.xlsx",sheetName = "m")

mah$sexo <- "H" ; mam$sexo <- "M"
ma <- rbind(mah, mam)

ma$Age..x. <- as.numeric(as.character(ma$Age..x.))
ma$Age.interval..n.  <- as.numeric(as.character(ma$Age.interval..n.))

setnames(ma, "Number.of.deaths.d.x.n.", "dxn")
setnames(ma, "Major.area..region..country.or.area..",  "Pais")
setnames(ma, "Age..x.",  "Edad")
setnames(ma, "Age.interval..n.", "Intervalo")
setnames(ma, "Probability.of.dying.q.x.n.", "qxn")
setnames(ma, "Expectation.of.life.e.x.", "exn")

mas <- subset(ma, Edad %in% c(0, 40, 60, 80))

mas$clasep <- factor(mas$Period, levels = c("1950-1955", "1955-1960", "1960-1965", 
                                            "1965-1970", "1970-1975", "1975-1980", "1980-1985", "1985-1990", 
                                            "1990-1995", "1995-2000", "2000-2005", "2005-2010"),
                     labels = seq(1952.5, 2007.5, 5) )
mas$clasep <- as.numeric(as.character(mas$clasep))
mas$exn <- as.numeric(as.character(mas$exn))

mas$Edad <- factor(mas$Edad, levels = c(0, 40, 60, 80), 
                   labels = c('Al nacer', 'A la edad 40', 'A la edad 60', 'A la edad 80') )

sizet <- 11.5

g1 <- ggplot(mas, aes(x = clasep, y = exn, colour = sexo)) +
     geom_vline(xintercept = seq(1950, 2010, 10), colour = '#EAEAEA', linetype = '22') + 
   geom_vline(xintercept = seq(1950, 2010, 20), colour = '#E4E4E4', linetype = '22') + 
  geom_line(size = 1.3 ) +  xlab("Año") +  facet_wrap(~Edad, scale = "free") +
  scale_colour_manual(name = "",values = c("#4292c6","red") ) +
  ylab('Esperanza de vida') + 
  scale_x_continuous(lim = c(1949, 2011), breaks = seq(1950, 2010, 20) ) +
   guides(colour = guide_legend(label.vjust = 0.9, reverse = TRUE,keywidth = 2 ) ) +  
  theme_bw(base_size = sizet, base_family = "Helvetica") +
           theme(strip.background = element_rect(fill="white"), 
                  legend.position="right", panel.margin = unit(2, "lines") ,
                 axis.title.y = element_text(size = sizet, vjust=0.9), 
                 axis.title.x = element_text(size = sizet, vjust=0.1),
                 axis.text.x = element_text( size = sizet, family="Helvetica"),
                 axis.text.y = element_text(size = sizet, family="Helvetica"), 
                 legend.text = element_text(size = sizet, family="Helvetica"),
                 strip.text.x = element_text(size = sizet + 1, family="Helvetica"),
                 panel.grid.major.x = element_blank(),
                 panel.grid.minor.x = element_blank(),
                 panel.grid.major.y = element_line(colour = '#EAEAEA', linetype = '22'), 
                 panel.grid.minor.y = element_line(colour = '#EAEAEA', linetype = '22') )


pdf(file = "gr05_alc_ex_0_40_60_80_1950_2010.pdf" , width = 8, height = 7, family = "Helvetica")
print(g1) 
dev.off()




# ***CALIDAD REGISTROS*** -------------------------------------------------------------


#  COL Defunciones 1916 2010  -------------------------------------------------------
bd <- read.xlsx2(file = "def 1925 actual v2.xlsx",  sheetName = "resumen")
names(bd)[1] <- "anio"

bd$Defunciones <- as.numeric(as.character(bd$Defunciones))
bd$anio <- as.numeric(as.character(bd$anio))
bd$CIE <- as.numeric(as.character(bd$CIE))


sizet <- 12

p <- ggplot(bd, aes(y = Defunciones / 1000, x = anio, group = 1) ) +
  geom_vline(xintercept = seq(1915, 2010, 2.5), colour = '#f0f0f0', linetype = '22') + 
  geom_hline(yintercept = seq(75, 225, 6.25), colour = '#f0f0f0', linetype = '22') +
  geom_vline(xintercept = seq(1915, 2010, 5), colour = '#EAEAEA', linetype = '22') + 
  geom_hline(yintercept = seq(75, 225, 12.5), colour = '#EAEAEA', linetype = '22') +
  geom_vline(xintercept = seq(1920, 2010, 10), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = seq(75, 225, 25), colour = '#E4E4E4', linetype = '22') +
  geom_smooth(span = .6,method = 'loess', alpha = 1, color = '#023858', fill = '#d0d1e6') +
  geom_line(colour = "#252525", size = 1.3) + 
  theme_bw(base_size = sizet, base_family = "Helvetica") + xlab("Año") +
  geom_vline(aes(xintercept = c( 1968,  1980)), linetype="dashed", colour = "#B2182B" ) +
  annotate("text", size = 5,  x = 1959, y = 220 ,  
           label = "Ref. Adm. \u2192\nDANE", colour = '#525252', family = "Helvetica", fontface="bold") +
  annotate("text", size = 5,  x = 1993, y = 220 ,   
           label = "\u2190  Trabajo del \n DANE - INS para \n recuperar serie", colour = '#525252', 
           family = "Helvetica", fontface="bold") +
  ylab("Defunciones (en miles)") + scale_x_continuous(breaks = seq(1920,2010,10)) +
  scale_y_continuous(lim= c(75,230), breaks = seq(75, 230, 25) )+
  theme(  legend.title = element_blank(), 
          axis.text.x = element_text( size = sizet, family="Helvetica"),
          axis.text.y = element_text(size = sizet, family="Helvetica"),  
          axis.title.x = element_text(size = sizet, family="Helvetica"),
          axis.title.y = element_text(size = sizet, family="Helvetica"),
          panel.grid = element_blank() ) +
  geom_dl(data =  subset(bd, anio %in% c(1915, 1922, 1928, 1939, 1943, 1960, 1973, 1985, 1996, 2002, 2010)), 
          aes(y = Defunciones / 1000, x = anio, label =      round(Defunciones / 1000,0)   ),
          list(dl.combine(first.bumpup), cex = 0.75, family = "Helvetica", vjust = -1)) +
  geom_point(data =  
               subset(bd, anio %in% c(1915, 1922, 1928, 1939, 1943, 1960, 1973, 1985, 1996, 2002, 2010)), 
             aes(y = Defunciones / 1000, x = anio), fill = 'white', colour = '#d6604d', size = 4) +
  geom_text(data =  subset(bd, anio %in% c(1920, 1930, 1940, 1970, 1954, 1980)), 
            aes(y = Defunciones / 1000, x = anio, label =  round(Defunciones / 1000,0) ,
                vjust = 2, family = "Helvetica"  ), size = 4) +
  geom_point(data =      subset(bd, anio %in% c(1920, 1930, 1940, 1970, 1954, 1980)), 
             aes(y = Defunciones / 1000, x = anio), fill = 'white', colour = '#f4a582', size = 3.5) +
  annotate('rect', xmin = 1968, xmax = 1980, ymin = -Inf, ymax = Inf,    alpha = .1 )

cairo_pdf(file = "gr06_col_defunciones_registradas_1925_2010.pdf",    width = 8, 
          height = 5,           family = "Helvetica")
print(p)
dev.off()


#  COL Divipola 1964 1993 ----------------------------------------------------------
bd <- read.xlsx2(file = "mapa.vacio.col.xlsx",   1)

colm <- readOGR("cescm2Polyvl3.shp", layer = "cescm2Polyvl3", 
                verbose = TRUE, stringsAsFactors = FALSE)

colm.c <- data.frame(long = coordinates(colm)[, 1],  lat = coordinates(colm)[, 2]) 

colm.c[, 'ID4'] <- colm@data[,'ID4']
colm.c[32,"ID4"] <- ''; colm.c[33,"ID4"] <- ''
colm.c[34,"ID4"] <- 26; colm.c[35,"ID4"] <- 26

gpclibPermit()
pds <- fortify(colm, region="ID4")
names(bd)[2] <- "id"; names(colm.c)[3] <- "id"

bd <- merge(bd, colm.c, by = "id")

sizet <- 13

gf1 <- ggplot(bd ,aes(map_id = id)) + coord_fixed() + 
  geom_map(aes(fill = a.1964), map = pds) + 
  geom_text(aes(label = n.1964, x =  long, y = lat), size = 2.8, colour = as.vector(bd$c.1964),
            family = "Helvetica") +
  guides(fill = F, colour = F) +   expand_limits(x =  pds$long, y = pds$lat)  +
  ylim(-4, 13)    +  xlim(-80, -66.5) + xlab("") + ylab("") +  
  theme_tufte(base_size = 12, base_family = "Helvetica") +
  geom_segment( aes(x = -79,  y=9.5, xend=-79,   yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.7, xend=-77.7,   y=9.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-77.5,   y=10.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -76, xend=-76,   y=10.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -79, xend=-77.7,   y=13, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -79, xend=-77.7,   y=9.5, yend = 9.5), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-76,   y=13, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-76,   y=10.5, yend = 10.5), colour = '#d9d9d9', size = .2)+
  theme(axis.text = element_blank(),  strip.background = element_rect(colour = 'white' , fill="white"), 
        strip.text = element_text(size = sizet, face="bold"),     
        panel.grid = element_blank(),  axis.ticks = element_blank(), 
        plot.margin = unit(c(0,0,0,0),"mm"), 
        plot.title = element_text(size = sizet)) + ggtitle('1964') + coord_quickmap()

gf2 <- ggplot(bd ,aes(map_id = id)) + coord_fixed() + 
  geom_map(aes(fill = a.1973), map = pds) + 
  geom_text(aes(label = n.1973, x =  long, y = lat), size = 2.8, colour = as.vector(bd$c.1973),
            family = "Helvetica") +
  guides(fill = F)+   expand_limits(x =  pds$long, y = pds$lat)  +
  ylim(-4, 13)    +  xlim(-80, -66.5)    +  xlab("") + ylab("") + 
  theme_tufte(base_size = 10, base_family = "Helvetica")+
  geom_segment( aes(x = -79,  y=9.5, xend=-79,   yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.7, xend=-77.7,   y=9.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-77.5,   y=10.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -76, xend=-76,   y=10.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -79, xend=-77.7,   y=13, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -79, xend=-77.7,   y=9.5, yend = 9.5), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-76,   y=13, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-76,   y=10.5, yend = 10.5), colour = '#d9d9d9', size = .2)+
  theme(axis.text = element_blank(),  strip.background = element_rect(colour = 'white' , fill="white"), 
        strip.text = element_text(size = sizet, face="bold"),    
        panel.grid =element_blank(),  axis.ticks = element_blank(), 
        plot.margin=unit(c(0,0,0,0),"mm"), 
        plot.title = element_text(size = sizet)) + ggtitle('1973')+ coord_quickmap()

gf3 <- ggplot(bd ,aes(map_id = id)) + coord_fixed() + 
  geom_map(aes(fill = a.1985), map = pds) + 
  geom_text(aes(label = n.1985, x =  long, y = lat), size = 2.8, colour = as.vector(bd$c.1985),
            family = "Helvetica") +
  guides(fill = F)+   expand_limits(x =  pds$long, y = pds$lat)  +
  ylim(-4, 13)    +  xlim(-80, -66.5)     +  xlab("") + ylab("") + 
  theme_tufte(base_size = 10, base_family = "Helvetica")+
  geom_segment( aes(x = -79,  y=9.5, xend=-79,   yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.7, xend=-77.7,   y=9.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-77.5,   y=10.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -76, xend=-76,   y=10.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -79, xend=-77.7,   y=13, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -79, xend=-77.7,   y=9.5, yend = 9.5), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-76,   y=13, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-76,   y=10.5, yend = 10.5), colour = '#d9d9d9', size = .2)+
  theme(axis.text = element_blank(),  strip.background = element_rect(colour = 'white' , fill="white"), 
        strip.text = element_text(size = sizet, face="bold"),    
        panel.grid = element_blank(),  axis.ticks = element_blank(), 
        plot.margin=unit(c(0,0,0,0),"mm"), 
        plot.title = element_text(size = sizet)) + ggtitle('1985')+ coord_quickmap()

gf4 <- ggplot(bd ,aes(map_id = id)) + coord_fixed() + 
  geom_map(aes(fill = a.1993), map = pds) + 
  geom_text(aes(label = n.1993, x =  long, y = lat), size = 2.8, , colour = as.vector(bd$c.1993),
            family = "Helvetica") +
  guides(fill = F)+   expand_limits(x =  pds$long, y = pds$lat)  +
  ylim(-4, 13)    +  xlim(-80, -66.5)     +  xlab("") + ylab("") + 
  theme_tufte(base_size = 10, base_family = "Helvetica")+
  geom_segment( aes(x = -79,  y=9.5, xend=-79,   yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.7, xend=-77.7,   y=9.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-77.5,   y=10.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -76, xend=-76,   y=10.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -79, xend=-77.7,   y=13, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -79, xend=-77.7,   y=9.5, yend = 9.5), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-76,   y=13, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-76,   y=10.5, yend = 10.5), colour = '#d9d9d9', size = .2)+
  theme(axis.text = element_blank(),  strip.background = element_rect(colour = 'white' , fill="white"), 
        strip.text = element_text(size = sizet, face="bold"),    
        panel.grid =element_blank(),  axis.ticks = element_blank(), 
        plot.margin=unit(c(0,0,0,0),"mm"), 
        plot.title = element_text(size = sizet)) + ggtitle('1993') + coord_quickmap()

pdf(file = "map03_col_adm_1964_1993.pdf",   width = 8, height = 9, family = "Helvetica")
print(grid.arrange(gf1,  gf2, gf3, gf4, ncol = 2))
dev.off()  


# COL Defunciones sin declaración de edad 1985 2010 ---------------------------------------------
resd <- function(anio){
  fil <- paste("DEFU", anio, ".txt", sep="")
  bd <- fread(fil,  header = TRUE)
  bd <- data.table(bd)
  
  bdo <- bd[,.N, keyby = list(CODPTORE, GRU_ED1)][ 
    ,Porcentaje := N * 100  / sum(N), by = CODPTORE][
      GRU_ED1 == 25  ,]
  print(as.data.frame(bdo))
}

resdg <- function(anio){
  fil <- paste("DEFU", anio, ".txt", sep="")
  bd <- fread(fil,  header = TRUE)
  bd <- data.table(bd)
  
  bdo <- bd[,.N, keyby = list(CODPTORE, GRU_ED1)][ 
    ,Porcentaje := N * 100  / sum(N), by = CODPTORE][
      GRU_ED1 == 26  ,]
  print(as.data.frame(bdo))
}

resdg2 <- function(anio){
  fil <- paste("DEFU", anio, ".txt", sep="")
  bd <- fread(fil,  header = TRUE)
  bd <- data.table(bd)
  setnames(bd, names(bd), toupper(names(bd)) )
  bdo <- bd[,.N, keyby = list(CODPTORE, GRU_ED1)][ 
    ,Porcentaje := N * 100  / sum(N), by = CODPTORE][
      GRU_ED1 == 29  ,]
  print(as.data.frame(bdo))
}

cod <- as.data.frame(c(1, 5, 8, 11, 13, 15, 17, 18, 19, 20,   23, 25, 27, 41, 44, 47, 
                       50, 52, 54, 63, 66, 68, 70, 73, 75, 76,
                       81, 85, 86, 88, 91,94, 95, 97, 99))     
names(cod) <- c("CODPTORE")

def <- resd(1980)  ; def <- merge(def, cod, by = c("CODPTORE") , all.y = TRUE)
def$anio <- 1980
def2 <- resd(1985) ;  def2 <- merge(def2, cod, by = c("CODPTORE") , all.y = TRUE)
def2$anio <- 1985
def3 <- resd(1990) ;  def3 <- merge(def3, cod, by = c("CODPTORE") , all.y = TRUE)
def3$anio <- 1990
def4 <- resd(1995) ;  def4 <- merge(def4, cod, by = c("CODPTORE") , all.y = TRUE)
def4$anio <- 1995
def5 <- resdg(2000) ;  def5 <- merge(def5, cod, by = c("CODPTORE") , all.y = TRUE)
def5$anio <- 2000
def6 <- resdg(2005) ;  def6 <- merge(def6, cod, by = c("CODPTORE") , all.y = TRUE)
def6$anio <- 2005
def7 <- resdg2(2010) ;  def7 <- merge(def7, cod, by = c("CODPTORE") , all.y = TRUE)
def7$anio <- 2010

def <- rbind(def, def2, def3, def4,def5, def6, def7 )

def[which(is.na(def$Porcentaje == TRUE)),]$Porcentaje <- 0

lab <- read.xlsx2(file = "omision_censal_col.xlsx",  sheetName = "2005")
lab <- lab[, c(1:2)]

names(def)[1] <- "cod_depto"

def$cod_depto <- round(as.numeric(as.character(def$cod_depto)), 1)
lab$cod_depto <- round(as.numeric(as.character(lab$cod_depto)), 1)

def <- merge (def, lab, by = "cod_depto", all.y = TRUE)
def$ID_1 <- round(as.numeric(as.character(def$ID_1)), digits =0)

colm <- readOGR("cescm2Polyvl3.shp", layer = "cescm2Polyvl3", 
                verbose = TRUE, stringsAsFactors = FALSE)
pds <- fortify(colm, region = "ID4")
names(def)[6] <- "id"
defs <- subset(def, anio %in% c(1985, 1990, 1995, 2000, 2005, 2010 ))

sizet <- 12

p <-  ggplot(defs, aes(map_id = id)) + coord_fixed() + 
  geom_map(aes(fill = Porcentaje, colour = ''), map = pds, size = .2) + 
  guides(colour = F)+ scale_colour_manual(values = '#d9d9d9')+
  expand_limits(x =  pds$long, y = pds$lat) +
  scale_fill_gradient( low = "white",  high = "#fe9929",
                       guide = guide_colorbar(title.vjust = 1), breaks = seq(0,8,2) ) +
  ylim(-4, 14)    + facet_wrap( ~ anio) + xlab("") + ylab("") + 
  geom_segment(aes(x = -79, xend=-79,   y=9.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.7, xend=-77.7,   y=9.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-77.5,   y=10.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -76, xend=-76,   y=10.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -79, xend=-77.7,   y=13, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -79, xend=-77.7,   y=9.5, yend = 9.5), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-76,   y=13, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-76,   y=10.5, yend = 10.5), colour = '#d9d9d9', size = .2)+
  theme_tufte(base_size = 12) +  
  theme(axis.text = element_blank(), 
        strip.background = element_rect(colour = 'white' , fill="white"), 
        strip.text = element_text(size = sizet, family="Helvetica"),
        panel.grid =element_blank(), 
        legend.text = element_text(size = sizet - 2, family="Helvetica"),
        legend.title = element_text(size = sizet - 2, family="Helvetica", face = 'plain'),
        axis.ticks = element_blank()) + coord_quickmap()

pdf(file = "map05_col_porcentaje_defunciones_sin_declaracion_edad.pdf",   family = "Helvetica",
    width = 8, height = 6)
print(p)
dev.off() 

defb <- data.table(def)
defb$Namd <- factor(defb$cod_depto, lev = c(5 , 8 , 11 , 13 , 15 , 17 , 18 , 19 , 20 , 23 , 
                                            25 , 27 , 41 , 44 , 47 , 50 , 52 , 54 , 63 , 66 , 
                                            68 , 70 , 73 , 76 , 81 , 85 , 86 , 88 , 91 , 94 , 
                                            95 , 97 , 99 ), 
                    labels = c('ANTIOQUIA'     , 'ATLÁNTICO'     , 'BOGOTÁ, D. C.'    , 
                               'BOLÍVAR'          , 'BOYACÁ'        , 'CALDAS'   , 
                               'CAQUETÁ'          , 'CAUCA'        , 'CESAR'         , 
                               'CÓRDOBA'         , 'CUNDINAMARCA'        , 'CHOCÓ'          , 
                               'HUILA'            , 'LA GUAJIRA'     , 'MAGDALENA'       , 
                               'META'     , 'NARIÑO'       , 'NORTE DE SANTANDER'       , 
                               'QUINDÍO'      , 'RISARALDA'    , 'SANTANDER'    ,
                               'SUCRE'   , 'TOLIMA'     , 'VALLE DEL CAUCA'       , 
                               'ARAUCA'    , 'CASANARE'   , 'PUTUMAYO'       , 
                               'ARCHIPIÉLAGO DE SAN ANDRÉS, PROVIDENCIA Y '  , 'AMAZONAS'  , 'GUAINÍA' , 
                               'GUAVIARE'          , 'VAUPÉS'            , 'VICHADA'         ) )

defc <- defb[order(Namd, anio)][, c('Namd', 'anio', 'Porcentaje'), with =F][
  , Pctb := round(Porcentaje) ][, Pct.Sidecl := 100- Pctb]

defc[anio == 1985][order(Pct.Sidecl)]
defc[anio == 1990][order(Pct.Sidecl)]
defc[anio == 1995][order(Pct.Sidecl)]
defc[anio == 2000][order(Pct.Sidecl)]
defc[anio == 2005][order(Pct.Sidecl)]
defc[anio == 2010][order(Pct.Sidecl)]
defc[Namd == 'VAUPÉS']
defc[Namd == 'GUAINÍA']


# COL Defunciones sin certificación médica 1985 2010 ---------------------------------------------
resd <- function(anio){
  fil <- paste("DEFU", anio, ".txt", sep="")
  bd <- fread(fil,  header = TRUE)
  bd <- data.table(bd)
  setnames(bd, names(bd), toupper(names(bd)) )
  bdo <- bd[,.N, keyby = list(CODPTORE, CONS_EXP)][
    ,    Porcentaje := N * 100 / sum(N), keyby = list(CODPTORE)][
      CONS_EXP == 3  ,]
  print(as.data.frame(bdo))
}

resdg <- function(anio){
  fil <- paste("DEFU", anio, ".txt", sep="")
  bd <- fread(fil,  header = TRUE)
  bd <- data.table(bd)  
  setnames(bd, names(bd), toupper(names(bd)) )
  bdo <- bd[,.N, keyby = list(CODPTORE, C_MCM1)][ 
    ,Porcentaje := N * 100  / sum(N), by = CODPTORE][
      C_MCM1 != "" &  C_MCM1 != " " ,][
        , list(CONS_EXP = 3, N = sum(N), Porcentaje = sum(Porcentaje)), 
        by = CODPTORE ]
  print(as.data.frame(bdo))
}

def <- resd(1980)  ; def$anio <- 1980
def2 <- resd(1985) ; def2$anio <- 1985
def3 <- resd(1990) ; def3$anio <- 1990
def4 <- resd(1995) ; def4$anio <- 1995
def5 <- resdg(2000) ; def5$anio <- 2000
def6 <- resdg(2005) ; def6$anio <- 2005
def7 <- resdg(2010) ; def7$anio <- 2010

r1 <- c(99,  3,  0,  0,  1985,  32)
r2 <- c(99,  3,  0,  0,  1990,  32)
r3 <- c(99,  3,  0,  0,  1995,  32)
r4 <- c(97,  3,  0,  0,  1985,  31)
r5 <- c(97,  3,  0,  0,  1995,  31)
r6 <- c(91,  3,  0,  0,  1990,  1)
r7 <- c(91,  3,  0,  0,  1995,  1)
r8 <- c(95,  3,  0,  0,  2005,  16)
r9 <- c(95,  3,  0,  0,  2010,  16)
r10 <- c(85,  3,  0,  0,  2005,  9)
r11 <- c(85,  3,  0,  0,  2010,  9)
r12 <- c(25,  3,  0,  0,  2005,  14)
r13 <- c(99,  3,  0,  0,  2005,  32)
r14 <- c(95,  3,  0,  0,  1990,  16)
r15 <- c(94,  3,  0,  0,  1995,  15)
r16 <- c(94,  3,  0,  0,  1990,  15)
r17 <- c(66,  3,  0,  0,  2005,  25)
r18 <- c(63,  3,  0,  0,  2000,  24)
r19 <- c(63,  3,  0,  0,  2005,  24)
r20 <- c(66,  3,  0,  0,  2010,  25)
r21 <- c(17,  3,  0,  0,  2010,  7)
r22 <- c(17,  3,  0,  0,  2005,  7)
r23 <- c(88,  3,  0,  0,  1985,  26)
r24 <- c(88,  3,  0,  0,  1990,  26)
r25 <- c(88,  3,  0,  0,  1995,  26)
r26 <- c(88,  3,  0,  0,  2000,  26)
r27 <- c(88,  3,  0,  0,  2005,  26)
r28 <- c(88,  3,  0,  0,  2010,  26)

def <- rbind(def, def2, def3, def4,def5, def6, def7,
             r1, r2,r3,r4,r5,r6,r7,r8,r9,r10,r11,r12,r13,r14,r15,r16,r17,
             r18,r19,r20,r21,r22,r23,r24,r25,r26,r27,r28)


lab <- read.xlsx2(file = "omision_censal_col.xlsx",  sheetName = "2005")
lab <- lab[, c(1:2)]

names(def)[1] <- "cod_depto"

def$cod_depto <- round(as.numeric(as.character(def$cod_depto)), 1)
lab$cod_depto <- round(as.numeric(as.character(lab$cod_depto)), 1)

def <- merge (def, lab, by = "cod_depto", all.y = TRUE)
def$ID_1 <- round(as.numeric(as.character(def$ID_1)), digits =0)

colm <- readOGR("cescm2Polyvl3.shp", layer = "cescm2Polyvl3", 
                verbose = TRUE, stringsAsFactors = FALSE)
pds <- fortify(colm, region="ID4")

names(def)[6] <- "id"
defs <- subset(def, anio %in% c(1985 , 1990, 1995, 2000,2005, 2010 ))

sizet <- 12

p <- ggplot(defs, aes(map_id = id)) + coord_fixed() + 
  geom_map(aes(fill = Porcentaje, colour = ''), map = pds, size = .2) + 
  guides(colour = F)+ scale_colour_manual(values = '#d9d9d9')+
  expand_limits(x =  pds$long, y = pds$lat) +
  scale_fill_gradient( low = "white",  high = "#67000d",
                       guide = guide_colorbar(title.vjust = 1), breaks = seq(0,60,10) ) +
  facet_wrap(~ anio) + xlab("") + ylab("") + 
  geom_segment(aes(x = -79, xend=-79,   y=9.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.7, xend=-77.7,   y=9.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-77.5,   y=10.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -76, xend=-76,   y=10.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -79, xend=-77.7,   y=13, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -79, xend=-77.7,   y=9.5, yend = 9.5), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-76,   y=13, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-76,   y=10.5, yend = 10.5), colour = '#d9d9d9', size = .2)+
  theme_tufte(base_size = 12) +  
  theme(axis.text = element_blank(), 
        strip.background = element_rect(colour = 'white' , fill="white"), 
        strip.text = element_text(size = sizet, family="Helvetica"),
        panel.grid.minor=element_blank(),  panel.grid.major=element_blank(), 
        legend.text = element_text(size = sizet - 2, family="Helvetica"),
        legend.title = element_text(size = sizet - 2, family="Helvetica", face = 'plain'),
        axis.ticks = element_blank()) +
  scale_y_continuous(limits = c(-4, 14) ) + coord_quickmap()

pdf(file = "map04_col_porcentaje_defunciones_sin_certificacion_1985_2010.pdf", family = "Helvetica",
             width = 8, height = 6)
print(p)
dev.off() 


defb <- data.table(def)
defb$Namd <- factor(defb$cod_depto, lev = c(5 , 8 , 11 , 13 , 15 , 17 , 18 , 19 , 20 , 23 , 
                                            25 , 27 , 41 , 44 , 47 , 50 , 52 , 54 , 63 , 66 , 
                                            68 , 70 , 73 , 76 , 81 , 85 , 86 , 88 , 91 , 94 , 
                                            95 , 97 , 99 ), 
                    labels = c('ANTIOQUIA'     , 'ATLÁNTICO'     , 'BOGOTÁ, D. C.'    , 
                               'BOLÍVAR'          , 'BOYACÁ'        , 'CALDAS'   , 
                               'CAQUETÁ'          , 'CAUCA'        , 'CESAR'         , 
                               'CÓRDOBA'         , 'CUNDINAMARCA'        , 'CHOCÓ'          , 
                               'HUILA'            , 'LA GUAJIRA'     , 'MAGDALENA'       , 
                               'META'     , 'NARIÑO'       , 'NORTE DE SANTANDER'       , 
                               'QUINDÍO'      , 'RISARALDA'    , 'SANTANDER'    ,
                               'SUCRE'   , 'TOLIMA'     , 'VALLE DEL CAUCA'       , 
                               'ARAUCA'    , 'CASANARE'   , 'PUTUMAYO'       , 
                              'ARCHIPIÉLAGO DE SAN ANDRÉS, PROVIDENCIA Y '  , 'AMAZONAS'  , 'GUAINÍA' , 
                              'GUAVIARE'          , 'VAUPÉS'            , 'VICHADA'         ) )

defc <- defb[order(Namd, anio)][, c('Namd', 'anio', 'Porcentaje'), with =F][
  , Pctb := round(Porcentaje) ][, Pct.Sicert := 100- Pctb]

defc[Namd == 'CUNDINAMARCA']
defc[Namd == 'ANTIOQUIA']
defc[Namd == 'VALLE DEL CAUCA']

defc[Namd == 'CHOCÓ']
defc[Namd == 'NARIÑO']



# COL Defunciones con causas mal definidas 1985 2010 ---------------------------------------------
resd <- function(anio){
  fil <- paste("DEFU", anio, ".txt", sep="")
  bd <- fread(fil,  header = TRUE)
  bd <- data.table(bd)
  setnames(bd, names(bd), toupper(names(bd)) )
  bdo <- bd[,.N, keyby = list(CODPTORE, C_BAS1R)][ 
    ,Porcentaje := N * 100  / sum(N), by = CODPTORE][
      C_BAS1R == "7999"  ,]
  print(as.data.frame(bdo))
}

resdg <- function(anio){
  fil <- paste("DEFU", anio, ".txt", sep="")
  bd <- fread(fil,  header = TRUE)
  bd <- data.table(bd)
  setnames(bd, names(bd), toupper(names(bd)) )
  bdo <- bd[,.N, keyby = list(CODPTORE, C_BAS1R)][ 
    ,Porcentaje := N * 100  / sum(N), by = CODPTORE][
      C_BAS1R %in% c("R98X","R99X")  ,][
        , list(C_BAS1R = 7999, N = sum(N), Porcentaje = sum(Porcentaje)), 
        by = CODPTORE ]
  print(as.data.frame(bdo))
}

resdg2 <- function(anio){
  fil <- paste("DEFU", anio, ".txt", sep="")
  bd <- fread(fil,  header = TRUE)
  bd <- data.table(bd)
  setnames(bd, names(bd), toupper(names(bd)) )
  bdo <- bd[,.N, keyby = list(CODPTORE, C_BAS1)][ 
    ,Porcentaje := N * 100  / sum(N), by = CODPTORE][
      C_BAS1 %in% c("R98","R99")  ,][
        , list(C_BAS1R = 7999,N = sum(N), Porcentaje = sum(Porcentaje)), 
        by = CODPTORE ]
  print(as.data.frame(bdo))
}

resdg3 <- function(anio){
  fil <- paste("DEFU", anio, ".txt", sep="")
  bd <- fread(fil,  header = TRUE)
  bd <- data.table(bd)
  setnames(bd, names(bd), toupper(names(bd)) )
  bdo <- bd[,.N, keyby = list(CODPTORE, C_BAS1)][ 
    ,Porcentaje := N * 100  / sum(N), by = CODPTORE][
      C_BAS1 %in% c("R98X","R99X")  ,][
        , list(C_BAS1R = 7999, N = sum(N), Porcentaje = sum(Porcentaje)),
        by = CODPTORE ]
  print(as.data.frame(bdo))
}

def <- resd(1980)  ; def$anio <- 1980
def2 <- resd(1985) ; def2$anio <- 1985
def3 <- resd(1990) ; def3$anio <- 1990
def4 <- resd(1995) ; def4$anio <- 1995
def5 <- resdg(2000) ; def5$anio <- 2000
def6 <- resdg3(2005) ; def6$anio <- 2005
def7 <- resdg2(2010) ; def7$anio <- 2010

r1 <- c(18,  7999,  0,  0,	1980,	8)
r2 <- c(88,  7999,  0,  0,	1990,	26)
r3 <- c(94,  7999,  0,  0,  1990,	15)
r4 <- c(95,  7999,  0,  0,  1990,	16)
r5 <- c(97,  7999,  0,  0,  1985,  31)
r6 <- c(99,  7999,  0,  0,  1985,  32)
r7 <- c(99,  7999,  0,  0,  1990,  32)
r8 <- c(99,  7999,  0,  0,  1980,  32)
r9 <- c(99,  7999,  0,  0,  1995,  32)
r10 <- c(99,  7999,  0,  0,  2005,  32)
r11 <- c(97,  7999,  0,  0,  1995,  31)
r12 <- c(97,  7999,  0,  0,  2010,  31)
r13 <- c(88,  3,  0,  0,  1985,  26)
r14 <- c(88,  3,  0,  0,  1990,  26)
r15 <- c(88,  3,  0,  0,  1995,  26)
r16 <- c(88,  3,  0,  0,  2000,  26)
r17 <- c(88,  3,  0,  0,  2005,  26)
r18 <- c(88,  3,  0,  0,  2010,  26)

def <- rbind(def, def2, def3, def4,def5, def6, def7,
             r1, r2,r3,r4,r5,r6,r7,r8,r9,r10,r11,r12,r13,r14,r15,r16,r17,r18)

lab <- read.xlsx2(file = "omision_censal_col.xlsx",  sheetName = "2005")
lab <- lab[, c(1:2)]

names(def)[1] <- "cod_depto"

def$cod_depto <- round(as.numeric(as.character(def$cod_depto)), 1)
lab$cod_depto <- round(as.numeric(as.character(lab$cod_depto)), 1)

def <- merge (def, lab, by = "cod_depto", all.y = TRUE)
def$ID_1 <- round(as.numeric(as.character(def$ID_1)), digits =0)

colm <- readOGR("cescm2Polyvl3.shp", layer = "cescm2Polyvl3", 
                verbose = TRUE, stringsAsFactors = FALSE)
pds <- fortify(colm, region="ID4")

names(def)[6] <- "id"
defs <- subset(def, anio %in% c(1985, 1990, 1995, 2000, 2005, 2010 ))

sizet <- 12

p <-  ggplot(defs, aes(map_id = id)) + coord_fixed() + 
  geom_map(aes(fill = Porcentaje, colour = ''), map = pds, size = .2) + 
  guides(colour = F)+ scale_colour_manual(values = '#d9d9d9')+
  expand_limits(x =  pds$long, y = pds$lat) +
  scale_fill_gradient( low = "white",  high = "#a50f15",
                       guide = "colorbar", breaks = seq(0,60,10) ) +
  ylim(-4, 14)    + facet_wrap(~ anio) + xlab("") + ylab("") + 
  geom_segment(aes(x = -79, xend=-79,   y=9.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.7, xend=-77.7,   y=9.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-77.5,   y=10.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -76, xend=-76,   y=10.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -79, xend=-77.7,   y=13, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -79, xend=-77.7,   y=9.5, yend = 9.5), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-76,   y=13, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-76,   y=10.5, yend = 10.5), colour = '#d9d9d9', size = .2)+
  theme_tufte(base_size = 12) +
  theme(axis.text = element_blank(), 
        strip.background = element_rect(colour = 'white' , fill="white"), 
        strip.text = element_text(size = sizet, family="Helvetica"),
        panel.grid.minor=element_blank(),  panel.grid.major=element_blank(), 
        legend.text = element_text(size = sizet -2, family="Helvetica"),
        legend.title = element_text(size = sizet - 2, family="Helvetica", face = 'plain'),
        axis.ticks = element_blank()) + coord_quickmap()

pdf(file = "map06_col_porcentaje_defunciones_causas_mal_definidas.pdf", family = "Helvetica",
             width = 8, height = 6)
print(p)
dev.off() 


defb <- data.table(def)
defb$Namd <- factor(defb$cod_depto, lev = c(5 , 8 , 11 , 13 , 15 , 17 , 18 , 19 , 20 , 23 , 
                                            25 , 27 , 41 , 44 , 47 , 50 , 52 , 54 , 63 , 66 , 
                                            68 , 70 , 73 , 76 , 81 , 85 , 86 , 88 , 91 , 94 , 
                                            95 , 97 , 99 ), 
                    labels = c('ANTIOQUIA'     , 'ATLÁNTICO'     , 'BOGOTÁ, D. C.'    , 
                               'BOLÍVAR'          , 'BOYACÁ'        , 'CALDAS'   , 
                               'CAQUETÁ'          , 'CAUCA'        , 'CESAR'         , 
                               'CÓRDOBA'         , 'CUNDINAMARCA'        , 'CHOCÓ'          , 
                               'HUILA'            , 'LA GUAJIRA'     , 'MAGDALENA'       , 
                               'META'     , 'NARIÑO'       , 'NORTE DE SANTANDER'       , 
                               'QUINDÍO'      , 'RISARALDA'    , 'SANTANDER'    ,
                               'SUCRE'   , 'TOLIMA'     , 'VALLE DEL CAUCA'       , 
                               'ARAUCA'    , 'CASANARE'   , 'PUTUMAYO'       , 
                               'ARCHIPIÉLAGO DE SAN ANDRÉS, PROVIDENCIA Y '  , 'AMAZONAS'  , 'GUAINÍA' , 
                               'GUAVIARE'          , 'VAUPÉS'            , 'VICHADA'         ) )

defc <- defb[order(Namd, anio)][, c('Namd', 'anio', 'Porcentaje'), with =F][
  , Pctb := round(Porcentaje) ][, Pct.Cbiend := 100- Pctb]

defc[anio == 1985][order(-Pctb)]
defc[anio == 1990][order(-Pctb)]
defc[anio == 1995][order(-Pctb)]
defc[anio == 2000][order(-Pctb)]
defc[anio == 2005][order(-Pctb)]
defc[anio == 2010][order(-Pctb)]


# COL Nacimientos registrados 1927 2010 -------------------------------------------------------
bd <- read.xlsx2(file = "nacimientosdeptoregistro.xlsx",  sheetName = "nacf")
names(bd)[1] <- "anio"

bd$nacim <- as.numeric(as.character(bd$nacim))
bd$anio <- as.numeric(as.character(bd$anio))

sizet <- 12

p <- ggplot(bd, aes(y = nacim / 1000, x = anio, group = 1) ) +
  geom_vline(xintercept = seq(1915, 2010, 2.5), colour = '#f0f0f0', linetype = '22') + 
  geom_hline(yintercept = seq(100, 1000, 37.5), colour = '#f0f0f0', linetype = '22') +
  geom_vline(xintercept = seq(1915, 2010, 5), colour = '#EAEAEA', linetype = '22') + 
  geom_hline(yintercept = seq(100, 1000, 75), colour = '#EAEAEA', linetype = '22') +
  geom_vline(xintercept = seq(1920, 2010, 10), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = 100, 1000, 150, colour = '#E4E4E4', linetype = '22') +
  geom_smooth(span = .5,method = 'loess', alpha = 1, color = '#023858', fill = '#d0d1e6') +
  geom_line(colour = "#252525", size = 1.3) + theme_bw(base_size = 18) + xlab("Año") +
  ylab("Nacimientos (en miles)") + scale_x_continuous(breaks = seq(1920,2010,10)) +
  annotate("text", size = 5,  x = 1959, y = 960 ,  
           label = "1era crisis \u2192\ndel registro", colour = '#525252', family = "Helvetica", fontface="bold") +
  annotate("text", size = 5,  x = 2006, y = 960 ,   
           label = "\u2190 2da crisis\n del registro", colour = '#525252', 
           family = "Helvetica", fontface="bold") +
  geom_vline(aes(xintercept = 1968), linetype="dashed", colour = "#B2182B" ) +
  geom_vline(aes(xintercept =   1980), linetype="dashed", colour = "#B2182B" ) +
  geom_vline(aes(xintercept = 1988), linetype="dashed", colour = "#B2182B" ) +
  geom_vline(aes(xintercept =   1997), linetype="dashed", colour = "#B2182B" ) +
  theme(text = element_text(size = sizet),    legend.title = element_blank(),
        axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank()) + 
  scale_y_continuous(lim = c(100,1050), breaks = seq(100, 1050, 150) ) +
  geom_dl(data =  subset(bd, anio %in% c(1920, 1930, 1940, 1950, 1959, 1972, 1988)), 
          aes(y = nacim / 1000, x = anio, label =      round(nacim / 1000,0)   ),
          list(dl.combine(first.bumpup), cex = 0.75, family = "Helvetica", vjust = -1)) +
  geom_point(data =  
               subset(bd, anio %in% c(1920, 1930, 1940, 1950, 1959, 1972, 1988)), 
             aes(y = nacim / 1000, x = anio), fill = 'white', colour = '#d6604d', size = 4) +
  geom_text(data =  subset(bd, anio %in% c(1970, 1979, 1993, 2010)), 
            aes(y = nacim / 1000, x = anio, label =  round(nacim / 1000,0) , vjust = 2 ,
                family = "Helvetica" ), size = 3 ) +
  geom_point(data =      subset(bd, anio %in% c(1970, 1979, 1993, 2010)), 
             aes(y = nacim / 1000, x = anio), fill = 'white', colour = '#f4a582', size = 4) +
  annotate('rect', xmin = 1968, xmax = 1980, ymin = -Inf, ymax = Inf,    alpha = .1 )  +
  annotate('rect', xmin = 1988, xmax = 1997, ymin = -Inf, ymax = Inf,    alpha = .1 )


cairo_pdf(file = "gr07_col_nacimientos_registrados_1927_2010.pdf",  width = 8, height = 5,
          family = "Helvetica")
print(p)
dev.off() 


# ***CALIDAD CENSOS*** -------------------------------------------------------------


# COL Cobertura Departamental Censos  1985 a 2005 --------------------------------------------------------------------
bd2005 <- read.xlsx2(file = "omision_censal_col.xlsx",  sheetName = "2005")
bd2005 <- bd2005[, c(1:4)]

bd1993 <- read.xlsx2(file = "omision_censal_col.xlsx",  sheetName = "1993")
bd1993 <- bd1993[, c(1,2,3, 6)]
bd1993$cob.1993 <- as.numeric(as.character(bd1993$cob.1993)) * 100

bd1985 <- read.xlsx2(file = "omision_censal_col.xlsx",  sheetName = "1985")
bd1985 <- bd1985[, c(1:4)]

bdr <- join_all(list(bd1985, bd1993, bd2005),   by = c("ID_1", "cod_depto", "Dep") )

bdrm <- melt(bdr, id = c("ID_1", "cod_depto", "Dep") )

bdrm$variable <- gsub("[cob.]","", bdrm$variable)
bdrm$cod_depto <- round(as.numeric(as.character(bdrm$cod_depto)), digits =0)
bdrm$ID_1 <- round(as.numeric(as.character(bdrm$ID_1)), digits =0)

myShapeInR <- readOGR("cescm2Polyvl3.shp", layer = "cescm2Polyvl3", 
                      verbose = TRUE, stringsAsFactors = FALSE)
colsa <- fortify(myShapeInR, region = "ID4")

names(bdrm)[1] <- "id"
bdrm$value <- as.numeric(bdrm$value)

sizet <- 12

p <-  ggplot(bdrm, aes(map_id = id)) + coord_fixed() + 
  geom_map(aes(fill = value, colour = ''), map = colsa, size = .2) + 
  guides(colour = F) + scale_colour_manual(values = '#d9d9d9')+
  expand_limits(x =  colsa$long, y = colsa$lat) +
  scale_fill_gradient(name='Porcentaje', low = "#fed98e",  high = "#006837",
                      guide = "colorbar", breaks = seq(60,100,10) ) +
  geom_segment(aes(x = -79, xend=-79,   y=9.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.7, xend=-77.7,   y=9.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-77.5,   y=10.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -76, xend=-76,   y=10.5, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -79, xend=-77.7,   y=13, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -79, xend=-77.7,   y=9.5, yend = 9.5), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-76,   y=13, yend = 13), colour = '#d9d9d9', size = .2) +
  geom_segment(aes(x = -77.5, xend=-76,   y=10.5, yend = 10.5), colour = '#d9d9d9', size = .2)+
  facet_wrap( ~ variable) + xlab("") + ylab("") +     theme_tufte(base_size = 12) +    
  theme(axis.text = element_blank(), 
        strip.background = element_rect(colour = 'white' , fill="white"), 
        strip.text = element_text(size = sizet, family="Helvetica"),
        panel.grid.minor=element_blank(),  panel.grid.major=element_blank(), 
        legend.text = element_text(size = sizet - 2, family="Helvetica"),
        legend.title = element_text(size = sizet - 2, family="Helvetica", face = 'plain'),
        axis.ticks = element_blank()) + coord_quickmap()

cairo_pdf(file = 
            "MAP07_Col_Tasas_de_Cobertura_Departamental_de_los_Censos_de_Poblacion_y_Vivienda_1985_a_2005.pdf",  
          width = 8, height = 4, family = "Helvetica")
print(p)
dev.off() 


# COL Piramides 1985   -----------
bd <- read.xlsx2("poblacion.edades.simples.censos.xlsx",1)

bd$Hombres <- as.numeric(as.character(bd$Hombres ))
bd$Mujeres <- as.numeric(as.character(bd$Mujeres))
bd$edad <- as.numeric(as.character(bd$edad))

melt.pop <- melt(bd, id= c("Cod.Dep","Dep",  "edad", "anio" ) )

bds <- data.table(melt.pop)

bds <- bds[, den := sum(value) , keyby = list(anio, Cod.Dep, Dep)]
bds$Porcentaje <- bds$value / bds$den
bds <- subset(bds, Dep == 'Colombia')
bds$gen <- as.numeric(as.character(bds$anio)) - bds$edad

sizet <- 9

p2 <- ggplot(subset(bds, anio == '1985'), aes(edad -.2 , fill = variable, group = 1)) +  
  geom_vline( xintercept = seq(0, 100, 5), colour = '#f0f0f0', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.02,.02,.00125),colour = '#f0f0f0', linetype = 'solid') +
  geom_vline( xintercept = seq(0, 100, 10), colour = '#EAEAEA', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.02,.02,.0025),colour = '#EAEAEA', linetype = 'solid') +
  geom_vline( xintercept = seq(0, 100, 20), colour = '#E4E4E4', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.02,.02,.005),colour = '#E4E4E4', linetype = 'solid') +
  geom_histogram(subset = .(variable == "Mujeres"), alpha = .4,
           aes(y = Porcentaje ,  fill = "M"), stat="identity", width = 1 ) +
  geom_histogram(subset = .(variable == "Hombres"), alpha = .4,
           aes(y = Porcentaje* -1, fill = "H" ), stat="identity", width = 1)  +  
  coord_flip() + xlab("") + ylab("") + theme_bw() + 
  scale_x_continuous(limits = c(-1, 101), breaks = seq(0,100, 10), labels = seq(1985, 1885, -10) ) +
  scale_y_continuous(limits = c(-.02, .02), breaks = seq(-.02,.02,.005), 
                     labels = paste0(abs(seq(-.02,.02,.005)) *  100,'%')   ) +
  scale_fill_manual(name= 'Sexo',   values=c("H" = "#377eb8", "M" = "#e41a1c", "white", "white") ) + 
  theme(axis.text.x = element_text(size = sizet , family="Helvetica", colour = 'black'),
        axis.text.y = element_text(size = sizet + .5, family="Helvetica", colour = 'black'),
        panel.grid = element_blank(), 
        plot.title = element_text(size = sizet + 4, family="Helvetica")
  )  + guides(fill = FALSE) 

p1 <- ggplot(subset(bds, anio == '1985'), 
             aes( x = gen +.2, y = Porcentaje, colour = variable, group = 1)) +
  geom_blank(subset = .(variable == "Mujeres"), 
             aes(y = Porcentaje ,  colour = "M"), stat="identity" ) +
  geom_blank(subset = .(variable == "Hombres"), 
             aes(y = Porcentaje* -1, colour = "H" ), stat="identity")  +
  coord_flip() + xlab("") + ylab("") + 
  scale_x_reverse(limits = c(1986, 1884), breaks = seq(1985, 1885, -10), labels = seq(0, 100, 10) )+
  scale_y_continuous(limits = c(-.02, .02), breaks = seq(-.02,.02,.005), 
                     labels = paste0(abs(seq(-.02,.02,.005)) *  100,'%')   ) +
  theme(axis.text.x = element_text(size = sizet, family="Helvetica", colour = 'black'),
        axis.text.y = element_text(size = sizet + .5, family="Helvetica", colour = 'black'),
        panel.grid = element_blank() )+
  guides(fill = FALSE) 

# extract gtable
twet <- function (p1, p2) {
  g1 <- ggplot_gtable(ggplot_build(p1))
  g2 <- ggplot_gtable(ggplot_build(p2))
  
  # overlap the panel of 2nd plot on that of 1st plot
  pp <- c(subset(g1$layout, name == "panel", se = t:r))
  g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t, 
                       pp$l, pp$b, pp$l)
  
  # axis tweaks
  ia <- which(g2$layout$name == "axis-l")
  ga <- g2$grobs[[ia]]
  ax <- ga$children[[2]]
  ax$widths <- rev(ax$widths)
  ax$grobs <- rev(ax$grobs)
  ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
  g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
  g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
}
g1985 <- twet(p1 +   ggtitle('1985'), p2) 


# COL Piramides 1993 cont.   -----------

p2 <- ggplot(subset(bds, anio == '1993'), aes(edad -.2  , fill  = variable, group = 1)) +
  geom_vline( xintercept = seq(0, 100, 5), colour = '#f0f0f0', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.02,.02,.00125),colour = '#f0f0f0', linetype = 'solid') +
  geom_vline( xintercept = seq(0, 100, 10), colour = '#EAEAEA', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.02,.02,.0025),colour = '#EAEAEA', linetype = 'solid') +
  geom_vline( xintercept = seq(0, 100, 20), colour = '#E4E4E4', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.02,.02,.005),colour = '#E4E4E4', linetype = 'solid') +
  geom_histogram(subset = .(variable == "Mujeres"), alpha = .4,
           aes(y = Porcentaje ,  fill  = "M"), stat="identity" , width = 1 ) +
  geom_histogram(subset = .(variable == "Hombres"), alpha = .4,
           aes(y = Porcentaje* -1, fill = "H" ), stat="identity", width = 1 )  +
  coord_flip() + xlab("") + ylab("") + theme_bw() + 
  scale_x_continuous(limits = c(-1,101), breaks = abs(seq(0, 100, 10)), 
                     labels = seq(1993, 1893, -10) ) +
  scale_y_continuous(limits = c(-.02, .02), breaks = seq(-.02, .02, .005), minor_breaks = seq(-.02, .02, .005),
                     labels = paste0(abs(seq(-.02,.02,.005)) *  100,'%')   ) +
  scale_fill_manual(name= 'Sexo',   values=c("H" = "#377eb8", "M" = "#e41a1c") ) + 
  theme(axis.text.x = element_text(size = sizet , family="Helvetica", colour = 'black'),
        axis.text.y = element_text(size = sizet + .5, family="Helvetica", colour = 'black'),
        panel.grid = element_blank()
  )  + guides(fill = FALSE) 


g1993 <- twet(p1 + ggtitle('1993'), p2 ) 


# COL Piramides 2005 cont.  -----------

grid.newpage()

p2 <- ggplot(subset(bds, anio == '2005'), aes(edad -.2  , fill = variable, group = 1)) +
  geom_vline( xintercept = seq(0, 100, 5), colour = '#f0f0f0', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.02,.02,.00125),colour = '#f0f0f0', linetype = 'solid') +
  geom_vline( xintercept = seq(0, 100, 10), colour = '#EAEAEA', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.02,.02,.0025),colour = '#EAEAEA', linetype = 'solid') +
  geom_vline( xintercept = seq(0, 100, 20), colour = '#E4E4E4', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.02,.02,.005),colour = '#E4E4E4', linetype = 'solid') +
  geom_histogram(subset = .(variable == "Mujeres"),  alpha = .4,
           aes(y = Porcentaje ,  fill = "M"), stat="identity", width = 1  ) +
  geom_histogram(subset = .(variable == "Hombres"),  alpha = .4,
           aes(y = Porcentaje* -1, fill = "H" ), stat="identity", width = 1 )  +
  coord_flip() + xlab("") + ylab("") + theme_bw() + 
  scale_x_continuous(limits = c(-1,101), breaks = seq(0, 100, 10) , labels =seq(2005, 1905, -10) ,
                     minor_breaks = seq(0, 100, 10)) +
  scale_y_continuous(limits = c(-.02, .02), breaks = seq(-.02,.02,.005), minor_breaks = seq(-.02,.02,.005),
                     labels = paste0(abs(seq(-.02,.02,.005)) *  100,'%')   ) +
  scale_fill_manual(name= 'Sexo',   values=c("H" = "#377eb8", "M" = "#e41a1c") ) + 
  theme(axis.text.x = element_text(size = sizet , family="Helvetica", colour = 'black'),
        axis.text.y = element_text(size = sizet + .5, family="Helvetica", colour = 'black'),
          panel.grid = element_blank()
  )  + guides(fill = FALSE) 


g2005 <- twet(p1 +   ggtitle('2005'), p2) 


# COL Piramides 1973 cont.  -----------

p2 <- ggplot(subset(bds, anio == '1973'), aes(edad -.2 , fill  = variable, group = 1))+
  geom_vline( xintercept = seq(0, 100, 5), colour = '#f0f0f0', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.02,.02,.00125),colour = '#f0f0f0', linetype = 'solid') +
  geom_vline( xintercept = seq(0, 100, 10), colour = '#EAEAEA', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.02,.02,.0025),colour = '#EAEAEA', linetype = 'solid') +
  geom_vline( xintercept = seq(0, 100, 20), colour = '#E4E4E4', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.02,.02,.005),colour = '#E4E4E4', linetype = 'solid') +
  geom_histogram(subset = .(variable == "Mujeres"),  alpha = .4,
           aes(y = Porcentaje ,  fill  = "M"), stat="identity" , width = 1 ) +
  geom_histogram(subset = .(variable == "Hombres"),  alpha = .4,
           aes(y = Porcentaje* -1, fill = "H" ), stat="identity", width = 1 )  +
  coord_flip() + xlab("") + ylab("") + theme_bw() + 
  scale_x_continuous(limits = c(-1,101), breaks = abs(seq(0, 100, 10)), 
                     labels = seq(1973, 1873, -10)) +
  scale_y_continuous(limits = c(-.02, .02), breaks = seq(-.02,.02,.005), minor_breaks = seq(-.02,.02,.005),
                     labels = paste0(abs(seq(-.02,.02,.005)) *  100,'%')   ) +
  scale_fill_manual(name= 'Sexo',   values=c( "H" = "#377eb8", "M" = "#e41a1c") ) + 
  theme(axis.text.x = element_text(size = sizet , family="Helvetica", colour = 'black'),
        axis.text.y = element_text(size = sizet + .5, family="Helvetica", colour = 'black'),
        panel.grid = element_blank()
  )  + guides(fill = FALSE) 

g1973 <- twet(p1 +   ggtitle('1973'), p2) 


# COL Piramides 1964 cont.  -----------


p2 <- ggplot(subset(bds, anio == '1964'), aes(edad -.2 , fill  = variable, group = 1))+
  geom_vline( xintercept = seq(0, 100, 5), colour = '#f0f0f0', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.02,.02,.00125),colour = '#f0f0f0', linetype = 'solid') +
  geom_vline( xintercept = seq(0, 100, 10), colour = '#EAEAEA', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.02,.02,.0025),colour = '#EAEAEA', linetype = 'solid') +
  geom_vline( xintercept = seq(0, 100, 20), colour = '#E4E4E4', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.02,.02,.005),colour = '#E4E4E4', linetype = 'solid') +
  geom_histogram(subset = .(variable == "Mujeres"),  alpha = .4,
           aes(y = Porcentaje ,  fill  = "M"), stat="identity" , width = 1 ) +
  geom_histogram(subset = .(variable == "Hombres"),  alpha = .4,
           aes(y = Porcentaje* -1, fill = "H" ), stat="identity", width = 1 )  +
  coord_flip() + xlab("") + ylab("") + theme_bw() + 
  scale_x_continuous(limits = c(-1,101), breaks = abs(seq(0, 100, 10)), 
                     labels = seq(1964, 1864, -10)) + 
  scale_y_continuous(limits = c(-.02, .02), breaks = seq(-.02,.02,.005), minor_breaks = seq(-.02,.02,.005),
                     labels = paste0(abs(seq(-.02,.02,.005)) *  100,'%')   ) +
  scale_fill_manual(name= 'Sexo',   values=c("H" = "#377eb8", "M" = "#e41a1c") ) + 
  theme(axis.text.x = element_text(size = sizet , family="Helvetica", colour = 'black'),
        axis.text.y = element_text(size = sizet + .5, family="Helvetica", colour = 'black'),
        panel.grid = element_blank()   )  + guides(fill = FALSE) 

g1964 <- twet(p1+   ggtitle('1964'), p2) 


grid.newpage()
cairo_pdf(file = "pirs2.pdf",  width = 8,  height = 10,     family = "Helvetica", antialias = "none")
print(grid.arrange(g1964, g1973, g1985, g1993, g2005,  ncol = 2))
dev.off() 


grid.newpage()
png(file = "prs2b.png", width = 2430, height = 3150, pointsize = 8, type = 'cairo', res = 300)
print(grid.arrange(g1964, g1973, g1985, g1993, g2005, ncol = 2   ))
dev.off()

# COL Piramides edad agrupadas   -------------
# 1985
bd <- read.xlsx2("pob.cen.gq.col.v4.xlsx",1)

melt.pop <- melt(bd, id= c("Cod.Dep","Dep", "Edad.Grup"))

# identificar hombres y mujeres y volver factor
indh <- grep("Hom",as.character(melt.pop$variable))
melt.pop$sexo <- 2;    melt.pop[indh, c("sexo")] <-1

melt.pop$sexo <- factor(  melt.pop$sexo,   levels=c (1, 2),    labels=c ("H", "M") )

# identificar a?os
melt.pop$anio <- substring(melt.pop$variable,9,12)
melt.pop <- data.table(melt.pop)
melt.pop$value <- as.numeric(as.character(melt.pop$value))

bds <- melt.pop[, den :=sum(value) , keyby = list(anio, Cod.Dep)]
bds$Porcentaje <- bds$value / bds$den

a <- seq(1985, 1900, -5)
b <- a -4
lab <- paste0(b, ' - ', a)
lab[18] <-  ''

d <- seq(0, 85, 5)
e <- d + 4
lab2 <- paste0(d, ' - ', e)
lab2[18] <-  ''

p1985 <- ggplot(subset (bds, anio == 1985), 
             aes(x = as.numeric(Edad.Grup) +.5  , fill = sexo, group = 1)) +
  geom_vline( xintercept = seq(1, 18, 1), colour = '#f0f0f0', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.08,.08,.005),colour = '#f0f0f0', linetype = 'solid') +
  geom_vline( xintercept = seq(1, 18, 2), colour = '#EAEAEA', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.08,.08,.01),colour = '#EAEAEA', linetype = 'solid') +
  geom_vline( xintercept = seq(1, 18, 4), colour = '#E4E4E4', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.08,.08,.02),colour = '#E4E4E4', linetype = 'solid') +
  geom_histogram(subset = .(sexo == "M"), aes(y = Porcentaje ,  fill = "M"), alpha = .4,
           stat="identity", width = 1, binwidth = 1 ) +
  geom_histogram(subset = .(sexo == "H"), aes(y = Porcentaje* -1,   fill = "H" ), alpha = .4,
           stat="identity", width = 1, binwidth = 1)  +
  scale_fill_manual(name= 'Sexo',   values=c("H" = "#377eb8", "M" = "#e41a1c") ) + 
  coord_flip() + xlab("") + ylab("") + theme_bw() + 
  scale_x_continuous(lim = c(.5, 18), breaks = unique(as.numeric(bds$Edad.Grup)),    labels = lab2 )+
  scale_y_continuous(limits = c(-.09, .09), breaks = seq(-.08,.08,.02),
                     labels = paste0( c(0.08, 0.06, 0.04, 0.02, 0, 0.02, 0.04, 0.06, 0.08) * 100, '%') )+
  theme(axis.text.y = element_text(size = 9, family="Helvetica", colour = 'black', vjust = -.2),
        axis.text.x = element_text(size = 9, family="Helvetica", colour = 'black'), 
        panel.grid = element_blank() ) + 
  guides(fill = FALSE, colour = F) +
  ggtitle('1985') 

# 1993
a <- seq(1993, 1993 - 85, -5)
b <- a -4
lab <- paste0(b, ' - ', a)
lab[18] <-  ''

d <- seq(0, 85, 5)
e <- d + 4
lab2 <- paste0(d, ' - ', e)
lab2[18] <-  ''

p1993 <- ggplot(subset (bds, anio == 1993), 
             aes(x = as.numeric(Edad.Grup) +.5  , fill = sexo, group = 1)) +
  geom_vline( xintercept = seq(1, 18, 1), colour = '#f0f0f0', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.08,.08,.005),colour = '#f0f0f0', linetype = 'solid') +
  geom_vline( xintercept = seq(1, 18, 2), colour = '#EAEAEA', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.08,.08,.01),colour = '#EAEAEA', linetype = 'solid') +
  geom_vline( xintercept = seq(1, 18, 4), colour = '#E4E4E4', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.08,.08,.02),colour = '#E4E4E4', linetype = 'solid') +
  geom_histogram(subset = .(sexo == "M"), aes(y = Porcentaje ,  fill = "M"), alpha = .4,
           stat="identity", width = 1 ) +
  geom_histogram(subset = .(sexo == "H"), aes(y = Porcentaje* -1,   fill = "H" ),  alpha = .4,
           stat="identity", width = 1 ) +
  coord_flip() + xlab("") + ylab("") + theme_bw() + 
  scale_fill_manual(name= 'Sexo',   values=c("H" = "#377eb8", "M" = "#e41a1c") ) +
  scale_x_continuous(lim = c(.5, 18), breaks = unique(as.numeric(bds$Edad.Grup)), 
                     labels = lab2 )+
  scale_y_continuous(limits = c(-.09, .09), breaks = seq(-.08,.08,.02),
                     labels = paste0(  c(0.08, 0.06, 0.04, 0.02, 0, 0.02, 0.04, 0.06, 0.08) * 100, '%') )+
  theme(axis.text.y = element_text(size = 9, family="Helvetica", colour = 'black', vjust = -.2),
        axis.text.x = element_text(size = 9, family="Helvetica", colour = 'black'), 
        axis.title.x = element_text(size = 9, family="Helvetica"),
        axis.title.y = element_text(size = 9, family="Helvetica"),
        axis.ticks = element_line(colour = 'black')       )  + guides(fill = FALSE, colour = F) +
  ggtitle('1993')

# 2005
a <- seq(2005, 2005 - 85, -5)
b <- a -4
lab <- paste0(b, ' - ', a)
lab[18] <-  ''

d <- seq(0, 85, 5)
e <- d + 4
lab2 <- paste0(d, ' - ', e)
lab2[18] <-  ''

p2005 <- ggplot(subset (bds, anio == 2005), 
             aes(x = as.numeric(Edad.Grup) +.5  , fill = sexo, group = 1)) +
  geom_vline( xintercept = seq(1, 18, 1), colour = '#f0f0f0', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.08,.08,.005),colour = '#f0f0f0', linetype = 'solid') +
  geom_vline( xintercept = seq(1, 18, 2), colour = '#EAEAEA', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.08,.08,.01),colour = '#EAEAEA', linetype = 'solid') +
  geom_vline( xintercept = seq(1, 18, 4), colour = '#E4E4E4', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.08,.08,.02),colour = '#E4E4E4', linetype = 'solid') +
  geom_histogram(subset = .(sexo == "M"), aes(y = Porcentaje ,  fill = "M"),  alpha = .4,
           stat="identity", width = 1 ) +
  geom_histogram(subset = .(sexo == "H"), aes(y = Porcentaje* -1,   fill = "H" ),  alpha = .4,
           stat="identity", width = 1 ) +
  coord_flip() + xlab("") + ylab("") + theme_bw() + 
  scale_fill_manual(name= 'Sexo',   values=c("H" = "#377eb8", "M" = "#e41a1c") ) + 
  scale_x_continuous(lim = c(.5, 18), breaks = unique(as.numeric(bds$Edad.Grup)), 
                     labels = lab2 )+
  scale_y_continuous(limits = c(-.09, .09), breaks = seq(-.08,.08,.02),
                     labels = paste0(  c(0.08, 0.06, 0.04, 0.02, 0, 0.02, 0.04, 0.06, 0.08) * 100, '%') )+
  theme(axis.text.y = element_text(size = 9, family="Helvetica", colour = 'black', vjust = -.2),
        axis.text.x = element_text(size = 9, family="Helvetica", colour = 'black'), 
        axis.title.x = element_text(size = 9, family="Helvetica"),
        axis.title.y = element_text(size = 9, family="Helvetica") ) + guides(fill = FALSE, colour = F) +
  ggtitle('2005')


#73
d <- seq(0, 85, 5)
e <- d + 4
lab2 <- paste0(d, ' - ', e)
lab2[18] <-  ''

p1973 <- ggplot(subset (bds, anio == 1973), 
             aes(x = as.numeric(Edad.Grup) +.5  , fill = sexo, group = 1)) +
  geom_vline( xintercept = seq(1, 18, 1), colour = '#f0f0f0', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.08,.08,.005),colour = '#f0f0f0', linetype = 'solid') +
  geom_vline( xintercept = seq(1, 18, 2), colour = '#EAEAEA', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.08,.08,.01),colour = '#EAEAEA', linetype = 'solid') +
  geom_vline( xintercept = seq(1, 18, 4), colour = '#E4E4E4', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.08,.08,.02),colour = '#E4E4E4', linetype = 'solid') +
  geom_histogram(subset = .(sexo == "M"), aes(y = Porcentaje ,  fill = "M"),  alpha = .4,
           stat="identity", width = 1 ) +
  geom_histogram(subset = .(sexo == "H"), aes(y = Porcentaje* -1,   fill = "H" ),  alpha = .4,
           stat="identity", width = 1 ) +
  coord_flip() + xlab("") + ylab("") + theme_bw() + 
  scale_fill_manual(name= 'Sexo',   values=c("H" = "#377eb8", "M" = "#e41a1c") ) +
  scale_x_continuous(lim = c(.5, 18), breaks = unique(as.numeric(bds$Edad.Grup)), 
                     labels = lab2 ) +
  scale_y_continuous(limits = c(-.09, .09), breaks = seq(-.08,.08,.02),
                     labels = paste0( c(0.08, 0.06, 0.04, 0.02, 0, 0.02, 0.04, 0.06, 0.08) * 100, '%') ) +
  theme(axis.text.y = element_text(size = 9, family="Helvetica", colour = 'black', vjust = -.2),
        axis.text.x = element_text(size = 9, family="Helvetica", colour = 'black'), 
        axis.title.x = element_text(size = 9, family="Helvetica"),
        axis.title.y = element_text(size = 9, family="Helvetica"),
        axis.ticks = element_line(colour = 'black')  ) + guides(fill = FALSE, colour = F) +
  ggtitle('1973')


#64
d <- seq(0, 85, 5)
e <- d + 4
lab2 <- paste0(d, ' - ', e)
lab2[18] <-  ''

p1964 <- ggplot(subset (bds, anio == 1964), 
             aes(x = as.numeric(Edad.Grup) +.5  , fill = sexo, group = 1)) +
  geom_vline( xintercept = seq(1, 18, 1), colour = '#f0f0f0', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.08,.08,.005),colour = '#f0f0f0', linetype = 'solid') +
  geom_vline( xintercept = seq(1, 18, 2), colour = '#EAEAEA', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.08,.08,.01),colour = '#EAEAEA', linetype = 'solid') +
  geom_vline( xintercept = seq(1, 18, 4), colour = '#E4E4E4', linetype = 'solid') +  
  geom_hline(yintercept = seq(-.08,.08,.02),colour = '#E4E4E4', linetype = 'solid') +
  geom_histogram(subset = .(sexo == "M"), aes(y = Porcentaje ,  fill = "M"),  alpha = .4,
           stat="identity", width = 1 ) +
  geom_histogram(subset = .(sexo == "H"), aes(y = Porcentaje* -1,   fill = "H" ),  alpha = .4,
           stat="identity", width = 1 ) +
  coord_flip() + xlab("") + ylab("") + theme_bw() + 
  scale_fill_manual(name= 'Sexo',   values=c("H" = "#377eb8", "M" = "#e41a1c") ) +
  scale_x_continuous(lim = c(.5, 18), breaks = unique(as.numeric(bds$Edad.Grup)), 
                     labels = lab2 )+
  scale_y_continuous(limits = c(-.09, .09), breaks = seq(-.08,.08,.02),
                     labels = paste0( c(0.08, 0.06, 0.04, 0.02, 0, 0.02, 0.04, 0.06, 0.08) * 100, '%') )+
  theme(axis.text.y = element_text(size = 9, family="Helvetica", colour = 'black', vjust = -.2),
        axis.text.x = element_text(size = 9, family="Helvetica", colour = 'black'), 
        axis.title.x = element_text(size = 9, family="Helvetica"),
        axis.title.y = element_text(size = 9, family="Helvetica"),
        axis.ticks = element_line(colour = 'black') ) + guides(fill = FALSE, colour = F) +
  ggtitle('1964')


# draw it
grid.newpage()
cairo_pdf(file = "GR10_COL_estructura_poblacion_edad_agrupadas_censo_8505.pdf",  
    width = 8,  height = 10, family = "Helvetica", antialias = "none")
print(grid.arrange(p1964, p1973, p1985, p1993, p2005, ncol = 2))
dev.off()



# draw it
grid.newpage()
png(file = "prestruccol.png", width = 2430, height = 3150, pointsize = 8, type = 'cairo', res = 300)
print(grid.arrange(p1964, p1973, p1985, p1993, p2005, ncol = 2   ))
dev.off()

# library(Cairo)
# 
# grid.newpage()
# CairoPDF(file = "GR10_COL_estructura_poblacion_edad_agrupadas_censo_8505.pdf",  
#           width = 8,  height = 10, family = "Helvetica")
# print(grid.arrange(p1964, p1973, p1985, p1993, p2005, ncol = 2))
# dev.off()

# # *** COL Indicadores Evaluar estructura censal *** ------------------------------------------------------

# # COL Masculinidad edad -----------------------------------------------------

pop <- read.xlsx2 (file ="pob.cen.gq.col.v4.xlsx", sheetName="f1")
melt.pop <- melt(pop, id= c("Cod.Dep","Dep", "Edad.Grup"))

indh <- grep("Hom",as.character(melt.pop$variable))
melt.pop$sexo <- 2;    melt.pop[indh, c("sexo")] <- 1
melt.pop$sexo <- factor(  melt.pop$sexo,  levels=c (1, 2),    labels=c ("Hombres", "Mujeres") )

melt.pop$anio <- substring(melt.pop$variable,9,12)
melt.pop$value <- as.numeric(as.character(melt.pop$value))

masc <- dcast(melt.pop, Dep + anio + Edad.Grup ~ sexo, value.var ="value",   fun.aggregate = sum)
masc$ind <- masc$Hombres / masc$Mujeres

masc <- subset(masc, anio %in% c(1985, 1993, 2005))
masc <- subset(masc, Edad.Grup != "85 y más")

masc$Edad.Grup <- factor( masc$Edad.Grup, levels = c(" 0 -  4", " 5 -  9", "10 - 14", "15 - 19", "20 - 24", "25 - 29", 
                                                     "30 - 34", "35 - 39", "40 - 44", "45 - 49", "50 - 54", "55 - 59", 
                                                     "60 - 64", "65 - 69", "70 - 74", "75 - 79", "80 - 84", "85 y más"
), labels = c(" 0 -  4  ", " 5 -  9  ", "10 - 14  ", "15 - 19  ", "20 - 24  ", "25 - 29  ", 
              "30 - 34  ", "35 - 39  ", "40 - 44  ", "45 - 49  ", "50 - 54  ", "55 - 59  ", 
              "60 - 64  ", "65 - 69  ", "70 - 74  ", "75 - 79  ", "80 - 84  ", "85 y más  "   ) )


p1 <- ggplot(masc, aes(as.numeric(Edad.Grup) + .5 , y = ind, colour = anio,
                       size = anio,linetype = anio) ) +
  geom_vline(xintercept = seq(1, 18, 1), colour = '#f0f0f0', linetype = '22') + 
  geom_hline(yintercept = seq(0.2, 1.1, .1), colour = '#f0f0f0', linetype = '22') +
  geom_vline(xintercept = seq(1, 18, 2), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = seq(0.2, 1.1, .2), colour = '#E4E4E4', linetype = '22') +
  geom_line(alpha = .9) + theme_bw(base_size = 10) +
  scale_colour_manual(values =c('#e31a1c', '#fb9a99' ,'#1f78b4'),
                      guide = guide_legend(direction = 'vertical',keywidth = 2) 
  ) + scale_size_manual(values = c(1.6, 1.6, 1.6), 
                        guide = guide_legend(direction = 'vertical',keywidth = 2)  ) +
  scale_linetype_manual(values = c('solid','solid','solid'),
                        guide = guide_legend(direction = 'vertical', keywidth = 2) )+
  scale_x_discrete( breaks = 1:18 , labels = c(levels(masc$Edad.Grup)[1:17], ''),
                    expand = c(0.05, 0.05) ) + 
  scale_y_continuous(limits = c(0.6, 1.1), breaks = seq(0.2, 1.3, .1)) +
  theme(axis.text.x = element_text(size = 10, family="Helvetica", vjust = 1.1, angle = 90),
        axis.title.y = element_text(size = 10, family="Helvetica", vjust = 0.9), 
        axis.title.x=element_text(size = 10, family="Helvetica", vjust=0.5),
        axis.text.y = element_text(size = 10, family="Helvetica"),
        legend.text = element_text(size = 10, family="Helvetica"),
        title = element_text(size = 10, family="Helvetica") ,
        panel.grid = element_blank()) +  
  xlab("Edad") + ylab("Razón de \n masculinidad") + 
  theme(legend.title=element_blank(), legend.position = c(0.2,0.35)) + 
  ggtitle("a. Indice de Masculinidad por Edad") 


# # COL Indice masculinidad generacion ------------------------------------

pop <- read.xlsx2 (file ="pob.cen.gq.col.v4.xlsx", sheetName="f1")
melt.pop <- melt(pop, id= c("Cod.Dep","Dep", "Edad.Grup"))

indh <- grep("Hom",as.character(melt.pop$variable))
melt.pop$sexo <- 2;    melt.pop[indh, c("sexo")] <-1
melt.pop$sexo <- factor(  melt.pop$sexo,  levels=c (1, 2),    labels=c ("Hombres", "Mujeres") )

melt.pop$anio <- substring(melt.pop$variable,9,12)
melt.pop$value <- as.numeric(as.character(melt.pop$value))

masc <- dcast(melt.pop, Dep + anio + Edad.Grup ~ sexo, value.var ="value",   fun.aggregate = sum)
masc$ind <- masc$Hombres / masc$Mujeres

masc <- subset(masc, anio %in% c(1985,  2005))

masc <- subset(masc, Edad.Grup != "85 y más")

masc$clasep <- factor(masc$Edad.Grup, levels = c(" 0 -  4", " 5 -  9", "10 - 14", "15 - 19", 
                                                 "20 - 24", "25 - 29", 
                                                 "30 - 34", "35 - 39", "40 - 44", 
                                                 "45 - 49", "50 - 54", "55 - 59", 
                                                 "60 - 64", "65 - 69", "70 - 74", 
                                                 "75 - 79", "80 - 84" ),
                      labels = seq(2.5, 82.5, 5) )
masc$clasep <- as.numeric(as.character(masc$clasep))

masc$gen <- as.numeric(masc$anio) - masc$clasep


a <- seq(2005, 2005 - 100, -5);  b <- a -4; c <- str_sub(a, start = 3, end = 4)
lab <- paste0(b, '/', c, " ");     dput(rev(lab))

masc$gen <- factor(masc$gen, levels = rev(c(seq(1902.5, 2002.5, 5))), 
                   labels = rev(c("1901 / 05 ", "1906 / 10 ", "1911 / 15 ", "1916 / 20 ", "1921 / 25 ", 
                                  "1926 / 30 ", "1931 / 35 ", "1936 / 40 ", "1941 / 45 ", "1946 / 50 ", "1951 / 55 ", 
                                  "1956 / 60 ", "1961 / 65 ", "1966 / 70 ", "1971 / 75 ", "1976 / 80 ", "1981 / 85 ", 
                                  "1986 / 90 ", "1991 / 95 ", "1996 / 00 ", "2001 / 05 ")  ) )

p2 <- ggplot(masc, aes(ind, as.numeric(gen) + .5) ) + 
  geom_vline(xintercept = seq(0.4, 1.1, .1), colour = '#f0f0f0', linetype = '22') + 
  geom_hline(yintercept =seq(1, 21, 1), colour = '#f0f0f0', linetype = '22') +
  geom_vline(xintercept = seq(0.4, 1.1, .2), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = seq(2, 21, 2), colour = '#E4E4E4', linetype = '22') +
  theme_bw(base_size = 10) + 
  geom_line(aes(group = gen), colour = '#969696') + 
  geom_path(aes(group = anio, colour = anio, linetype = anio), alpha = .9, size = 1.6) +
  
  scale_colour_manual(name = '', limits = c( 1985, 2005), 
                      values = c( '#e31a1c', '#1f78b4'),  
                      guide = guide_legend(direction = 'vertical', keywidth = 2)) +
  ylab('Generación') + coord_flip() +
  scale_x_continuous(name = 'Razón de \n Masculinidad', 
                     limits = c(0.6, 1.1) , breaks = seq(0.4, 1.1, .1) ) +
  scale_y_continuous(limits = c(1, 21), breaks = 1:21, labels = levels(masc$gen) ) +
  scale_linetype_manual(name = '', values = c('solid','solid'), 
                        guide = guide_legend(direction = 'vertical', keywidth = 2)) +
  theme(legend.position = c(.2,.35) ) + 
  theme(axis.text.x = element_text(size = 10, family = "Helvetica",vjust = 1, angle = 90),
        axis.text.y = element_text(size = 10, family="Helvetica"),  
        axis.title.x = element_text(size = 10, family="Helvetica"),
        axis.title.y = element_text(size = 10, family="Helvetica"),
        legend.text = element_text(size = 10, family="Helvetica")  ,
        panel.grid = element_blank() ) +   ggtitle('b. Indice de Masculinidad por generación')


# # COL Hombres Razones de edades -----------------------------------------


pop <- read.xlsx2 (  file ="pob.cen.gq.col.v4.xlsx", , sheetName="f1")
melt.pop <- melt(pop, id= c("Cod.Dep","Dep", "Edad.Grup"))

indh <- grep("Hom",as.character(melt.pop$variable))
melt.pop$sexo <- 2;    melt.pop[indh, c("sexo")] <-1

melt.pop$sexo <- factor(  melt.pop$sexo,   levels=c (1, 2),    labels=c ("Hombres", "Mujeres") )
melt.pop$anio <- substring(melt.pop$variable,9,12)
melt.pop <- melt.pop[order(melt.pop$Dep, melt.pop$sexo, melt.pop$anio, melt.pop$Edad.Grup),]
melt.pop$value <- as.numeric(as.character(melt.pop$value))

ar <- ddply(  melt.pop, .(Dep, sexo, anio),  transform,
              valueant = c(NA,value[1:length(value)-1]) , 
              valuepos = c(value[2:length(value)], NA)   )

ar$ager <- 2 * ar$value / (ar$valueant + ar$valuepos)
ar <- subset(ar, anio %in% c(1985, 1993, 2005) & sexo == 'Hombres')

ar <- na.omit(ar)

ar$clasep <- factor(ar$Edad.Grup, levels = c(" 0 -  4", " 5 -  9", "10 - 14", "15 - 19", 
                                             "20 - 24", "25 - 29", 
                                             "30 - 34", "35 - 39", "40 - 44", 
                                             "45 - 49", "50 - 54", "55 - 59", 
                                             "60 - 64", "65 - 69", "70 - 74", 
                                             "75 - 79", "80 - 84" ),
                    labels = seq(2.5, 82.5, 5) )
ar$clasep <- as.numeric(as.character(ar$clasep))

ar$gen <- as.numeric(ar$anio) - ar$clasep


melt.pop$Edad.Grup <- factor( melt.pop$Edad.Grup, levels = c(" 0 -  4", " 5 -  9", "10 - 14", "15 - 19", "20 - 24", "25 - 29", 
                                                             "30 - 34", "35 - 39", "40 - 44", "45 - 49", "50 - 54", "55 - 59", 
                                                             "60 - 64", "65 - 69", "70 - 74", "75 - 79", "80 - 84", "85 y más"
), labels = c(" 0 -  4  ", " 5 -  9  ", "10 - 14  ", "15 - 19  ", "20 - 24  ", "25 - 29  ", 
              "30 - 34  ", "35 - 39  ", "40 - 44  ", "45 - 49  ", "50 - 54  ", "55 - 59  ", 
              "60 - 64  ", "65 - 69  ", "70 - 74  ", "75 - 79  ", "80 - 84  ", "85 y más  "
) )

p4 <- ggplot(  data = ar , aes(x = as.numeric(Edad.Grup)-.5 , y = ager,  colour = anio, 
                               size = anio, linetype = anio, group = anio ) ) +
  geom_vline(xintercept = seq(1, 17, 1), colour = '#f0f0f0', linetype = '22') + 
  geom_hline(yintercept = seq(0, 1.2, .1), colour = '#f0f0f0', linetype = '22') +
  geom_vline(xintercept = seq(2, 17, 2), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = seq(0, 1.2, .2), colour = '#E4E4E4', linetype = '22') +
  geom_line( alpha = .9)  +   theme_bw(base_size = 10) + 
  scale_x_discrete(breaks=2:17 , labels = levels(melt.pop$Edad.Grup)[2:17]  )  +
  scale_colour_manual(values = c('#e31a1c', '#fb9a99' ,'#1f78b4') ,
                      guide = guide_legend(direction = 'vertical',keywidth = 2) ) +
  scale_size_manual(values = seq(1.2,1.6,0.2) ,
                    guide = guide_legend(direction = 'vertical',keywidth = 2) ) +
  scale_linetype_manual(values = c('solid','solid','solid'),
                        guide = guide_legend(direction = 'vertical',keywidth = 2) )+
  xlab("Edad") + ylab("Razón de \n edades") + 
  scale_y_continuous(lim = c(0.3, 1.25),    breaks = seq(0, 1.2, .1) ) +
  theme(axis.text.x = element_text(size = 10, family = "Helvetica", vjust = -.6, angle = 90),
        axis.text.y = element_text(size = 10, family = "Helvetica"),
        legend.text = element_text(size = 10, family = "Helvetica"),
        legend.title = element_blank(),
        legend.position = c(0.2,0.35), panel.margin = unit(2, "lines") ,
        axis.title.y=element_text(size = 10, family = "Helvetica", vjust=0.9), 
        axis.title.x=element_text(size = 10, family = "Helvetica", vjust=0.1),
        panel.grid = element_blank() ) +
  ggtitle("c. Razón de edades. Hombres")


# # COL Mujeres  Razones de edades ----------------------------------------



pop <- read.xlsx2 (  file ="pob.cen.gq.col.v4.xlsx", , sheetName="f1")
melt.pop <- melt(pop, id= c("Cod.Dep","Dep", "Edad.Grup"))

indh <- grep("Hom",as.character(melt.pop$variable))
melt.pop$sexo <- 2;    melt.pop[indh, c("sexo")] <-1

melt.pop$sexo <- factor(  melt.pop$sexo,   levels=c (1, 2),    labels=c ("Hombres", "Mujeres") )
melt.pop$anio <- substring(melt.pop$variable,9,12)
melt.pop <- melt.pop[order(melt.pop$Dep, melt.pop$sexo, melt.pop$anio, melt.pop$Edad.Grup),]
melt.pop$value <- as.numeric(as.character(melt.pop$value))

ar <- ddply(  melt.pop, .(Dep, sexo, anio),  transform,
              valueant = c(NA,value[1:length(value)-1]) , 
              valuepos = c(value[2:length(value)], NA)   )

ar$ager <- 2 * ar$value / (ar$valueant + ar$valuepos)
ar <- subset(ar, anio %in% c(1985, 1993, 2005) & sexo == 'Mujeres')

ar <- na.omit(ar)

ar$clasep <- factor(ar$Edad.Grup, levels = c(" 0 -  4", " 5 -  9", "10 - 14", "15 - 19", 
                                             "20 - 24", "25 - 29", 
                                             "30 - 34", "35 - 39", "40 - 44", 
                                             "45 - 49", "50 - 54", "55 - 59", 
                                             "60 - 64", "65 - 69", "70 - 74", 
                                             "75 - 79", "80 - 84" ),
                    labels = seq(2.5, 82.5, 5) )
ar$clasep <- as.numeric(as.character(ar$clasep))

ar$gen <- as.numeric(ar$anio) - ar$clasep

melt.pop$Edad.Grup <- factor( melt.pop$Edad.Grup, levels = c(" 0 -  4", " 5 -  9", "10 - 14", "15 - 19", "20 - 24", "25 - 29", 
                                                             "30 - 34", "35 - 39", "40 - 44", "45 - 49", "50 - 54", "55 - 59", 
                                                             "60 - 64", "65 - 69", "70 - 74", "75 - 79", "80 - 84", "85 y más"
), labels = c(" 0 -  4  ", " 5 -  9  ", "10 - 14  ", "15 - 19  ", "20 - 24  ", "25 - 29  ", 
              "30 - 34  ", "35 - 39  ", "40 - 44  ", "45 - 49  ", "50 - 54  ", "55 - 59  ", 
              "60 - 64  ", "65 - 69  ", "70 - 74  ", "75 - 79  ", "80 - 84  ", "85 y más  "
) )

p5 <- ggplot(  data = ar , aes(x = as.numeric(Edad.Grup)-.5 , y = ager,  colour = anio, 
                               size = anio, linetype = anio, group = anio ) ) +
  geom_vline(xintercept = seq(1, 17, 1), colour = '#f0f0f0', linetype = '22') + 
  geom_hline(yintercept = seq(0, 1.2, .1), colour = '#f0f0f0', linetype = '22') +
  geom_vline(xintercept = seq(2, 17, 2), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = seq(0, 1.2, .2), colour = '#E4E4E4', linetype = '22') +
  geom_line( alpha = .9)  +   theme_bw(base_size = 10) + 
  scale_x_discrete(breaks=2:17 , labels = levels(melt.pop$Edad.Grup)[2:17]  )  +
  scale_colour_manual(values = c('#e31a1c', '#fb9a99' ,'#1f78b4') ,
                      guide = guide_legend(direction = 'vertical',keywidth = 2) ) +
  scale_size_manual(values = seq(1.2,1.6,0.2) ,
                    guide = guide_legend(direction = 'vertical',keywidth = 2) ) +
  scale_linetype_manual(values = c('solid','solid','solid'),
                        guide = guide_legend(direction = 'vertical',keywidth = 2) )+
  xlab("Edad") + ylab("Razón de \n edades") + 
  scale_y_continuous(lim = c(0.3, 1.25),    breaks = seq(0, 1.2, .1) ) +
  theme(axis.text.x = element_text(size = 10, family = "Helvetica", vjust = -.6, angle = 90),
        axis.text.y = element_text(size = 10, family = "Helvetica"),
        legend.text = element_text(size = 10, family = "Helvetica"),
        legend.title = element_blank(),
        legend.position = c(0.2,0.35), panel.margin = unit(2, "lines") ,
        axis.title.y=element_text(size = 10, family = "Helvetica", vjust = 0.9), 
        axis.title.x=element_text(size = 10, family = "Helvetica", vjust=0.1),
        panel.grid = element_blank() ) +
  ggtitle("d. Razón de edades. Mujeres")


# # COL Relacion de sobrevivencia intercensal -----------------------------


pop <- read.xlsx2 (file ="pob.cen.gq.col.v4.xlsx", sheetName="f1")

melt.pop <- melt(pop, id= c("Cod.Dep","Dep", "Edad.Grup"))

indh <- grep("Hom",as.character(melt.pop$variable))
melt.pop$sexo <- 2;    melt.pop[indh, c("sexo")] <-1
melt.pop$sexo <- factor(  melt.pop$sexo,  levels=c (1, 2),    labels=c ("Hombres", "Mujeres") )

melt.pop$anio <- substring(melt.pop$variable,9,12)
melt.pop$value <- as.numeric(as.character(melt.pop$value))
melt.pop <- subset(melt.pop, anio %in% c(1985, 2005))

melt.pop$clasep <- factor(melt.pop$Edad.Grup, levels = c(" 0 -  4", " 5 -  9", "10 - 14", "15 - 19", 
                                                         "20 - 24", "25 - 29", 
                                                         "30 - 34", "35 - 39", "40 - 44", 
                                                         "45 - 49", "50 - 54", "55 - 59", 
                                                         "60 - 64", "65 - 69", "70 - 74", 
                                                         "75 - 79", "80 - 84" ),
                          labels = seq(2.5, 82.5, 5) )
melt.pop$clasep <- as.numeric(as.character(melt.pop$clasep))
melt.pop$anio <- as.numeric(as.character(melt.pop$anio))

melt.pop$gen <- melt.pop$anio - melt.pop$clasep

mpop <- dcast(melt.pop, Cod.Dep + Dep + sexo + gen ~ anio, 
              value.var ="value",   fun.aggregate = sum)

setnames(mpop, 5:6, c('a1985', 'a2005'))
mpop$sob <- mpop$a2005 / mpop$a1985

mpop <- subset(mpop, gen >= 1922.5 & gen <= 1982.5)

a <- seq(1985, 1925, -5);  b <- a -4; c <- str_sub(a, start = 3, end = 4)
lab <- paste0(b, '/', c, " ");    dput(rev(lab))

mpop$gen <- factor(mpop$gen, levels = rev(c(seq(1922.5, 1982.5, 5))), 
                   labels = rev(c("1921 / 25", "1926 / 30", "1931 / 35", "1936 / 40", "1941 / 45", "1946 / 50", 
                                  "1951 / 55", "1956 / 60", "1961 / 65", "1966 / 70", "1971 / 75", "1976 / 80", 
                                  "1981 / 85") ))

p3 <- ggplot(mpop, aes(as.numeric(gen) + .5, sob, colour = sexo, group = sexo) ) + 
  geom_vline(xintercept = seq(1, 13, 1), colour = '#f0f0f0', linetype = '22') + 
  geom_hline(yintercept = seq(0, 1.2, .1), colour = '#f0f0f0', linetype = '22') +
  geom_vline(xintercept = seq(2, 13, 2), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = seq(0, 1.2, .2), colour = '#E4E4E4', linetype = '22') +
  scale_colour_manual(name = "", values = c( "#fdbf6f" ,"#6a3d9a"),
                      guide = guide_legend( keywidth = 2  ) ) +
  geom_path(, alpha = .9 , size = 2) + 
  theme_bw(base_size = 10) + xlab('Generación') + 
  ylab("Razón de \n supervivencia") +
  scale_x_continuous(limits = c(1, 14), breaks = 1:13, labels = levels(mpop$gen) ) + 
  scale_y_continuous(limits= c(0.3, 1.2), breaks = seq(0, 1.2, .1) ) +
  theme(axis.text.x = element_text(size = 10, family = "Helvetica",vjust = 1, angle = 90),
        axis.text.y = element_text(size = 10, family="Helvetica"),  
        axis.title.x = element_text(size = 10, family="Helvetica"),
        axis.title.y = element_text(size = 10, family="Helvetica"),
        legend.text = element_text(size = 10, family="Helvetica"),
        legend.title = element_blank(),
        legend.position = c(0.2,0.35) ,    
        panel.grid = element_blank() ) + 
  ggtitle("e. Razon de supervivencia 2005/1985")

p6 <- ggplot(masc, aes(ind, as.numeric(gen) + .5) ) + 
  geom_blank() + theme_tufte() + 
  theme(axis.title = element_blank() , axis.text = element_blank(), axis.ticks = element_blank() )


pdf(file = "col indicadores calidad.pdf",      width = 8, height = 10, family = "Helvetica")
grid.newpage()
grid.draw(  rbind( cbind(ggplotGrob(p1), ggplotGrob(p2), size="last") ,
                   cbind(ggplotGrob(p4), ggplotGrob(p5), size="last") , 
                   cbind(ggplotGrob(p3), ggplotGrob(p6), size="first") , 
                   size="first")  )
dev.off() 



# ***METODOLOGIA*** -------------------------------------------------------------



#   LEXIS opticas y elementos -----------------------------------------------------------

sizet <- 11

# ilustracion periodo
p1 <-   # dibujo limites
  ggplot( ) + geom_blank() +  theme_bw(base_size = sizet) +  coord_fixed(ratio = 1)  +
  theme(panel.grid.minor=element_blank(),   panel.grid.major=element_blank() ,
        axis.text.x = element_text( size = sizet, family="Helvetica", vjust = .5, angle = 90),
        axis.text.y = element_text( size = sizet, family="Helvetica"),
        axis.title=element_text(size = sizet, family = "Helvetica"), 
        plot.title=element_text(size = sizet + 2, family = "Helvetica")  ,
        plot.margin=unit(c(0, 0, 0, 0), "cm"),
        panel.margin=unit(c(0, 0, 0, 0), "cm")      ) +
  scale_x_continuous(name = 'Año', lim = c(1950, 2010), breaks = seq(1950, 2010, 5)) + 
  scale_y_continuous(name = 'Edad',lim = c(0, 82.5), breaks = seq(0, 80, 5), expand = c(0, 0) )  +
  #dibujo periodo estudio
  geom_rect(aes(ymin = 0, ymax = 80, xmin = 1950, xmax = 2010), fill = "#ece7f2", alpha = .6 ) +
  # grilla pr
  geom_abline(  aes(intercept = seq(1860, 2015, 5) * -1, slope = rep(1, length(seq(1860, 2015, 5))) ), 
                colour = '#d9d9d9' ) +
  geom_vline(xintercept = seq(1950, 2010, 5), colour = '#d9d9d9'  ) +
  geom_hline(yintercept = seq(0, 80, 5), colour = '#d9d9d9'  ) +
    
  # grilla  sec
  geom_abline(  aes(intercept = seq(1860, 2015, 10) * -1, slope = rep(1, length(seq(1860, 2015, 10))) ), 
                colour = '#bdbdbd' ) +
  geom_vline(xintercept = seq(1950, 2010, 10), colour = '#bdbdbd'  ) +
  geom_hline(yintercept = seq(0, 80, 10), colour = '#bdbdbd'  ) +
  
  # grilla ter
  geom_abline(  aes(intercept = seq(1860, 2015, 20) * -1, slope = rep(1, length(seq(1860, 2015, 20))) ), 
                colour = '#969696' ) +  
  geom_vline(xintercept = seq(1950, 2010, 20), colour = '#969696'  ) +
  geom_hline(yintercept = seq(0, 80, 20), colour = '#969696'  ) +
  
  #   # edad resaltada
  geom_rect(aes(ymin = 20, ymax = 30, xmin = -Inf, xmax = Inf), fill = "#fcbba1", alpha = .5,
            colour = '#ef3b2c') +
  #periodo resaltado
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = 1990, xmax = 1995), fill = "#a6bddb", alpha = .5 ) +
  #   # generacion resaltado
  geom_polygon( aes(x = c(1960, 1975, 2010, 2010), y = c(0, 0, 35, 50) ), fill = '#a1d99b', 
                alpha = .5 , colour = '#238b45') +  
  # lineas periodo resaltado
  geom_vline(xintercept = seq(1990, 1995, 5), colour = '#74a9cf'  ) +
  # lineas intermedias
  geom_hline(yintercept = 25, colour = '#ef3b2c') + 
  geom_polygon( aes(x = c(1965, 1970, 2010, 2010), y = c(0, 0, 40, 45) ), fill = NA, 
                alpha = .5 , colour = '#238b45') + 
  ggtitle('Ilustración del análisis de dos grupos\n de edades en un periodo')

# ilustracion edad
p2 <-    # dibujo limites
  ggplot( ) + geom_blank() +  theme_bw(base_size = sizet) +  coord_fixed(ratio = 1)  +
  theme(panel.grid.minor=element_blank(),   panel.grid.major=element_blank() ,
        axis.text.x = element_text( size = sizet, family="Helvetica", vjust = .5, angle = 90),
        axis.text.y = element_text( size = sizet, family="Helvetica"),
        axis.title=element_text(size = sizet, family = "Helvetica"), 
        plot.title=element_text(size = sizet + 2, family = "Helvetica") ,
        plot.margin=unit(c(0, 0, 0, 0), "cm"),
        panel.margin=unit(c(0, 0, 0, 0), "cm") ) +
  scale_x_continuous(name = 'Año', lim = c(1950, 2010), breaks = seq(1950, 2010, 5)) + 
  scale_y_continuous(name = 'Edad',lim = c(0, 82.5), breaks = seq(0, 80, 5), expand = c(0, 0) )  +
  #dibujo periodo estudio
  geom_rect(aes(ymin = 0, ymax = 80, xmin = 1950, xmax = 2010), fill = "#ece7f2", alpha = .6 ) +
  # grilla pr
  geom_abline(  aes(intercept = seq(1860, 2015, 5) * -1, slope = rep(1, length(seq(1860, 2015, 5))) ), 
                colour = '#d9d9d9' ) +
  geom_vline(xintercept = seq(1950, 2010, 5), colour = '#d9d9d9'  ) +
  geom_hline(yintercept = seq(0, 80, 5), colour = '#d9d9d9'  ) +
  
  # grilla  sec
  geom_abline(  aes(intercept = seq(1860, 2015, 10) * -1, slope = rep(1, length(seq(1860, 2015, 10))) ), 
                colour = '#bdbdbd' ) +
  geom_vline(xintercept = seq(1950, 2010, 10), colour = '#bdbdbd'  ) +
  geom_hline(yintercept = seq(0, 80, 10), colour = '#bdbdbd'  ) +
  
  # grilla ter
  geom_abline(  aes(intercept = seq(1860, 2015, 20) * -1, slope = rep(1, length(seq(1860, 2015, 20))) ), 
                colour = '#969696' ) +  
  geom_vline(xintercept = seq(1950, 2010, 20), colour = '#969696'  ) +
  geom_hline(yintercept = seq(0, 80, 20), colour = '#969696'  ) +

  #   # edad resaltada
  geom_rect(aes(ymin = 20, ymax = 25, xmin = -Inf, xmax = Inf), fill = "#fcbba1", alpha = .5,
            colour = '#ef3b2c') +
  #periodo resaltado
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = 1985, xmax = 1995), fill = "#a6bddb",
            alpha = .5, colour = '#74a9cf' ) +
  #   # generacion resaltado
  geom_polygon( aes(x = c(1960, 1975, 2010, 2010), y = c(0, 0, 35, 50) ), fill = '#a1d99b', 
                alpha = .5 , colour = '#238b45') +  
  # lineas periodo resaltado
  geom_vline(xintercept = 1990, colour = '#74a9cf'  ) +
  # lineas intermedias
  geom_polygon( aes(x = c(1965, 1970, 2010, 2010), y = c(0, 0, 40, 45) ), fill = NA, 
                alpha = .5 , colour = '#238b45') + 
  ggtitle('Ilustración del análisis de un grupo de \nedades en dos periodos')



cairo_pdf(file = "GR13_Representacion_de_opticas_y_elementos_para_el_analisis_en_el_diagrama_de_Lexis.pdf", 
             width = 8, height = 4.5, family = "Helvetica")
grid.arrange(p1, p2, nrow = 1)
dev.off()  


grid.newpage()
png(file = "gr13v2.png", width = 2300, height = 2400, pointsize = 12, type = 'cairo', res = 300)
print(grid.arrange(p1, p2, ncol = 2   ))
dev.off()

# HELIGMAN  LAC ---------------------------------------------------------------------------------------------
mah <- read.xlsx2(file =  "alc.wpp.xlsx",sheetName = "h")
mam <- read.xlsx2(file =  "alc.wpp.xlsx",sheetName = "m")

mah$sexo <- "H" ; mam$sexo <- "M"
ma <- rbind(mah, mam);  ma <- data.table(ma)
ma$sexo <- factor(ma$sexo, c('H','M')  , c('Hombres','Mujeres'))
setnames(ma,c(3,8,9,11,13, 14, 18, 19) , c( "Pais", "Edad","Intervalo", "qxn", "lxn","dxn" , "ex", "axn")) 

ma$Edad <- as.numeric(as.character( ma$Edad ))
ma$Intervalo <- as.numeric(as.character( ma$Intervalo ))
ma$lxn <- as.numeric(as.character(ma$lxn)) 
ma$dxn <- as.numeric(as.character(ma$dxn)) 
ma$axn <- as.numeric(as.character(ma$axn)) 

ma <- ma[Edad < 80  , c("Pais", "sexo", "Period", "Edad", "Intervalo", "qxn", "lxn","dxn", "axn"), with =F ]
ma$clase <- ma$Edad + (ma$Intervalo) / 2;       ma$qxn <- as.numeric(as.character(ma$qxn)) 

ma$Edadb <- ifelse(ma$Edad %in% 0:1, 0, ma$Edad   )

ma <-  ma[ , list(min(qxn), min(lxn), sum(dxn), min(axn) )  , keyby = list(Pais, sexo, Period, Edadb)   ]
setnames(ma, 4:8, c("Edad","qxn", "lxn","dxn", "axn")   )

ma[Edad == 0]$qxn <- NA;  ma[Edad == 0]$axn <- NA
ma$qxn <- ifelse(ma$Edad == 0, ma$dxn / ma$lxn  ,  ma$qxn)

parConv <- c(a = 0.0005893,b = 0.0043836, c = 0.0828424,   d = 0.000706,e = 9.927863, 
             f = 22.197312, g = 0.00004948, h = 1.10003); 
parStart <- parConv; 

HP8 <- function(parS,x) with(as.list(parS),    ifelse(x == 0, a ^ ((x + b) ^ c) + g * h ^ x, 
                                                      a ^ ((x + b) ^ c) + d * exp(-e * (log(x / f))^2) + g * h ^ x))
## Define qx = HP8/(1+HP8)
qxPred <- function(parS, x) { h <- HP8(parS, x);         h / (1 + h)  }
nqxPred <- function(parS,x)
  (1 -(1 - qxPred(parS, x)) * (1 - qxPred(parS, x + 1)) * 
     (1 - qxPred(parS, x + 2)) * (1 - qxPred(parS, x + 3)) * (1 - qxPred(parS, x + 4))) 
##Define Residual Function, the relative squared distance is minimized  
ResidFun <- function(parS, Observed, x) (nqxPred(parS, x)/ Observed - 1)
ssqfun <- function(parS, Observed, x) { sum(ResidFun(parS, Observed, x) ^ 2) }

no <- function (Periode, sexoe, Paise) {
  massu <- subset(ma, Period == Periode  & sexo == sexoe & Pais == Paise)
  opt2 <- nlminb(start = parStart, objective = ssqfun,    Observed = massu$qxn, x = massu$Edad,                 
                 control= list(eval.max=200,iter.max=200))
  parNLM <- opt2$par    
  
  ajust <- data.frame(matrix(ncol = 1, nrow = length(seq(0, 100, 5)) ))
  ajust$Edad <- seq(0, 100, 5)
  ajust$pred2 <- nqxPred(as.list(parNLM), ajust$Edad )
  ajust$Period <- unique(massu$Period)
  ajust$Pais <- unique(massu$Pais)
  ajust$sexo <- unique(massu$sexo)    
    
  dPred <- merge(massu, ajust, by = c('Edad', 'Period', 'Pais', 'sexo'), all = T )
    list( opt2$par, subset(dPred, select = c('Edad', 'pred2', 'qxn',
                                             'Period', 'Pais', 'sexo')  ) )
  
}

no("2005-2010","Hombres","Latin America and the Caribbean")
no("2005-2010","Mujeres","Latin America and the Caribbean")

mas1 <- subset(ma, Pais == "Latin America and the Caribbean" & Edad < 80 & sexo == "Hombres")
resb <- dlply(mas1, .(Period, sexo, Pais), function(massu)
{opt2 <- nlminb(start = parStart, objective = ssqfun,    Observed = massu$qxn, x = massu$Edad,                 
                control= list(eval.max=200,iter.max=200, abs.tol = 1e-20))
 parNLM <- opt2$par
 
 ajust <- data.frame(matrix(ncol = 1, nrow = length(seq(0, 100, 5)) ))
 ajust$Edad <- seq(0, 100, 5)
 ajust$pred2 <- nqxPred(as.list(parNLM), ajust$Edad )
 ajust$Period <- unique(massu$Period)
 ajust$Pais <- unique(massu$Pais)
 ajust$sexo <- unique(massu$sexo)  
 
 dPred <- merge(massu, ajust, by = c('Edad', 'Period', 'Pais', 'sexo'), all = T )
 list( opt2$par, subset(dPred, select = c('Edad', 'pred2', 'qxn',
                                          'Period', 'Pais', 'sexo')  ) ) 
})

resbl1 <- lapply( 1:12, function(i) resb[[i]][1]  );    m.resbl1 <- melt(resbl1)
resbln <- lapply( 1:12, function(i) names(resb[i])  );      m.resbln <- melt(resbln)
resblc <- lapply( 1:12, function(i) names(resb[[i]][[1]])  );     m.resblc <- melt(resblc)

lb <-  cbind(m.resbl1, m.resblc[,1]);   lb <- merge(lb, m.resbln, by = "L1");   setnames(lb, 4, "param")
l1b <- dcast(lb, value.y ~ param, value.var="value.x")

setnames(l1b, 1, "id" );     l1b$anio <- factor(substring(l1b$id, 1,9))
l1b$sexo <- factor(substring(l1b$id, 11,11))

l1b <- data.table(l1b);   l1b <- l1b[order(sexo, anio)]

resbl2 <- lapply( 1:12, function(i) resb[[i]][2]  );  
resbl2m <- ldply(resbl2, data.frame)
setnames(resbl2m, 1:6, c( 'clase', 'ajust', 'obs', 'periodo', 'sexo', 'pais') )

sizet <- 12

p1 <- ggplot(subset(resbl2m, periodo == "2005-2010"),  aes(clase, obs) )  + 
  ggtitle("Hombres") +
  geom_vline(xintercept = seq(0, 100, 5), colour = '#f0f0f0', linetype = '22') +   
  geom_vline(xintercept = seq(0, 100, 10), colour = '#EAEAEA', linetype = '22') +   
  geom_vline(xintercept = seq(0, 100, 20), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = c(.001, .001, .01, .1, 1), colour = '#E4E4E4', linetype = '22') + 
  geom_point(size = 4, colour = "#2171b5") +  
  geom_point(size = 3, colour = "white") + 
  geom_line(data = subset(resbl2m, periodo == "2005-2010"),  aes(clase, ajust), colour = "#08519c", size = 1.1) +
  theme_bw(base_size = sizet) +   theme(legend.position = c(.85, .15)) +   
  scale_x_continuous(name = "Edad", breaks = seq(0, 100, 10), expand=c(0.1, 0.1) ) + 
   scale_y_log10(name = expression(log(paste(''[n], q[x])  ) ) , limits = c(0.001, 1) ,
                 expand = c(.15,.15), breaks = trans_breaks("log10", function(x) 10^x),
                 labels = trans_format("log10", math_format(10^.x))  )  +
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        strip.text = element_text(size = sizet, family="Helvetica"),
        strip.background = element_rect( fill = "white"), 
        panel.grid = element_blank(), 
        plot.title = element_text(size = sizet + 2, family="Helvetica")) +
 annotation_logticks(sides = "l")

mas1 <- subset(ma, Pais == "Latin America and the Caribbean" & Edad < 80 & sexo == "Mujeres")
resb <- dlply(mas1, .(Period, sexo, Pais), function(massu)
{opt2 <- nlminb(start = parStart, objective = ssqfun,    Observed = massu$qxn, x = massu$Edad,                 
                control= list(eval.max=200,iter.max=200, abs.tol = 1e-20))
 parNLM <- opt2$par
 
 ajust <- data.frame(matrix(ncol = 1, nrow = length(seq(0, 100, 5)) ))
 ajust$Edad <- seq(0, 100, 5)
 ajust$pred2 <- nqxPred(as.list(parNLM), ajust$Edad )
 ajust$Period <- unique(massu$Period)
 ajust$Pais <- unique(massu$Pais)
 ajust$sexo <- unique(massu$sexo)  
 
 dPred <- merge(massu, ajust, by = c('Edad', 'Period', 'Pais', 'sexo'), all = T )
 list( opt2$par, subset(dPred, select = c('Edad', 'pred2', 'qxn',
                                          'Period', 'Pais', 'sexo')  ) )
 })

resbl1 <- lapply( 1:12, function(i) resb[[i]][1]  );    m.resbl1 <- melt(resbl1)
resbln <- lapply( 1:12, function(i) names(resb[i])  );      m.resbln <- melt(resbln)
resblc <- lapply( 1:12, function(i) names(resb[[i]][[1]])  );     m.resblc <- melt(resblc)

lb <-  cbind(m.resbl1, m.resblc[,1]);   lb <- merge(lb, m.resbln, by = "L1");   setnames(lb, 4, "param")
l1b <- dcast(lb, value.y ~ param, value.var="value.x")

setnames(l1b, 1, "id" );     l1b$anio <- factor(substring(l1b$id, 1,9))
l1b$sexo <- factor(substring(l1b$id, 11,11))

l1b <- data.table(l1b);   l1b <- l1b[order(sexo, anio)]

resbl2 <- lapply( 1:12, function(i) resb[[i]][2]  );  
resbl2m <- ldply(resbl2, data.frame)
setnames(resbl2m, 1:6, c( 'clase', 'ajust', 'obs', 'periodo', 'sexo', 'pais') )

p2 <- ggplot(subset(resbl2m, periodo == "2005-2010"),  aes(clase, obs))  + ggtitle("Mujeres") +  
  geom_vline(xintercept = seq(0, 100, 5), colour = '#f0f0f0', linetype = '22') +   
  geom_vline(xintercept = seq(0, 100, 10), colour = '#EAEAEA', linetype = '22') +   
  geom_vline(xintercept = seq(0, 100, 20), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = c(.001, .001, .01, .1, 1), colour = '#E4E4E4', linetype = '22') + 
  geom_point(size = 4, colour = "#d7301f") +  
  geom_point(size = 3, colour = "white") + 
  geom_line(data = subset(resbl2m, periodo == "2005-2010"), 
            aes(clase, ajust), colour = "#b30000", size = 1.1) +
  theme_bw(base_size = sizet) +   theme(legend.position = c(.85, .15)) +   
  scale_x_continuous(name = "Edad", breaks = seq(0, 100, 10), expand=c(0.1, 0.1) ) + 
  scale_y_log10(name = expression(log(paste(''[n], q[x])  ) ) , limits = c(0.001, 1) ,
                expand = c(.15,.15), breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))  )  +
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        strip.text = element_text(size = sizet, family="Helvetica"),
        strip.background = element_rect( fill = "white"), 
        panel.grid = element_blank(), 
        plot.title = element_text(size = sizet + 2, family="Helvetica")) +
  annotation_logticks(sides = "l")

cairo_pdf(file = "lac helligman 2005 2010.pdf", width = 8,   height = 4.2, 
          family = "Helvetica")
print(  grid.arrange(p1, p2, nrow = 1)   )
dev.off()


# ***MORTALIDAD COL ALC*** ---------------------------------------------------------------

# ALC Esperanza vida   1950 2010-----------------------------------------------------
mah <- fread('tvhombres.csv')
mam <- fread('tvmujeres.csv')

mah$sexo <- "H" ; mam$sexo <- "M"
ma <- rbind(mah, mam)

setnames(ma,c(3,8,9,14, 18) , c( "Pais", "Edad","Intervalo", "dxn" , "ex")) 

mmas <- subset(ma, Edad %in% c(0) & Codigo %in% c("CR", "SV", "MX", "NI", "PA", "AR", "BR", "CL", "PY", "UY", 
                                                  "CU", "DO", "HT", "JM", "TT", "BO", "CO", "EC", "PE", "VE", 
                                                    "GT", "HN")  )

mmas <- mmas[, c("sexo", "ex",  "Period", "Codigo","Edad"), with = F]

mmas$clasep <- factor(mmas$Period, levels = c("1950-1955", "1955-1960", "1960-1965", 
                                                "1965-1970", "1970-1975", "1975-1980", "1980-1985", "1985-1990", 
                                                "1990-1995", "1995-2000", "2000-2005", "2005-2010"),
                       labels = seq(1952.5, 2007.5, 5) )
mmas$clasep <- as.numeric(as.character(mmas$clasep))

dmmas <- dcast(mmas, clasep + Codigo + Edad ~ sexo, value.var = "ex")
dmmas$dif <- as.numeric(dmmas$M) - as.numeric(dmmas$H)

dmmas$H <- as.numeric(dmmas$H); dmmas$M <- as.numeric(dmmas$M)

#as.data.table(dmmas[dmmas$clasep == 2007.5, ])[order(H),]

s1 <- subset(dmmas, Codigo %in% c('HT','BO','SV','CL','CU','CR','CO', 'MX', 'AR') )

s1$Codigo <- factor(s1$Codigo, levels = c('CR','CU','CL', 'MX', 'AR','CO','SV', 'HT',  'BO' ) ) 

sizet <- 11.5

p1 <- ggplot() +
  geom_vline(xintercept = seq(1950, 2010, 5), colour = '#f0f0f0', linetype = '22') + 
  geom_hline(yintercept = seq(35, 85, 1.25), colour = '#f0f0f0', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2010, 10), colour = '#EAEAEA', linetype = '22') + 
  geom_hline(yintercept = seq(35, 85, 2.5), colour = '#EAEAEA', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2010, 20), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = seq(35, 85, 5), colour = '#E4E4E4', linetype = '22') +
  geom_line(data= dmmas, aes(x = clasep, y = H, group = Codigo), colour = "gray")  +
  geom_line(data= s1, aes(x = clasep, y = H,  colour = Codigo, linetype = Codigo), size = 1.6)  +
  theme_bw(base_size = sizet) + xlab('Año') + ylab(expression( e[0])) +
  scale_x_continuous(lim = c(1947, 2013), breaks = seq(1950, 2010, 10) ) + 
  scale_y_continuous(lim = c(35,85), breaks = seq(35, 85,5 ), expand=c(.025, .025) ) +
  scale_colour_tableau( )  +
  scale_linetype_manual(values = c('solid', '51', '11', 'solid','51', '11','solid', '51','11'))+
  geom_dl(aes(x = s1$clasep, y = s1$H, label = s1$Codigo,  colour = s1$Codigo),
          list(dl.combine(first.bumpup,last.bumpup) , cex = 1.2  )) + 
  theme(legend.position = '',
        axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank(),
        plot.title = element_text(size = sizet + 2, family="Helvetica") ) + 
  ggtitle('Hombres')

p2 <- ggplot() +
  geom_vline(xintercept = seq(1950, 2010, 5), colour = '#f0f0f0', linetype = '22') + 
  geom_hline(yintercept = seq(35, 85, 1.25), colour = '#f0f0f0', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2010, 10), colour = '#EAEAEA', linetype = '22') + 
  geom_hline(yintercept = seq(35, 85, 2.5), colour = '#EAEAEA', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2010, 20), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = seq(35, 85, 5), colour = '#E4E4E4', linetype = '22') +
  geom_line(data= dmmas, aes(x = clasep, y = M, group = Codigo), colour = "gray")  +
  geom_line(data= s1, aes(x = clasep, y = M,  colour = Codigo, linetype = Codigo), size = 1.6)  +
  theme_bw(base_size = sizet) + xlab('Año') + ylab(expression( e[0])) +
  scale_x_continuous(lim = c(1947, 2013), breaks = seq(1950, 2010, 10) ) +  
  scale_y_continuous(lim = c(35,85), breaks = seq(35, 85,5), expand=c(0.025, 0.025) ) +
  scale_colour_tableau( )  +
  scale_linetype_manual(values = c('solid', '51', '11', 'solid','51', '11','solid', '51','11'))+
  geom_dl(aes(x = s1$clasep, y = s1$M, label = s1$Codigo,  colour = s1$Codigo),
          list(dl.combine(first.bumpup,last.bumpup), cex = 1.2)) + 
  theme(legend.position = 'none',
        axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank(),
        plot.title = element_text(size = sizet + 2, family="Helvetica") ) +
  ggtitle('Mujeres')

pdf(file = "GR16_ALC_Esperanza_de_vida_al__nacer_segun_sexo_1950_2010.pdf", 
    width = 8,   height = 7, family = "Helvetica")
print(grid.arrange( p1, p2, nrow = 1) )
dev.off()

write.xlsx(dmmas, 'Resultados.xlsx', sheetName = 'GR16', append = T)

dmmas <- data.table(dmmas)
dmmas[Codigo == 'CO',]

pr <- mmas[clasep %in% c(1952.5, 2007.5), ][order(Codigo),]
pr1 <- dcast(pr,  sexo + Codigo ~ Period, value.var= 'ex')
pr1$dif <- pr1[,4] - pr1[,3]
pr1 <- data.table(pr1)
pr1[order(-sexo, dif),]

pr <- dmmas[Codigo == 'CO' & clasep %in% c(seq(1952.5, 2002.5, 10), 2007.5),]
pr$Hr <- c(NA, pr[1:(nrow(pr)-1)]$H)  ; pr$Mr <- c(NA, pr[1:(nrow(pr)-1)]$M)
pr <- pr[, DH := H-Hr ][, DM := M-Mr ][, DHM:= DM-DH];pr

pr1 <- dmmas[Codigo == 'CO' & clasep %in% c(seq(1952.5, 2002.5, 10), 2007.5),]
pr2 <- dmmas[Codigo == 'MX' & clasep %in% c(seq(1952.5, 2002.5, 10), 2007.5),]
pr <- merge(pr1,pr2, by = c('clasep'))
pr <- pr[, DH := H.y- H.x][, DM := M.y- M.x]  ; pr

pr1 <- dmmas[Codigo == 'CO' & clasep %in% c(seq(1952.5, 2002.5, 10), 2007.5),]
pr2 <- dmmas[Codigo == 'CL' & clasep %in% c(seq(1952.5, 2002.5, 10), 2007.5),]
pr <- merge(pr1,pr2, by = c('clasep'))
pr <- pr[, DH := H.y- H.x][, DM := M.y- M.x]  ; pr
pr$DHr <- c(NA, pr[1:(nrow(pr)-1)]$DH)  ; pr$DMr <- c(NA, pr[1:(nrow(pr)-1)]$DM)
pr <- pr[, DDH := DH-DHr ][, DDM := DM-DMr ];pr

pr1 <- dmmas[Codigo == 'CO' ,]
pr2 <- dmmas[Codigo == 'CU' ,]
pr <- merge(pr1,pr2, by = c('clasep')); pr

pr1 <- dmmas[Codigo == 'CO' ,]
pr2 <- dmmas[Codigo == 'CR' ,]
pr <- merge(pr1,pr2, by = c('clasep')); pr

pr1 <- dmmas[Codigo == 'CO' ,]
pr2 <- dmmas[Codigo == 'CL' ,]
pr <- merge(pr1,pr2, by = c('clasep')); pr


# ALC Brecha esperanza de vida sexo 1980 a 2010  -------------------------------------------
mah <- fread('tvhombres.csv')
mam <- fread('tvmujeres.csv')

mah$sexo <- "H" ; mam$sexo <- "M"
ma <- rbind(mah, mam)

setnames(ma,c(3,8,9,14, 18) , c( "Pais", "Edad","Intervalo", "dxn" , "ex")) 

mmas <- subset(ma, Edad %in% c(0))
mmas <- mmas[, c("sexo", "ex",  "Period", "Codigo","Edad"), with = F]

mmas$clasep <- factor(mmas$Period, levels = c("1950-1955", "1955-1960", "1960-1965", 
                                              "1965-1970", "1970-1975", "1975-1980", "1980-1985", "1985-1990", 
                                              "1990-1995", "1995-2000", "2000-2005", "2005-2010"),
                      labels = seq(1952.5, 2007.5, 5) )
mmas$clasep <- as.numeric(as.character(mmas$clasep))

dmmas <- dcast(mmas, Period + Codigo + Edad ~ sexo, value.var = "ex")
dmmas$dif <- as.numeric(dmmas$M) - as.numeric(dmmas$H)

dmmas$H <- as.numeric(dmmas$H); dmmas$M <- as.numeric(dmmas$M)

#as.data.table(dmmas[dmmas$clasep == 2007.5, ])[order(H),]

s1 <- subset(dmmas, Codigo %in% c("AR", "BO", "BR", "CL", "CO", 
                                  "CR", "CU", "DO", "EC",  "GT", "GY", "HN", 
                                  "HT", "JM",  "MX", "NI", "PA", "PE", "PR", "PY", "SR", 
                                  "SV", "TT", "UY",  "VE") & 
               Period %in% c( "1980-1985", "1990-1995", "2005-2010") )

# Normalize coordinates to maintain constant aspect ratio
x.fact <- 100 / max(s1$H)
y.fact <- 100 / max(s1$dif)

# Repel points
coords <-   FFieldPtRep(coords = cbind(s1$H * x.fact,    s1$dif * y.fact),      rep.fact = 0.6)

# Convert back to plot coordinates
x.t <- coords$x / x.fact
y.t <- coords$y / y.fact

sizet <- 15

scatter <- ggplot(data = s1,  aes( H, dif, colour = Period, label = s1$Codigo ) ) +
  theme_bw(base_size = 12) +
  # geom_point(size = 1) + geom_segment(data = s1, aes(xend = x.t,  yend = y.t)) + 
  geom_text(aes(x = x.t, y = y.t, size = Period )  ) + scale_size_manual(values= c(3,3.5,4)) + 
  scale_colour_manual(name = 'Periodo', values = c('#a50026', '#f46d43' ,'#4575b4')) +
  scale_y_continuous(lim = c(2, 14), breaks = seq(3, 14, 1) ) +
  scale_x_continuous(lim = c(49, 78), breaks = seq(50,78, 2) )  + 
  ylab('Diferencia entre sexos') +
  xlab('Esperanza de vida de los hombres') +
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet + 2, family="Helvetica"),
        axis.title.y = element_text(size = sizet + 2 , family="Helvetica"))+
  guides(colour=FALSE, size = F)


g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

#placeholder plot - prints nothing at all
empty <- ggplot(s1, aes(H, dif, colour=Period)) + geom_blank( ) +
  theme(                              
    plot.background = element_blank(), 
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.position = c(.5,.5)
  )

#marginal density of x - plot on top
plot_top <- ggplot(s1, aes(H, colour=Period)) + 
  geom_density(alpha=.5, size = 1.2) + theme_bw(base_size = 12) + theme(axis.title.x = element_blank()) +
  scale_colour_manual(values = c('#a50026', '#f46d43' ,'#4575b4')) + 
  scale_y_continuous(lim = c(0,.12), breaks = c(.03,.06,.09, .12) ) +
  scale_x_continuous(lim = c(49, 78), breaks = seq(50,78, 2) ) +
  theme(legend.position = "none", 
        axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet + 2, family="Helvetica"),
        axis.title.y = element_text(size = sizet + 2, family="Helvetica"))  + ylab('Densidad') + xlab('')

#marginal density of y - plot on the right
plot_right <- ggplot(s1, aes(dif, colour=Period)) + 
  geom_density(alpha = .5, size = 1.2) + 
  coord_flip() + theme_bw(base_size = sizet) + 
  theme(axis.title.y = element_blank()) +
  scale_colour_manual(name = '', values = c('#a50026', '#f46d43' ,'#4575b4')) + 
  scale_x_continuous(lim = c(2, 14), breaks = seq(3, 14, 1) ) +
  scale_y_continuous(breaks = c(.1,.2) ) +
  theme(legend.position = c(.59, .8), 
        axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet + 2, family="Helvetica"),
        axis.title.y = element_text(size = sizet + 2, family="Helvetica"),
        legend.text = element_text( family="Helvetica"),  
        legend.title = element_text(family="Helvetica", face = 'plain') )  + 
  ylab('Densidad') + xlab('')

plot_rightb <- ggplot(s1, aes(dif, colour=Period)) + 
  geom_density(alpha = .5, size = 1.2) + 
  coord_flip() + theme_bw(base_size = sizet) + 
  theme(axis.title.y = element_blank()) +
  scale_colour_manual(name = 'Periodo', values = c('#e31a1c', '#ff7f00' ,'#1f78b4')) + 
  scale_x_continuous(breaks = seq(3, 14, 1) ) +
  scale_y_continuous(breaks = c(.1,.2) ) +
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet + 2, family="Helvetica"),
        axis.title.y = element_text(size = sizet + 2, family="Helvetica"))  + ylab('Densidad') + xlab('') +
   guides(colour = FALSE)

mylegend_1 <- g_legend(plot_right)



gA <- ggplotGrob(direct.label(plot_top, list('top.points', vjust = -.5)))
gB <- ggplotGrob(direct.label(scatter, "extreme.grid"))
maxWidth = grid::unit.pmax(gA$widths[2:5], gB$widths[2:5])
gA$widths[2:5] <- as.list(maxWidth)
gB$widths[2:5] <- as.list(maxWidth)


gC <- ggplotGrob(plot_right)
maxheights = grid::unit.pmax(gC$heights[2:5], gB$heights[2:5])
gC$heights[2:5] <- as.list(maxheights)
gB$heights[2:5] <- as.list(maxheights)


#arrange the plots together, with appropriate height and width for each row and column

pdf(file = "GR17_ALC_Diferencia_de_la_esperanza_de_vida_al_nacer_entre_hombres_y_mujeres_1980_a_2010.pdf",
             width = 11,   height = 8, family = "Helvetica")
grid.arrange(gA,       empty,        gB, 
             gC, ncol = 2, nrow = 2, 
             widths = c(3.8, 1.2), heights = c(1.4, 3.6))
dev.off()



write.xlsx(s1, 'Resultados.xlsx', sheetName = 'GR17',append = T)


estimate_mode <- function(x) {
  d <- density(x)
  d$x[which.max(d$y)]
}
s1 <- data.table(s1)
s1[, estimate_mode(H) , keyby = list(Period)]

pr <- s1[ , c('Period', 'Codigo', 'dif') , with = F]
pr <- dcast(pr,  Codigo ~  Period, value.var=   'dif')
pr <- data.table(pr)
pr$camb <- pr[,4, with=F] -   pr[,2, with=F]
pr[order(camb),]
setnames(pr, 2:4, c('a1980_1985' , 'a1990_1995' , 'a2005_2010')  )
pr[order(a1980_1985),]
pr[order(a2005_2010),]


# ALC Tasa de mortalidad infantil 1950 - 2010 --------------------------------------------------------
mah <- fread('tvhombres.csv')
mam <- fread('tvmujeres.csv')

mah$sexo <- "H" ; mam$sexo <- "M"
ma <- rbind(mah, mam)

setnames(ma,c(3,8,9,11, 14, 18) , c( "region", "Edad","Intervalo", 'qxn',"dxn" , "ex")) 

mas <- subset(ma, Edad %in% c(0) & Codigo %in% c("CR", "SV", "MX", "NI", "PA", "AR", "BR", "CL", "PY", "UY", 
                                                 "CU", "DO", "HT", "JM", "TT", "BO", "CO", "EC", "PE", "VE", 
                                                 "GT", "HN")  )

mas$clase <- mas$Edad + (mas$Intervalo) / 2

mas$clasep <- factor(mas$Period, levels = c("1950-1955", "1955-1960", "1960-1965", 
                                            "1965-1970", "1970-1975", "1975-1980", "1980-1985", "1985-1990", 
                                            "1990-1995", "1995-2000", "2000-2005", "2005-2010"),
                     labels = seq(1952.5, 2007.5, 5) )

mas$clasep <- as.numeric(as.character(mas$clasep))


mas$Edad <- factor(mas$Edad, levels = c("0"),   labels = c("0 - 1"))

mas <- mas[, c("region", "Period", "Edad", "qxn", "sexo"), with = F]

mas$qxn <- as.numeric(as.character(mas$qxn) ) 

mmas <- subset(mas, Period %in% c("1955-1960","1980-1985", "2005-2010"))
#dput(mmas[sexo == 'M' & Period == '1955-1960',][order(qxn)][,1,with = F])


mmas$region <- factor(mmas$region, c("Uruguay", "Argentina", "Cuba", "Trinidad and Tobago", 
                                     "Paraguay", "Jamaica", "Panama", "Costa Rica", "Venezuela (Bolivarian Republic of)", 
                                     "Mexico", "Colombia", "Chile", "Brazil", "Ecuador", "El Salvador", 
                                     "Guatemala", "Dominican Republic", "Peru", "Nicaragua", "Honduras", 
                                     "Bolivia (Plurinational State of)", "Haiti"),
                      labels =  c("Uruguay", "Argentina", "Cuba", "Trinidad y Tobago", 
                                  "Paraguay", "Jamaica", "Panamá", "Costa Rica", "Venezuela", "México", 
                                  "Colombia", "Chile", "Brasil", "Ecuador", "El Salvador", "Guatemala", 
                                  "Rep. Dominicana", "Perú", "Nicaragua", "Honduras", "Bolivia", 
                                  "Haití"))

sizet <- 12

p <- ggplot(mmas, aes( qxn, region) ) + 
  geom_vline(xintercept = seq(0, .20 , .025), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0, .20 , .05), colour = '#EAEAEA', linetype = '22') + 
  geom_vline(xintercept = seq(0, .20 , .10), colour = '#E4E4E4', linetype = '22') + 
  
  geom_blank() +
  geom_hline(yintercept = 1:22, colour = '#f0f0f0', linetype = '22') +
  geom_point( aes(colour = sexo, shape = sexo), size = 3 ) +
  
  facet_wrap(~ Period) + theme_bw(base_size = 16) +
  scale_shape_discrete() + 
  scale_colour_manual(values = c('#377eb8', '#e41a1c')  ) + ylab('País') + 
  xlab(expression(paste(''[1], q[0] ))) +
  scale_x_continuous(breaks = seq(0, .20 , .05), expand = c(.02, .02),
                     labels =  paste0(seq(0, .20 , .05) * 1000, '\u2030') ) +
  annotate('rect',  ymin = 10.5, ymax = 11.5, xmin = -Inf, xmax = Inf,    alpha = .15 ) +
  theme( strip.background = element_rect(colour = '#525252' , fill="white"),
         legend.title = element_blank(), legend.position = 'bottom',
         axis.text.x = element_text( size = sizet, family="Helvetica", vjust = .5, angle = 90),
         axis.text.y = element_text(size = sizet, family="Helvetica",
                                    face =  c(rep('plain', 10), 'bold' , rep('plain', 11) ) ),  
         axis.title.x = element_text(size = sizet, family="Helvetica"),
         axis.title.y = element_text(size = sizet, family="Helvetica"),
         legend.text = element_text(size = sizet, family="Helvetica"),
         strip.text.x = element_text(size = sizet + 1, family="Helvetica"),
         panel.margin = unit(0, "lines"), panel.grid = element_blank()  )+ 
  guides(fill = guide_legend(reverse = TRUE))

cairo_pdf(file = "GR19_ALC_Tasa_de_mortalidad_infantil_1950_2010.pdf",  family = "Helvetica",
             width = 8, height = 6)
print( p  )
dev.off()


a <- dcast(mmas, region + Period + Edad ~ sexo, value.var ='qxn')
a$dif <- a$H- a$M
a <-data.table(a)
a1 <-   a[Period == "1955-1960",][order(dif),][, difd := dif * 1000 ][, hd := H*1000][, md := M*1000]; a1
a2 <- a[Period == "2005-2010",][order(dif),][, difd := dif * 1000 ][, hd := H*1000][, md := M*1000]; a2

a3 <- a[region == 'Colombia', ][order(Period),][, difd := dif * 1000 ][, hd := H*1000][, md := M*1000]; a3

a1 <-   a[Period == "1955-1960",][order(H),][, difd := dif * 1000 ][, hd := H*1000][, md := M*1000]; a1
a2 <- a[Period == "2005-2010",][order(H),][, difd := dif * 1000 ][, hd := H*1000][, md := M*1000]; a2
a3 <-   a[Period == "1980-1985",][order(H),][, difd := dif * 1000 ][, hd := H*1000][, md := M*1000]; a3

a1 <-   a[Period == "1955-1960",][order(M),][, difd := dif * 1000 ][, hd := H*1000][, md := M*1000]; a1
a2 <- a[Period == "2005-2010",][order(M),][, difd := dif * 1000 ][, hd := H*1000][, md := M*1000]; a2
a3 <-   a[Period == "1980-1985",][order(M),][, difd := dif * 1000 ][, hd := H*1000][, md := M*1000]; a3

mas[region == 'Chile']


#  ALC Potencial de años vividos 0 4 ---------------------------------------------
mah <- fread('tvhombres.csv');     mam <- fread('tvmujeres.csv')
mah$sexo <- "H" ; mam$sexo <- "M";  ma <- rbind(mah, mam)

setnames(ma, c(3, 8, 9, 11, 13, 14, 15, 18, 19) , c( "region", "Edad","Intervalo", 'qxn', 
                                                     "lx", "dxn" , "Lxn", "ex", "axn")) 
ma$lxad <-  c( ma[2:nrow(ma),]$lx, NA  ) ;   ma[ma$Edad == 85, ]$lxad <- NA
ma$etr <- ma$Intervalo * ma$lxad + ma$dxn * ma$axn 

ma <- data.table(ma)
ma$clasep <- factor(ma$Period, levels = c("1950-1955", "1955-1960", "1960-1965", 
                                          "1965-1970", "1970-1975", "1975-1980", "1980-1985", "1985-1990", 
                                          "1990-1995", "1995-2000", "2000-2005", "2005-2010"),
                    labels = seq(1952.5, 2007.5, 5) )

pot04 <- ma[ Edad %in%  c(0, 1), ][
  ,  list(sum(etr),max(lx, na.rm = TRUE) , sum(etr) / (5* max(lx, na.rm = TRUE) )  ) , 
  keyby = list(Codigo, sexo,  clasep)]

setnames(pot04, 6, 'pt')

dpot04 <- dcast(pot04,  clasep + Codigo ~ sexo, value.var ='pt')
s1 <- subset(dpot04, Codigo %in% c('CL','CU','CR','CO', 'MX', 'AR') )
s1$Codigo <- factor(s1$Codigo, levels = c('CU','CL','CR', 'AR', 'MX','CO') ) 
s1$clasep <- as.numeric(as.character(s1$clasep))

sizet <- 12.5

p1 <- ggplot(  ) + 
  geom_vline(xintercept = seq(1950, 2010, 5), colour = '#f0f0f0', linetype = '22') + 
  geom_hline(yintercept = seq(.85, 1, .00625), colour = '#f0f0f0', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2010, 10), colour = '#EAEAEA', linetype = '22') + 
  geom_hline(yintercept = seq(.85, 1, .0125), colour = '#EAEAEA', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2010, 20), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = seq(.85, 1, .025), colour = '#E4E4E4', linetype = '22') +
  geom_line(data= s1,
            aes(clasep, H, colour = Codigo, linetype = Codigo, group = Codigo), size = 1.6) + 
  theme_bw(base_size = sizet) + scale_colour_tableau() + 
  scale_y_continuous(name = 'Potencial de años vividos',lim = c(.83, 1), breaks = seq(.85,1, .025),
                     labels = percent ) +
  scale_linetype_manual(values = c('solid', '51', '11', 'solid','51', '11','solid', '51','11')) +
  scale_x_continuous(name = 'Año',lim = c(1947, 2013), breaks = seq(1950, 2010, 20) ) + 
  geom_dl(aes(x = s1$clasep, y = s1$H, label = s1$Codigo,  colour = s1$Codigo),
          list(dl.combine(first.bumpup), cex = 1.2, family = "Helvetica")) + ggtitle('Hombres') + 
  theme(legend.position = '',
        axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        title = element_text(size = sizet , family="Helvetica") ,
        panel.grid = element_blank()  ) 


p2 <- ggplot(  ) + 
  geom_vline(xintercept = seq(1950, 2010, 5), colour = '#f0f0f0', linetype = '22') + 
  geom_hline(yintercept = seq(.85, 1, .00625), colour = '#f0f0f0', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2010, 10), colour = '#EAEAEA', linetype = '22') + 
  geom_hline(yintercept = seq(.85, 1, .0125), colour = '#EAEAEA', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2010, 20), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = seq(.85, 1, .025), colour = '#E4E4E4', linetype = '22') +
  geom_line(data= s1,
            aes(clasep, M, colour = Codigo, linetype = Codigo, group = Codigo), size = 1.6) + 
  theme_bw(base_size = sizet) + scale_colour_tableau() + 
  scale_y_continuous(name = '', lim = c(.83, 1), breaks = seq(.85,1, .025),
                     labels = percent ) +
  scale_linetype_manual(values = c('solid', '51', '11', 'solid','51', '11','solid', '51','11')) +
  scale_x_continuous(name = 'Año',lim = c(1947, 2013), breaks = seq(1950, 2010, 20) ) + 
  geom_dl(aes(x = s1$clasep, y = s1$M, label = s1$Codigo,  colour = s1$Codigo),
          list(dl.combine(first.bumpup), cex = 1.2)) + ggtitle('Mujeres') + 
  theme(legend.position = '',
        axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        title = element_text(size = sizet , family="Helvetica"),
        panel.grid = element_blank()  )

pdf(file = "GRexppt04.pdf", width = 8,   height = 6, family = "Helvetica")
print(
  grid.arrange( p1, p2, nrow=1)
)
dev.off()

s1 <- data.table(s1)
s2 <- s1[order(Codigo),][,  PH := round(H * 100) ][, PM := round(M * 100)][
  , c('clasep' , 'Codigo', 'PH' , 'PM'), with = F][,PD := PM - PH][
    clasep %in% c(seq(1952.5, 2002.5, 10), 2007.5),]; s2

s2 <- s1[clasep == 1952.5, ][,  PH := round(H * 100) ][, PM := round(M * 100)] ; s2
max(s2$PH) - min(s2$PH);  max(s2$PM) - min(s2$PM)

s2 <- s1[clasep == 2007.5, ][,  PH := round(H * 100) ][, PM := round(M * 100)] ; s2
max(s2$PH) - min(s2$PH);  max(s2$PM) - min(s2$PM)


s2 <- s1[order(Codigo),][,  PH := round(H * 100) ][, PM := round(M * 100)][
  ,   c('clasep' , 'Codigo', 'PH' , 'PM'), with = F]
s2b <- s1[order(Codigo),][,  PH := round(H * 100) ][, PM := round(M * 100)][
  Codigo == "CO",   c('clasep' , 'Codigo', 'PH' , 'PM'), with = F]
s3 <- merge(s2 , s2b, by = c('clasep') )
s3[, DH := PH.x- PH.y][, DM := PM.x- PM.y]; s3[order(Codigo.x, clasep),]


#  ALC Potencial de años vividos 15 39 ---------------------------------------------
mah <- fread('tvhombres.csv')
mam <- fread('tvmujeres.csv')

mah$sexo <- "H" ; mam$sexo <- "M"
ma <- rbind(mah, mam)

setnames(ma, c(3, 8, 9, 11, 13, 14, 15, 18, 19) , c( "region", "Edad","Intervalo", 'qxn', 
                                                     "lx", "dxn" , "Lxn", "ex", "axn")) 

ma$lxad <-  c( ma[2:nrow(ma),]$lx, NA  ) 
ma[ma$Edad == 85, ]$lxad <- NA

ma$etr <- ma$Intervalo * ma$lxad + ma$dxn * ma$axn 

ma <- data.table(ma)
ma$clasep <- factor(ma$Period, levels = c("1950-1955", "1955-1960", "1960-1965", 
                                          "1965-1970", "1970-1975", "1975-1980", "1980-1985", "1985-1990", 
                                          "1990-1995", "1995-2000", "2000-2005", "2005-2010"),
                    labels = seq(1952.5, 2007.5, 5) )

potem <- ma[ Edad %in%  c(15,20,25,30,35), ][
  ,  list(sum(etr), max(lx, na.rm = TRUE) , sum(etr) / (25 * max(lx, na.rm = TRUE) )  ) , 
  keyby = list(Codigo, sexo,  clasep)]

setnames(potem, 6, 'pt')

dpotem <- dcast(potem,  clasep + Codigo ~ sexo, value.var ='pt')

s1 <- subset(dpotem, Codigo %in% c('CU','CL','CR', 'AR', 'MX','CO')  )
s1$Codigo <- factor(s1$Codigo, levels = c('CL','CU','AR','CR', 'MX','CO') ) 
s1$clasep <- as.numeric(as.character(s1$clasep))

sizet <- 12.5

p1 <- ggplot(  ) + 
  geom_vline(xintercept = seq(1950, 2010, 5), colour = '#f0f0f0', linetype = '22') + 
  geom_hline(yintercept = seq(.935, 1, .005), colour = '#f0f0f0', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2010, 10), colour = '#EAEAEA', linetype = '22') + 
  geom_hline(yintercept = seq(.935, 1, .010), colour = '#EAEAEA', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2010, 20), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = seq(.935, 1, .020), colour = '#E4E4E4', linetype = '22') +
  geom_line(data= s1,
            aes(clasep, H, colour = Codigo, linetype = Codigo, group = Codigo), size = 1.6) + 
  theme_bw(base_size = 14) + scale_colour_tableau() + 
  scale_y_continuous(name = 'Potencial de años vividos',lim = c(.935, 1), breaks = seq(.94, 1, .01),
                     labels = percent ) +
  scale_linetype_manual(values = c('solid', '51', '11', 'solid','51', '11','solid', '51','11')) +
  scale_x_continuous(name = 'Año',lim = c(1947, 2013), breaks = seq(1950, 2010, 20) ) + 
  geom_dl(aes(x = s1$clasep, y = s1$H, label = s1$Codigo,  colour = s1$Codigo),
          list(dl.combine(first.bumpup), cex = 1.2))+ ggtitle('Hombres') + 
  theme(legend.position = '',
        axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        title = element_text(size = sizet, family="Helvetica")   ,
        panel.grid = element_blank()  ) + 
  annotate('rect',  xmin = 1980, xmax = 2010, ymin = .935, ymax = .96,    alpha = .2)


p2 <- ggplot(  ) + 
  geom_vline(xintercept = seq(1950, 2010, 5), colour = '#f0f0f0', linetype = '22') + 
  geom_hline(yintercept = seq(.935, 1, .005), colour = '#f0f0f0', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2010, 10), colour = '#EAEAEA', linetype = '22') + 
  geom_hline(yintercept = seq(.935, 1, .010), colour = '#EAEAEA', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2010, 20), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = seq(.935, 1, .020), colour = '#E4E4E4', linetype = '22') +
  geom_line(data= s1,
            aes(clasep, M, colour = Codigo, linetype = Codigo, group = Codigo), size = 1.6) + 
  theme_bw(base_size = 14) + scale_colour_tableau() + 
  scale_y_continuous(name = '',lim = c(.935, 1), breaks = seq(.94, 1, .01),  labels = percent ) +
  scale_linetype_manual(values = c('solid', '51', '11', 'solid','51', '11','solid', '51','11')) +
  scale_x_continuous(name = 'Año',lim = c(1947, 2013), breaks = seq(1950, 2010, 20) ) + 
  geom_dl(aes(x = s1$clasep, y = s1$M, label = s1$Codigo,  colour = s1$Codigo),
          list(dl.combine(first.bumpup), cex = 1.2))+ ggtitle('Mujeres') + 
  theme(legend.position = 'none',
        axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        title = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank() ) 

pdf(file = "GRexppt1539.pdf", width = 8,   height = 6, family = "Helvetica")
print(
  grid.arrange( p1, p2, nrow=1)
)
dev.off()


s1 <- data.table(s1)
s2 <- s1[order(Codigo),][,  PH := round(H * 100, 1) ][, PM := round(M * 100, 1)][
  , c('clasep' , 'Codigo', 'PH' , 'PM'), with = F][,PD := PM - PH][
    clasep %in% c(seq(1952.5, 2002.5, 10), 2007.5),]; s2


s1 <- data.table(s1)
s2a <- s1[order(Codigo),][,  PH := round(H * 100, 1) ][, PM := round(M * 100, 1)][
  , c('clasep' , 'Codigo', 'PH' , 'PM'), with = F][,PD := PM - PH][
    Codigo == 'CO',]
s2b <- s1[order(Codigo),][,  PH := round(H * 100, 1) ][, PM := round(M * 100, 1)][
  , c('clasep' , 'Codigo', 'PH' , 'PM'), with = F][,PD := PM - PH]
s3 <- merge(s2a, s2b , by = c('clasep') )
s3[order( Codigo.y ,  clasep), ][, c('clasep' , 'Codigo.x', 'PM.x', 'Codigo.y', 'PM.y'), with = F]


s1 <- data.table(s1)
s2a <- s1[order(Codigo),][,  PH := round(H * 100, 1) ][, PM := round(M * 100, 1)][
  , c('clasep' , 'Codigo', 'PH' , 'PM'), with = F][,PD := PM - PH][
    Codigo == 'CO',]
s2b <- s1[order(Codigo),][,  PH := round(H * 100, 1) ][, PM := round(M * 100, 1)][
  , c('clasep' , 'Codigo', 'PH' , 'PM'), with = F][,PD := PM - PH]
s3 <- merge(s2a, s2b , by = c('clasep') )
s3[, DH := PH.y -PH.x][, DM := PM.y -PM.x][
  , c('clasep' , 'Codigo.x', 'Codigo.y', 'DH', 'DM'), with = F][order(Codigo.y,  clasep), ]

s3[, list(clasep[which.max(DH)], max(DH) ) , keyby = list(Codigo.x, Codigo.y  )]
s3[, list(clasep[which.max(DM)], max(DM) ) , keyby = list(Codigo.x, Codigo.y  )]

s3[, list(clasep[which.min(DH)], min(DH) ) , keyby = list(Codigo.x, Codigo.y  )]
s3[, list(clasep[which.min(DM)], min(DM) ) , keyby = list(Codigo.x, Codigo.y  )]



# ALC Potencial de años vividos 5 14 ---------------------------------------------
mah <- fread('tvhombres.csv')
mam <- fread('tvmujeres.csv')

mah$sexo <- "H" ; mam$sexo <- "M"
ma <- rbind(mah, mam)

setnames(ma, c(3, 8, 9, 11, 13, 14, 15, 18, 19) , c( "region", "Edad","Intervalo", 'qxn', 
                                                     "lx", "dxn" , "Lxn", "ex", "axn")) 

ma$lxad <-  c( ma[2:nrow(ma),]$lx, NA  ) 
ma[ma$Edad == 85, ]$lxad <- NA

ma$etr <- ma$Intervalo * ma$lxad + ma$dxn * ma$axn 

ma <- data.table(ma)
ma$clasep <- factor(ma$Period, levels = c("1950-1955", "1955-1960", "1960-1965", 
                                          "1965-1970", "1970-1975", "1975-1980", "1980-1985", "1985-1990", 
                                          "1990-1995", "1995-2000", "2000-2005", "2005-2010"),
                    labels = seq(1952.5, 2007.5, 5) )

pot514 <- ma[ Edad %in%  c(5, 10), ][
  ,  list(sum(etr), max(lx, na.rm = TRUE) , sum(etr) / (10 * max(lx, na.rm = TRUE) )  ) , 
  keyby = list(Codigo, region, sexo, Period, clasep)]

setnames(pot514, 8, 'pt')

dpot514 <- dcast(pot514, region + Period+ clasep + Codigo ~ sexo, value.var ='pt')

s1 <- subset(dpot514, Codigo %in% c('CU','CL','CR', 'AR', 'MX','CO')  )
s1$Codigo <- factor(s1$Codigo, levels = c('CU','CL','CR', 'AR', 'MX','CO') ) 
s1$clasep <- as.numeric(as.character(s1$clasep))

p1 <- ggplot(  ) + 
  geom_line(data= s1,
            aes(clasep, H, colour = Codigo, linetype = Codigo, group = Codigo), size = 1.6) + 
  theme_bw(base_size = 14) + scale_colour_tableau() + 
  scale_y_continuous(name = 'Potencial de años vividos',lim = c(.98, 1), breaks = seq(.98, 1, .005),
                     labels = percent ) +
  scale_linetype_manual(values = c('solid', '51', '11', 'solid','51', '11','solid', '51','11')) +
  scale_x_continuous(name = 'Año',lim = c(1947, 2013), breaks = seq(1950, 2010, 10) ) + 
  geom_dl(aes(x = s1$clasep, y = s1$H, label = s1$Codigo,  colour = s1$Codigo),
          list(dl.combine(first.bumpup), cex = 1.2)) + ggtitle('Hombres') + 
  theme(legend.position = '',
        axis.text.x = element_text( size = 12, family="Helvetica"),
        axis.text.y = element_text(size = 12, family="Helvetica"),  
        axis.title.x = element_text(size = 12, family="Helvetica"),
        axis.title.y = element_text(size = 12, family="Helvetica"),
        title = element_text(size = 12, family="Helvetica")) 


p2 <- ggplot(  ) + 
  geom_line(data= s1,
            aes(clasep, M, colour = Codigo, linetype = Codigo, group = Codigo), size = 1.6) + 
  theme_bw(base_size = 14) + scale_colour_tableau() + 
  scale_y_continuous(name = '',lim = c(.98, 1), breaks = seq(.98, 1, .005),
                     labels = percent ) +
  scale_linetype_manual(values = c('solid', '51', '11', 'solid','51', '11','solid', '51','11')) +
  scale_x_continuous(name = 'Año',lim = c(1947, 2013), breaks = seq(1950, 2010, 10) ) + 
  geom_dl(aes(x = s1$clasep, y = s1$M, label = s1$Codigo,  colour = s1$Codigo),
          list(dl.combine(first.bumpup), cex = 1.2)) + ggtitle('Mujeres')+ 
  theme(legend.position = 'none',
        axis.text.x = element_text( size = 12, family="Helvetica"),
        axis.text.y = element_text(size = 12, family="Helvetica"),  
        axis.title.x = element_text(size = 12, family="Helvetica"),
        axis.title.y = element_text(size = 12, family="Helvetica"),
        title = element_text(size = 12, family="Helvetica"))  

pdf(file = "GRexppt514.pdf", width = 8,   height = 6, family = "Helvetica")
print(  grid.arrange( p1, p2, nrow=1))
dev.off()

s1 <- data.table(s1)
s1$H <- s1$H * 100  ; s1$M <- s1$M * 100
xtable(s1[Period %in% c( "1955-1960",   "2005-2010")][
  , c('region',  'Period', 'H', 'M') , with = F])


s1[Period %in% c( "1955-1960",   "2005-2010")][
  , c('region',  'Period', 'H', 'M') , with = F][order(Period, M)]


# ALC Potencial de años vividos 40 64 ---------------------------------------------
mah <- fread('tvhombres.csv')
mam <- fread('tvmujeres.csv')

mah$sexo <- "H" ; mam$sexo <- "M"
ma <- rbind(mah, mam)

setnames(ma, c(3, 8, 9, 11, 13, 14, 15, 18, 19) , c( "region", "Edad","Intervalo", 'qxn', 
                                                     "lx", "dxn" , "Lxn", "ex", "axn")) 

ma$lxad <-  c( ma[2:nrow(ma),]$lx, NA  ) 
ma[ma$Edad == 85, ]$lxad <- NA

ma$etr <- ma$Intervalo * ma$lxad + ma$dxn * ma$axn 

ma <- data.table(ma)
ma$clasep <- factor(ma$Period, levels = c("1950-1955", "1955-1960", "1960-1965", 
                                          "1965-1970", "1970-1975", "1975-1980", "1980-1985", "1985-1990", 
                                          "1990-1995", "1995-2000", "2000-2005", "2005-2010"),
                    labels = seq(1952.5, 2007.5, 5) )

pot4064 <- ma[ Edad %in%  c(40, 45, 50, 55, 60), ][
  ,  list(sum(etr), max(lx, na.rm = TRUE) , sum(etr) / (25 * max(lx, na.rm = TRUE) )  ) , 
  keyby = list(Codigo, sexo,  clasep)]

setnames(pot4064, 6, 'pt')

dpot4064 <- dcast(pot4064,  clasep + Codigo ~ sexo, value.var ='pt')

s1 <- subset(dpot4064, Codigo %in% c('CU','CL','CR', 'AR', 'MX','CO')  )
s1$Codigo <- factor(s1$Codigo, levels = c('CU','CL','CR', 'AR', 'MX','CO') ) 
s1$clasep <- as.numeric(as.character(s1$clasep))

sizet <- 12

p1 <- ggplot(  ) + 
  geom_vline(xintercept = seq(1950, 2010, 5), colour = '#f0f0f0', linetype = '22') + 
  geom_hline(yintercept = seq(.82, 1, .005), colour = '#f0f0f0', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2010, 10), colour = '#EAEAEA', linetype = '22') + 
  geom_hline(yintercept = seq(.82, 1, .010), colour = '#EAEAEA', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2010, 20), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = seq(.82, 1, .020), colour = '#E4E4E4', linetype = '22') +
  geom_line(data= s1,
            aes(clasep, H, colour = Codigo, linetype = Codigo, group = Codigo), size = 1.6) + 
  theme_bw(base_size = 14) + scale_colour_tableau() + 
  scale_y_continuous(name = 'Potencial de años vividos', lim = c(.82, 1), breaks = seq(.82, 1, .02),
                     labels = percent ) +
  scale_linetype_manual(values = c('solid', '51', '11', 'solid','51', '11','solid', '51','11')) +
  scale_x_continuous(name = 'Año',lim = c(1947, 2013), breaks = seq(1950, 2010, 10) ) + 
  geom_dl(aes(x = s1$clasep, y = s1$H, label = s1$Codigo,  colour = s1$Codigo),
          list(dl.combine(first.bumpup), cex = 1.2)) + 
  theme(legend.position = '',
        axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        title = element_text(size = sizet, family="Helvetica")   ,
        panel.grid = element_blank()  ) + 
  ggtitle('Hombres')

p2 <- ggplot(  ) + 
  geom_vline(xintercept = seq(1950, 2010, 5), colour = '#f0f0f0', linetype = '22') + 
  geom_hline(yintercept = seq(.82, 1, .005), colour = '#f0f0f0', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2010, 10), colour = '#EAEAEA', linetype = '22') + 
  geom_hline(yintercept = seq(.82, 1, .010), colour = '#EAEAEA', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2010, 20), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = seq(.82, 1, .020), colour = '#E4E4E4', linetype = '22') +
  geom_line(data= s1,
            aes(clasep, M, colour = Codigo, linetype = Codigo, group = Codigo), size = 1.6) + 
  theme_bw(base_size = 14) + scale_colour_tableau() + 
  scale_y_continuous(name = '',lim = c(.82, 1), breaks = seq(.82, 1, .02),
                     labels = percent ) +
  scale_linetype_manual(values = c('solid', '51', '11', 'solid','51', '11','solid', '51','11')) +
  scale_x_continuous(name = 'Año',lim = c(1947, 2013), breaks = seq(1950, 2010, 10) ) + 
  geom_dl(aes(x = s1$clasep, y = s1$M, label = s1$Codigo,  colour = s1$Codigo),
          list(dl.combine(first.bumpup), cex = 1.2)) + 
  theme(legend.position = '',
        axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        title = element_text(size = sizet, family="Helvetica")   ,
        panel.grid = element_blank()  ) + 
  ggtitle('Mujeres')

pdf(file = "GRexppt4064.pdf", width = 8,   height = 6, family = "Helvetica")
print(  grid.arrange( p1, p2, nrow=1))
dev.off()


s1 <- data.table(s1)
s2 <- s1[order(Codigo),][,  PH := round(H * 100, 1) ][, PM := round(M * 100, 1)][
  , c('clasep' , 'Codigo', 'PH' , 'PM'), with = F][,PD := PM - PH]; s2


s1 <- data.table(s1)
s2a <- s1[order(Codigo),][,  PH := round(H * 100, 1) ][
  , PM := round(M * 100, 1)][
  , c('clasep' , 'Codigo', 'PH' , 'PM'), with = F][,PD := PM - PH][
    Codigo == 'CO',]
s2b <- s1[order(Codigo),][,  PH := round(H * 100, 1) ][
  , PM := round(M * 100, 1)][
  , c('clasep' , 'Codigo', 'PH' , 'PM'), with = F][,PD := PM - PH]
s3 <- merge(s2a, s2b , by = c('clasep') )
(s3[order( Codigo.y ,  clasep), ][
  , c('clasep' , 'Codigo.x', 'PM.x', 'Codigo.y', 'PM.y'), with = F][
    , B := PM.y - PM.x])
(s3[order( Codigo.y ,  clasep), ][
  , c('clasep' , 'Codigo.x', 'PH.x', 'Codigo.y', 'PH.y'), with = F][
    , B := PH.y - PH.x])

s1 <- data.table(s1)
s2a <- s1[order(Codigo),][,  PH := round(H * 100, 1) ][, PM := round(M * 100, 1)][
  , c('clasep' , 'Codigo', 'PH' , 'PM'), with = F][,PD := PM - PH][
    Codigo == 'CO',]
s2b <- s1[order(Codigo),][,  PH := round(H * 100, 1) ][, PM := round(M * 100, 1)][
  , c('clasep' , 'Codigo', 'PH' , 'PM'), with = F][,PD := PM - PH]
s3 <- merge(s2a, s2b , by = c('clasep') )
s3[, DH := PH.y -PH.x][, DM := PM.y -PM.x][
  , c('clasep' , 'Codigo.x', 'Codigo.y', 'DH', 'DM'), 
  with = F][order(Codigo.y,  clasep), ]


s3[, list(clasep[which.max(DH)], max(DH) ) , 
   keyby = list(Codigo.x, Codigo.y  )]
s3[, list(clasep[which.max(DM)], max(DM) ) , 
   keyby = list(Codigo.x, Codigo.y  )]

s3[, list(clasep[which.min(DH)], min(DH) ) , 
   keyby = list(Codigo.x, Codigo.y  )]
s3[, list(clasep[which.min(DM)], min(DM) ) , 
   keyby = list(Codigo.x, Codigo.y  )]


# ALC Potencial de años vividos 65 79 ---------------------------------------------
mah <- fread('tvhombres.csv')
mam <- fread('tvmujeres.csv')

mah$sexo <- "H" ; mam$sexo <- "M"
ma <- rbind(mah, mam)

setnames(ma, c(3, 8, 9, 11, 13, 14, 15, 18, 19) , c( "region", "Edad","Intervalo", 'qxn', 
                                                     "lx", "dxn" , "Lxn", "ex", "axn")) 

ma$lxad <-  c( ma[2:nrow(ma),]$lx, NA  ) 
ma[ma$Edad == 85, ]$lxad <- NA

ma$etr <- ma$Intervalo * ma$lxad + ma$dxn * ma$axn 

ma <- data.table(ma)
ma$clasep <- factor(ma$Period, levels = c("1950-1955", "1955-1960", "1960-1965", 
                                          "1965-1970", "1970-1975", "1975-1980", "1980-1985", "1985-1990", 
                                          "1990-1995", "1995-2000", "2000-2005", "2005-2010"),
                    labels = seq(1952.5, 2007.5, 5) )

pot6579 <- ma[ Edad %in%  c(65 , 70, 75, 79), ][
  ,  list(sum(etr), max(lx, na.rm = TRUE) , sum(etr) / (20 * max(lx, na.rm = TRUE) )  ) , 
  keyby = list(Codigo, sexo,  clasep)]

setnames(pot6579, 6, 'pt')

dpot6579 <- dcast(pot6579,  clasep + Codigo ~ sexo, value.var ='pt')

s1 <- subset(dpot6579, Codigo %in% c('CU','CL','CR', 'AR', 'MX','CO')  )
s1$Codigo <- factor(s1$Codigo, levels = c('CU','CL','CR', 'AR', 'MX','CO') ) 
s1$clasep <- as.numeric(as.character(s1$clasep))

sizet <- 12

p1 <- ggplot(  ) + 
  geom_vline(xintercept = seq(1950, 2010, 5), colour = '#f0f0f0', linetype = '22') + 
  geom_hline(yintercept = seq(.5, .7, .05), colour = '#f0f0f0', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2010, 10), colour = '#EAEAEA', linetype = '22') + 
  geom_hline(yintercept = seq(.5, .7, .05), colour = '#EAEAEA', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2010, 20), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = seq(.5, .7, .05), colour = '#E4E4E4', linetype = '22') +
  geom_line(data= s1,
            aes(clasep, H, colour = Codigo, linetype = Codigo, group = Codigo), size = 1.6) + 
  theme_bw(base_size = 14) + scale_colour_tableau() + 
  scale_y_continuous(name = 'Potencial de años vividos', lim = c(.48, .7), breaks = seq(.5, .7, .05),
                     labels = percent ) +
  scale_linetype_manual(values = c('solid', '51', '11', 'solid','51', '11','solid', '51','11')) +
  scale_x_continuous(name = 'Año',lim = c(1947, 2013), breaks = seq(1950, 2010, 10) ) + 
  geom_dl(aes(x = s1$clasep, y = s1$H, label = s1$Codigo,  colour = s1$Codigo),
          list(dl.combine(first.bumpup), cex = 1.2)) + 
  theme(legend.position = '',
        axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        title = element_text(size = sizet, family="Helvetica")   ,
        panel.grid = element_blank()  ) + 
  ggtitle('Hombres')

p2 <- ggplot(  ) + 
  geom_vline(xintercept = seq(1950, 2010, 5), colour = '#f0f0f0', linetype = '22') + 
  geom_hline(yintercept = seq(.5, .7, .05), colour = '#f0f0f0', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2010, 10), colour = '#EAEAEA', linetype = '22') + 
  geom_hline(yintercept = seq(.5, .7, .05), colour = '#EAEAEA', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2010, 20), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = seq(.5, .7, .05), colour = '#E4E4E4', linetype = '22') +
  geom_line(data= s1,
            aes(clasep, M, colour = Codigo, linetype = Codigo, group = Codigo), size = 1.6) + 
  theme_bw(base_size = 14) + scale_colour_tableau() + 
  scale_y_continuous(name = '', lim = c(.48, .7), breaks = seq(.5, .7, .05),
                     labels = percent ) +
  scale_linetype_manual(values = c('solid', '51', '11', 'solid','51', '11','solid', '51','11')) +
  scale_x_continuous(name = 'Año',lim = c(1947, 2013), breaks = seq(1950, 2010, 10) ) + 
  geom_dl(aes(x = s1$clasep, y = s1$M, label = s1$Codigo,  colour = s1$Codigo),
          list(dl.combine(first.bumpup), cex = 1.2)) + 
  theme(legend.position = '',
        axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        title = element_text(size = sizet, family="Helvetica")   ,
        panel.grid = element_blank()  ) + 
  ggtitle('Mujeres')


pdf(file = "GRexppt6579.pdf", width = 8,   height = 6, family = "Helvetica")
print(  grid.arrange( p1, p2, nrow=1))
dev.off()



s1 <- data.table(s1)
s2 <- s1[order(Codigo),][,  PH := round(H * 100, 1) ][, PM := round(M * 100, 1)][
  , c('clasep' , 'Codigo', 'PH' , 'PM'), with = F][,PD := PM - PH]; s2


s1 <- data.table(s1)
s2a <- s1[order(Codigo),][,  PH := round(H * 100, 1) ][
  , PM := round(M * 100, 1)][
    , c('clasep' , 'Codigo', 'PH' , 'PM'), with = F][,PD := PM - PH][
      Codigo == 'CO',]
s2b <- s1[order(Codigo),][,  PH := round(H * 100, 1) ][
  , PM := round(M * 100, 1)][
    , c('clasep' , 'Codigo', 'PH' , 'PM'), with = F][,PD := PM - PH]
s3 <- merge(s2a, s2b , by = c('clasep') )
(s3[order( Codigo.y ,  clasep), ][
  , c('clasep' , 'Codigo.x', 'PM.x', 'Codigo.y', 'PM.y'), with = F][
    , B := PM.y - PM.x])
(s3[order( Codigo.y ,  clasep), ][
  , c('clasep' , 'Codigo.x', 'PH.x', 'Codigo.y', 'PH.y'), with = F][
    , B := PH.y - PH.x])

s1 <- data.table(s1)
s2a <- s1[order(Codigo),][,  PH := round(H * 100, 1) ][, PM := round(M * 100, 1)][
  , c('clasep' , 'Codigo', 'PH' , 'PM'), with = F][,PD := PM - PH][
    Codigo == 'CO',]
s2b <- s1[order(Codigo),][,  PH := round(H * 100, 1) ][, PM := round(M * 100, 1)][
  , c('clasep' , 'Codigo', 'PH' , 'PM'), with = F][,PD := PM - PH]
s3 <- merge(s2a, s2b , by = c('clasep') )
s3[, DH := PH.y -PH.x][, DM := PM.y -PM.x][
  , c('clasep' , 'Codigo.x', 'Codigo.y', 'DH', 'DM'), 
  with = F][order(Codigo.y,  clasep), ]


s3[, list(clasep[which.max(DH)], max(DH) ) , 
   keyby = list(Codigo.x, Codigo.y  )]
s3[, list(clasep[which.max(DM)], max(DM) ) , 
   keyby = list(Codigo.x, Codigo.y  )]

s3[, list(clasep[which.min(DH)], min(DH) ) , 
   keyby = list(Codigo.x, Codigo.y  )]
s3[, list(clasep[which.min(DM)], min(DM) ) , 
   keyby = list(Codigo.x, Codigo.y  )]



# GR25 ALC Boxplot qx entre  5 y  79 años  --------------------------------------------
mah <- fread('tvhombres.csv')
mam <- fread('tvmujeres.csv')

mah$sexo <- "H" ; mam$sexo <- "M"
ma <- rbind(mah, mam)

setnames(ma, c(3,8,9,11, 14, 18) , c( "Pais", "Edad","Intervalo", 'qxn',"dxn" , "ex")) 

ma$Edad <- as.numeric( as.character(ma$Edad) )

ma <- ma[Edad %in% seq(5, 75, 5) & Period %in% c('1955-1960',     '2005-2010') &
            Codigo %in% c("CR", "SV", "MX", "NI", "PA", "AR", "BR", "CL", "PY", "UY", 
                           "CU", "DO", "HT", "JM", "TT", "BO", "CO", "EC", "PE", "VE", 
                           "GT", "HN") , ]

ma$edadcl <-  ma$Edad + (ma$Interv / 2)

ma$Edadg <- factor(ma$edadcl, levels = seq(7.5, 77.5, 5),
                   labels = c('5 - 9', '10 - 14',  '15 - 19',
                              '20 - 24',  '25 - 29','30 - 34',
                              '35 - 39',  '40 - 44',    '45 - 49',    '50 - 54',
                              '55 - 59',    '60 - 64',    '65 - 69',
                              '70 - 74',      '75 - 79'              ) )

ma$qxn <- as.numeric( as.character(ma$qxn) )
# maco <- subset(ma, Codigo == 'CO')
# maco$sexob <- factor(maco$sexo, levels = c('H', 'M'), labels = c( 'H - CO','M - CO' ) )

ma$sexob <- factor(ma$sexo, levels = c('H', 'M'), labels = c( 'H - CO','M - CO' ) )

g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

sizet <- 12.2

p1 <- ggplot(data = ma ) + 
  geom_boxplot( aes(x = Edadg, y = qxn, colour = sexo, , fill = sexo ), outlier.shape = NA) + 
  facet_wrap( ~ Period) +
  theme_bw(base_size = 16) + 
  scale_fill_manual(name = 'ALC', values = c('white', 'white') ) + 
  scale_colour_manual(name = 'ALC', values = c('#a6cee3', '#fb9a99' ) ) + 
  scale_y_log10(name = expression(log(paste(''[n], q[x])  ) )  ) + xlab('Edad') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", vjust = .5), 
        axis.text.x = element_text(size = sizet, family="Helvetica", vjust = .5, angle = 90),
        legend.position = c(.5,.5), 
        strip.background = element_rect(fill = "white"),
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.text = element_text(size = sizet, family="Helvetica"),
        strip.text.x = element_text(size = sizet + 1, family="Helvetica") ,
        panel.margin = unit(0, "lines"),
        panel.grid = element_blank() ) 

p2 <- ggplot(data = ma ) + 
  geom_point(data = subset(ma, Codigo == 'CO' & sexo == 'H'), 
             aes(x = Edadg, y = qxn, group = sexo, shape = sexo, colour = 'H'),  size = 2.5) +
  geom_point(data = subset(ma, Codigo == 'CO' & sexo == 'M'), 
             aes(x = Edadg, y = qxn, group = sexo, shape = sexo, colour = 'M'),  size = 2.5) +
  facet_wrap( ~ Period) +
  theme_bw(base_size = 16) + 
  scale_shape_manual(name = 'COL',values = c(16, 17) ) + 
  scale_colour_manual(name = 'COL', values = c('H' = '#1f78b4', 'M' = '#e31a1c' ) ) + 
  scale_y_log10(name = expression(log(paste(''[n], q[x])  ) )) + xlab('Edad') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", vjust = .5), 
        axis.text.x = element_text(size = sizet, family="Helvetica", vjust = .5, angle = 90),
        legend.position = c(.5,.5), 
        strip.background = element_rect(fill = "white"),
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.text = element_text(size = sizet, family="Helvetica"),
        strip.text.x = element_text(size = sizet + 1, family="Helvetica") ,
        panel.margin = unit(0, "lines"), panel.grid = element_blank() ) 

mylegend_1<-g_legend(p1)
mylegend_2<-g_legend(p2)


pf <- ggplot(data = ma ) + 
  geom_hline(yintercept = c( .001, .01, .1), colour = '#E4E4E4', linetype = '22') + 
  geom_vline( xintercept = seq(1.5, 15.5, 1), colour = '#f0f0f0', linetype = '22') + 
  geom_vline( xintercept = seq(1.5, 15.5, 2), colour = '#E4E4E4', linetype = '22') + 
  geom_boxplot( aes(x = Edadg, y = qxn, colour = sexo, , fill = sexo ), outlier.shape = NA) + 
  geom_point(data = subset(ma, Codigo == 'CO' & sexo == 'H'), 
             aes(x = Edadg, y = qxn, group = sexo, shape = sexo, colour = 'H'),  size = 2.5, 
             colour = '#1f78b4') +
  geom_point(data = subset(ma, Codigo == 'CO' & sexo == 'M'), 
             aes(x = Edadg, y = qxn, group = sexo, shape = sexo, colour = 'M'),  size = 2.5,
             colour = '#e31a1c') +
  facet_wrap( ~ Period) +
  theme_bw(base_size = 16) + 
  scale_fill_manual(name = 'ALC', values = c('white', 'white') , guide="none") + 
  scale_colour_manual(name = 'ALC', values = c('#a6cee3', '#fb9a99' ), guide="none" ) +
  scale_shape_manual(name = 'COL',values = c(16, 17), guide="none" ) +
  scale_y_log10(name = expression(log(paste(''[n], q[x])  ) )  ) + 
  scale_x_discrete( expand = c(0.1,0.1)  )  +
  xlab('Edad') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", vjust = .5), 
        axis.text.x = element_text(size = sizet, family="Helvetica", vjust = .5, angle = 90),
        strip.background = element_rect(fill = "white"),
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.text = element_text(size = sizet, family="Helvetica"),
        strip.text.x = element_text(size = sizet + 1, family="Helvetica") ,
        panel.margin = unit(0, "lines"),
        panel.grid = element_blank() ) + annotation_logticks(sides = "l") 

pb <- ggplot(data = ma) + geom_blank(aes(x = Edadg, y = qxn, colour = sexo, , fill = sexo ), outlier.shape = NA) +
  theme_tufte() + xlab("") + ylab("") +
  theme(axis.text = element_blank() , axis.ticks = element_blank(),
        panel.margin = unit(0, "lines"), panel.grid = element_blank()   )

pdf(file = 
      "GR25_ALC_Diagrama_de_caja_de_los_cocientes_de_mortalidad_entre_los_5_y_los_79_aos_por_edades_quinquenales_y_sexo.pdf", 
             width = 8,    height = 5.6, family = "Helvetica")
grid.arrange(pf,    arrangeGrob(pb,  mylegend_1, mylegend_2, nrow = 6),  
             ncol = 2, widths=c(7.5, .5) )
dev.off()

ma1 <- ma[ , list( md = quantile(qxn * 1000, probs = .5) ,  q3 = quantile(qxn * 1000, probs = .75)   )  , 
   keyby = list(  sexo, Edadg, Period)   ]
ma2 <- ma[Codigo == 'CO',  ][
  , qxnco := qxn *1000 ][,c('qxnco',  'sexo', 'Edadg', 'Period'), with = F]
ma3 <- merge(ma1, ma2, by = c("sexo", "Edadg", "Period") )
ma4 <- ma3[, qxncob := round(qxnco) ][, mdb := round(md) ][,q3b := round(q3)][, Dme := mdb - qxncob][
  , Dq3 := q3b - qxncob][, c("sexo" ,  "Edadg" , "Period" , "qxncob", "mdb"  , 
                             "q3b"   , "Dme"  ,  "Dq3" ) , with = F]
(ma5 <- ma4[Edadg %in% c('15 - 19' , '20 - 24' , '25 - 29', '30 - 34') ][
  , Dmeb  := Dme < 0 ][    , Dq3b  := Dq3 < 0 ])

ma1 <- ma[ , list( md = round(quantile(qxn * 1000, probs = .5)))  , 
   keyby = list(  sexo, Edadg, Period)   ]
ma2 <- dcast.data.table(ma1,  Edadg  +  Period   ~ sexo , value.var = "md" )
ma2[, MDD := H - M]
ma3 <- dcast.data.table(ma2,  Edadg   ~ Period, value.var="MDD" )
ma3$DifP <- ma3[,4, with =F] - ma3[,2, with =F]

(ma1 <- ma[ , list( q1 = quantile(qxn * 1000, probs = .25) ,  q3 = quantile(qxn * 1000, probs = .75)   )  , 
          keyby = list(  sexo, Edadg, Period)   ][, iqr := q3 - q1])
ma2 <- dcast.data.table(ma1,  Edadg +   Period ~  sexo, value.var = 'iqr' )
ma2[, DI := H / M]


# ALC Sobremortalidad masculina   --------------------------------------------
mah <- fread('tvhombres.csv')
mam <- fread('tvmujeres.csv')

mah$sexo <- "H" ; mam$sexo <- "M"
ma <- rbind(mah, mam)

setnames(ma, c(3,8,9,11, 14, 18) , c( "Pais", "Edad","Intervalo", 'qxn',"dxn" , "ex")) 

ma$Edad <- as.numeric( as.character(ma$Edad) ) 

mas <- ma[Pais %in% c("El Salvador", "Colombia", "Venezuela", 
                      "Puerto Rico", "Brasil", "Panamá", "Chile", "México", "Guatemala", 
                      "Costa Rica", "Ecuador", "Nicaragua", "Uruguay", "República Dominicana", 
                      "Argentina", "Cuba") & 
            Edad <= 75  & Edad >= 0 & Period %in% c('1955-1960',  '1980-1985',
                                                    '2005-2010'), ]

mas$qxn <- as.numeric(as.character(mas$qxn) ) 

mas$edadcl <-  mas$Edad + (mas$Interv / 2)

mas <- mas[, c("Pais", "Period", "edadcl", "qxn", "sexo"), with = F]
mmas <- dcast(mas, Pais + Period + edadcl ~  sexo, value.var = c('qxn'), sum)
mmas <- data.table(mmas)

# b <- mmas[, max(H/M, na.rm = T), keyby = list(Pais)][order(-V1)]
# dput(b[,c(1),with=F])

mmas$Pais <- factor(mmas$Pais, 
                    levels =   c("El Salvador", "Colombia", "Venezuela", 
                                 "Puerto Rico", "Brasil", "Panamá", "Chile", "México", "Guatemala", 
                                 "Costa Rica", "Ecuador", "Nicaragua", "Uruguay", "República Dominicana", 
                                 "Argentina", "Cuba"
                    ),
                    labels =   c("El Salvador", "Colombia", "Venezuela", 
                                 "Puerto Rico", "Brasil", "Panamá", "Chile", "México", "Guatemala", 
                                 "Costa Rica", "Ecuador", "Nicaragua", "Uruguay", "República Dominicana", 
                                 "Argentina", "Cuba"
                    ) )

sizet <- 12

p <-  ggplot(subset(mmas, Pais %in% c("El Salvador", "Colombia", "Venezuela",   "Puerto Rico")  )   , 
             aes(x = edadcl , y = H / M, colour = Period) ) +   
  annotate('rect',  ymin = -Inf, ymax = Inf, xmin = 20, xmax = 30,    alpha = .15 ) +
  geom_vline(xintercept = seq(10, 70, 5), colour = '#f0f0f0', linetype = '22') + 
  geom_hline(yintercept = seq(1, 6, .5), colour = '#f0f0f0', linetype = '22') +
  geom_vline(xintercept = seq(10, 70, 10), colour = '#EAEAEA', linetype = '22') + 
  geom_hline(yintercept = seq(1, 6, 1), colour = '#EAEAEA', linetype = '22') +
  geom_vline(xintercept = seq(10, 70, 10), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = seq(1, 6, 2), colour = '#E4E4E4', linetype = '22') +
  geom_line( aes(group = Period, linetype = Period, size = Period) ) +
  facet_wrap( ~ Pais , ncol = 2) +     theme_bw(base_size = sizet ) + 
  ylab(expression( paste(''[n], q[x]^H) / paste(''[n], q[x]^M)    )) +     
  scale_x_continuous(name = 'Edad', breaks = seq(10, 70 , 10)  ) +
  scale_colour_manual(name = "Periodo",    
                      values = rev(c('#e31a1c', '#fb9a99' ,'#1f78b4')),
                      guide = guide_legend(direction = 'vertical',keywidth = 3, reverse = T) ) +
  scale_size_manual(name = "Periodo", values = c(1.4, 1.5, 1.6),
                    guide = guide_legend(direction = 'vertical',keywidth = 3, reverse = T) ) +
  scale_linetype_manual(name = "Periodo",  values = c("11", "51","solid") ,
                        guide = guide_legend(direction = 'vertical',keywidth = 3, reverse = T))+
  theme(axis.text.y = element_text(size = sizet , family="Helvetica",vjust = .5), 
        axis.text.x = element_text(size = sizet , family="Helvetica", vjust = .5, angle = 90),
        legend.position = 'right', 
        axis.title.x = element_text(size = sizet , family="Helvetica"),
        axis.title.y = element_text(size = sizet , family="Helvetica"),
        legend.text = element_text(size = sizet , family="Helvetica"),
        strip.text = element_text(size = sizet + 1 , family = "Helvetica" ),
        legend.title = element_text(size = sizet + 1, family="Helvetica", face = 'plain'),
        strip.background = element_rect(fill = "white"),
        panel.margin = unit(0, "lines"),
        panel.grid = element_blank()   )


pdf(file = "GR23_ALC_Sobremortalidad_masculina_adulta_198085_y_200005.pdf", 
    width = 8,  height = 5, family = "Helvetica")
print( p)
dev.off()

mmas <- mmas[Pais %in% c("El Salvador", "Colombia", "Venezuela", 
                         "Puerto Rico"), ]

m1 <- mmas[,sm := round(H / M, 2)]
(m1[, list( edadcl[which.max(sm)],  max(sm)  ), keyby = list(Pais , Period)])

m1 <- mmas[,sm := round(H / M, 2)]
m2 <- m1[sm > 2 & Period %in% c("1980-1985", "2005-2010"), ][
  ,                     c("Pais" ,  "Period" , "sm","edadcl"),      with  = F]


m1 <- mmas[,sm := round(H / M, 2)]
m2 <- m1[, c('Pais', 'Period', "edadcl", "sm"  ) , with =F]
m3 <- dcast.data.table(m2, Pais +    edadcl  ~ Period, value.var =  'sm')
setnames(m3, 3:5, c('P1955_60', 'P1980_85', 'P2005_10') )
m3[, CB55_85 :=  round(  (P1980_85 - P1955_60) * 100 / P1955_60 )   ][
  , CB80_05 := round( (P2005_10 - P1980_85) * 100 / P1980_85  ) ][Pais == 'Colombia']


# ALC Descomp cambio  e0 por decenio--------------------------------------------------------------

mah <- fread('tvhombres.csv')
mam <- fread('tvmujeres.csv')

mah$sexo <- "H" ; mam$sexo <- "M"
ma <- rbind(mah, mam)

setnames(ma, c(3, 8, 9, 11, 13, 14, 15, 18, 19) , c( "region", "Edad","Intervalo", 'qxn', 
                                                     "lx", "dxn" , "Lxn", "ex", "axn")) 
ma <- data.table(ma)

ma <- ma[Period %in% c("1955-1960", "1965-1970", "1975-1980",
                       "1985-1990", "1995-2000", "2005-2010"      )]

ma$clasep <- factor(ma$Period, levels = c("1955-1960", 
                                          "1965-1970",  "1975-1980",  "1985-1990", 
                                          "1995-2000",  "2005-2010"),
                    labels = seq(1957.5, 2007.5, 10) )

mas <- ma[Edad  %in% c(0, 1, 5, 20, 40, 60, 80) ,
          c("region", "Codigo", "Period", "Edad","Intervalo", 'qxn', 
            "lx", "dxn" , "Lxn", "ex", "axn", "sexo", "clasep"),          with = F]

mas[ , lxad := c( lx[2:length(lx)] , 0  ) , keyby = list(region, Codigo, Period, sexo ) ]
mas[ , exad := c( ex[2:length(ex)] , 0  ) , keyby = list(region, Codigo, Period, sexo ) ]

masc <- mas
masc$clasep <- factor(masc$Period, levels = c("1955-1960", 
                                              "1965-1970",  "1975-1980",  "1985-1990", 
                                              "1995-2000",  "2005-2010"),
                      labels = c(seq(1967.5, 2007.5, 10), NA) )


mas <- merge(mas, masc,  by = c("region", "sexo", "clasep",  "Edad")   )

mas <- mas[order(region, Codigo.x, Period.x, sexo, Edad), ]

mas[, arria3.tot := (lx.y + lx.x) * (ex.x - ex.y) / (2 * 100000) - 
      (lxad.y + lxad.x) * (exad.x - exad.y) / (2 * 100000)  ]

a <- mas[,  list(  sum(arria3.tot) ),     keyby = list(region, Codigo.x, Period.x, sexo ) ]
b <- mas[Edad == 0, c('region', 'Codigo.x', 'Period.x', 'sexo', 'ex.x','ex.y' ) , with = F][
  , dif := ex.x-ex.y]
c <- merge(a, b, by = c('region', 'Codigo.x', 'Period.x', 'sexo')   )


mass <- mas[ Codigo.x %in% c("CR", "SV", "MX", "NI", "PA", "AR", "BR", "CL", "PY", "UY", 
                             "CU", "DO", "HT", "JM", "TT", "BO",  "EC", "PE", "VE", "CO",
                             "GT", "HN") ,  ]

mass$Edadg <- recode(mass$Edad, " 0 = '0';  1:4 = '1-4'; 5:19= '5-19';
                     20:39 = '20-39'     ; 40:59 = '40-59' ; 60:79= '60-79'; 
                     else = '80+'     " )

mass$Edadg <- factor(mass$Edadg, lev = c("0", "1-4", "5-19", "20-39", "40-59", "60-79", "80+") )

mass$clasep.x <- as.numeric(as.character(mass$clasep))

p.data <- mass
p.data$arria3.tot[p.data$arria3.tot < 0] <- 0
n.data <- mass
n.data$arria3.tot[n.data$arria3.tot > 0] <- 0


sizet <- 10

p1 <- ggplot( ) +  
  geom_blank(data = mass[ Codigo.x == 'CO' & sexo == 'H', ] ,  
             aes(x = Period.x, y = arria3.tot,  fill = Edadg), stat= 'Identity',
             position = 'stack') +
  geom_vline( xintercept = seq(1.5, 5.5, 1), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = seq(-2,8, .5),colour = '#f0f0f0', linetype = '22') +
  geom_hline(yintercept = seq(-2,8, 1), colour = '#EAEAEA', linetype = '22') +  
  geom_hline(yintercept = seq(-2,8, 2), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = 0,colour = '#969696', linetype = 'solid') +
  geom_bar(data = p.data[ Codigo.x == 'CO' & sexo == 'H', ] ,  
           aes(x = Period.x, y = arria3.tot,  fill = Edadg), stat= 'Identity',
           position = 'stack', width = .75) +
  geom_bar(data = n.data[ Codigo.x == 'CO' & sexo == 'H', ] ,  
           aes(x = Period.x, y = arria3.tot,  fill = Edadg), stat= 'Identity',
           position = 'stack', width = .75) +
  theme_bw(base_size = sizet)+ guides(fill = guide_legend(reverse=TRUE))+ 
  ggtitle('En la esperanza de vida de los hombres') + 
  xlab('Periodo') +   scale_fill_manual(name = "Edad" , 
                                        values = c("#FFBB78", "#2CA02C", "#98DF8A", 
                                                   "#D62728", "#FF9896", "#9467BD", "#C5B0D5"),
                                        breaks = c('0', '1-4', '5-19', '20-39', '40-59', '60-79', '80+' )   ) +
  scale_colour_manual(name = "Edad" , 
                      values = c("#FFBB78", "#2CA02C", "#98DF8A", 
                                 "#D62728", "#FF9896", "#9467BD", "#C5B0D5"),
                      breaks = c('0', '1-4', '5-19', '20-39', '40-59', '60-79', '80+' )  ) +
  scale_y_continuous(name = "Contribución", limits = c(-1, 8), breaks = seq(-10, 25, 1)) +
  scale_x_discrete(name = 'Año',  breaks = c("1965-1970", "1975-1980", "1985-1990", 
                                             "1995-2000", "2005-2010"  ), 
                   labels = c(" 1957\n/ 1967  ", " 1967\n/ 1977  ", " 1977\n/ 1987  ", 
                              " 1987\n/ 1997  ", " 1997\n/ 2007  "  )  ) +
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.title = element_text(size = sizet, family="Helvetica", face = 'plain'),
        legend.text = element_text(size = sizet, family="Helvetica"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.ticks.x = element_blank())  + ggtitle('Colombia. Hombres') + guides(fill = FALSE)

p2 <- ggplot( ) + 
  geom_blank(data = mass[ Codigo.x == 'CO' & sexo == 'M', ] ,  
             aes(x = Period.x, y = arria3.tot,  fill = Edadg), stat= 'Identity',
             position = 'stack') +
  geom_vline( xintercept = seq(1.5, 5.5, 1), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = seq(-2,8, .5),colour = '#f0f0f0', linetype = '22') +
  geom_hline(yintercept = seq(-2,8, 1), colour = '#EAEAEA', linetype = '22') +  
  geom_hline(yintercept = seq(-2,8, 2), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = 0,colour = '#969696', linetype = 'solid') +
  geom_bar(data = p.data[ Codigo.x == 'CO' & sexo == 'M', ] ,  
           aes(x = Period.x, y = arria3.tot,  fill = Edadg), stat= 'Identity',
           position = 'stack', width = .75) +
  geom_bar(data = n.data[ Codigo.x == 'CO' & sexo == 'M', ] ,  
           aes(x = Period.x, y = arria3.tot,  fill = Edadg), stat= 'Identity',
           position = 'stack', width = .75) +
  theme_bw(base_size = sizet)+ guides(fill = guide_legend(reverse=TRUE))+ 
  ggtitle('En la esperanza de vida de los hombres') + 
  xlab('Periodo') +   scale_fill_manual(name = "Edad" , 
                                        values = c('#d73027','#fc8d59','#fee090','#ffffbf','#e0f3f8','#91bfdb', '#4575b4'),
                                        breaks = c('0', '1-4', '5-19', '20-39', '40-59', '60-79', '80+' )   ) +
  scale_colour_manual(name = "Edad" , 
                      values = c('#d73027','#fc8d59','#fee090','#ffffbf','#e0f3f8','#91bfdb', '#4575b4'),
                      breaks = c('0', '1-4', '5-19', '20-39', '40-59', '60-79', '80+' )  ) +
  scale_y_continuous(name = "Contribución", limits = c(-1, 8), breaks = seq(-10, 25, 1)) +
  scale_x_discrete(name = 'Año',  breaks = c("1965-1970", "1975-1980", "1985-1990", 
                                             "1995-2000", "2005-2010"  ), 
                   labels = c(" 1957\n/ 1967  ", " 1967\n/ 1977  ", " 1977\n/ 1987  ", 
                              " 1987\n/ 1997  ", " 1997\n/ 2007  "  )  ) +
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.title = element_text(size = sizet, family="Helvetica", face = 'plain'),
        legend.text = element_text(size = sizet, family="Helvetica"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.ticks.x = element_blank())  + ggtitle('Colombia. Mujeres') + guides(fill = FALSE)

p3 <- ggplot( ) + 
  geom_vline( xintercept = seq(1.5, 5.5, 1), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = seq(-2,8, .5),colour = '#f0f0f0', linetype = '22') +
  geom_hline(yintercept = seq(-2,8, 1), colour = '#EAEAEA', linetype = '22') +  
  geom_hline(yintercept = seq(-2,8, 2), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = 0,colour = '#969696', linetype = 'solid') +
  geom_blank(data = mass[ Codigo.x == 'CL' & sexo == 'H', ] ,  
             aes(x = Period.x, y = arria3.tot,  fill = Edadg), stat= 'Identity',
             position = 'stack') +
  geom_bar(data = p.data[ Codigo.x == 'CL' & sexo == 'H', ] ,  
           aes(x = Period.x, y = arria3.tot,  fill = Edadg), stat= 'Identity',
           position = 'stack', width = .75) +
  geom_bar(data = n.data[ Codigo.x == 'CL' & sexo == 'H', ] ,  
           aes(x = Period.x, y = arria3.tot,  fill = Edadg), stat= 'Identity',
           position = 'stack', width = .75) +
  theme_bw(base_size = sizet)+ guides(fill = guide_legend(reverse=TRUE))+ 
  ggtitle('En la esperanza de vida de los hombres') + 
  xlab('Periodo') +   scale_fill_manual(name = "Edad" , 
                                        values = c('#d73027','#fc8d59','#fee090','#ffffbf','#e0f3f8','#91bfdb', '#4575b4'),
                                        breaks = c('0', '1-4', '5-19', '20-39', '40-59', '60-79', '80+' )   ) +
  scale_colour_manual(name = "Edad" , 
                      values = c('#d73027','#fc8d59','#fee090','#ffffbf','#e0f3f8','#91bfdb', '#4575b4'),
                      breaks = c('0', '1-4', '5-19', '20-39', '40-59', '60-79', '80+' )  ) +
  scale_y_continuous(name = "Contribución", limits = c(-1, 8), breaks = seq(-10, 25, 1)) +
  scale_x_discrete(name = 'Año',  breaks = c("1965-1970", "1975-1980", "1985-1990", 
                                             "1995-2000", "2005-2010"  ), 
                   labels = c(" 1957\n/ 1967  ", " 1967\n/ 1977  ", " 1977\n/ 1987  ", 
                              " 1987\n/ 1997  ", " 1997\n/ 2007  "  )  ) +
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.title = element_text(size = sizet, family="Helvetica", face = 'plain'),
        legend.text = element_text(size = sizet, family="Helvetica"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.ticks.x = element_blank()) + ggtitle('Chile. Hombres') + guides(fill=FALSE)

p4 <- ggplot( ) + 
  geom_blank(data = mass[ Codigo.x == 'CL' & sexo == 'M', ] ,  
             aes(x = Period.x, y = arria3.tot,  fill = Edadg), stat= 'Identity',
             position = 'stack') +
  geom_vline( xintercept = seq(1.5, 5.5, 1), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = seq(-2,8, .5),colour = '#f0f0f0', linetype = '22') +
  geom_hline(yintercept = seq(-2,8, 1), colour = '#EAEAEA', linetype = '22') +  
  geom_hline(yintercept = seq(-2,8, 2), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = 0,colour = '#969696', linetype = 'solid') +
  geom_bar(data = p.data[ Codigo.x == 'CL' & sexo == 'M', ] ,  
           aes(x = Period.x, y = arria3.tot,  fill = Edadg), stat= 'Identity',
           position = 'stack', width = .75) +
  geom_bar(data = n.data[ Codigo.x == 'CL' & sexo == 'M', ] ,  
           aes(x = Period.x, y = arria3.tot,  fill = Edadg), stat= 'Identity',
           position = 'stack', width = .75) +
  theme_bw(base_size = sizet)+ guides(fill = guide_legend(reverse=TRUE))+ 
  ggtitle('En la esperanza de vida de los hombres') + 
  xlab('Periodo') +   scale_fill_manual(name = "Edad" , 
                                        values = c('#d73027','#fc8d59','#fee090','#ffffbf','#e0f3f8','#91bfdb', '#4575b4'),
                                        breaks = c('0', '1-4', '5-19', '20-39', '40-59', '60-79', '80+' )   ) +
  scale_colour_manual(name = "Edad" , 
                      values = c('#d73027','#fc8d59','#fee090','#ffffbf','#e0f3f8','#91bfdb', '#4575b4'),
                      breaks = c('0', '1-4', '5-19', '20-39', '40-59', '60-79', '80+' )  ) +
  scale_y_continuous(name = "Contribución", limits = c(-1,8), breaks = seq(-10, 25, 1)) +
  scale_x_discrete(name = 'Año',  breaks = c("1965-1970", "1975-1980", "1985-1990", 
                                             "1995-2000", "2005-2010"  ), 
                   labels = c(" 1957\n/ 1967  ", " 1967\n/ 1977  ", " 1977\n/ 1987  ", 
                              " 1987\n/ 1997  ", " 1997\n/ 2007  "  )  ) +
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.title = element_text(size = sizet, family="Helvetica", face = 'plain'),
        legend.text = element_text(size = sizet, family="Helvetica"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.ticks.x = element_blank())  + ggtitle('Chile. Mujeres') + guides(fill=FALSE)

p5 <- ggplot( ) + 
  geom_blank(data = mass[ Codigo.x == 'PE' & sexo == 'H', ] ,  
             aes(x = Period.x, y = arria3.tot,  fill = Edadg), stat= 'Identity',
             position = 'stack', width = .75) +
  geom_vline( xintercept = seq(1.5, 5.5, 1), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = seq(-2,8, .5),colour = '#f0f0f0', linetype = '22') +
  geom_hline(yintercept = seq(-2,8, 1), colour = '#EAEAEA', linetype = '22') +  
  geom_hline(yintercept = seq(-2,8, 2), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = 0,colour = '#969696', linetype = 'solid') +
  geom_bar(data = p.data[ Codigo.x == 'PE' & sexo == 'H', ] ,  
           aes(x = Period.x, y = arria3.tot,  fill = Edadg), stat= 'Identity',
           position = 'stack', width = .75) +
  geom_bar(data = n.data[ Codigo.x == 'PE' & sexo == 'H', ] ,  
           aes(x = Period.x, y = arria3.tot,  fill = Edadg), stat= 'Identity') +
  theme_bw(base_size = sizet)+ guides(fill = guide_legend(reverse=TRUE))+ 
  ggtitle('En la esperanza de vida de los hombres') + 
  xlab('Periodo') +   scale_fill_manual(name = "Edad" , 
                                        values = c('#d73027','#fc8d59','#fee090','#ffffbf','#e0f3f8','#91bfdb', '#4575b4'),
                                        breaks = c('0', '1-4', '5-19', '20-39', '40-59', '60-79', '80+' )   ) +
  scale_colour_manual(name = "Edad" , 
                      values = c('#d73027','#fc8d59','#fee090','#ffffbf','#e0f3f8','#91bfdb', '#4575b4'),
                      breaks = c('0', '1-4', '5-19', '20-39', '40-59', '60-79', '80+' )  ) +
  scale_y_continuous(name = "Contribución", limits = c(-1, 8), breaks = seq(-10, 25, 1)) +
  scale_x_discrete(name = 'Año',  breaks = c("1965-1970", "1975-1980", "1985-1990", 
                                             "1995-2000", "2005-2010"  ), 
                   labels = c(" 1957\n/ 1967  ", " 1967\n/ 1977  ", " 1977\n/ 1987  ", 
                              " 1987\n/ 1997  ", " 1997\n/ 2007  "  )  ) +
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.title = element_text(size = sizet, family="Helvetica", face = 'plain'),
        legend.text = element_text(size = sizet, family="Helvetica"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.ticks.x = element_blank()) + ggtitle('Perú. Hombres') + guides(fill=FALSE)

p6 <- ggplot( ) + 
  geom_blank(data = mass[ Codigo.x == 'PE' & sexo == 'M', ] ,  
             aes(x = Period.x, y = arria3.tot,  fill = Edadg), stat= 'Identity',
             position = 'stack', width = .75) +
  geom_vline( xintercept = seq(1.5, 5.5, 1), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = seq(-2,8, .5),colour = '#f0f0f0', linetype = '22') +
  geom_hline(yintercept = seq(-2,8, 1), colour = '#EAEAEA', linetype = '22') +  
  geom_hline(yintercept = seq(-2,8, 2), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = 0,colour = '#969696', linetype = 'solid') +
  geom_bar(data = p.data[ Codigo.x == 'PE' & sexo == 'M', ] ,  
           aes(x = Period.x, y = arria3.tot,  fill = Edadg), stat= 'Identity',
           position = 'stack', width = .75) +
  geom_bar(data = n.data[ Codigo.x == 'PE' & sexo == 'M', ] ,  
           aes(x = Period.x, y = arria3.tot,  fill = Edadg), stat= 'Identity') +
  theme_bw(base_size = sizet)+ guides(fill = guide_legend(reverse=TRUE))+ 
  ggtitle('En la esperanza de vida de los hombres') + 
  xlab('Periodo') +   scale_fill_manual(name = "Edad" , 
                                        values = c('#d73027','#fc8d59','#fee090','#ffffbf','#e0f3f8','#91bfdb', '#4575b4'),
                                        breaks = c('0', '1-4', '5-19', '20-39', '40-59', '60-79', '80+' )   ) +
  scale_colour_manual(name = "Edad" , 
                      values = c('#d73027','#fc8d59','#fee090','#ffffbf','#e0f3f8','#91bfdb', '#4575b4'),
                      breaks = c('0', '1-4', '5-19', '20-39', '40-59', '60-79', '80+' )  ) +
  scale_y_continuous(name = "Contribución", limits = c(-1, 8), breaks = seq(-10, 25, 1)) +
  scale_x_discrete(name = 'Año',  breaks = c("1965-1970", "1975-1980", "1985-1990", 
                                             "1995-2000", "2005-2010"  ), 
                   labels = c(" 1957\n/ 1967  ", " 1967\n/ 1977  ", " 1977\n/ 1987  ", 
                              " 1987\n/ 1997  ", " 1997\n/ 2007  "  )  ) +
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.title = element_text(size = sizet, family="Helvetica", face = 'plain'),
        legend.text = element_text(size = sizet, family="Helvetica"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.ticks.x = element_blank())  + ggtitle('Perú. Mujeres') + guides(fill=FALSE)


pl <- ggplot( ) + 
  geom_blank(data = mass[ Codigo.x == 'CL' & sexo == 'M', ] ,  
             aes(x = Period.x, y = arria3.tot,  fill = Edadg), stat= 'Identity',
             position = 'stack') +
  geom_vline( xintercept = seq(1.5, 5.5, 1), colour = '#f0f0f0', linetype = '22') +  
  geom_hline(yintercept = seq(-2,8, .5),colour = '#f0f0f0', linetype = '22') +
  geom_hline(yintercept = seq(-2,8, 1), colour = '#d9d9d9', linetype = '22') +  
  geom_hline(yintercept = seq(-2,8, 2), colour = '#bdbdbd', linetype = '22') +  
  geom_hline(yintercept = 0,colour = '#969696', linetype = 'solid') +
  geom_bar(data = p.data[ Codigo.x == 'CL' & sexo == 'M', ] ,  
           aes(x = Period.x, y = arria3.tot,  fill = Edadg), stat= 'Identity',
           position = 'stack') +
  geom_bar(data = n.data[ Codigo.x == 'CL' & sexo == 'M', ] ,  
           aes(x = Period.x, y = arria3.tot,  fill = Edadg), stat= 'Identity') +
  theme_bw(base_size = sizet)+ guides(fill = guide_legend(reverse=TRUE))+ 
  ggtitle('En la esperanza de vida de los hombres') + 
  xlab('Periodo') +   scale_fill_manual(name = "Edad" , 
                                        values = c('#d73027','#fc8d59','#fee090','#ffffbf','#e0f3f8','#91bfdb', '#4575b4'),
                                        breaks = c('0', '1-4', '5-19', '20-39', '40-59', '60-79', '80+' )   ) +
  scale_colour_manual(name = "Edad" , 
                      values = c('#d73027','#fc8d59','#fee090','#ffffbf','#e0f3f8','#91bfdb', '#4575b4'),
                      breaks = c('0', '1-4', '5-19', '20-39', '40-59', '60-79', '80+' )  ) +
  scale_y_continuous(name = "Contribución", limits = c(-1, 8), breaks = seq(-10, 25, 1)) +
  scale_x_discrete(name = 'Año',  breaks = c("1965-1970", "1975-1980", "1985-1990", 
                                             "1995-2000", "2005-2010"  ), 
                   labels = c(" 1957\n/ 1967  ", " 1967\n/ 1977  ", " 1977\n/ 1987  ", 
                              " 1987\n/ 1997  ", " 1997\n/ 2007  "  )  ) +
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.title = element_text(size = sizet, family="Helvetica", face = 'plain'),
        legend.text = element_text(size = sizet, family="Helvetica"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.ticks.x = element_blank())  + ggtitle('Chile. Mujeres') 


g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

mylegend_1 <- g_legend(pl)

pb <- ggplot(data = mass) + geom_blank(aes(x = Period.x, y = arria3.tot,  fill = Edadg ), outlier.shape = NA) +
  theme_tufte() + xlab("") + ylab("") +
  theme(axis.text = element_blank() , axis.ticks = element_blank()   )


pdf(file = "GRexpbrechevol1950sexo.pdf", width = 8,   height = 10)
print(   grid.arrange(p1, p2,pb, p3, p4,mylegend_1, p5,p6, nrow = 3, widths=c(3.5, 3.5, 1) )   )
dev.off()

mass[Codigo.x == 'CO' & sexo == 'H' ][
  , c('Codigo.y', 'sexo', 'Period.x', 'Period.y', 'Edadg', 'arria3.tot' ), with = F][
    Edadg == '0']
mass[Codigo.x == 'CO' & sexo == 'M' ][
  , c('Codigo.y', 'sexo', 'Period.x', 'Period.y', 'Edadg', 'arria3.tot' ), with = F][
    Edadg == '0']

mass[Codigo.x == 'CL' & sexo == 'H' ][
  , c('Codigo.y', 'sexo', 'Period.x', 'Period.y', 'Edadg', 'arria3.tot' ), with = F][
    Edadg == '0']
mass[Codigo.x == 'CL' & sexo == 'M' ][
  , c('Codigo.y', 'sexo', 'Period.x', 'Period.y', 'Edadg', 'arria3.tot' ), with = F][
    Edadg == '0']

mass[Codigo.x == 'PE' & sexo == 'H' ][
  , c('Codigo.y', 'sexo', 'Period.x', 'Period.y', 'Edadg', 'arria3.tot' ), with = F][
    Edadg == '0']
mass[Codigo.x == 'PE' & sexo == 'M' ][
  , c('Codigo.y', 'sexo', 'Period.x', 'Period.y', 'Edadg', 'arria3.tot' ), with = F][
    Edadg == '0']


mass[Codigo.x == 'CO' & sexo == 'H' & Edadg  %in% c('40-59', '60-79', '80+') ][
  , c('Codigo.y', 'sexo', 'Period.x', 'Period.y', 'Edadg', 'arria3.tot' ), with = F][  
    , sum(arria3.tot) , keyby = list(Codigo.y, sexo, Period.x, Period.y) ]
mass[Codigo.x == 'CO' & sexo == 'M' & Edadg  %in% c('40-59', '60-79', '80+') ][
  , c('Codigo.y', 'sexo', 'Period.x', 'Period.y', 'Edadg', 'arria3.tot' ), with = F][  
    , sum(arria3.tot) , keyby = list(Codigo.y, sexo, Period.x, Period.y) ]



mass[Codigo.x == 'CL' & sexo == 'H' & Edadg  %in% c('40-59', '60-79', '80+') ][
  , c('Codigo.y', 'sexo', 'Period.x', 'Period.y', 'Edadg', 'arria3.tot' ), with = F][  
    , sum(arria3.tot) , keyby = list(Codigo.y, sexo, Period.x, Period.y) ]
mass[Codigo.x == 'CL' & sexo == 'M' & Edadg  %in% c('40-59', '60-79', '80+') ][
  , c('Codigo.y', 'sexo', 'Period.x', 'Period.y', 'Edadg', 'arria3.tot' ), with = F][  
    , sum(arria3.tot) , keyby = list(Codigo.y, sexo, Period.x, Period.y) ]



mass[Codigo.x == 'PE' & sexo == 'H' & Edadg  %in% c('40-59', '60-79', '80+') ][
  , c('Codigo.y', 'sexo', 'Period.x', 'Period.y', 'Edadg', 'arria3.tot' ), with = F][  
    , sum(arria3.tot) , keyby = list(Codigo.y, sexo, Period.x, Period.y) ]
mass[Codigo.x == 'PE' & sexo == 'M' & Edadg  %in% c('40-59', '60-79', '80+') ][
  , c('Codigo.y', 'sexo', 'Period.x', 'Period.y', 'Edadg', 'arria3.tot' ), with = F][  
    , sum(arria3.tot) , keyby = list(Codigo.y, sexo, Period.x, Period.y) ]


cbind(mass[Codigo.x == 'CO' & sexo == 'H' & Edadg  %in% c('40-59', '60-79', '80+') ][
  , c('Codigo.y', 'sexo', 'Period.x', 'Period.y', 'Edadg', 'arria3.tot' ), with = F][  
    , sum(arria3.tot) , keyby = list(Codigo.y, sexo, Period.x, Period.y) ],
  mass[Codigo.x == 'CL' & sexo == 'H' & Edadg  %in% c('40-59', '60-79', '80+') ][
    , c('Codigo.y', 'sexo', 'Period.x', 'Period.y', 'Edadg', 'arria3.tot' ), with = F][  
      , sum(arria3.tot) , keyby = list(Codigo.y, sexo, Period.x, Period.y) ])


cbind(mass[Codigo.x == 'CO' & sexo == 'H' & Edadg  %in% c('40-59', '60-79', '80+') ][
  , c('Codigo.y', 'sexo', 'Period.x', 'Period.y', 'Edadg', 'arria3.tot' ), with = F][  
    , sum(arria3.tot) , keyby = list(Codigo.y, sexo, Period.x, Period.y) ],
  mass[Codigo.x == 'PE' & sexo == 'H' & Edadg  %in% c('40-59', '60-79', '80+') ][
    , c('Codigo.y', 'sexo', 'Period.x', 'Period.y', 'Edadg', 'arria3.tot' ), with = F][  
      , sum(arria3.tot) , keyby = list(Codigo.y, sexo, Period.x, Period.y) ] )




cbind(mass[Codigo.x == 'CO' & sexo == 'M' & Edadg  %in% c('40-59', '60-79', '80+') ][
  , c('Codigo.y', 'sexo', 'Period.x', 'Period.y', 'Edadg', 'arria3.tot' ), with = F][  
    , sum(arria3.tot) , keyby = list(Codigo.y, sexo, Period.x, Period.y) ],
  mass[Codigo.x == 'CL' & sexo == 'M' & Edadg  %in% c('40-59', '60-79', '80+') ][
    , c('Codigo.y', 'sexo', 'Period.x', 'Period.y', 'Edadg', 'arria3.tot' ), with = F][  
      , sum(arria3.tot) , keyby = list(Codigo.y, sexo, Period.x, Period.y) ])


cbind(mass[Codigo.x == 'CO' & sexo == 'M' & Edadg  %in% c('40-59', '60-79', '80+') ][
  , c('Codigo.y', 'sexo', 'Period.x', 'Period.y', 'Edadg', 'arria3.tot' ), with = F][  
    , sum(arria3.tot) , keyby = list(Codigo.y, sexo, Period.x, Period.y) ],
  mass[Codigo.x == 'PE' & sexo == 'M' & Edadg  %in% c('40-59', '60-79', '80+') ][
    , c('Codigo.y', 'sexo', 'Period.x', 'Period.y', 'Edadg', 'arria3.tot' ), with = F][  
      , sum(arria3.tot) , keyby = list(Codigo.y, sexo, Period.x, Period.y) ] )


c1 <- mass[Codigo.x == 'CO' & sexo == 'H' ][
  , c('Codigo.y', 'sexo', 'Period.x', 'Period.y', 'Edadg', 'arria3.tot' ), with = F][
    Edadg == '20-39']
c2 <- mass[Codigo.x == 'CO' & sexo == 'M' ][
  , c('Codigo.y', 'sexo', 'Period.x', 'Period.y', 'Edadg', 'arria3.tot' ), with = F][
    Edadg == '20-39']
merge(c1,c2, by = c('Codigo.y' , 'Period.x' , 'Period.y' ,'Edadg') )



mex <- 
  mass[Codigo.x %in% c('CO', 'CL', 'PE' )][
    ,       c('region', 'sexo', "Period.y" , "Period.x" ,  'Edadg',  'arria3.tot'), with = F] %>%
  mutate(cont = round(arria3.tot, 2))

mex$clasep.y <- factor(mex$Period.y, levels = c("1955-1960", 
                                          "1965-1970",  "1975-1980",  "1985-1990", 
                                          "1995-2000",  "2005-2010"),
                    labels = seq(1957.5, 2007.5, 10) )

mex$clasep.x <- factor(mex$Period.x, levels = c("1955-1960", 
                                                "1965-1970",  "1975-1980",  "1985-1990", 
                                                "1995-2000",  "2005-2010"),
                       labels = seq(1957.5, 2007.5, 10) )

pr <- dcast(mex, region + sexo + clasep.y + clasep.x ~ Edadg , value.var = 'cont', fun = mean)

dlply(pr, .(region, sexo), function(df)  xtable(df[,3:11])   )


library(tables)

tabular(RowFactor(region) * RowFactor(sexo) * (Periodo= RowFactor(paste(clasep.y , clasep.x))  ) ~ 
          Edadg * (cont*sum)  , data = mex)

# ALC Descomp brecha e0 paises 2005-2010 --------------------------------------------------------------
mah <- fread('tvhombres.csv')
mam <- fread('tvmujeres.csv')

mah$sexo <- "H" ; mam$sexo <- "M"
ma <- rbind(mah, mam)

setnames(ma, c(3, 8, 9, 11, 13, 14, 15, 17, 18, 19) , c( "region", "Edad","Intervalo", 'qxn', 
                                                         "lx", "dxn" , "Lxn","Tx", "ex", "axn")) 
ma <- data.table(ma)
ma$clasep <- factor(ma$Period, levels = c("1950-1955", "1955-1960", "1960-1965", 
                                          "1965-1970", "1970-1975", "1975-1980", "1980-1985", "1985-1990", 
                                          "1990-1995", "1995-2000", "2000-2005", "2005-2010"),
                    labels = seq(1952.5, 2007.5, 5) )
# corregir Lxn
ma$Edadg <- recode(ma$Edad, " 0:19 = '0-19'; 20:39 = '20-39'  ; 40:59 = '40-59' ; 60:79= '60-79'; 
                   else = '80+' "               )
ma[, Lxc := sum(Lxn)  , keyby = list(region, Codigo, Period, sexo, Edadg ) ]

mas <- ma[Edad  %in% c(0,20,40,60,80), c("region", "Codigo", "Period", "Edad","Intervalo", 'qxn', 
                                         "lx", "dxn" , "Lxc", "Tx", "ex", "axn", "sexo", "clasep", "Edadg"),
          with = F]

mas[ , lxad := c( lx[2:length(lx)] , 0  ) , keyby = list(region, Codigo, Period, sexo ) ]
mas[ , exad := c( ex[2:length(ex)] , 0  ) , keyby = list(region, Codigo, Period, sexo ) ]
mas[ , Txad := c( Tx[2:length(Tx)] , 0  ) , keyby = list(region, Codigo, Period, sexo ) ]

masco <- mas[Codigo == 'CO', ]

mas <- merge(mas, masco,  by = c("Period", "Edad", "sexo")   )

mas <- mas[order(region.x, Codigo.x, Period, sexo, Edad), ]

mas[, arria3.tot := (lx.y + lx.x) * (ex.x - ex.y) / (2 * 100000) - 
      (lxad.y + lxad.x) * (exad.x - exad.y) / (2 * 100000)  ]

mas[, arria.vr := (  ( lx.y / 100000 ) * (  (Lxc.x / lx.x) - (Lxc.y / lx.y)  )  ) +
      (( Txad.x / 100000) * ( (lx.y / lx.x) - (lxad.y / lxad.x) ) )]
mas$arria.vr <- ifelse(mas$Edad == 80 , 
                       ( mas$lx.y / 100000 ) * ( (mas$Tx.x / mas$lx.x) -(mas$Tx.y / mas$lx.y)  ) , 
                       mas$arria.vr )

mas[, arria1.tot := ((lx.y  * (ex.x - ex.y) ) -  (lxad.y * (exad.x - exad.y)) ) / 100000 ]
mas[, arria2.tot := ((lx.x  * (ex.x - ex.y) ) -  (lxad.x * (exad.x - exad.y)) ) / 100000 ]

a <- mas[,  list(  sum(arria3.tot), sum(arria1.tot), sum(arria2.tot), sum(arria.vr, na.rm = T) ),     
         keyby = list(region.x, Codigo.x, Period, sexo ) ]
b <- mas[Edad == 0, c('region.x', 'Codigo.x', 'Period', 'sexo', 'ex.x','ex.y' ) , with = F][
  , dif := ex.x-ex.y]
c <- merge(a, b, by = c('region.x', 'Codigo.x', 'Period', 'sexo')   )


mass <- mas[ Codigo.x %in% c("CR", "SV", "MX", "NI", "PA", "AR", "BR", "CL", "PY", "UY", 
                             "CU", "DO", "HT", "JM", "TT", "BO",  "EC", "PE", "VE", 
                             "GT", "HN") ,  ]

dput(mass[Edad == 0 & sexo == 'H' & Period == '2005-2010', ][order(ex.x), ][,"Codigo.x", with = F])

mass$Codigo.x <- factor( mass$Codigo.x, levels = c("HT",  "BO", "TT",  "SV", 
                                                   "GT", "BR", "DO",  "JM",  "HN", "PY",  "NI",  
                                                   "PE", "VE",  "AR",  "EC",  
                                                   "UY", "PA", "MX",  "CL", "CU", "CR") )

sizet <- 10

p1 <- ggplot( ) +   
  geom_blank(data = mass[sexo == 'H' & Period == '2005-2010' , ] ,  
             aes(x = Codigo.x, y = arria3.tot, fill = Edadg.y), stat= 'Identity'  ) +
  geom_vline( xintercept = seq(1.5, 20.5, 1), colour = '#f0f0f0', linetype = '22') +  
  geom_hline(yintercept = seq(-16, 8, 1),colour = '#f0f0f0', linetype = '22') +
  geom_vline( xintercept = seq(1.5, 20.5, 2), colour = '#EAEAEA', linetype = '22') +  
  geom_hline(yintercept = seq(-16, 8, 2),colour = '#EAEAEA', linetype = '22') +
  geom_vline( xintercept = seq(1.5, 20.5, 4), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = seq(-16, 8, 4),colour = '#E4E4E4', linetype = '22') +
  geom_hline(yintercept = 0,colour = '#969696', linetype = 'solid') +
  geom_bar(data = mass[sexo == 'H' & Period == '2005-2010' & arria3.tot > 0 , ] ,  
           aes(x = Codigo.x, y = arria3.tot, fill = Edadg.y), stat= 'Identity', width = .75) +
  geom_bar(data = mass[sexo == 'H' & Period == '2005-2010' & arria3.tot < 0, ] , 
           aes(x = Codigo.x, y = arria3.tot, fill = Edadg.y), stat= 'Identity', width = .75) +
  theme_bw(base_size = sizet) + ggtitle('En la esperanza de vida de los hombres') +   xlab('País') +
  scale_fill_manual(name = "Edad" , 
                    values = c('#d73027','#fc8d59','#ffffbf','#91bfdb', '#4575b4') ) +
  scale_y_continuous(name = "Contribución", breaks = seq(-16, 8, 2),  
                     limits = c(-14.5, 8), expand =c(.02,.02) ) +
  scale_x_discrete(expand =c(.05,.05) ) + 
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.text = element_text(size = sizet, family="Helvetica"),
        legend.title = element_text(size = sizet, family="Helvetica", face = 'plain'),
        title =  element_text(size = sizet +1 , family="Helvetica"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.ticks.x = element_blank())

mass[sexo == 'H' & Period == '2005-2010' & Codigo.x =='DO' , ] 

mass <- mas[ Codigo.x %in% c("CR", "SV", "MX", "NI", "PA", "AR", "BR", "CL", "PY", "UY", 
                             "CU", "DO", "HT", "JM", "TT", "BO",  "EC", "PE", "VE", 
                             "GT", "HN") ,  ]

dput(mass[Edad == 0 & sexo == 'M' & Period == '2005-2010', ][order(ex.x), ][,"Codigo.x", with = F])

mass$Codigo.x <- factor( mass$Codigo.x, levels =  c("HT", "BO", "TT", "GT", "PY", "HN", 
                                                    "JM", "DO", "PE", "SV", "NI", "BR", "VE", "EC", "MX", "AR", "PA", 
                                                    "UY", "CU", "CR", "CL") )

mass$Edadg <- recode(mass$Edad, " 0:19 = '0-19'; 20:39 = '20-39'  ; 40:59 = '40-59' ; 60:79= '60-79'; 
                     else = '80+' " )

p2 <- ggplot( ) + 
  geom_blank(data = mass[sexo == 'M' & Period == '2005-2010' , ] ,  
             aes(x = Codigo.x, y = arria3.tot, fill = Edadg), stat= 'Identity'  ) +
  geom_vline( xintercept = seq(1.5, 20.5, 1), colour = '#f0f0f0', linetype = '22') +  
  geom_hline(yintercept = seq(-16, 8, 1),colour = '#f0f0f0', linetype = '22') +
  geom_vline( xintercept = seq(1.5, 20.5, 2), colour = '#EAEAEA', linetype = '22') +  
  geom_hline(yintercept = seq(-16, 8, 2),colour = '#EAEAEA', linetype = '22') +
  geom_vline( xintercept = seq(1.5, 20.5, 4), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = seq(-16, 8, 4),colour = '#E4E4E4', linetype = '22') +
  geom_hline(yintercept = 0,colour = '#969696', linetype = 'solid') +
  geom_bar(data = mass[sexo == 'M' & Period == '2005-2010' & arria3.tot > 0 , ] ,  
           aes(x = Codigo.x, y = arria3.tot, fill = Edadg), stat= 'Identity', width = .75) +
  geom_bar(data = mass[sexo == 'M' & Period == '2005-2010' & arria3.tot < 0, ] ,  
           aes(x = Codigo.x, y = arria3.tot, fill = Edadg), stat= 'Identity', width = .75) +
  theme_bw(base_size = sizet) + 
  ggtitle('En la esperanza de vida de las mujeres') + 
  xlab('País') +
  scale_fill_manual(name = "Edad", values = c('#d73027','#fc8d59','#ffffbf','#91bfdb', '#4575b4') ) +
  scale_y_continuous(name = "Contribución", breaks = seq(-16, 8, 2), 
                     limits = c(-14.5, 8), expand =c(.02,.02) ) +
  scale_x_discrete(expand =c(.05,.05) ) + 
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.text = element_text(size = sizet, family="Helvetica"),
        legend.title = element_text(size = sizet, family="Helvetica", face = 'plain'),
        title =  element_text(size = sizet + 1, family="Helvetica"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.ticks.x = element_blank() )


#mass[sexo == 'M' & Period == '2005-2010' & Codigo.x == 'HN', ]


pdf(file = "GRexpcontdifpais0510.pdf", width = 7.8,   height = 9.8,  family = "Helvetica")
print(   grid.arrange( p1, p2, nrow = 2)   )
dev.off()

mass[sexo == 'H' & Period == '2005-2010' & Codigo.x == 'CR',][
  , c('Edad', 'sexo', 'Codigo.x', 'ex.x', 'ex.y','arria3.tot'), with = F]
mass[sexo == 'H' & Period == '2005-2010' & Codigo.x == 'CU',][
  , c('Edad', 'sexo', 'Codigo.x', 'ex.x', 'ex.y','arria3.tot'), with = F]
mass[sexo == 'H' & Period == '2005-2010' & Codigo.x == 'CL',][
  , c('Edad', 'sexo', 'Codigo.x', 'ex.x', 'ex.y','arria3.tot'), with = F]

mass[sexo == 'H' & Period == '2005-2010' & Codigo.x == 'BO',][
  , c('Edad', 'sexo', 'Codigo.x', 'ex.x', 'ex.y','arria3.tot'), with = F]
mass[sexo == 'H' & Period == '2005-2010' & Codigo.x == 'HT',][
  , c('Edad', 'sexo', 'Codigo.x', 'ex.x', 'ex.y','arria3.tot'), with = F]

mass[sexo == 'H' & Period == '2005-2010' & Codigo.x == 'VE',][
  , c('Edad', 'sexo', 'Codigo.x', 'ex.x', 'ex.y','arria3.tot'), with = F]
mass[sexo == 'H' & Period == '2005-2010' & Codigo.x == 'PE',][
  , c('Edad', 'sexo', 'Codigo.x', 'ex.x', 'ex.y','arria3.tot'), with = F]


mass[sexo == 'M' & Period == '2005-2010' & Codigo.x == 'CR',][
  , c('Edad', 'sexo', 'Codigo.x', 'ex.x', 'ex.y','arria3.tot'), with = F]
mass[sexo == 'M' & Period == '2005-2010' & Codigo.x == 'CU',][
  , c('Edad', 'sexo', 'Codigo.x', 'ex.x', 'ex.y','arria3.tot'), with = F]
mass[sexo == 'M' & Period == '2005-2010' & Codigo.x == 'CL',][
  , c('Edad', 'sexo', 'Codigo.x', 'ex.x', 'ex.y','arria3.tot'), with = F]

mass[sexo == 'M' & Period == '2005-2010' & Codigo.x == 'BO',][
  , c('Edad', 'sexo', 'Codigo.x', 'ex.x', 'ex.y','arria3.tot'), with = F]
mass[sexo == 'M' & Period == '2005-2010' & Codigo.x == 'HT',][
  , c('Edad', 'sexo', 'Codigo.x', 'ex.x', 'ex.y','arria3.tot'), with = F]


mass[sexo == 'M' & Period == '2005-2010' & Codigo.x == 'VE',][
  , c('Edad', 'sexo', 'Codigo.x', 'ex.x', 'ex.y','arria3.tot'), with = F]
mass[sexo == 'M' & Period == '2005-2010' & Codigo.x == 'PE',][
  , c('Edad', 'sexo', 'Codigo.x', 'ex.x', 'ex.y','arria3.tot'), with = F]




# ALC  Descomp brecha e0 sexo--------------------------------------------------------------

mah <- fread('tvhombres.csv')
mam <- fread('tvmujeres.csv')

mah$sexo <- "H" ; mam$sexo <- "M"

setnames(mah, c(3, 8, 9, 11, 13, 14, 15, 18, 19) , c( "region", "Edad","Intervalo", 'qxn', 
                                                      "lx", "dxn" , "Lxn", "ex", "axn")) 

setnames(mam, c(3, 8, 9, 11, 13, 14, 15, 18, 19) , c( "region", "Edad","Intervalo", 'qxn', 
                                                      "lx", "dxn" , "Lxn", "ex", "axn")) 

ma <- merge(mam, mah,  by = c("region", "Codigo","Period", "Edad")  )
ma <- data.table(ma)

mas <- ma[Edad  %in% c(0, 1, 10, 20, 30, 40, 50, 60, 70, 80),
          c("region", "Codigo","Period", "Edad", "lx.x", "lx.y" , "ex.x" ,  "ex.y",
            "sexo.x", "sexo.y") , with = F]

mas$clasep <- factor(mas$Period, levels = c("1950-1955", "1955-1960", "1960-1965", 
                                            "1965-1970", "1970-1975", "1975-1980", "1980-1985", "1985-1990", 
                                            "1990-1995", "1995-2000", "2000-2005", "2005-2010"),
                     labels = seq(1952.5, 2007.5, 5) )

mas[ , lxad.x := c( lx.x[2:length(lx.x)] , 0  ) , keyby = list(region, Codigo, Period ) ]
mas[ , exad.x := c( ex.x[2:length(ex.x)] , 0  ) , keyby = list(region, Codigo, Period ) ]
mas[ , lxad.y := c( lx.y[2:length(lx.y)] , 0  ) , keyby = list(region, Codigo, Period ) ]
mas[ , exad.y := c( ex.y[2:length(ex.y)] , 0  ) , keyby = list(region, Codigo, Period ) ]

mas[, arria3.tot := (lx.y + lx.x) * (ex.x - ex.y) / (2 * 100000) - 
      (lxad.y + lxad.x) * (exad.x - exad.y) / (2 * 100000)  ]

a <- mas[,  list(  sum(arria3.tot) ),     keyby = list(region, Codigo, Period ) ]
b <- mas[Edad == 0, c('region', 'Codigo', 'Period',  'ex.x','ex.y' ) , with = F][
  , dif := ex.x - ex.y]
c <- merge(a, b, by = c('region', 'Codigo', 'Period')   )

mass <- mas[ Codigo %in% c("CR", "SV", "MX", "NI", "PA", "AR", "BR", "CL", "PY", "UY", "CO",
                           "CU", "DO", "HT", "JM", "TT", "BO",  "EC", "PE", "VE", 
                           "GT", "HN") ,  ]

dput(mass[Edad == 0 & Period == '2005-2010', ][order(ex.x -ex.y), ][,"Codigo", with = F])

mass$Codigo <- factor( mass$Codigo, levels = c("HT", "CU", "PY", "BO", "CR", "HN", 
                                               "MX", "PE", "JM", "EC", "PA", "VE",
                                               "CL", "NI", "DO", "GT", "UY", 
                                               "TT", "BR", "CO","AR", "SV") )

mass$Edadg <- recode(mass$Edad, " 0 = '0'; 1:9 = '1-9'; 10:19 = '10-19'; 20:29 = '20-29';
                     30:39 = '30-39'; 40:49  = '40-49' ; 50:59 = '50-59'  ; 60:69  = '60-69' ; 70:79 = '70-79'  ;
                     else = '80+' "   )

mass$clasep <- as.numeric(as.character(mass$clasep))

sizet <- 12


p1 <- ggplot( ) + 
  geom_vline( xintercept = seq(1950, 2010, 5), colour = '#f0f0f0', linetype = '22') +  
  geom_hline(yintercept = seq(0, 10, 1),colour = '#f0f0f0', linetype = '22') +
  geom_vline( xintercept = seq(1950, 2010, 10), colour = '#EAEAEA', linetype = '22') +  
  geom_hline(yintercept = seq(0, 10, 2),colour = '#EAEAEA', linetype = '22') +
  geom_vline( xintercept = seq(1950, 2010, 20), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = seq(0, 10, 4),colour = '#E4E4E4', linetype = '22') +
  geom_area(data = mass[ Codigo == 'CO' & arria3.tot > 0, ] ,  
            aes(x = clasep, y = arria3.tot,  fill = Edadg), stat= 'Identity',
            position = 'stack') +  
  theme_bw(base_size = 12) + 
  scale_fill_manual(name = "Edad" , values = c(  '#034e7b', '#0570b0','#5aae61','#1b7837','#00441b', 
                                                 '#40004b','#762a83', '#9970ab','#c2a5cf', '#df65b0') ) +
  scale_y_continuous(name = "Contribución", limits = c(-.05,8.5),  breaks = seq(0, 10, 1)) +
  scale_x_continuous(name = 'Año', lim = c(1952.5, 2014),breaks = seq(1950, 2010, 10) ) +
  geom_hline(yintercept = 0, colour = '#252525') + 
  scale_colour_manual(name = 'Edad', values = c(    '#034e7b', '#0570b0','#5aae61','#1b7837','#00441b', 
                                                    '#40004b','#762a83', '#9970ab','#c2a5cf', '#df65b0') )  +
  geom_dl(data = mass[ Codigo == 'CO' & arria3.tot > 0, ] ,  
          aes(x = clasep, y = arria3.tot, label = Edadg,  colour = Edadg),
          list(dl.combine(last.bumpup), cex = .9, vjust = 1.5, family="Helvetica"), position = 'stack') +
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        plot.title = element_text(size = sizet  + 2, family="Helvetica"),
        legend.position = '',
        panel.grid = element_blank() ) + ggtitle('Colombia')

p.data <- mass
p.data$arria3.tot[p.data$arria3.tot < 0] <- 0
n.data <- mass
n.data$arria3.tot[n.data$arria3.tot > 0] <- 0


p2 <- ggplot( ) + 
  geom_vline( xintercept = seq(1950, 2010, 5), colour = '#f0f0f0', linetype = '22') +  
  geom_hline(yintercept = seq(0, 10, 1),colour = '#f0f0f0', linetype = '22') +
  geom_vline( xintercept = seq(1950, 2010, 10), colour = '#EAEAEA', linetype = '22') +  
  geom_hline(yintercept = seq(0, 10, 2),colour = '#EAEAEA', linetype = '22') +
  geom_vline( xintercept = seq(1950, 2010, 20), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = seq(0, 10, 4),colour = '#E4E4E4', linetype = '22') +
  geom_area(data = p.data[ Codigo == 'CR'  , ] ,  
            aes(x = clasep, y = arria3.tot,  fill = Edadg), stat= 'Identity') +
  geom_ribbon(data = n.data[ Codigo == 'CR', ] ,  
              aes(x = clasep, ymin = arria3.tot,  ymax = 0, fill = Edadg), stat= 'Identity') +
  theme_bw(base_size = 14) + 
  scale_fill_manual(name = "Edad" , values = c(  '#034e7b', '#0570b0','#5aae61','#1b7837','#00441b', 
                                                 '#40004b','#762a83', '#9970ab','#c2a5cf', '#df65b0') ) +
  scale_y_continuous(name = "Contribución", limits = c(-.05,8.5),  breaks = seq(0, 10, 1)) +
  scale_x_continuous(name = 'Año', lim = c(1952.5, 2014),breaks = seq(1950, 2010, 10) ) +
  geom_hline(yintercept = 0, colour = '#252525') + 
  scale_colour_manual(name = 'Edad', values = c(    '#034e7b', '#0570b0','#5aae61','#1b7837','#00441b', 
                                                    '#40004b','#762a83', '#9970ab','#c2a5cf', '#df65b0') )  +
  geom_dl(data = mass[ Codigo == 'CR' , ] ,  
          aes(x = clasep, y = arria3.tot, label = Edadg,  colour = Edadg),
          list(dl.combine(last.bumpup), cex = .9, vjust = 1.5, family = "Helvetica"), position = 'stack') +
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        plot.title = element_text(size = sizet + 2, family="Helvetica"),
        legend.position = 'none',
        panel.grid = element_blank() ) + ggtitle('Costa Rica')

p3 <- ggplot( ) + 
  geom_vline( xintercept = seq(1950, 2010, 5), colour = '#f0f0f0', linetype = '22') +  
  geom_hline(yintercept = seq(0, 10, 1),colour = '#f0f0f0', linetype = '22') +
  geom_vline( xintercept = seq(1950, 2010, 10), colour = '#EAEAEA', linetype = '22') +  
  geom_hline(yintercept = seq(0, 10, 2),colour = '#EAEAEA', linetype = '22') +
  geom_vline( xintercept = seq(1950, 2010, 20), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = seq(0, 10, 4),colour = '#E4E4E4', linetype = '22') +
  geom_area(data = p.data[ Codigo == 'CL'  , ] ,  
            aes(x = clasep, y = arria3.tot,  fill = Edadg), stat= 'Identity') +
  geom_ribbon(data = n.data[ Codigo == 'CL', ] ,  
              aes(x = clasep, ymin = arria3.tot,  ymax = 0, fill = Edadg), stat= 'Identity') +
  theme_bw(base_size = 14) + 
  scale_fill_manual(name = "Edad" , values = c(  '#034e7b', '#0570b0','#5aae61','#1b7837','#00441b', 
                                                 '#40004b','#762a83', '#9970ab','#c2a5cf', '#df65b0') ) +
  scale_y_continuous(name = "Contribución", limits = c(-.05,8.5),  breaks = seq(0, 10, 1)) +
  scale_x_continuous(name = 'Año', lim = c(1952.5, 2014),breaks = seq(1950, 2010, 10) ) +
  geom_hline(yintercept = 0, colour = '#252525') + 
  scale_colour_manual(name = 'Edad', values = c(   '#034e7b', '#0570b0','#5aae61','#1b7837','#00441b', 
                                                   '#40004b','#762a83', '#9970ab','#c2a5cf', '#df65b0') )  +
  geom_dl(data = mass[ Codigo == 'CL' , ] ,  
          aes(x = clasep, y = arria3.tot, label = Edadg,  colour = Edadg),
          list(dl.combine(last.bumpup), cex = .9, vjust = 1.5, family = "Helvetica"), position = 'stack') +
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        plot.title = element_text(size = sizet + 2, family="Helvetica"),
        legend.position = 'none', panel.grid = element_blank() )  + ggtitle('Chile')

p4 <- ggplot( ) + 
  geom_vline( xintercept = seq(1950, 2010, 5), colour = '#f0f0f0', linetype = '22') +  
  geom_hline(yintercept = seq(0, 10, 1),colour = '#f0f0f0', linetype = '22') +
  geom_vline( xintercept = seq(1950, 2010, 10), colour = '#EAEAEA', linetype = '22') +  
  geom_hline(yintercept = seq(0, 10, 2),colour = '#EAEAEA', linetype = '22') +
  geom_vline( xintercept = seq(1950, 2010, 20), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = seq(0, 10, 4),colour = '#E4E4E4', linetype = '22') +
  geom_area(data = p.data[ Codigo == 'VE'  , ] ,  
            aes(x = clasep, y = arria3.tot,  fill = Edadg), stat= 'Identity') +
  geom_ribbon(data = n.data[ Codigo == 'VE', ] ,  
              aes(x = clasep, ymin = arria3.tot,  ymax = 0, fill = Edadg), stat= 'Identity') +
  theme_bw(base_size = 14) + 
  scale_fill_manual(name = "Edad" , values = c(  '#034e7b', '#0570b0','#5aae61','#1b7837','#00441b', 
                                                 '#40004b','#762a83', '#9970ab','#c2a5cf', '#df65b0') ) +
  scale_y_continuous(name = "Contribución", limits = c(-.05,8.5),  breaks = seq(0, 10, 1)) +
  scale_x_continuous(name = 'Año', lim = c(1952.5, 2014),breaks = seq(1950, 2010, 10) ) +
  geom_hline(yintercept = 0, colour = '#252525') + 
  scale_colour_manual(name = 'Edad', values = c(    '#034e7b', '#0570b0','#5aae61','#1b7837','#00441b', 
                                                    '#40004b','#762a83', '#9970ab','#c2a5cf', '#df65b0') )  +
  geom_dl(data = mass[ Codigo == 'VE' , ] ,  
          aes(x = clasep, y = arria3.tot, label = Edadg,  colour = Edadg),
          list(dl.combine(last.bumpup), cex = .9, vjust = 1.5, family = "Helvetica"), position = 'stack') +
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        plot.title = element_text(size = sizet + 2, family="Helvetica"),
        legend.position = 'none' ,
        panel.grid = element_blank() )  + ggtitle('Venezuela')

pdf(file = "GRexpbrechcontrsexo.pdf", width = 8,   height = 10, family = "Helvetica")
print(   grid.arrange(p1, p4, p3, p2, nrow = 2)   )
dev.off()

#mass[ Codigo == 'CL' & arria3.tot < 0, ]

mass[, Pct.Ctr:= arria3.tot * 100 /sum(arria3.tot), keyby = list(region, Codigo, Period) ]


mass[ Edadg %in% c('0') & Codigo == 'CO' , 
     c( 'Codigo', 'Period', 'Edadg', 'ex.x',  'ex.y', 'arria3.tot', 'Pct.Ctr') , with  = F]
mass[ Edadg %in% c('0') & Codigo == 'VE' , 
      c( 'Codigo', 'Period', 'Edadg', 'ex.x',  'ex.y', 'arria3.tot', 'Pct.Ctr') , with  = F]
mass[ Edadg %in% c('0') & Codigo == 'CL' , 
      c( 'Codigo', 'Period', 'Edadg', 'ex.x',  'ex.y', 'arria3.tot', 'Pct.Ctr') , with  = F]
mass[ Edadg %in% c('0') & Codigo == 'CR' , 
      c( 'Codigo', 'Period', 'Edadg', 'ex.x',  'ex.y', 'arria3.tot', 'Pct.Ctr') , with  = F]

mass[ Edadg %in% c('20-29') & Codigo == 'CO' , 
      c( 'Codigo', 'Period', 'Edadg', 'ex.x',  'ex.y', 'arria3.tot', 'Pct.Ctr') , with  = F]
mass[ Edadg %in% c('20-29') & Codigo == 'VE' , 
      c( 'Codigo', 'Period', 'Edadg', 'ex.x',  'ex.y', 'arria3.tot', 'Pct.Ctr') , with  = F]
mass[ Edadg %in% c('20-29') & Codigo == 'CL' , 
      c( 'Codigo', 'Period', 'Edadg', 'ex.x',  'ex.y', 'arria3.tot', 'Pct.Ctr') , with  = F]
mass[ Edadg %in% c('20-29') & Codigo == 'CR' , 
      c( 'Codigo', 'Period', 'Edadg', 'ex.x',  'ex.y', 'arria3.tot', 'Pct.Ctr') , with  = F]


mass[ Edadg %in% c("60-69", "70-79" ,"80+") & Codigo == 'CO' , 
      c( 'Codigo', 'Period', 'Edadg', 'ex.x',  'ex.y', 'arria3.tot', 'Pct.Ctr') , with  = F][,
       list( sum(arria3.tot) ,   sum(Pct.Ctr) )  , keyby = list(Codigo ,   Period) ]
mass[ Edadg %in% c("60-69", "70-79" ,"80+") & Codigo == 'CL' , 
      c( 'Codigo', 'Period', 'Edadg', 'ex.x',  'ex.y', 'arria3.tot', 'Pct.Ctr') , with  = F][
        ,         list( sum(arria3.tot) ,   sum(Pct.Ctr) )  , keyby = list(Codigo ,   Period) ]
mass[ Edadg %in% c("60-69", "70-79" ,"80+") & Codigo == 'CR' , 
      c( 'Codigo', 'Period', 'Edadg', 'ex.x',  'ex.y', 'arria3.tot', 'Pct.Ctr') , with  = F][
        ,         list( sum(arria3.tot) ,   sum(Pct.Ctr) )  , keyby = list(Codigo ,   Period) ]
mass[ Edadg %in% c("60-69", "70-79" ,"80+") & Codigo == 'VE' , 
      c( 'Codigo', 'Period', 'Edadg', 'ex.x',  'ex.y', 'arria3.tot', 'Pct.Ctr') , with  = F][
        ,         list( sum(arria3.tot) ,   sum(Pct.Ctr) )  , keyby = list(Codigo ,   Period) ]



mass[Codigo %in% c('CO', 'CL', 'CR' , 'VE') ][
  ,  c("region", "Period","Edadg","arria3.tot" ) , with = F] %>%
  dcast(  region + Period ~ Edadg, value.var= 'arria3.tot', mean ) %>%
dlply(.(region), function(df){xtable(df[, 2:12])}  )




# ALC Clasif Drendograma qx ------------------------------------------------------------------

library(ggdendro)
mah <- fread('tvhombres.csv')
mam <- fread('tvmujeres.csv')

mah$sexo <- "H" ; mam$sexo <- "M"
ma <- rbind(mah, mam)

setnames(ma,c(3,8,9,11, 14, 18) , c( "region", "Edad","Intervalo", 'qxn',"dxn" , "ex")) 

ma$edadcl <-  ma$Edad + (ma$Interv / 2)


# # dendrograma mujeres 2005 ----------------------------------------------

mas <- ma[, c("Period","region", "Edad", 'edadcl', 'qxn', 'sexo') , with = F]
mas <- mas[ sexo == 'M' & Period == '2005-2010', ]

mas$qxn  <- as.numeric(as.character(mas$qxn))

mmas <- dcast(mas,  region   ~   Period +sexo + Edad, value.var = c('qxn'), sum)

# unique(mmas$region) %>%     dput(.)

mmas <- subset(mmas, region %in% c("Uruguay", "Argentina", "Cuba", 
                                   "Paraguay", "Panama", "Costa Rica", 
                                   "Venezuela (Bolivarian Republic of)", "Mexico", 
                                   "Colombia", "Chile", "Brazil", "Ecuador", "El Salvador", "Guatemala", 
                                   "Dominican Republic", "Peru", "Nicaragua", "Honduras", 
                                   "Bolivia (Plurinational State of)", 
                                   "Haiti")     )

mmas$region <- factor(mmas$region, c("Uruguay", "Argentina", "Cuba", 
                                     "Paraguay", "Panama", "Costa Rica", 
                                     "Venezuela (Bolivarian Republic of)", "Mexico", 
                                     "Colombia", "Chile", "Brazil", "Ecuador", "El Salvador", "Guatemala", 
                                     "Dominican Republic", "Peru", "Nicaragua", "Honduras", 
                                     "Bolivia (Plurinational State of)", 
                                     "Haiti"),
                      c("Uruguay", "Argentina", "Cuba", 
                        "Paraguay", "Panamá", "Costa Rica", "Venezuela", "México", 
                        "Colombia", "Chile", "Brasil", "Ecuador", "El Salvador", "Guatemala", 
                        "Rep. Dominicana", "Perú", "Nicaragua", "Honduras", "Bolivia", 
                        "Haití") )

row.names(mmas) <- mmas$region
mmas <- subset( mmas, select = -c(region) )

sizet <- 10

hc <- hclust(dist(mmas))
p1 <-   ggdendrogram(hc, rotate = T) + ggtitle ('Mujeres. 2005 - 2010') + 
  theme(axis.text.y = element_text(size = sizet,  family="Helvetica",
                colour =  c( rep('black',2) , rep("#1F77B4",4) ,  rep('#FF7F0E', 5), 
                           'black'  , '#D62728',  rep("#2CA02C",2), '#D62728',   rep('#2CA02C',4) ) ),
        title = element_text(size = sizet + 1, family="Helvetica",colour = '#252525'),
        axis.text.x = element_text(size = sizet,  family="Helvetica")  ) +
  geom_hline(yintercept = .1, colour = '#b2182b', linetype = 'dashed')

#show_col(tableau_color_pal("tableau20")(20))


mas <- subset(mas, region %in% c("Uruguay", "Argentina", "Cuba", 
                                   "Paraguay", "Panama", "Costa Rica", "Venezuela", "Mexico", 
                                   "Colombia", "Chile", "Brazil", "Ecuador", "El Salvador", "Guatemala", 
                                   "Dominican Republic", "Peru", "Nicaragua", "Honduras", "Bolivia", 
                                   "Haiti")     )

p1b <- ggplot( subset(mas, sexo = 'M'), aes(edadcl, qxn, group = region ) ) + 
  geom_vline(xintercept = seq(0, 80, 5), colour = '#f0f0f0', linetype = '22') +   
  geom_vline(xintercept = seq(0, 80, 10), colour = '#EAEAEA', linetype = '22') +   
  geom_vline(xintercept = seq(0, 80, 20), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = c(.0001, .001, .01, .1, 1), colour = '#E4E4E4', linetype = '22') + 
  geom_line( colour = 'gray') + theme_bw() +
  scale_y_log10(limits = c(0.0001, 1), name = expression(log(paste(''[n], q[x])  ) ), 
                expand = c(.1, 0) , breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x)) ) + 
  xlab('Edad') +
  scale_x_continuous(limits = c(0,85), breaks = seq(0, 85, 10), expand = c(.1, .1) ) + 
  ggtitle ('Mujeres. 2005 - 2010') +
  geom_line( data = subset(mas , region %in% 
                             c('El Salvador',  'Brazil', 'Nicaragua', 'Dominican Republic') ), 
             aes(edadcl, qxn, group = region,   colour = 'GR1 SLV BRA NIC DOM' ), size = 1.05) +
  geom_line( data = subset(mas , region %in% 
                             c('Mexico', 'Cuba', 'Costa Rica', 'Chile' , 'Panamá', 'Ecuador' ) ), 
             aes(edadcl, qxn, group = region,    colour = 'GR3 MEX CUB CRC CHL PAN ECU' ), size = 1.05)  +
  geom_line( data = subset(mas , region %in% 
                             c('Uruguay', 'Argentina' ) ), 
             aes(edadcl, qxn, group = region,   colour = 'GR4 URY ARG' ), size = 1.05)  +
  geom_line( data = subset(mas , region %in% 
                             c("Colombia" , 'Guatemala' , 'Peru', 'Paraguay' , 'Venezuela' ) ), 
             aes(edadcl, qxn, group = region,  colour = 'GR2 COL GTM PER PRY VEN' ), size = 1.05) +
  scale_colour_tableau(name = '') + 
  theme(legend.position = c(.6, .17),    
        legend.text = element_text(size = sizet - 1 ),
        panel.grid = element_blank(),
        axis.text = element_text(size = sizet,  family="Helvetica") , 
        axis.title = element_text(size = sizet,  family="Helvetica"),
        title = element_text(size = sizet + 1,  family="Helvetica")) +
  annotation_logticks(sides = "l")


# # dendrograma hombres 2005 ----------------------------------------------


mas <- ma[, c("Period","region", "Edad", 'edadcl', 'qxn', 'sexo') , with = F]
mas <- mas[ sexo == 'H' & Period == '2005-2010', ]

mas$qxn  <- as.numeric(as.character(mas$qxn))

mmas <- dcast(mas,  region   ~  Period +sexo + Edad, value.var = c('qxn'), sum)
mmas <- subset(mmas, region %in% c("Uruguay", "Argentina", "Cuba", 
                                   "Paraguay", "Panama", "Costa Rica", 
                                   "Venezuela (Bolivarian Republic of)", "Mexico", 
                                   "Colombia", "Chile", "Brazil", "Ecuador", "El Salvador", "Guatemala", 
                                   "Dominican Republic", "Peru", "Nicaragua", "Honduras", 
                                   "Bolivia (Plurinational State of)", 
                                   "Haiti")     )

mmas$region <- factor(mmas$region, c("Uruguay", "Argentina", "Cuba", 
                                     "Paraguay", "Panama", "Costa Rica", 
                                     "Venezuela (Bolivarian Republic of)", "Mexico", 
                                     "Colombia", "Chile", "Brazil", "Ecuador", "El Salvador", "Guatemala", 
                                     "Dominican Republic", "Peru", "Nicaragua", "Honduras", 
                                     "Bolivia (Plurinational State of)", 
                                     "Haiti"),
                      c("Uruguay", "Argentina", "Cuba", 
                        "Paraguay", "Panamá", "Costa Rica", "Venezuela", "México", 
                        "Colombia", "Chile", "Brasil", "Ecuador", "El Salvador", "Guatemala", 
                        "Rep. Dominicana", "Perú", "Nicaragua", "Honduras", "Bolivia", 
                        "Haití") )

row.names(mmas) <- mmas$region
mmas <- subset( mmas, select = -c(region) )

hc <- hclust(dist(mmas))
p2 <- ggdendrogram(hc, rotate = T)  + ggtitle ('Hombres. 2005 - 2010') + 
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour =  c( rep ('#2CA02C', 6)  , 
                                               rep("#FF7F0E",3), 'black',  rep("#FF7F0E",2), 
                                                rep('#1F77B4', 4),  
                                                rep('#D62728',2),  rep('black',2) ) ),
        title = element_text(size = sizet + 1, family="Helvetica",colour = '#252525'),
        axis.text.x = element_text(size = sizet,  family="Helvetica") ) +
  geom_hline(yintercept = .1, colour = '#b2182b', linetype = 'dashed')

mas <- subset(mas, region %in% c("Uruguay", "Argentina", "Cuba", 
                                 "Paraguay", "Panama", "Costa Rica", "Venezuela", "Mexico", 
                                 "Colombia", "Chile", "Brazil", "Ecuador", "El Salvador", "Guatemala", 
                                 "Dominican Republic", "Peru", "Nicaragua", "Honduras", "Bolivia", 
                                 "Haiti")     )

p2b <- ggplot( subset(mas, sexo = 'H'), aes(edadcl, qxn, group = region ) ) + 
  geom_vline(xintercept = seq(0, 80, 5), colour = '#f0f0f0', linetype = '22') +   
  geom_vline(xintercept = seq(0, 80, 10), colour = '#EAEAEA', linetype = '22') +   
  geom_vline(xintercept = seq(0, 80, 20), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = c(.0001, .001, .01, .1, 1), colour = '#E4E4E4', linetype = '22') + 
  geom_line( colour = 'gray') + theme_bw() + ggtitle ('Hombres. 2005 - 2010') +
  scale_y_log10(limits = c(0.0001, 1), name = expression(log(paste(''[n], q[x])  ) ), expand = c(.1,0),
                breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x)) ) + 
   xlab('Edad') +
  scale_x_continuous(limits = c(0,85), breaks = seq(0, 85, 10), expand = c(.1, .1) ) +
  geom_line( data = subset(mas , region %in% 
                             c('Mexico', 'Cuba' , 'Costa Rica', 'Chile' , 'Panamá', 'Ecuador') ), 
             aes(edadcl, qxn, group = region,    colour = 'GR3 MEX CUB CRC CHL PAN ECU' ), size = 1.05)  +
  geom_line( data = subset(mas , region %in% 
                             c('Uruguay', 'Argentina' ) ), 
             aes(edadcl, qxn, group = region,   colour = 'GR4 URY ARG' ), size = 1.05)+
  geom_line( data = subset(mas , region %in% 
                             c('El Salvador',  'Brazil', 'Nicaragua', 'Dominican Republic') ), 
             aes(edadcl, qxn, group = region,   colour = 'GR1 SLV BRA NIC DOM' ), size = 1.05) +
  geom_line( data = subset(mas , region %in% 
                             c("Colombia" , 'Guatemala' , 'Peru', 'Paraguay' , 'Venezuela' ) ), 
             aes(edadcl, qxn, group = region,  colour = 'GR2 COL GTM PER PRY VEN' ), size = 1.05) +
  scale_colour_tableau(name = '') + 
  theme(legend.position = c(.6, .17),   
        legend.text = element_text(size = sizet - 1 ),
        panel.grid = element_blank(),
        axis.text = element_text(size = sizet,  family="Helvetica") , 
        axis.title = element_text(size = sizet,  family="Helvetica"),
        title = element_text(size = sizet + 1,  family="Helvetica")) +
  annotation_logticks(sides = "l")


# dendrograma # mujeres 1950 ----------------------------------------------

mas <- ma[, c("Period","region", "Edad", 'edadcl', 'qxn', 'sexo') , with = F]
mas <- mas[ sexo == 'M' & Period == '1950-1955', ]

mas$qxn  <- as.numeric(as.character(mas$qxn))

mmas <- dcast(mas,  region   ~   Period +sexo + Edad, value.var = c('qxn'), sum)
mmas <- subset(mmas, region %in% c("Uruguay", "Argentina", "Cuba", 
                                   "Paraguay", "Panama", "Costa Rica", 
                                   "Venezuela (Bolivarian Republic of)", "Mexico", 
                                   "Colombia", "Chile", "Brazil", "Ecuador", "El Salvador", "Guatemala", 
                                   "Dominican Republic", "Peru", "Nicaragua", "Honduras", 
                                   "Bolivia (Plurinational State of)", 
                                   "Haiti")     )

mmas$region <- factor(mmas$region, c("Uruguay", "Argentina", "Cuba", 
                                     "Paraguay", "Panama", "Costa Rica", 
                                     "Venezuela (Bolivarian Republic of)", "Mexico", 
                                     "Colombia", "Chile", "Brazil", "Ecuador", "El Salvador", "Guatemala", 
                                     "Dominican Republic", "Peru", "Nicaragua", "Honduras", 
                                     "Bolivia (Plurinational State of)", 
                                     "Haiti"),
                      c("Uruguay", "Argentina", "Cuba", 
                        "Paraguay", "Panamá", "Costa Rica", "Venezuela", "México", 
                        "Colombia", "Chile", "Brasil", "Ecuador", "El Salvador", "Guatemala", 
                        "Rep. Dominicana", "Perú", "Nicaragua", "Honduras", "Bolivia", 
                        "Haití") )

row.names(mmas) <- mmas$region


mmas <- subset( mmas, select = -c(region) )

hc <- hclust(dist(mmas))
p3 <- ggdendrogram(hc, rotate = T) + ggtitle ('Mujeres. 1950-1955') + 
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c("black", "#FF7F0E" ,  "#FF7F0E" , "#FF7F0E" ,
                                             '#FF7F0E', 'black', 'black', '#1F77B4', '#1F77B4', 
                                             '#1F77B4', 'black', '#D62728', '#D62728', 'black',  'black',  
                                               '#2CA02C', 'black', 'black', '#2CA02C', '#2CA02C'                                              
                                              ) ),
        title = element_text(size = sizet + 1, family="Helvetica",colour = '#252525'),
        axis.text.x = element_text(size = sizet,  family="Helvetica") ) +
  geom_hline(yintercept = .1, colour = '#b2182b', linetype = 'dashed')

mas <- subset(mas, region %in% c("Uruguay", "Argentina", "Cuba", 
                                 "Paraguay", "Panama", "Costa Rica", "Venezuela", "Mexico", 
                                 "Colombia", "Chile", "Brazil", "Ecuador", "El Salvador", "Guatemala", 
                                 "Dominican Republic", "Peru", "Nicaragua", "Honduras", "Bolivia", 
                                 "Haiti")     )

p3b <- ggplot( subset(mas, sexo = 'M'), aes(edadcl, qxn, group = region ) ) + 
  geom_vline(xintercept = seq(0, 80, 5), colour = '#f0f0f0', linetype = '22') +   
  geom_vline(xintercept = seq(0, 80, 10), colour = '#EAEAEA', linetype = '22') +   
  geom_vline(xintercept = seq(0, 80, 20), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = c(.0001, .001, .01, .1, 1 ), colour = '#E4E4E4', linetype = '22') + 
  geom_line( colour = 'gray') + theme_bw() + ggtitle ('Mujeres. 1950-1955') + 
  scale_y_log10(limits = c(0.0001, 1), name = expression(log(paste(''[n], q[x])  ) ), expand = c(.1,0),
                breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x)) ) + 
  xlab('Edad') +
  scale_x_continuous(limits = c(0,85), breaks = seq(0, 85, 10), expand = c(.1, .1)) +
  geom_line( data = subset(mas , region %in% 
                             c('Peru', 'Bolivia', 'Nicaragua'  ) ), 
             aes(edadcl, qxn, group = region,    colour = 'GR1 PER BOL NIC' ), size = 1.05) +
  geom_line( data = subset(mas , region %in% 
                             c('Mexico', 'Brazil' , 'Chile' ) ), 
             aes(edadcl, qxn, group = region,    colour = 'GR3 MEX BRA CHL' ), size = 1.05)  +
  geom_line( data = subset(mas , region %in% 
                             c('Uruguay', 'Argentina' ) ), 
             aes(edadcl, qxn, group = region,   colour = 'GR4 URY ARG' ), size = 1.05) +
  geom_line( data = subset(mas , region %in% 
                             c("El Salvador" , "Dominican Republic", "Ecuador" , "Colombia"  ) ), 
             aes(edadcl, qxn, group = region,  colour = 'GR2 SLV DOM ECU COL' ), size = 1.05) +
  scale_colour_tableau(name = '') + 
  theme(legend.position = c(.65, .15), legend.text = element_text(size = sizet - 1 ),
        panel.grid = element_blank(),
        axis.text = element_text(size = sizet,  family="Helvetica") , 
        axis.title = element_text(size = sizet,  family="Helvetica"),
        title = element_text(size = sizet + 1,  family="Helvetica")) +
  annotation_logticks(sides = "l")

# dendrograma # hombres 50 ------------------------------------------------

mas <- ma[, c("Period","region", "Edad", 'edadcl', 'qxn', 'sexo') , with = F]
mas <- mas[ sexo == 'H' & Period == '1950-1955', ]

mas$qxn  <- as.numeric(as.character(mas$qxn))

mmas <- dcast(mas,  region   ~  Period +sexo + Edad, value.var = c('qxn'), sum)

mmas <- subset(mmas, region %in% c("Uruguay", "Argentina", "Cuba", 
                                   "Paraguay", "Panama", "Costa Rica", 
                                   "Venezuela (Bolivarian Republic of)", "Mexico", 
                                   "Colombia", "Chile", "Brazil", "Ecuador", "El Salvador", "Guatemala", 
                                   "Dominican Republic", "Peru", "Nicaragua", "Honduras", 
                                   "Bolivia (Plurinational State of)", 
                                   "Haiti")     )

mmas$region <- factor(mmas$region, c("Uruguay", "Argentina", "Cuba", 
                                     "Paraguay", "Panama", "Costa Rica", 
                                     "Venezuela (Bolivarian Republic of)", "Mexico", 
                                     "Colombia", "Chile", "Brazil", "Ecuador", "El Salvador", "Guatemala", 
                                     "Dominican Republic", "Peru", "Nicaragua", "Honduras", 
                                     "Bolivia (Plurinational State of)", 
                                     "Haiti"),
                      c("Uruguay", "Argentina", "Cuba", 
                        "Paraguay", "Panamá", "Costa Rica", "Venezuela", "México", 
                        "Colombia", "Chile", "Brasil", "Ecuador", "El Salvador", "Guatemala", 
                        "Rep. Dominicana", "Perú", "Nicaragua", "Honduras", "Bolivia", 
                        "Haití") )

row.names(mmas) <- mmas$region
mmas <- subset( mmas, select = -c(region) )

hc <- hclust(dist(mmas))

p4 <- ggdendrogram(hc, rotate = T) + ggtitle ('Hombres. 1950-1955')+ 
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c( '#D62728', '#D62728','black','black','black',
                                               'black','black','#2CA02C','#2CA02C','#2CA02C',
                                               '#1F77B4','#1F77B4','#1F77B4','#FF7F0E','#FF7F0E',
                                               '#FF7F0E',"#FF7F0E","black","black","black") ),
        title = element_text(size = sizet + 1, family="Helvetica",colour = '#252525'),
        axis.text.x = element_text(size = sizet,  family="Helvetica") ) +
  geom_hline(yintercept = .1, colour = '#b2182b', linetype = 'dashed')

mas <- subset(mas, region %in% c("Uruguay", "Argentina", "Cuba", 
                                 "Paraguay", "Panama", "Costa Rica", "Venezuela", "Mexico", 
                                 "Colombia", "Chile", "Brazil", "Ecuador", "El Salvador", "Guatemala", 
                                 "Dominican Republic", "Peru", "Nicaragua", "Honduras", "Bolivia", 
                                 "Haiti")     )

p4b <- ggplot( subset(mas, sexo = 'H'), aes(edadcl, qxn, group = region ) ) + 
  geom_vline(xintercept = seq(0, 80, 5), colour = '#f0f0f0', linetype = '22') +   
  geom_vline(xintercept = seq(0, 80, 10), colour = '#EAEAEA', linetype = '22') +   
  geom_vline(xintercept = seq(0, 80, 20), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = c(.0001, .001, .01, .1,1), colour = '#E4E4E4', linetype = '22') + 
  geom_line( colour = 'gray') + theme_bw() + ggtitle ('Hombres. 1950-1955')+ 
  scale_y_log10(limits = c(0.0001, 1), name = expression(log(paste(''[n], q[x])  ) ), expand = c(.1,0),
                breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) + 
   xlab('Edad') +
  scale_x_continuous(limits = c(0,85), breaks = seq(0, 85, 10), expand = c(.1, .1)) +
  geom_line( data = subset(mas , region %in% 
                             c('Peru', 'Bolivia', 'Nicaragua'  ) ), 
             aes(edadcl, qxn, group = region,    colour = 'GR1 PER BOL NIC' ), size = 1.05) +
  geom_line( data = subset(mas , region %in% 
                             c('Mexico', 'Brazil' , 'Chile' ) ), 
             aes(edadcl, qxn, group = region,    colour = 'GR3 MEX BRA CHL' ), size = 1.05)  +
  geom_line( data = subset(mas , region %in% 
                             c('Uruguay', 'Argentina' ) ), 
             aes(edadcl, qxn, group = region,   colour = 'GR4 URY ARG' ), size = 1.05) +
  geom_line( data = subset(mas , region %in% 
                             c("El Salvador" , "Dominican Republic", "Ecuador" , "Colombia"  ) ), 
             aes(edadcl, qxn, group = region,  colour = 'GR2 SLV DOM ECU COL' ), size = 1.05) +
  scale_colour_tableau(name = '') + 
  theme(legend.position = c(.65, .15), 
        legend.text = element_text(size = sizet - 1 ),
        panel.grid = element_blank(),
        axis.text = element_text(size = sizet,  family="Helvetica") , 
        axis.title = element_text(size = sizet,  family="Helvetica"),
        title = element_text(size = sizet + 1,  family="Helvetica")) +
  annotation_logticks(sides = "l")

pdf(file = "GRdendro.pdf",      width = 8,    height = 10.5)
print(grid.arrange(p4,p3,p4b,p3b))
dev.off()

pdf(file = "GRdendro2.pdf",      width = 8,    height = 10.5)
print(grid.arrange(p2,p1,p2b,p1b))
dev.off()


# dendrograma # analisis 50 55 --------------------------------------------

mas <- ma[, c("Period","region", "Edad", 'edadcl', 'qxn', 'sexo') , with = F]
mas <- mas[  Period == '1950-1955', ]

mas$qxn  <- as.numeric(as.character(mas$qxn))

mmas <- dcast(mas,  region   ~  Period +sexo + Edad, value.var = c('qxn'), sum)

mmas <- subset(mmas, region %in% c("Uruguay", "Argentina", "Cuba", 
                                   "Paraguay", "Panama", "Costa Rica", "Venezuela", "Mexico", 
                                   "Colombia", "Chile", "Brazil", "Ecuador", "El Salvador", "Guatemala", 
                                   "Dominican Republic", "Peru", "Nicaragua", "Honduras", "Bolivia", 
                                   "Haiti")     )

mmas$region <- factor(mmas$region, c("Uruguay", "Argentina", "Cuba", 
                                     "Paraguay", "Panama", "Costa Rica", "Venezuela", "Mexico", 
                                     "Colombia", "Chile", "Brazil", "Ecuador", "El Salvador", "Guatemala", 
                                     "Dominican Republic", "Peru", "Nicaragua", "Honduras", "Bolivia", 
                                     "Haiti"),
                      c("Uruguay", "Argentina", "Cuba", 
                        "Paraguay", "Panamá", "Costa Rica", "Venezuela", "México", 
                        "Colombia", "Chile", "Brasil", "Ecuador", "El Salvador", "Guatemala", 
                        "Rep. Dominicana", "Perú", "Nicaragua", "Honduras", "Bolivia", 
                        "Haití") )

m1 <- mas[region %in%  c("El Salvador" , "Dominican Republic", "Ecuador" , "Colombia"  ) ][
  , qxnpm := round(qxn *1000)]
m2a <- dcast.data.table(m1,  Edad ~ sexo + region, value.var = 'qxnpm')

m2a[, c("gccolhmin", "gccolhmax") := { z <- m2a[, 2:5, with = FALSE]; 
                        list(do.call(pmin, z), do.call(pmax, z))}]
m2a[, c("gccolmmin", "gccolmmax") := { z <- m2a[, 6:9, with = FALSE]; 
                             list(do.call(pmin, z), do.call(pmax, z))}]

m1 <- mas[region %in%   c('Peru', 'Bolivia', 'Nicaragua'  ) ][
  , qxnpm := round(qxn *1000)]
m2b <- dcast.data.table(m1,  Edad ~ sexo + region, value.var = 'qxnpm')

m2b[, c("gbolhmin", "gbolhmax") := { z <- m2b[, 2:4, with = FALSE]; 
                             list(do.call(pmin, z), do.call(pmax, z))}]
m2b[, c("gbolmmin", "gbolmmax") := { z <- m2b[, 5:7, with = FALSE]; 
                             list(do.call(pmin, z), do.call(pmax, z))}]


m1 <- mas[region %in%   c('Mexico', 'Brazil' , 'Chile'  ) ][
  , qxnpm := round(qxn *1000)]
m2c <- dcast.data.table(m1,  Edad ~ sexo + region, value.var = 'qxnpm')

m2c[, c("gmexhmin", "gmexhmax") := { z <- m2c[, 2:4, with = FALSE]; 
                             list(do.call(pmin, z), do.call(pmax, z))}]
m2c[, c("gmexmmin", "gmexmmax") := { z <- m2c[, 5:7, with = FALSE]; 
                             list(do.call(pmin, z), do.call(pmax, z))}]



m1 <- mas[region %in%   c('Uruguay', 'Argentina'  ) ][
  , qxnpm := round(qxn *1000)]
m2d <- dcast.data.table(m1,  Edad ~ sexo + region, value.var = 'qxnpm')

m2d[, c("garghmin", "garghmax") := { z <- m2d[, 2:3, with = FALSE]; 
                                     list(do.call(pmin, z), do.call(pmax, z))}]
m2d[, c("gargmmin", "gargmmax") := { z <- m2d[, 4:5, with = FALSE]; 
                                     list(do.call(pmin, z), do.call(pmax, z))}]

m2a[, c("Edad" , "gccolhmin" , "gccolhmax"   ,   "gccolmmin"  ,"gccolmmax"  ) , with = F]

(cbind(m2a[,c(1,10:11), with =F], m2b[,c(8:9), with =F])[, crit := gccolhmax < gbolhmin])
(cbind(m2a[,c(1,12:13), with =F], m2b[,c(10:11), with =F])[, crit := gccolmmax < gbolmmin])
m2b[, c("Edad" ,"gbolhmin" ,   "gbolhmax"  ,  "gbolmmin"  ,  "gbolmmax") , with = F]


(cbind( m2c[,c(1,8:9), with =F]   ,m2a[,c(10:11), with =F] )[, crit := gmexhmax < gccolhmin])
(cbind( m2c[,c(1,10:11), with =F], m2a[,c(12:13), with =F])[, crit := gmexmmax < gccolmmin])
m2c[, c("Edad" , "gmexhmin", "gmexhmax", "gmexmmin", "gmexmmax"), with = F]


(cbind( m2d[,c(1,6:7), with =F] , m2a[,c(10:11), with =F])[, crit := garghmax < gccolhmin])
(cbind(m2d[,c(1,8:9), with =F], m2a[,c(12:13), with =F] )[, crit := gargmmax < gccolmmin])
m2d[, c("Edad" ,"garghmin" ,   "garghmax" ,"gargmmin"  ,  "gargmmax"), with = F]



# dendrograma # analisis 0510 ---------------------------------------------

mas <- ma[, c("Period","region", "Edad", 'edadcl', 'qxn', 'sexo') , with = F]
mas <- mas[  Period == '2005-2010', ]

mas$qxn  <- as.numeric(as.character(mas$qxn))

mmas <- dcast(mas,  region   ~  Period +sexo + Edad, value.var = c('qxn'), sum)

mmas <- subset(mmas, region %in% c("Uruguay", "Argentina", "Cuba", 
                                   "Paraguay", "Panama", "Costa Rica", "Venezuela", "Mexico", 
                                   "Colombia", "Chile", "Brazil", "Ecuador", "El Salvador", "Guatemala", 
                                   "Dominican Republic", "Peru", "Nicaragua", "Honduras", "Bolivia", 
                                   "Haiti")     )

mmas$region <- factor(mmas$region, c("Uruguay", "Argentina", "Cuba", 
                                     "Paraguay", "Panama", "Costa Rica", "Venezuela", "Mexico", 
                                     "Colombia", "Chile", "Brazil", "Ecuador", "El Salvador", "Guatemala", 
                                     "Dominican Republic", "Peru", "Nicaragua", "Honduras", "Bolivia", 
                                     "Haiti"),
                      c("Uruguay", "Argentina", "Cuba", 
                        "Paraguay", "Panamá", "Costa Rica", "Venezuela", "México", 
                        "Colombia", "Chile", "Brasil", "Ecuador", "El Salvador", "Guatemala", 
                        "Rep. Dominicana", "Perú", "Nicaragua", "Honduras", "Bolivia", 
                        "Haití") )

m1 <- mas[region %in%  c("Colombia" , 'Guatemala' , 'Peru', 'Paraguay' , 'Venezuela' ) ][
  , qxnpm := round(qxn *1000)]
m2a <- dcast.data.table(m1,  Edad ~ sexo + region, value.var = 'qxnpm')

m2a[, c("gccolhmin", "gccolhmax") := { z <- m2a[, 2:6, with = FALSE]; 
                                       list(do.call(pmin, z), do.call(pmax, z))}]
m2a[, c("gccolmmin", "gccolmmax") := { z <- m2a[, 7:11, with = FALSE]; 
                                       list(do.call(pmin, z), do.call(pmax, z))}]

m1 <- mas[region %in%   c('El Salvador',  'Brazil', 'Nicaragua', 'Dominican Republic'  ) ][
  , qxnpm := round(qxn *1000)]
m2b <- dcast.data.table(m1,  Edad ~ sexo + region, value.var = 'qxnpm')

m2b[, c("gbolhmin", "gbolhmax") := { z <- m2b[, 2:5, with = FALSE]; 
                                     list(do.call(pmin, z), do.call(pmax, z))}]
m2b[, c("gbolmmin", "gbolmmax") := { z <- m2b[, 6:9, with = FALSE]; 
                                     list(do.call(pmin, z), do.call(pmax, z))}]


m1 <- mas[region %in%   c('Mexico', 'Cuba', 'Costa Rica', 'Chile' , 'Panama', 'Ecuador'  ) ][
  , qxnpm := round(qxn *1000)]
m2c <- dcast.data.table(m1,  Edad ~ sexo + region, value.var = 'qxnpm')

m2c[, c("gmexhmin", "gmexhmax") := { z <- m2c[, 2:7, with = FALSE]; 
                                     list(do.call(pmin, z), do.call(pmax, z))}]
m2c[, c("gmexmmin", "gmexmmax") := { z <- m2c[, 8:13, with = FALSE]; 
                                     list(do.call(pmin, z), do.call(pmax, z))}]

m2a[, c("Edad" , "gccolhmin" , "gccolhmax" , "gccolmmin" , "gccolmmax"), with = F]

m1 <- mas[region %in%   c('Uruguay', 'Argentina'  ) ][
  , qxnpm := round(qxn *1000)]
m2d <- dcast.data.table(m1,  Edad ~ sexo + region, value.var = 'qxnpm')

m2d[, c("garghmin", "garghmax") := { z <- m2d[, 2:3, with = FALSE]; 
                                     list(do.call(pmin, z), do.call(pmax, z))}]
m2d[, c("gargmmin", "gargmmax") := { z <- m2d[, 4:5, with = FALSE]; 
                                     list(do.call(pmin, z), do.call(pmax, z))}]

(cbind( m2a[, c("Edad" , "gccolhmin" , "gccolhmax"   ) , with = F]
       , m2b[, c( "gbolhmin" , "gbolhmax"     ) , with = F])[, crit := gccolhmax < gbolhmin])

(cbind( m2c[, c("Edad" ,  "gmexhmin"  ,   "gmexhmax" ) , with = F]
        , m2d[, c( "garghmin" ,   "garghmax"     ) , with = F])[, crit := garghmin > gmexhmax])





# COL ALC Heligman Anualizar TVida  -----------------------------------------------------------

# ajuste hombres ----------------------------------------------------------


mah <- fread('tvhombres.csv');     mam <- fread('tvmujeres.csv')
mah$sexo <- "H" ;      mam$sexo <- "M";    ma <- rbind(mah, mam); ma <- data.table(ma)
ma$sexo <- factor(ma$sexo, c('H','M')  , c('Hombres','Mujeres'))

setnames(ma,c(3,8,9,11,13, 14, 18, 19) , c( "Pais", "Edad","Intervalo", "qxn", "lxn","dxn" , "ex", "axn")) 
ma <- ma[Edad < 80  , c("Pais", "sexo", "Period", "Edad", "Intervalo", "qxn", "lxn","dxn", "axn"), with =F ]
ma$clase <- ma$Edad + (ma$Intervalo) / 2;       ma$qxn <- as.numeric(as.character(ma$qxn)) 

ma$Edadb <- ifelse(ma$Edad %in% 0:1, 0, ma$Edad   )

ma <-  ma[ , list(min(qxn), min(lxn), sum(dxn), min(axn) )  , keyby = list(Pais, sexo, Period, Edadb)   ]
setnames(ma, 4:8, c("Edad","qxn", "lxn","dxn", "axn")   )

ma[Edad == 0]$qxn <- NA;  
ma$qxn <- ifelse(ma$Edad == 0, ma$dxn / ma$lxn  ,  ma$qxn)

parConv <- c(a = 0.0005893,b = 0.0043836, c = 0.0828424,   d = 0.000706,e = 9.927863, 
             f = 22.197312, g = 0.00004948, h = 1.10003);       parStart <- parConv; 

HP8 <- function(parS,x) with(as.list(parS),    ifelse(x == 0, a ^ ((x + b) ^ c) + g * h ^ x, 
                                                      a ^ ((x + b) ^ c) + d * exp(-e * (log(x / f))^2) + g * h ^ x))
## Define qx = HP8/(1+HP8)
qxPred <- function(parS, x) { h <- HP8(parS, x);         h / (1 + h)  }
nqxPred <- function(parS,x)
  (1 -(1 - qxPred(parS, x)) * (1 - qxPred(parS, x + 1)) * 
     (1 - qxPred(parS, x + 2)) * (1 - qxPred(parS, x + 3)) * (1 - qxPred(parS, x + 4))) 
##Define Residual Function, the relative squared distance is minimized  
ResidFun <- function(parS, Observed, x) (nqxPred(parS, x)/ Observed - 1)
ssqfun <- function(parS, Observed, x) { sum(ResidFun(parS, Observed, x) ^ 2) }

no <- function (Periode, sexoe, Paise) {
  massu <- subset(ma, Period == Periode  & sexo == sexoe & Pais == Paise)
  opt2 <- nlminb(start = parStart, objective = ssqfun,    Observed = massu$qxn, x = massu$Edad,                 
                 control= list(eval.max=200,iter.max=200))
  parNLM <- opt2$par;      
  
  
  pred2 <- nqxPred(as.list(parNLM), massu$Edad)
  dPred <- with(massu,  data.frame(Edad, qxn = pred2, w="nlminb"))
  list( opt2$par, data.frame(nqxPred(as.list(opt2$par), massu$Edad), massu$Edad, massu$qxn)  )
  ajust <- data.frame(matrix(ncol = 1, nrow = length(seq(0, 100, 5)) ))
  ajust$Edad <- seq(0, 100, 5)
  ajust$pred2 <- nqxPred(as.list(parNLM), ajust$Edad )
  ajust$Period <- unique(massu$Period)
  ajust$Pais <- unique(massu$Pais)
  ajust$sexo <- unique(massu$sexo)  
  
  dPred <- merge(massu, ajust, by = c('Edad', 'Period', 'Pais', 'sexo'), all = T )
  list( opt2$par, subset(dPred, select = c('Edad', 'pred2', 'qxn',
                                           'Period', 'Pais', 'sexo')  ) )

}

hstart <- no("2005-2010","Hombres","Colombia");  mstart <- no("2005-2010","Mujeres","Colombia")
dput(hstart[[1]]);  dput( mstart[[1]]);  

parStart <- c(a = 0.0858154382177973, b = 2.53428042800576, c = 0.54902274848672, 
              d = 0.0039450120409146, e = 4.95969958002048, f = 25.4950097467139, g = 7.35318048820254e-05, 
              h = 1.09102199100661)

mas1 <- subset(ma, Pais == "Colombia" & Edad < 80 & sexo == "Hombres")
resb <- dlply(mas1, .(Period, sexo, Pais), function(massu)
{opt2 <- nlminb(start = parStart, objective = ssqfun,    Observed = massu$qxn, x = massu$Edad,                 
                control= list(eval.max=200,iter.max=200, abs.tol = 1e-20))
 parNLM <- opt2$par
 
 pred2 <- nqxPred(as.list(parNLM), massu$Edad)
 dPred <- with(massu,  data.frame(Edad, qxn = pred2, w="nlminb"))
 list( opt2$par, data.frame(nqxPred(as.list(opt2$par), massu$Edad), massu$Edad, massu$qxn)  )
 ajust <- data.frame(matrix(ncol = 1, nrow = length(seq(0, 100, 5)) ))
 ajust$Edad <- seq(0, 100, 5)
 ajust$pred2 <- nqxPred(as.list(parNLM), ajust$Edad )
 ajust$Period <- unique(massu$Period)
 ajust$Pais <- unique(massu$Pais)
 ajust$sexo <- unique(massu$sexo)  
 
 dPred <- merge(massu, ajust, by = c('Edad', 'Period', 'Pais', 'sexo'), all = T )
 list( opt2$par, subset(dPred, select = c('Edad', 'pred2', 'qxn',
                                          'Period', 'Pais', 'sexo')  ) )
})

resbl1 <- lapply( 1:12, function(i) resb[[i]][1]  );    m.resbl1 <- melt(resbl1)
resbln <- lapply( 1:12, function(i) names(resb[i])  );      m.resbln <- melt(resbln)
resblc <- lapply( 1:12, function(i) names(resb[[i]][[1]])  );     m.resblc <- melt(resblc)

lb <-  cbind(m.resbl1, m.resblc[,1]);   lb <- merge(lb, m.resbln, by = "L1");   setnames(lb, 4, "param")
l1b <- dcast(lb, value.y ~ param, value.var="value.x")

setnames(l1b, 1, "id" );     l1b$anio <- factor(substring(l1b$id, 1,9))
l1b$sexo <- factor(substring(l1b$id, 11,11))


l1b <- data.table(l1b);   l1b <- l1b[order(sexo, anio)]

resbl2 <- lapply( 1:12, function(i) resb[[i]][2]  );  
resbl2m <- ldply(resbl2, data.frame)
setnames(resbl2m, 1:6, c('clase', 'ajust',  'obs', 'periodo', 'pais', 'sexo') )


# errores porcentuales
resbl2mdt <- data.table(resbl2m)
resbl2mdt[, difporc :=  abs (round( (  (ajust / obs) - 1  ) * 100 ) )  ] 
er.h <- resbl2mdt[, list(round(mean(difporc, na.rm = T), 1)  ) , keyby = list(periodo) ]

tv <- ddply(l1b, .(sexo, anio  ) , function(bd)   {  
  data.frame (0:130, qxPred(as.list(bd[,c('a', 'b','c','d','e','f','g','h')]),   0:130) )
}  )
setnames(tv, 2:4, c('Period','Edad', 'qxn') )
tv$sexo <- factor(tv$sexo, c('H','M')  , c('Hombres','Mujeres'));  
tv <- data.table(tv);    

a0s <- ma[Edad == 0 & Pais == "Colombia", c( 'sexo' ,'Edad' ,  'Period', 'axn' )  , with = F]
tv <- merge(tv, a0s, by =  c('sexo'  ,  'Period','Edad'), all.x = T )
tv$axn[is.na(tv$axn)== T] <- 1/ 2;          tv$mxn <- 2 *  tv$qxn / (2- tv$qxn) 

tv[, lxn := round(c(100000, cumprod(1 - qxn) * 100000))  , keyby = list(sexo , Period )]
tv$dxn <- round(tv$lxn * tv$qxn);    
tv$Lxn <- tv$lxn - tv$axn * tv$dxn

tv[, Txn := rev( cumsum(rev(Lxn)   )   ) , keyby = list(sexo , Period )]
tv$exn <- tv$Txn / tv$Lxn 

tvh <- tv

setnames(mah,c(3,8,9,11,13, 14, 18, 19) , c( "Pais", "Edad","Intervalo", "qxn", "lxn","dxn" , "ex", "axn")) 
(mah[Pais == 'Colombia' & Edad == 0][, c('Period', 'ex'), with = F][, exr := round(ex,1)])
(tv[Edad==0][, c('Period', 'exn'), with = F][, exr := round(exn,1)])

estimate_mode <- function(x) {    d <- density(x) ;   d$x[which.max(d$y)]     }

med <- tv[, wtd.quantile(Edad, .5, weights = dxn) , keyby = list(Period )]
mod <- tv[Edad > 5][, round(estimate_mode(rep(Edad, dxn)),1 ) , keyby = list(Period )]
ev <- tv[Edad==0][, c('Period', 'exn'), with = F][, exr := round(exn,1)][ ,c('Period', 'exr'), with = F]

iqr <- tv[, list (wtd.quantile(Edad, .25, weights = dxn), wtd.quantile(Edad, .75, weights = dxn)) ,
          keyby = list(Period )][,IQR := V2-V1][ ,c('Period', 'IQR'), with = F]

d10 <- tv[Edad > 10][, round(sqrt(wtd.var( Edad, weights = dxn)),1)  , keyby = list(Period )]


su <- Reduce(function(...) merge(..., by='Period', all=T), list(ev, med, mod, iqr, d10)  )
setnames(su, 2:6, c('ex', 'Med', 'Moda', 'IQR', 'SD10')  )

suh <- su

# ggplot(l1b, aes(   anio, d)  ) + geom_path(aes(group=1)) + 
#   facet_grid(sexo~.) +  theme_bw() + geom_smooth(aes(group=1), span = 1)
# ggplot(l1b, aes(   anio, e)  ) + geom_path(aes(group=1)) + 
#   facet_grid(sexo~.) +  theme_bw() + geom_smooth(aes(group=1), span = 1)
# ggplot(l1b, aes(   anio, f)  ) + geom_path(aes(group=1)) + 
#   facet_grid(sexo~.) + coord_flip() + theme_bw()  + 
#   geom_smooth(aes(group=1), span = 1, method = 'loess')


# (l1b[, c('anio', 'd') , with =F][, d10mil := round(d * 10000)][, c('anio', 'd10mil') , with =F]   )
# 
# (l1b[, c('anio', 'e') , with =F][, er := round(e, 1)][, c('anio', 'er') , with =F]   )
# 
# (l1b[, c('anio', 'f') , with =F][, fr := round(f, 1)][, c('anio', 'fr') , with =F]   )


l1bh <- l1b[, c('anio', 'd', 'e', 'f') , with =F][, d10mil := round(d * 10000, 1)][
  , er := round(e, 1)][, fr := round(f, 1)][, c('anio', 'd10mil','er', 'fr') , with =F] 
 
xtable(l1bh)

# ggplot(l1b, aes(   anio, a)  ) + geom_path(aes(group=1)) + 
#   facet_grid(sexo~.) +  theme_bw() + geom_smooth(aes(group=1), span = 1)
# ggplot(l1b, aes(   anio, b)  ) + geom_path(aes(group=1)) + 
#   facet_grid(sexo~.) +  theme_bw() + geom_smooth(aes(group=1), span = 1)
# ggplot(l1b, aes(   anio, c)  ) + geom_path(aes(group=1)) + 
#   facet_grid(sexo~.) + coord_flip() + theme_bw()  + 
#   geom_smooth(aes(group=1), span = 1, method = 'loess')

# ggplot(l1b, aes(   anio, g)  ) + geom_path(aes(group=1)) + 
#   facet_grid(sexo~.) +  theme_bw() + geom_smooth(aes(group=1), span = 1)
# ggplot(l1b, aes(   anio, h)  ) + geom_path(aes(group=1)) + 
#   facet_grid(sexo~.) +  theme_bw() + geom_smooth(aes(group=1), span = 1)

sizet <- 10.5

p <- ggplot(resbl2m,  aes(clase, obs))  + facet_wrap( ~ periodo ) +    
  geom_vline(xintercept = seq(0, 100, 5), colour = '#f0f0f0', linetype = '22') +   
  geom_vline(xintercept = seq(0, 100, 10), colour = '#EAEAEA', linetype = '22') +   
  geom_vline(xintercept = seq(0, 100, 20), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = c(.001, .001, .01, .1, 1), colour = '#E4E4E4', linetype = '22') + 
  geom_point(size = 3, colour = "#2171b5") +  geom_point( size = 2, colour = "white") + 
  geom_line(data= resbl2m,  aes(clase, ajust), colour = "#08306b", size = 1) +
  theme_bw(base_size = 10.5) +   theme(legend.position = c(.85, .15)) +   
  scale_x_continuous(name = "Edad", breaks = seq(0, 100, 20), 
                     limit = c(0, 100), expand = c(.2, 0) ) + 
  scale_y_log10(name=expression(log(paste(''[n], q[x])  ) ) , expand = c(.15, .15),
                limits = c(0.001, 1), breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))   )  +
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        strip.text = element_text(size = sizet + 1, family="Helvetica"),
        strip.background = element_rect( fill = "white"), panel.margin = unit(0, "lines") ,
        panel.grid = element_blank() ) + annotation_logticks(sides = "l")

cairo_pdf(file = "helphombcol.pdf", width = 8,   height = 7, family = "Helvetica")
print(   p  )
dev.off()

ph <- ggplot(tv[Period %in% c( "1955-1960",  "1965-1970", "1975-1980", 
                               "1985-1990", "1995-2000",  "2005-2010") & Edad < 111], 
       aes(x = Edad, y = lxn / 1000, colour = Period)) + 
  geom_vline( xintercept = seq(0, 110, 5), colour = '#f0f0f0', linetype = '22') +  
  geom_hline(yintercept = seq(0, 100, 5),colour = '#f0f0f0', linetype = '22') +
  geom_vline( xintercept = seq(0, 110, 10), colour = '#EAEAEA', linetype = '22') +  
  geom_hline(yintercept = seq(0, 100, 10),colour = '#EAEAEA', linetype = '22') +
  geom_vline( xintercept = seq(0, 110, 20), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = seq(0, 100, 20),colour = '#E4E4E4', linetype = '22') +
  theme_bw(base_size = 10)  + geom_line(size = 1.3) +
  scale_x_continuous(limits = c(0, 114), breaks = seq(0, 110, 10) ) +
  scale_y_continuous(name = expression(paste(''[n], l[x], ' (en miles)')   ), breaks = seq(0, 100, 10)) +
  scale_colour_manual(name = '', values = c('#d0d1e6','#a6bddb','#67a9cf','#3690c0',
                                            '#02818a','#016450') ) +
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.text = element_text(size = sizet - 2, family="Helvetica"),
        title = element_text(size = sizet + 1, family="Helvetica"),
        panel.grid = element_blank(), legend.position = c(.85,.8) ) +
  guides(colour = guide_legend(reverse = TRUE)) + ggtitle('Hombres')


ph2 <- ggplot(tv[Period %in% c( "1955-1960",  "1965-1970", "1975-1980", 
                               "1985-1990", "1995-2000",  "2005-2010") & Edad > 39 & Edad < 111], 
             aes(x = Edad, y = dxn, colour = Period)) + 
  geom_vline( xintercept = seq(0, 110, 5), colour = '#f0f0f0', linetype = '22') +  
  geom_hline(yintercept = seq(0, 3750, 250),colour = '#f0f0f0', linetype = '22') +
  geom_vline( xintercept = seq(0, 110, 10), colour = '#EAEAEA', linetype = '22') +  
  geom_hline(yintercept = seq(0, 3750, 500),colour = '#EAEAEA', linetype = '22') +
  geom_vline( xintercept = seq(0, 110, 20), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = seq(0, 3750, 1000),colour = '#E4E4E4', linetype = '22') +
  theme_bw(base_size = 10)  + geom_line(size = 1.3) +
  scale_x_continuous(limits = c(40, 114), breaks = seq(0, 110, 10) ) +
  scale_y_continuous(limits = c(0, 3850), 
    name = expression(paste(''[n], d[x])   ), breaks = seq(0, 3700, 1000) ) +
  scale_colour_manual(name = '', values = c('#d0d1e6','#a6bddb','#67a9cf','#3690c0',
                                            '#02818a','#016450') ) +
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.text = element_text(size = sizet - 2, family="Helvetica"),
        title = element_text(size = sizet + 1, family="Helvetica"),
        panel.grid = element_blank(), legend.position = c(.85,.83) ) +
  guides(colour = guide_legend(reverse = TRUE)) + ggtitle('Hombres')


# ajuste mujeres ----------------------------------------------------------


parStart <- c(a = 0.018832474968403, b = 1.24441230925089, c = 0.352578493993152, 
              d = 0.000451995191648722, e = 3.03424719053933, f = 22.805902231859, g = 3.35079016644243e-05, 
              h = 1.09798346622236)

mas1 <- subset(ma, Pais == "Colombia" & Edad < 80 & sexo == "Mujeres")
resb <- dlply(mas1, .(Period, sexo, Pais), function(massu)
{opt2 <- nlminb(start = parStart, objective = ssqfun,    Observed = massu$qxn, x = massu$Edad,                 
                control= list(eval.max=200,iter.max=200, abs.tol = 1e-20))
 parNLM <- opt2$par
 
 ajust <- data.frame(matrix(ncol = 1, nrow = length(seq(0, 100, 5)) ))
 ajust$Edad <- seq(0, 100, 5)
 ajust$pred2 <- nqxPred(as.list(parNLM), ajust$Edad )
 ajust$Period <- unique(massu$Period)
 ajust$Pais <- unique(massu$Pais)
 ajust$sexo <- unique(massu$sexo)  
 
 dPred <- merge(massu, ajust, by = c('Edad', 'Period', 'Pais', 'sexo'), all = T )
 list( opt2$par, subset(dPred, select = c('Edad', 'pred2', 'qxn',
                                          'Period', 'Pais', 'sexo')  ) )
})

resbl1 <- lapply( 1:12, function(i) resb[[i]][1]  );    m.resbl1 <- melt(resbl1)
resbln <- lapply( 1:12, function(i) names(resb[i])  );      m.resbln <- melt(resbln)
resblc <- lapply( 1:12, function(i) names(resb[[i]][[1]])  );     m.resblc <- melt(resblc)

lb <-  cbind(m.resbl1, m.resblc[,1]);   lb <- merge(lb, m.resbln, by = "L1");   setnames(lb, 4, "param")
l1b <- dcast(lb, value.y ~ param, value.var="value.x")

setnames(l1b, 1, "id" );     l1b$anio <- factor(substring(l1b$id, 1,9))
l1b$sexo <- factor(substring(l1b$id, 11,11))

l1b <- data.table(l1b);   l1b <- l1b[order(sexo, anio)]

resbl2 <- lapply( 1:12, function(i) resb[[i]][2]  );  
resbl2m <- ldply(resbl2, data.frame)

setnames(resbl2m, 1:6, c('Edad', 'ajust',  'obs', 'periodo', 'pais', 'sexo') )

resbl2mdt <- data.table(resbl2m)
resbl2mdt[, difporc :=  abs (round( (  (ajust / obs) - 1  ) * 100 ) )  ] 
er.m <- resbl2mdt[, list(round(mean(difporc, na.rm = T) ,1 )) , keyby = list(periodo, sexo, pais) ]


tv <- ddply(l1b, .(sexo, anio  ) , function(bd)   {  
  data.frame (0:130, qxPred(as.list(bd[,c('a', 'b','c','d','e','f','g','h')]),   0:130) )
}  )
setnames(tv, 2:4, c('Period','Edad', 'qxn') )
tv$sexo <- factor(tv$sexo, c('H','M')  , c('Hombres','Mujeres'));  
tv <- data.table(tv);    

a0s <- ma[Edad == 0 & Pais == "Colombia", c( 'sexo' ,'Edad' ,  'Period', 'axn' )  , with = F]
tv <- merge(tv, a0s, by =  c('sexo'  ,  'Period','Edad'), all.x = T )
tv$axn[is.na(tv$axn)== T] <- 1/ 2;          tv$mxn <- 2 *  tv$qxn / (2- tv$qxn) 

tv[, lxn := round(c(100000, cumprod(1 - qxn) * 100000))  , keyby = list(sexo , Period )]
tv$dxn <- round(tv$lxn * tv$qxn);    
tv$Lxn <- tv$lxn - tv$axn * tv$dxn

tv[, Txn := rev( cumsum(rev(Lxn)   )   ) , keyby = list(sexo , Period )]
tv$exn <- tv$Txn / tv$Lxn 

tvm <- tv

setnames(mah,c(3,8,9,11,13, 14, 18, 19) , c( "Pais", "Edad","Intervalo", "qxn", "lxn","dxn" , "ex", "axn")) 
(mah[Pais == 'Colombia' & Edad == 0][, c('Period', 'ex'), with = F][, exr := round(ex,1)])
(tv[Edad==0][, c('Period', 'exn'), with = F][, exr := round(exn,1)])

estimate_mode <- function(x) {    d <- density(x) ;   d$x[which.max(d$y)]     }

med <- tv[, wtd.quantile(Edad, .5, weights = dxn) , keyby = list(Period )]
mod <- tv[Edad > 5][, round(estimate_mode(rep(Edad, dxn)),1 ) , keyby = list(Period )]
ev <- tv[Edad==0][, c('Period', 'exn'), with = F][, exr := round(exn,1)][ ,c('Period', 'exr'), with = F]

iqr <- tv[, list (wtd.quantile(Edad, .25, weights = dxn), wtd.quantile(Edad, .75, weights = dxn)) ,
          keyby = list(Period )][,IQR := V2-V1][ ,c('Period', 'IQR'), with = F]

d10 <- tv[Edad > 10][, round(sqrt(wtd.var( Edad, weights = dxn)),1)  , keyby = list(Period )]


su <- Reduce(function(...) merge(..., by='Period', all=T), list(ev, med, mod, iqr, d10)  )
setnames(su, 2:6, c('ex', 'Med', 'Moda', 'IQR', 'SD10')  )

sum <- su

# ggplot(l1b, aes(   anio, d)  ) + geom_path(aes(group=1)) + 
#   facet_grid(sexo~.) + coord_flip() + theme_bw() + geom_smooth(aes(group=1), span = 1)
# ggplot(l1b, aes(   anio, e)  ) + geom_path(aes(group=1)) + 
#   facet_grid(sexo~.) + coord_flip() + theme_bw() + geom_smooth(aes(group=1), span = 1)
# ggplot(l1b, aes(   anio, f)  ) +geom_path(aes(group=1)) + 
#   facet_grid(sexo~.) + coord_flip() + theme_bw()  + geom_smooth(aes(group=1), span = 1)

# 
# (l1b[, c('anio', 'd') , with =F][, d10mil := round(d * 10000)][, c('anio', 'd10mil') , with =F]   )
# 
# (l1b[, c('anio', 'e') , with =F][, er := round(e, 2)][, c('anio', 'er') , with =F]   )
# 
# (l1b[, c('anio', 'f') , with =F][, fr := round(f, 1)][, c('anio', 'fr') , with =F]   )

l1bm <- l1b[, c('anio', 'd', 'e', 'f') , with =F][, d10mil := round(d * 10000, 1)][
  , er := round(e, 1)][, fr := round(f, 1)][, c('anio', 'd10mil','er', 'fr') , with =F] 

p <- ggplot(resbl2m,  aes(Edad, obs))  + facet_wrap( ~ periodo ) +    
  geom_vline(xintercept = seq(0, 100, 5), colour = '#f0f0f0', linetype = '22') +   
  geom_vline(xintercept = seq(0, 100, 10), colour = '#EAEAEA', linetype = '22') +   
  geom_vline(xintercept = seq(0, 100, 20), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = c(.001, .001, .01, .1, 1), colour = '#E4E4E4', linetype = '22') + 
  geom_point(size = 3, colour = "#d7301f") +  
  geom_point( size = 2, colour = "white") + 
  geom_line(data = resbl2m,  aes(Edad, ajust), colour = "#7f0000", size = 1)+
  theme_bw(base_size = 12) +   theme(legend.position = c(.85, .15)) +   
  scale_x_continuous(name = "Edad", breaks = seq(0, 100, 20), 
                     limit = c(0, 100), expand = c(.2, 0) ) + 
  scale_y_log10(name=expression(log(paste(''[n], q[x])  ) ) , expand = c(.15, .15),
                limits = c(0.001, 1), breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))   )  +
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        strip.text = element_text(size = sizet + 1, family="Helvetica"),
        strip.background = element_rect( fill = "white"), panel.margin = unit(0, "lines") ,
        panel.grid = element_blank() ) + annotation_logticks(sides = "l")

cairo_pdf(file = "helpmujcol.pdf", width = 8,   height = 7, family = "Helvetica")
print(   p  )
dev.off()

pm <- ggplot(tv[Period %in% c( "1955-1960",  "1965-1970", "1975-1980", "1985-1990", 
                               "1995-2000",  "2005-2010")  & Edad < 111 ], 
             aes(x = Edad, y = lxn / 1000, colour = Period)) + 
  geom_vline( xintercept = seq(0, 110, 5), colour = '#f0f0f0', linetype = '22') +  
  geom_hline(yintercept = seq(0, 100, 5),colour = '#f0f0f0', linetype = '22') +
  geom_vline( xintercept = seq(0, 110, 10), colour = '#EAEAEA', linetype = '22') +  
  geom_hline(yintercept = seq(0, 100, 10),colour = '#EAEAEA', linetype = '22') +
  geom_vline( xintercept = seq(0, 110, 20), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = seq(0, 100, 20),colour = '#E4E4E4', linetype = '22') +
  theme_bw(base_size = 10)  + geom_line(size = 1.3) +
  scale_x_continuous(limits = c(0, 114), breaks = seq(0, 110, 10) ) +
  scale_y_continuous(name = expression(paste(''[n], l[x], ' (en miles)' )  ), 
                     breaks = seq(0, 100, 10)) +
  scale_colour_manual(name = '', values = c('#d4b9da','#c994c7','#df65b0','#e7298a',
                                            '#ce1256','#91003f') ) +
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.text = element_text(size = sizet - 2, family="Helvetica"),
        title = element_text(size = sizet + 1, family="Helvetica"),
        panel.grid = element_blank(), legend.position = c(.85,.8) ) +
  guides(colour = guide_legend(reverse = TRUE)) + ggtitle('Mujeres')

cairo_pdf(file = "sobcoltv.pdf", width = 8,   height = 5, family = "Helvetica")
grid.arrange(   ph, pm, nrow = 1  )
dev.off()

pm2 <- ggplot(tv[Period %in% c( "1955-1960",  "1965-1970", "1975-1980", 
                                "1985-1990", "1995-2000",  "2005-2010") & Edad > 39 & Edad < 111], 
              aes(x = Edad, y = dxn, colour = Period)) + 
  geom_vline( xintercept = seq(0, 110, 5), colour = '#f0f0f0', linetype = '22') +  
  geom_hline(yintercept = seq(0, 3750, 250),colour = '#f0f0f0', linetype = '22') +
  geom_vline( xintercept = seq(0, 110, 10), colour = '#EAEAEA', linetype = '22') +  
  geom_hline(yintercept = seq(0, 3750, 500),colour = '#EAEAEA', linetype = '22') +
  geom_vline( xintercept = seq(0, 110, 20), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = seq(0, 3750, 1000),colour = '#E4E4E4', linetype = '22') +
  theme_bw(base_size = 10)  + geom_line(size = 1.3) +
  scale_x_continuous(limits = c(40, 114), breaks = seq(0, 110, 10) ) +
  scale_y_continuous(limits = c(0, 3850) , 
    name = expression(paste(''[n], d[x])   ), breaks = seq(0, 3750, 1000) ) +
  scale_colour_manual(name = '', values = c('#d4b9da','#c994c7','#df65b0','#e7298a',
                                            '#ce1256','#91003f') ) +
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.text = element_text(size = sizet - 2, family="Helvetica"),
        title = element_text(size = sizet + 1, family="Helvetica"),
        panel.grid = element_blank(), legend.position = c(.85,.83) ) +
  guides(colour = guide_legend(reverse = TRUE)) + ggtitle('Mujeres')

cairo_pdf(file = "defcoltv.pdf", width = 8,   height = 5, family = "Helvetica")
grid.arrange(   ph2, pm2, nrow = 1  )
dev.off()


setnames(mam, 18, 'ex');  setnames(mam, 8, 'edad');
mam[ Codigo == 'CO' & edad == 0][, c('Period', 'ex')  , with = F]

ers <- merge(er.h, er.m, by ='periodo')
tou <- dcast(melt(ers), variable  ~ periodo, value.var = 'value' )
xtable(tou)

lo1 <- merge(l1bh, l1bm, by ='anio')
xtable(lo1, digits = 1)

suc <- merge(suh, sum, by = 'Period')
xtable(suc, digits = 1)


tvh1 <- tvh[Period %in% c( "1955-1960",  "1965-1970", "1975-1980", 
                   "1985-1990", "1995-2000",  "2005-2010") & Edad == 40, 
    c('Period', 'sexo',  'Edad', 'lxn'), with = F ]

tvh1$lxnr <- c(NA, tvh1[1:(nrow(tvh1)-1)]$lxn)  ; 
tvh1[, dsob := lxn - lxnr]


tvm1 <- tvm[Period %in% c( "1955-1960",  "1965-1970", "1975-1980", 
                   "1985-1990", "1995-2000",  "2005-2010") & Edad == 40, 
    c('Period', 'sexo','Edad', 'lxn'), with = F ]

tvm1$lxnr <- c(NA, tvm1[1:(nrow(tvm1)-1)]$lxn)  ; 
tvm1[, dsob := lxn - lxnr]

tvh[, list (wtd.quantile(Edad, .25, weights = dxn), wtd.quantile(Edad, .75, weights = dxn)) ,
   keyby = list(Period )]

tvm[, list (wtd.quantile(Edad, .25, weights = dxn), wtd.quantile(Edad, .75, weights = dxn)) ,
    keyby = list(Period )]


# 
# tvh[Edad < 110][, c('Period', 'Edad', 'qxn') , with = F][,qxn100m := round(qxn * 100000)] %>%
#   dcast( Edad  ~  Period, value.var =  'qxn100m')


rbind(tvh, tvm) %>% filter(Edad < 35 & Period %in% c('1955-1960') ) %>% 
  mutate(qxn100m = round(qxn * 100000)) %>%
   dcast( Period + Edad  ~  sexo, value.var =  'qxn100m') %>%
  dlply( .(Period),  function(df){xtable(df[,2:4 ], digits = 0)})



rbind(tvh, tvm) %>% filter(Edad > 34 & Edad < 70 & Period %in% c('1955-1960') ) %>% 
  mutate(qxn100m = round(qxn * 100000)) %>%
  dcast( Period + Edad  ~  sexo, value.var =  'qxn100m') %>%
  dlply( .(Period),  function(df){xtable(df[,2:4 ], digits = 0)})



rbind(tvh, tvm) %>% filter(Edad > 69 & Edad < 105 & Period %in% c('1955-1960') ) %>% 
  mutate(qxn100m = round(qxn * 100000)) %>%
  dcast( Period + Edad  ~  sexo, value.var =  'qxn100m') %>%
  dlply( .(Period),  function(df){xtable(df[,2:4 ], digits = 0)})


rbind(tvh, tvm) %>% filter(Edad < 110 & Period %in% c('1980-1985') ) %>% 
  mutate(qxn100m = round(qxn * 100000)) %>%
  dcast( Period + Edad  ~  sexo, value.var =  'qxn100m') %>%
  dlply( .(Period),  function(df){xtable(df[,2:4 ], digits = 0)})


rbind(tvh, tvm) %>% filter(Edad < 110 & Period %in% c('2005-2010') ) %>% 
  mutate(qxn100m = round(qxn * 100000)) %>%
  dcast( Period + Edad  ~  sexo, value.var =  'qxn100m') %>%
  dlply( .(Period),  function(df){xtable(df[,2:4 ])})





# *** TRANSICION EPID *** ---------------------------------------------------------



# COL Tasas estandarizadas de tab vida 50 10 -------------------------------------------------

mah <- fread('tvhombres.csv')
mam <- fread('tvmujeres.csv')

mah$sexo <- "H" ; mam$sexo <- "M"
ma <- rbind(mah, mam)

setnames(ma, c(3, 8, 9, 10) , c( "Pais", "Edad","Intervalo", "mxn" )) 

mmas <- subset(ma,  Codigo %in% c( "CO")  )

mmas <- mmas[, c("Codigo", "sexo",  "Period", "Edad", "Intervalo", "mxn"), with = F]

mmas$clasep <- factor(mmas$Period, levels = c("1950-1955", "1955-1960", "1960-1965", 
                                              "1965-1970", "1970-1975", "1975-1980", "1980-1985", "1985-1990", 
                                              "1990-1995", "1995-2000", "2000-2005", "2005-2010"),
                      labels = seq(1952.5, 2007.5, 5) )
mmas$clasep <- as.numeric(as.character(mmas$clasep))

mmas$Edad <- as.numeric( as.character(mmas$Edad) )
mmas$edadcl <-  mmas$Edad + (mmas$Intervalo / 2)

# Dist tipo col amb sex

bd <- read.xlsx2("poblacion.edades.simples.censos.xlsx", 1)
bd <- data.table(bd)
bd <- subset(bd, Dep == 'Colombia')

bd$Hombres <- as.numeric(as.character(bd$Hombres ))
bd$Mujeres <- as.numeric(as.character(bd$Mujeres))
bd$edad <- as.numeric(as.character(bd$edad))

bd[, Tot := round(Hombres + Mujeres)]


bd$edadcl <- cut(bd$edad, breaks = c(-1, 0, 4, seq(9, 85, 5), 100 ) )
dput(levels(bd$edadcl))
bd$edadcl <- factor(bd$edadcl, c("(-1,0]", "(0,4]", "(4,9]", "(9,14]", "(14,19]", "(19,24]", 
                                 "(24,29]", "(29,34]", "(34,39]", "(39,44]", "(44,49]", "(49,54]", 
                                 "(54,59]", "(59,64]", "(64,69]", "(69,74]", "(74,79]", "(79,84]", 
                                 "(84,100]"),   
                    c(0.5, 3, 7.5, 12.5, 17.5, 22.5, 27.5, 32.5, 37.5, 42.5, 47.5, 
                      52.5, 57.5, 62.5, 67.5, 72.5, 77.5, 82.5, 92.5)
)

bd1 <- bd[is.na(edadcl) == F,  sum(Tot) , keyby = list(anio, edadcl)][
  , Pct := V1  / sum(V1), keyby = list(anio)][anio == 2005, list(edadcl,  Pct)]

bd1$edadcl <- as.numeric(as.character(bd1$edadcl))

bdc <- merge(bd1, mmas, by = 'edadcl')

bdc <- bdc[, round(sum(mxn * Pct) * 1000, 1)  , keyby = list(sexo, clasep)]

bdd <- dcast(bdc, clasep ~ sexo, value.var = 'V1')

bdd$dif <- bdd$H - bdd$M

bdd <- data.table(bdd)

sizet <- 12.5

p <- ggplot(bdd  ) + 
  geom_vline(xintercept = seq(1950, 2010, 5), colour = '#f0f0f0', linetype = '22') + 
  geom_hline(yintercept = seq(0, 18, 1), colour = '#f0f0f0', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2010, 10), colour = '#EAEAEA', linetype = '22') + 
  geom_hline(yintercept = seq(0, 18, 2), colour = '#EAEAEA', linetype = '22') +
  geom_vline(xintercept = seq(1950, 2010, 20), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = seq(0, 18, 4), colour = '#E4E4E4', linetype = '22') +
  geom_ribbon( aes(x = clasep,ymin = M, ymax = H), fill = '#fa9fb5', alpha = .3 ) +
  geom_line(aes( x = clasep, y = H, colour = 'H'), size = 1.5) + 
  geom_line(aes( x = clasep, y = M, colour = 'M'), size = 1.5) + 
  xlab('Año') + ylab('Tasa estandarizada por edad (en miles)') +
  theme_bw(base_size = sizet, base_family="Helvetica") +
  scale_colour_manual(name = '', values = c('#313695', '#de77ae') ) +
  scale_x_continuous(limits = c(1950,2010),  breaks = seq(1950, 2010, 10)   ) +
  scale_y_continuous( breaks = seq(0, 18, 4)  ) +
  geom_text(data = bdd[clasep == 2007.5] , size = 4,
            aes( x = clasep, y = H, label =  'H'), hjust = -.5, colour = '#313695') +
  geom_text(data = bdd[clasep == 2007.5] , size = 4,
            aes( x = clasep, y = M, label =  'M'), hjust = -.5, colour = '#de77ae') +
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank(), legend.position = '' )

cairo_pdf(file = "testcol.pdf", family = "Helvetica",    width = 6, height = 4)
print(p)
dev.off() 

bdd <- data.table(bdd)
bde <- bdd[clasep %in% seq(1957.5, 2007.5, 10) ]

bde$Hr <- c(NA, bde[1:(nrow(bde)-1)]$H)  ; bde$Mr <- c(NA, bde[1:(nrow(bde)-1)]$M)

(bde[ , CPctH := round( (H - Hr) * 100 / Hr, 0 )][ , CPctM := round((M - Mr) * 100 / Mr)])


# COL Perfil epidemiologico 3 CAUSAS ------------------------------------------------------

colf <- fread("Col_Cause19_Deathsf.txt");   colf$Country <- "Colombia";   colf$Sex <- "Mujeres"
colm <- fread("Col_Cause19_Deathsm.txt");   colm$Country <- "Colombia";   colm$Sex <- "Hombres"
col <- rbind(colf, colm)
rsm <- col

setnames( rsm, c("Cause_1", "Cause_2", "Cause_3", "Cause_4", 
                 "Cause_5", "Cause_6", "Cause_7", "Cause_8", "Cause_9", "Cause_10", 
                 "Cause_11", "Cause_12a", "Cause_12b", "Cause_13", "Cause_14", 
                 "Cause_15", "Cause_16", "Cause_17", "Cause_18", "Cause_19", "Cause_20"),
          c('Neoplasms', 'Neoplasms_Respiratory','Neoplasms_Digestive','Neoplasms_Breast',
            'Circulatory_Diseases','Circulatory_Diseases_Heart','Circulatory_Diseases_Hypertension',
            'Circulatory_Diseases_Cerebrovascular','Circulatory_Diseases_Arteriosclerosis',
            'Respiratory_Diseases','Respiratory_Diseases_Acute_Upper_Respiratory_Infections',
            'Respiratory_Diseases_Influenza_Pneumonia_Acute_Bronchitis',
            'Respiratory_Diseases_Chronic_Bronchitis_Emphysema_Asthma',
            'Digestive_Diseases','Digestive_Diseases_Cirrhosis','Digestive_Diseases_Ulcers',
            'Diabetes_Mellitus','Infectious_Diseases','Accidents_Homicide_Suicides', 
            'Senility_Ill_Defined', 'Residual'))

#dput(names(colf))

rsm[, Transmisibles := Infectious_Diseases + Respiratory_Diseases ]
rsm[, No_Transmisibles :=  Neoplasms + Circulatory_Diseases + Digestive_Diseases +
      Diabetes_Mellitus]

rsmb <- rsm[, list( sum(Transmisibles, na.rm = T)  ,  sum(No_Transmisibles, na.rm = T) , 
                    sum(Accidents_Homicide_Suicides, na.rm = T)) , 
            keyby = list(Year, Country, Sex  )]

setnames(rsmb, c("V1","V2","V3") , c('Transmisibles', 'No_Transmisibles', 'Accidents_Homicide_Suicides')  ) 

rsmb[, Pct_Transmisibles := Transmisibles * 100 / 
       (Transmisibles + No_Transmisibles + Accidents_Homicide_Suicides)]
rsmb[, Pct_No_Transmisibles := No_Transmisibles * 100 / 
       (Transmisibles + No_Transmisibles + Accidents_Homicide_Suicides)]
rsmb[, Pct_Causas_Externas := Accidents_Homicide_Suicides * 100 / 
       (Transmisibles + No_Transmisibles + Accidents_Homicide_Suicides)]

p <- ggtern(rsmb, aes(Pct_Transmisibles, Pct_No_Transmisibles,Pct_Causas_Externas, colour = Year)) +
  geom_Lline(Lintercept = seq(0, 1, .1),color="#f0f0f0", linetype = '22') +
  geom_Tline(Tintercept = seq(0, 1,.1),color="#f0f0f0", linetype = '22') +
  geom_Rline(Rintercept = seq(0, 1, .1),color="#f0f0f0", linetype = '22') +
  geom_Lline(Lintercept = seq(0, 1, .2),color="#EAEAEA", linetype = '22') +
  geom_Tline(Tintercept = seq(0, 1, .2),color="#EAEAEA", linetype = '22') +
  geom_Rline(Rintercept = seq(0, 1, .2),color="#EAEAEA", linetype = '22') +
   geom_Lline(Lintercept = 0,color="#bdbdbd", linetype = 'solid') +
   geom_Tline(Tintercept = 0,color="#bdbdbd", linetype = 'solid') +
   geom_Rline(Rintercept = 0,color="#bdbdbd", linetype = 'solid') +
  geom_point(size = 2) +  facet_wrap(~   Sex , ncol = 2) +
  scale_colour_gradientn(name = "Año", colours =  rev(topo.colors(8))) + 
  theme_minimal(base_size = 12) + 
  scale_T_continuous( labels = c('',20  , '',40 ,'', 60,'No transmisibles \u2192', 80,'', 100 ) ,  
                      breaks=seq(0.1,1,by = 0.1  ))  + 
  scale_L_continuous( labels = c('',20  , '',40 ,'\u2190 Tr.', 60,'', 80,'', 100 ) , 
                      breaks=seq(0.1,1,by = 0.1  )  )  + 
  scale_R_continuous( labels = c('',20  , '',40 ,'\u2190 Causas externas', 60,'', 80,'', 100 ) ,  
                      breaks=seq(0.1,1,by = 0.1  )  ) + theme_hidegrid()  + 
  theme(  strip.text = element_text(size = 12), axis.tern.showtitles = F ,
          strip.background = element_rect(colour = 'white', fill = "white") , 
          legend.title = element_text(face = 'italic' ) ,
          axis.tern.showarrows = F ) 
   

cairo_pdf(file = "perfil_epidem.pdf", width = 8,   height = 3.4, family = "Helvetica")
print(   p  )
dev.off()

(rsmb[, list(Tr = round(Pct_Transmisibles), NOTr = round(Pct_No_Transmisibles), Ext = round(Pct_Causas_Externas)) ,
     keyby = list(Sex , Year  )][, TNt:= Tr+ NOTr])


#  COL Perfil epidemiologico 3 causas edad ------------------------------------------------------

colf <- fread("Col_Cause19_Deathsf.txt");   colf$Country <- "Colombia";   colf$Sex <- "Mujeres"
colm <- fread("Col_Cause19_Deathsm.txt");   colm$Country <- "Colombia";   colm$Sex <- "Hombres"
col <- rbind(colf, colm)

col$ageb <- recode(col$age, " 0:4 = '1-4';
                   5 = '5-9'; 10 = '10-14'; 15 = '15-19';20 = '20-24'; 25 = '25-29';
                   30 = '30-34';35 = '35-39';40 = '40-44';45 = '45-49';
                   50 = '50-54';55 = '55-59';60 = '60-64';65 = '65-69';
                   70 = '70-74'; 75 = '75-79';80 = '80-84'; 85:100 = '85+'   ")
col$ageb  <- factor(col$ageb,  levels = c("0-1","1-4", "5-9",  "10-14", "15-19", "20-24", "25-29", "30-34", 
                                          "35-39", "40-44", "45-49",  "50-54", "55-59", "60-64", 
                                          "65-69", "70-74", "75-79", "80-84", "85+"), 
                    labels = c(" 0 - 1"," 1 - 4", " 5 - 9",  "10-14", "15-19", "20-24", "25-29", "30-34", 
                               "35-39", "40-44", "45-49",  "50-54", "55-59", "60-64", 
                               "65-69", "70-74", "75-79", "80-84", "85+") )
rsm <- col

setnames( rsm, c("Cause_1", "Cause_2", "Cause_3", "Cause_4", 
                 "Cause_5", "Cause_6", "Cause_7", "Cause_8", "Cause_9", "Cause_10", 
                 "Cause_11", "Cause_12a", "Cause_12b", "Cause_13", "Cause_14", 
                 "Cause_15", "Cause_16", "Cause_17", "Cause_18", "Cause_19", "Cause_20"),
          c('Neoplasms', 'Neoplasms_Respiratory','Neoplasms_Digestive','Neoplasms_Breast',
            'Circulatory_Diseases','Circulatory_Diseases_Heart','Circulatory_Diseases_Hypertension',
            'Circulatory_Diseases_Cerebrovascular','Circulatory_Diseases_Arteriosclerosis',
            'Respiratory_Diseases','Respiratory_Diseases_Acute_Upper_Respiratory_Infections',
            'Respiratory_Diseases_Influenza_Pneumonia_Acute_Bronchitis',
            'Respiratory_Diseases_Chronic_Bronchitis_Emphysema_Asthma',
            'Digestive_Diseases','Digestive_Diseases_Cirrhosis','Digestive_Diseases_Ulcers',
            'Diabetes_Mellitus','Infectious_Diseases','Accidents_Homicide_Suicides', 
            'Senility_Ill_Defined', 'Residual'))

rsm[, Transmisibles := Infectious_Diseases + Respiratory_Diseases ]
rsm[, No_Transmisibles :=  Neoplasms + Circulatory_Diseases + Digestive_Diseases +
      Diabetes_Mellitus]

rsmb <- rsm[, list( sum(Transmisibles, na.rm = T)  ,  sum(No_Transmisibles, na.rm = T) , 
                    sum(Accidents_Homicide_Suicides, na.rm = T)) , 
            keyby = list(Year, Country, Sex , ageb)]

setnames(rsmb, c("V1","V2","V3") , c('Transmisibles', 'No_Transmisibles', 'Accidents_Homicide_Suicides')  ) 

rsmb[, Pct_Transmisibles := Transmisibles * 100 / 
       (Transmisibles + No_Transmisibles + Accidents_Homicide_Suicides)]
rsmb[, Pct_No_Transmisibles := No_Transmisibles * 100 / 
       (Transmisibles + No_Transmisibles + Accidents_Homicide_Suicides)]
rsmb[, Pct_Causas_Externas := Accidents_Homicide_Suicides * 100 / 
       (Transmisibles + No_Transmisibles + Accidents_Homicide_Suicides)]

rsmc <- rsmb[Year %in% c(1959, 1989, 2009) ,]


rsmc$fc <- paste0(rsmc$Sex,', ', rsmc$Year)
rsmc$fc <- factor(rsmc$fc, levels = c("Hombres, 1959", "Mujeres, 1959", "Hombres, 1989", "Mujeres, 1989", 
                       "Hombres, 2009", "Mujeres, 2009")) 

p <-   ggtern(rsmc, aes(Pct_Transmisibles, Pct_No_Transmisibles,Pct_Causas_Externas, colour = ageb))+
  geom_Lline(Lintercept = seq(0,1,.1),color="#f0f0f0", linetype = '22') +
  geom_Tline(Tintercept = seq(0,1,.1),color="#f0f0f0", linetype = '22') +
  geom_Rline(Rintercept = seq(0,1,.1),color="#f0f0f0", linetype = '22') +
  geom_Lline(Lintercept = seq(0,1,.2),color="#EAEAEA", linetype = '22') +
  geom_Tline(Tintercept = seq(0,1,.2),color="#EAEAEA", linetype = '22') +
  geom_Rline(Rintercept = seq(0,1,.2),color="#EAEAEA", linetype = '22') +
  geom_Lline(Lintercept = 0,color="#bdbdbd", linetype = 'solid') +
  geom_Tline(Tintercept = 0,color="#bdbdbd", linetype = 'solid') +
  geom_Rline(Rintercept = 0,color="#bdbdbd", linetype = 'solid') +
  geom_point(size = 2) + theme_bw() + facet_wrap(~  fc   , ncol = 2) +
   scale_colour_manual(name = 'Edad', values =  rev(topo.colors(20))  ) + theme_bw(base_size = 12)  + 
  theme(  strip.text = element_text(size = 12), axis.tern.showtitles = F ,
          strip.background = element_rect(colour = 'white', fill = "white") ,
          legend.title = element_text(face = 'italic') ,
          axis.tern.showarrows = F  )    + 
  scale_T_continuous( labels = c('',20  , '',40 ,'', 60,'No transmisibles \u2192', 80,'', 100 ) ,  
                      breaks=seq(0.1,1,by = 0.1  ))  + 
  scale_L_continuous( labels = c('',20  , '',40 ,'\u2190 Tr.', 60,'', 80,'', 100 ) , 
                      breaks=seq(0.1,1,by = 0.1  )  )  + 
  scale_R_continuous( labels = c('',20  , '',40 ,'\u2190 Causas externas', 60,'', 80,'', 100 ) ,  
                      breaks=seq(0.1,1,by = 0.1  )  )  + 
  theme_hidegrid() 


cairo_pdf(file = "perfil_epidem_edad.pdf", width = 8,   height = 9.5, family = "Helvetica")
print(   p  )
dev.off()

rsmd <- rsmc[, list(Tr = round(Pct_Transmisibles), NOTr = round(Pct_No_Transmisibles), Ext= round(Pct_Causas_Externas)) ,
     keyby = list(Year,  Country, Sex,   ageb  )]

rsmd[Sex=='Mujeres' & Year == 1989]
rsmd[Sex=='Mujeres' & Year == 2009]

# COL Pesos relativos causas muerte -------------------------------------------

colf <- fread("Col_Cause19_Deathsf.txt");   colf$Country <- "Colombia";   colf$Sex <- "Mujeres"
colm <- fread("Col_Cause19_Deathsm.txt");   colm$Country <- "Colombia";   colm$Sex <- "Hombres"
col <- rbind(colf, colm)

col[, otr := Cause_8 + Cause_19]

rsm <- melt(col, id = c("icd"  ,     "Year"     , "age", "Country"  , "Sex" ),
            measure=c("Cause_1", "Cause_2", "Cause_3", "Cause_4", 
                      "Cause_5", "Cause_6", "Cause_7", "Cause_8", "Cause_9", "Cause_10", 
                      "Cause_11", "Cause_12a", "Cause_12b", "Cause_13", "Cause_14", 
                      "Cause_15", "Cause_16", "Cause_17", "Cause_18", "Cause_19", "Cause_20", 'otr') )

rsm$variable <- factor(rsm$variable, 
                       c("Cause_1", "Cause_2", "Cause_3", "Cause_4", 
                         "Cause_5", "Cause_6", "Cause_7", "Cause_9", "Cause_10", 
                         "Cause_11", "Cause_12a", "Cause_12b", "Cause_13", "Cause_14", 
                         "Cause_15", "Cause_16", "Cause_17", "Cause_18", "Cause_19","Cause_8",  "Cause_20", 'otr'),
                       c('Neoplasias', 'Neoplasias Respiratorias','Neoplasias Digestivas','Neoplasias de la mama',
                         'Enfermedades cardiovasculares','Circulatorias del corazón','Enfermedades hipertensivas',
                         'Aterosclerosis',
                         'Enfermedades del sistema respiratorio','Infecciones respiratorias agudas altas',
                         'Infecciones respiratorias agudas bajas',
                         'Bronquitis crónica, enfisema, asma',
                         'Enfermedades digestivas','Cirrosis','Ulceras',
                         'Diabetes Mellitus','Enfermedades infecciosas y parasitarias','Causas externas', 
                         'Causas mal definidas','Otras causas', 'Residual', 'Mal definidas y otras causas'))

cl1 <- rsm[variable %in% c( 'Neoplasias Respiratorias','Neoplasias Digestivas','Neoplasias de la mama',
                            'Circulatorias del corazón','Enfermedades hipertensivas',
                            'Enfermedades cerebrovasculares','Aterosclerosis',
                            'Infecciones respiratorias agudas altas',
                            'Infecciones respiratorias agudas bajas',
                            'Bronquitis crónica, enfisema, asma',
                            'Cirrosis','Ulceras',
                            'Diabetes Mellitus','Enfermedades infecciosas y parasitarias','Causas externas', 
                            'Mal definidas y otras causas')]


cl1b <- cl1[, sum(value) , keyby = list(icd ,     Year     ,  Country  , Sex, variable)]
cl1bant <- data.table(as.data.frame(cl1b)); cl1bant[, Yeark := Year + 1][,Year:=NULL][, ant:= V1][,V1:=NULL]
cl1bpos <- data.table(as.data.frame(cl1b)); cl1bpos[, Yeark := Year - 1][,Year:=NULL][, pos:= V1][,V1:=NULL]
cl1bant2 <- data.table(as.data.frame(cl1b)); cl1bant2[, Yeark := Year + 2][,Year:=NULL][, ant2:= V1][,V1:=NULL]
cl1bpos2 <- data.table(as.data.frame(cl1b)); cl1bpos2[, Yeark := Year - 2][,Year:=NULL][, pos2:= V1][,V1:=NULL]

cl1b[, Yeark := Year][,Year:=NULL]

cl1bt <- Reduce(function(...) merge(..., by = c('icd' ,     'Yeark'     ,  'Country'  , 'Sex', 'variable'),
                                    all = T), list( cl1bant2, cl1bant, cl1b, cl1bpos, cl1bpos2)  )
cl1bt <- cl1bt[is.na(V1) == F][, value := rowSums( cbind(ant, V1, pos), na.rm = TRUE) ][
  , Pct := round(value * 100 / sum(value),2), keyby = list(icd ,     Yeark     ,  Country  , Sex)]

sizet <- 10

pr <- ggplot(cl1bt,     aes(Yeark, Pct, fill = variable) ) + 
  scale_x_continuous(breaks = seq(1960, 2000, 10) ) +
  facet_wrap(  ~  Sex , ncol = 2) + 
  geom_area(   stat = "Identity") + theme_bw() +
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        strip.text = element_text(size = sizet + 1, family="Helvetica"),
        legend.text = element_text(size = sizet - 1, family="Helvetica") ,
        strip.background = element_rect( fill = "white"),
        panel.margin = unit(0, "lines") ) + 
  guides(fill = guide_legend(reverse=TRUE)) + 
  scale_fill_manual(name = "", 
                    values = c('#003c30', '#01665e', '#35978f', '#bf812d','#8c510a','#543005',
                               '#2d004b', '#542788','#8073ac', '#b8e186','#7fbc41','#fb9a99', '#a6cee3',
                               '#bd0026', 'gray') ) + 
  xlab("Año") + ylab("Porcentaje")


pdf(file = "pesos_rel_caum_lac.pdf", width = 8,   height = 5, family = "Helvetica")
print(   pr  )
dev.off()


cl1bt[variable == 'Causas externas'][, round(Pct), keyby =list(Sex ,       variable, Yeark)]

cl1bt[Yeark == 2009 & Sex == 'Hombres'][order(Pct)]

cl1bt[variable == 'Enfermedades infecciosas y parasitarias'][
  , round(Pct), keyby =list(Sex ,       variable, Yeark)]

cl1bt[variable == 'Diabetes Mellitus'][
  , round(Pct), keyby =list(Sex ,       variable, Yeark)]

dput(unique(as.character(cl1bt$variable)))


cl1bt[variable == 'Circulatorias del corazón'][
  , round(Pct), keyby =list(Sex ,       variable, Yeark)] %>%
dcast(  variable + Yeark ~  Sex, value.var = 'V1')

cl1bt[variable == 'Neoplasias Digestivas'][
  , round(Pct), keyby =list(Sex ,       variable, Yeark)] %>%
  dcast(  variable + Yeark ~  Sex, value.var = 'V1')


# COL tasas estandarizadas gr causas-----------------------------------------------------

bd <- read.xlsx2('pob.col.anual.sexo.edq.xlsx',1)

mbd <- melt(bd, id = 'Edadg')

mbd$sexo <- substr(mbd$variable, 1, 7)
mbd$anio <- substr(mbd$variable, 9, 12)

mbd <- data.table(mbd)

mbd$value <- as.numeric( as.character(mbd$value) )
mbd$anio <- as.numeric( as.character(mbd$anio) )

mbd$SEXO <- recode(mbd$sexo, " 'Hombres' = 1; 'Mujeres' = 2 ")

setnames(mbd, 'value', 'pob')
#edad enf

resd <- function(anio){
  fil <- paste("DEFU", anio, ".txt", sep="")
  bd <- fread(fil,  header = TRUE, colClasses = "string", sep="\t")
  bd <- data.table(bd)
  
  setnames(bd, names(bd), toupper(names(bd))   )
  
  bd$EDAD <- as.numeric(bd$EDAD)
  
  bd <- as.data.frame(bd)
  bd$EDAD2 <- rep(NA,nrow(bd))
  
  bd[which( bd$EDAD %in% 1:99 ), ]$EDAD2  <- bd[which( bd$EDAD %in% 1:99 ), ]$EDAD
  bd[which( bd$GRU_ED1 %in% c('01','02','03','04','05') ), ]$EDAD2  <- 0
  
  bd <- data.table(bd)
  bd$EDAD <- bd$EDAD2
  
  bdo <- bd[,.N, keyby = list(SEXO, CAU_HOMOL, EDAD)]
  
  bdo$anio <- anio  
  as.data.frame(bdo)
}

def <- resd(1985)  
for(i in 1986:1997){   def <- rbind(resd(i), def)   }

resdb <- function(anio){
  fil <- paste("DEFU", anio, ".txt", sep="")
  bd <- fread(fil,  header = TRUE, colClasses = "string")
  bd <- data.table(bd)
  
  setnames(bd, names(bd), toupper(names(bd))   )
  
  bd$EDAD <- as.numeric(bd$EDAD)
  
  bd$EDAD2 <- NA  
  bd$EDAD2 <- recode( bd$EDAD, "100:311 = 0; 312:399=1; c(400,499,999)=NA;
                      402 =02 ; 403 =03 ; 404 =04 ; 405 =05 ; 406 =06 ;
                      407 =07 ; 408 =08 ; 409 =09 ; 410 =10 ; 411 =11 ; 412 =12 
                      ; 413 =13 ; 414 =14 ; 415 =15 ; 416 =16 ; 417 =17 ; 418 =18 ; 419 =19 ;
                      420 =20 ; 421 =21 ; 422 =22 ; 423 
                      =23 ; 424 =24 ; 425 =25 ; 426 =26 ; 427 =27 ; 428 =28 ; 429 =29 ; 430 =30 ; 
                      431 =31 ; 432 =32 ; 433 =33 ; 
                      434 =34 ; 435 =35 ; 436 =36 ; 437 =37 ; 438 =38 ; 439 =39 ; 440 =40 ; 441 =41 ;
                      442 =42 ; 443 =43 ; 444 =44 
                      ; 445 =45 ; 446 =46 ; 447 =47 ; 448 =48 ; 449 =49 ; 450 =50 ; 451 =51 ; 452 =52 ;
                      453 =53 ; 454 =54 ; 455 
                      =55 ; 456 =56 ; 457 =57 ; 458 =58 ; 459 =59 ; 460 =60 ; 461 =61 ; 462 =62 ; 463 =63 ; 
                      464 =64 ; 465 =65 ; 
                      466 =66 ; 467 =67 ; 468 =68 ; 469 =69 ; 470 =70 ; 471 =71 ; 472 =72 ; 473 =73 ; 
                      474 =74 ; 475 =75 ; 476 =76 
                      ; 477 =77 ; 478 =78 ; 479 =79 ; 480 =80 ; 481 =81 ; 482 =82 ; 483 =83 ; 484 =84 ; 
                      485 =85 ; 486 =86 ; 487 
                      =87 ; 488 =88 ; 489 =89 ; 490 =90 ; 491 =91 ; 492 =92 ; 493 =93 ; 494 =94 ;
                      495 =95 ; 496 =96 ; 497 =97 ; 
                      498 =98")
  
  
  bdo <- bd[,.N, keyby = list(SEXO, CAU_HOMOL, EDAD2)]
  
  setnames(bdo, 'EDAD2','EDAD')
  
  bdo$anio <- anio  
  as.data.frame(bdo)
}

defb <- resdb(1998)  
for(i in 1999:2007){   defb <- rbind(resdb(i), defb)   }

resdc <- function(anio){
  fil <- paste("DEFU", anio, ".txt", sep="")
  bd <- fread(fil,  header = TRUE, colClasses = "string")
  bd <- data.table(bd)
  
  setnames(bd, names(bd), toupper(names(bd))   )
  if(any(names(bd) == "CAU_HOMO")) {setnames(bd, "CAU_HOMO", "CAU_HOMOL")}
  
  bd$EDAD <- as.numeric(bd$EDAD)
  bd$EDAD2 <- NA
  
  bd$EDAD2 <- recode( bd$EDAD, "0:4000 = 0;  c(4000,9999,4999)=NA;
                      4001=001 ; 4002=002 ; 4003=003 ; 4004=004 ; 4005=005 ; 4006=006 ; 4007=007 ; 4008=008 ; 4009=009 ; 4010=010 
                      ; 4011=011 ; 4012=012 ; 4013=013 ; 4014=014 ; 4015=015 ; 4016=016 ; 4017=017 ; 4018=018 ; 4019=019 ; 
                      4020=020 ; 4021=021 ; 4022=022 ; 4023=023 ; 4024=024 ; 4025=025 ; 4026=026 ; 4027=027 ; 4028=028 ; 4029=029 
                      ; 4030=030 ; 4031=031 ; 4032=032 ; 4033=033 ; 4034=034 ; 4035=035 ; 4036=036 ; 4037=037 ; 4038=038 ; 
                      4039=039 ; 4040=040 ; 4041=041 ; 4042=042 ; 4043=043 ; 4044=044 ; 4045=045 ; 4046=046 ; 4047=047 ; 4048=048 
                      ; 4049=049 ; 4050=050 ; 4051=051 ; 4052=052 ; 4053=053 ; 4054=054 ; 4055=055 ; 4056=056 ; 4057=057 ; 
                      4058=058 ; 4059=059 ; 4060=060 ; 4061=061 ; 4062=062 ; 4063=063 ; 4064=064 ; 4065=065 ; 4066=066 ; 4067=067 
                      ; 4068=068 ; 4069=069 ; 4070=070 ; 4071=071 ; 4072=072 ; 4073=073 ; 4074=074 ; 4075=075 ; 4076=076 ; 
                      4077=077 ; 4078=078 ; 4079=079 ; 4080=080 ; 4081=081 ; 4082=082 ; 4083=083 ; 4084=084 ; 4085=085 ; 4086=086 
                      ; 4087=087 ; 4088=088 ; 4089=089 ; 4090=090 ; 4091=091 ; 4092=092 ; 4093=093 ; 4094=094 ; 4095=095 ; 
                      4096=096 ; 4097=097 ; 4098=098 ; 4099=099 ; 4100=100 ; 4101=101 ; 4102=102 ; 4103=103 ; 4104=104 ; 4105=105 
                      ; 4106=106 ; 4107=107 ; 4108=108 ; 4109=109 ; 4110=110 ; 4111=111 ; 4112=112 ; 4113=113 ; 4114=114 ; 
                      4115=115 ; 4116=116 ; 4117=117 ; 4118=118 ; 4119=119 ; 4120=120")
  
  bdo <- bd[,.N, keyby = list(SEXO, CAU_HOMOL, EDAD2)]
  
  bdo$anio <- anio  
  
  setnames(bdo, 'EDAD2','EDAD')
  as.data.frame(bdo)
}

defc <- resdc(2008)  
for(i in 2009:2010){   defc <- rbind(resdc(i), defc)   }



defd <- rbind(def,defb,defc)
cod <- read.xlsx2(file = "Lista_105_Colombia_CIE9-y-CIE10.xls",   1)
defd$CAU_HOMOL <- as.numeric(as.character(defd$CAU_HOMOL ))
cod$CAU_HOMOL <- as.numeric(as.character(cod$CAU_HOMOL ))

defd <- merge(defd, cod , by = 'CAU_HOMOL')

defd$Edadg <- cut(defd$EDAD, breaks =  c(-1,  4, seq(9, 79, 5), 100 ) )

dput(unique(defd$Edadg))
dput(unique(mbd$Edadg))

defd$Edadg <- factor(defd$Edadg, c("(-1,4]", 
                                   "(4,9]", "(9,14]", "(14,19]", "(19,24]", "(24,29]", "(29,34]", 
                                   "(34,39]", "(39,44]", "(44,49]", "(49,54]", "(54,59]", "(59,64]", 
                                   "(64,69]", "(69,74]", "(74,79]", "(79,100]")  ,   
                     c("0-4", "5-9",  "10-14", "15-19", 
                       "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", 
                       "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80 Y MÁS"
                     ) )

defd <- data.table(defd)

defe <- defd[is.na(Edadg) == F, list(tdef = sum(N)), 
             keyby = list( SEXO,   anio,     Grupo, Edadg) ]
defe$SEXO <- as.numeric(defe$SEXO)

dcb <- merge(defe, mbd, by = c("SEXO" ,     "anio" ,  "Edadg") )

#pr <-dcb[,sum(pob), keyby = list(anio,     Grupo)]
dcb[, tesp := tdef / pob ]

dcb$edadcl <- factor(dcb$Edadg, lev =  c("0-4", "5-9", "10-14", "15-19", 
                                         "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", 
                                         "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80 Y MÁS"    ) ,
                     labels = c(seq(2.5, 77.5, 5), 90) )

dcb$edadcl <- as.numeric(as.character(dcb$edadcl) )

# Dist tipo col amb sex

bd <- read.xlsx2("poblacion.edades.simples.censos.xlsx", 1)
bd <- data.table(bd)
bd <- subset(bd, Dep == 'Colombia')


bd$Hombres <- as.numeric(as.character(bd$Hombres ))
bd$Mujeres <- as.numeric(as.character(bd$Mujeres))
bd$edad <- as.numeric(as.character(bd$edad))

bd[, Tot := round(Hombres + Mujeres)]

bd$edadcl <- cut(bd$edad, breaks = c(-1,  4, seq(9, 79, 5), 100 ) )
dput(levels(bd$edadcl))
bd$edadcl <- factor(bd$edadcl, c("(-1,4]", "(4,9]", "(9,14]", "(14,19]", "(19,24]", "(24,29]", 
                                 "(29,34]", "(34,39]", "(39,44]", "(44,49]", "(49,54]", "(54,59]", 
                                 "(59,64]", "(64,69]", "(69,74]", "(74,79]", "(79,100]")  ,   
                    c(seq(2.5, 77.5, 5), 90) )

bd1 <- bd[is.na(edadcl) == F,  sum(Tot) , keyby = list(anio, edadcl)][
  , Pct := V1  / sum(V1), keyby = list(anio)][anio == 2005, list(edadcl,  Pct)]

bd1$edadcl <- as.numeric(as.character(bd1$edadcl))

bte <- merge(dcb, bd1, by = 'edadcl')

bteb <- bte[, list(tst = sum(tesp * Pct) * 100000), keyby = list(anio, SEXO,  Grupo )]

bteb$SEXO <- factor(bteb$SEXO, 1:2, c('H', 'M'   ))


bteb$SEXO <- factor(bteb$SEXO, levels = c("H", "M"), labels =c("Hombres", "Mujeres")  )

dput(unique(bteb$Grupo))

bteb$Grupo <- factor(bteb$Grupo, levels = c(" Aparato digestivo", "Anomalías congénitas", 
                                            "Aparato circulatorio", "Aparato genitourinario", "Aparato respiratorio", 
                                            "Causas externas", "Endocrinas, nutricionales y metabólicas", 
                                            "Infecciosas y parasitarias", "Maternales y perinatales", "Otras causas", 
                                            "Sist. nervioso", "Trast. Mentales", "Tumores"),
                     labels = c(" Ap. digestivo", "Congénitas", 
                                "Ap. circulatorio", "Ap. genitourinario", "Ap. respiratorio", 
                                "Causas externas", "Nutricionales", 
                                "Infecciosas", "Perinatales", "Otras causas", 
                                "Sist. nervioso", "Trast. Mentales", "Tumores"))

sizet <- 11

# bteb$Causa <- revalue(bteb$Causa, c("Enf. de los vasos sanguíneos y otras del sist. circulatorio" =
#                                       "Enf. de los vasos sanguíneos y otras") )

g <- ggplot(bteb[Grupo != 'Otras causas' & Grupo != 'Sist. nervioso'& 
                   Grupo != 'Trast. Mentales'],
            aes(x = anio, y = tst, colour = Grupo) ) + 
  facet_wrap( ~ SEXO) + 
  geom_line(size = 1.3 ) + 
  theme_bw(base_size = 10, base_family = "Helvetica") +
  scale_x_continuous(limits=c(1982, 2010), expand = c(0.1, 0.1)) +
  scale_y_log10() + 
  xlab('Año') + ylab('Tasa estandarizada (por 100 mil)') +
  theme(strip.background = element_rect(fill="white"), 
        axis.title.y=element_text(size = sizet, vjust = 0.9), 
        axis.title.x=element_text(size = sizet, vjust = 0.1),
        axis.text.x = element_text( size = sizet, family = "Helvetica"),
        axis.text.y = element_text(size = sizet, family = "Helvetica"), 
        legend.text = element_text(size = sizet, family = "Helvetica"),
        strip.text.x = element_text(size = sizet + 2, family = "Helvetica") ,
        panel.margin = unit(2, "lines"),
        legend.position = '',
        panel.grid = element_blank() ) +  
  geom_text(data = bteb[Grupo %in% c(  "Causas externas") & anio == 1993 &  SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c(  "Causas externas") & anio == 2006 & SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -4.7, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c(  "Tumores") & anio == 1993 &  SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c(  "Tumores") & anio == 1993 & SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 )  + 
   geom_text(data = bteb[Grupo %in% c( "Ap. circulatorio") & anio == 1991&  SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = 4, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Ap. circulatorio") & anio == 1991& SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -4, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c(  "Ap. genitourinario") & anio == 1995& SEXO == 'Hombres' ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = 2, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c(  "Ap. genitourinario") & anio == 1995&   SEXO == 'Mujeres' ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = 2, size = 4 )  + 
   geom_text(data = bteb[Grupo %in% c( "Ap. respiratorio") & anio == 1991&      SEXO == 'Hombres'  ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = - 3, size = 4)  + 
  geom_text(data = bteb[Grupo %in% c( "Ap. respiratorio") & anio == 1991&    SEXO == 'Mujeres'  ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -3, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Infecciosas") & anio == 1987 &  SEXO == 'Hombres'  ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = - 2, size = 4)  +
  geom_text(data = bteb[Grupo %in% c( "Infecciosas") & anio == 2002 &   SEXO == 'Mujeres'  ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust =  3, size = 4)  +
  geom_text(data = bteb[Grupo %in% c( "Congénitas") & anio == 1991 & SEXO == 'Hombres' ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -2.5, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Congénitas") & anio == 1991 & SEXO == 'Mujeres' ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -2.5, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Nutricionales") & anio == 1992 &   SEXO == 'Hombres'    ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust =4, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Nutricionales") & anio == 1992 & SEXO == 'Mujeres'    ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -3, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( " Ap. digestivo") & anio == 2006 &  SEXO == 'Hombres'    ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( " Ap. digestivo") & anio == 2007 &      SEXO == 'Mujeres'    ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = 2, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Perinatales") & anio == 2007& SEXO == 'Hombres'    ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Perinatales") & anio == 2008 &    SEXO == 'Mujeres'    ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -2, size = 4 )  + 
  annotation_logticks(sides = "l") +
  scale_colour_tableau(  )   

 pdf(file = "testand_grandes_gr.pdf", 
     width = 8,   height = 8, family = "Helvetica")
print(g )
 dev.off()

bteb[Grupo == "Causas externas"][order(SEXO)][, tstm := round(tst)] %>%
  dcast(anio   +   Grupo ~ SEXO        , value.var = 'tstm')



bteb[Grupo == 'Ap. circulatorio'][order(SEXO)][, tstm := round(tst)] %>%
  dcast(anio   +   Grupo ~ SEXO        , value.var = 'tstm')

bteb[Grupo == 'Ap. circulatorio'][, list(maxtst = round(max(tst)), amaxtst = anio[which.max(tst)],
                                             mintst = round(min(tst)), amintst = anio[which.min(tst)]),
                                      keyby = list(SEXO)]

( bteb[Grupo == 'Ap. circulatorio' & anio %in% c(1985, 2010)] %>%
    dcast( SEXO   +      Grupo ~anio , value.var='tst') %>%
    setnames(3:4, c('a1985', 'a2010'))   %>% 
    mutate( tc = (a2010 - a1985) *100 / a1985)   )


bteb[Grupo == 'Ap. circulatorio'] %>%
  dcast(anio +  Grupo ~ SEXO , value.var = 'tst') %>%
  mutate(tc = round((Hombres - Mujeres) * 100/ Mujeres))



bteb[Grupo == "Tumores"][order(SEXO)]

bteb[Grupo == "Tumores"][, list(maxtst = round(max(tst)), amaxtst = anio[which.max(tst)],
                                mintst = round(min(tst)), amintst = anio[which.min(tst)]),
                         keyby = list(SEXO)]

bteb[Grupo == 'Tumores'] %>%
  dcast(anio +  Grupo ~ SEXO , value.var = 'tst') %>%
  mutate(tc = round((Hombres - Mujeres) * 100/ Mujeres))



bteb[Grupo == "Ap. respiratorio"][order(SEXO)]



bteb[Grupo == 'Ap. respiratorio'] %>%
  dcast(anio +  Grupo ~ SEXO , value.var = 'tst') %>%
  mutate(tc = round((Hombres - Mujeres) * 100/ Mujeres))


( bteb[Grupo == 'Ap. respiratorio' & anio %in% c(1985, 2010)] %>%
    dcast( SEXO   +      Grupo ~anio , value.var='tst') %>%
    setnames(3:4, c('a1985', 'a2010'))   %>% 
    mutate( tc = (a2010 - a1985) *100 / a1985)   )




bteb[Grupo == 'Infecciosas'][order(SEXO)][, tstm := round(tst)] %>%
  dcast(anio   +   Grupo ~ SEXO        , value.var = 'tstm')


bteb[Grupo == ' Ap. digestivo'][order(SEXO)][, tstm := round(tst)] %>%
  dcast(anio   +   Grupo ~ SEXO        , value.var = 'tstm')



( bteb[Grupo == ' Ap. digestivo' & anio %in% c(1985, 2010)] %>%
    dcast( SEXO   +      Grupo ~anio , value.var='tst') %>%
    setnames(3:4, c('a1985', 'a2010'))   %>% 
    mutate( tc = (a2010 - a1985) *100 / a1985)   )



bteb[Grupo == " Ap. digestivo"][, list(maxtst = round(max(tst)), amaxtst = anio[which.max(tst)],
                                           mintst = round(min(tst)), amintst = anio[which.min(tst)]),
                                    keyby = list(SEXO)]



bteb[Grupo == 'Perinatales'][order(SEXO)]


bteb[Grupo == "Perinatales"][, list(maxtst = round(max(tst)), amaxtst = anio[which.max(tst)],
                                    mintst = round(min(tst)), amintst = anio[which.min(tst)]),
                             keyby = list(SEXO)]

bteb[Grupo == "Nutricionales"][, list(maxtst = round(max(tst)), amaxtst = anio[which.max(tst)],
                                      mintst = round(min(tst)), amintst = anio[which.min(tst)]),
                               keyby = list(SEXO)]



bteb[Grupo == 'Ap. genitourinario'][order(SEXO)][, tstm := round(tst)] %>%
  dcast(anio   +   Grupo ~ SEXO        , value.var = 'tstm')

bteb[Grupo == 'Congénitas'][order(SEXO)][, tstm := round(tst)] %>%
  dcast(anio   +   Grupo ~ SEXO        , value.var = 'tstm')


cod <- data.table(cod)

cod %>% setnames(4:5, c('CIE9', 'CIE10') ) %>% 
  mutate( CIE9B = as.character(CIE9), CIE10B = as.character(CIE10) )

cod$Grupo <- factor(cod$Grupo , levels = 
                      c("Infecciosas y parasitarias", "Tumores", "Endocrinas, nutricionales y metabólicas", 
                        "Aparato circulatorio", "Aparato respiratorio", " Aparato digestivo", 
                        "Aparato genitourinario", "Maternales y perinatales", "Anomalías congénitas", 
                        "Causas externas", "Otras causas"))



xtable( cod[, .SD[, .( paste(CIE9, sep="", collapse=", "), paste(CIE10, sep="", collapse=", ") ) 
                  ] , keyby = Grupo ])

p <- bteb[   Grupo %in% c(" Ap. digestivo", "Congénitas", 
                    "Ap. circulatorio", "Ap. genitourinario", "Ap. respiratorio")][
  , tstm := round(tst, 2)] %>%
 dcast(anio ~ Grupo + SEXO, value.var = 'tstm') 
  
  print(xtable(p, booktabs = TRUE, digits = 2) , 
        include.rownames=FALSE, hline.after = NULL,
        add.to.row = list(pos = list(seq(5, 25,5 )), 
                          command = c(" \\rule{0pt}{4ex} \\noindent ")))



p <- bteb[Grupo %in% c("Causas externas", "Nutricionales", 
                    "Infecciosas", "Perinatales", "Tumores")][
                      , tstm := round(tst, 2)] %>%
  dcast(anio ~ Grupo + SEXO, value.var = 'tstm') 

print(xtable(p, booktabs = TRUE, digits = 2) , 
      include.rownames=FALSE, hline.after = NULL,
      add.to.row = list(pos = list(seq(5, 25,5 )), 
                        command = c(" \\rule{0pt}{4ex} \\noindent ")))




# COL tasas estandarizadas gr edad grupos-----------------------------------------------------

bd <- read.xlsx2('pob.col.anual.sexo.edq.xlsx',1)

mbd <- melt(bd, id = 'Edadg')

mbd$sexo <- substr(mbd$variable, 1, 7)
mbd$anio <- substr(mbd$variable, 9, 12)

mbd <- data.table(mbd)

mbd$value <- as.numeric( as.character(mbd$value) )
mbd$anio <- as.numeric( as.character(mbd$anio) )

mbd$SEXO <- recode(mbd$sexo, " 'Hombres' = 1; 'Mujeres' = 2 ")

setnames(mbd, 'value', 'pob')
#edad enf

resd <- function(anio){
  fil <- paste("DEFU", anio, ".txt", sep="")
  bd <- fread(fil,  header = TRUE, colClasses = "string")
  bd <- data.table(bd)
  
  setnames(bd, names(bd), toupper(names(bd))   )
  
  bd$EDAD <- as.numeric(bd$EDAD)
  
  bd <- as.data.frame(bd)
  bd$EDAD2 <- rep(NA,nrow(bd))
  
  bd[which( bd$EDAD %in% 1:99 ), ]$EDAD2  <- bd[which( bd$EDAD %in% 1:99 ), ]$EDAD
  bd[which( bd$GRU_ED1 %in% c('01','02','03','04','05') ), ]$EDAD2  <- 0
  
  bd <- data.table(bd)
  bd$EDAD <- bd$EDAD2
  
  bdo <- bd[,.N, keyby = list(SEXO, CAU_HOMOL, EDAD)]
  
  bdo$anio <- anio  
  as.data.frame(bdo)
}

def <- resd(1985)  
for(i in 1986:1997){   def <- rbind(resd(i), def)   }

resdb <- function(anio){
  fil <- paste("DEFU", anio, ".txt", sep="")
  bd <- fread(fil,  header = TRUE, colClasses = "string")
  bd <- data.table(bd)
  
  setnames(bd, names(bd), toupper(names(bd))   )
  
  bd$EDAD <- as.numeric(bd$EDAD)
  
  bd$EDAD2 <- NA  
  bd$EDAD2 <- recode( bd$EDAD, "100:311 = 0; 312:399=1; c(400,499,999)=NA;
                      402 =02 ; 403 =03 ; 404 =04 ; 405 =05 ; 406 =06 ;
                      407 =07 ; 408 =08 ; 409 =09 ; 410 =10 ; 411 =11 ; 412 =12 
                      ; 413 =13 ; 414 =14 ; 415 =15 ; 416 =16 ; 417 =17 ; 418 =18 ; 419 =19 ;
                      420 =20 ; 421 =21 ; 422 =22 ; 423 
                      =23 ; 424 =24 ; 425 =25 ; 426 =26 ; 427 =27 ; 428 =28 ; 429 =29 ; 430 =30 ; 
                      431 =31 ; 432 =32 ; 433 =33 ; 
                      434 =34 ; 435 =35 ; 436 =36 ; 437 =37 ; 438 =38 ; 439 =39 ; 440 =40 ; 441 =41 ;
                      442 =42 ; 443 =43 ; 444 =44 
                      ; 445 =45 ; 446 =46 ; 447 =47 ; 448 =48 ; 449 =49 ; 450 =50 ; 451 =51 ; 452 =52 ;
                      453 =53 ; 454 =54 ; 455 
                      =55 ; 456 =56 ; 457 =57 ; 458 =58 ; 459 =59 ; 460 =60 ; 461 =61 ; 462 =62 ; 463 =63 ; 
                      464 =64 ; 465 =65 ; 
                      466 =66 ; 467 =67 ; 468 =68 ; 469 =69 ; 470 =70 ; 471 =71 ; 472 =72 ; 473 =73 ; 
                      474 =74 ; 475 =75 ; 476 =76 
                      ; 477 =77 ; 478 =78 ; 479 =79 ; 480 =80 ; 481 =81 ; 482 =82 ; 483 =83 ; 484 =84 ; 
                      485 =85 ; 486 =86 ; 487 
                      =87 ; 488 =88 ; 489 =89 ; 490 =90 ; 491 =91 ; 492 =92 ; 493 =93 ; 494 =94 ;
                      495 =95 ; 496 =96 ; 497 =97 ; 
                      498 =98")
  
  
  bdo <- bd[,.N, keyby = list(SEXO, CAU_HOMOL, EDAD2)]
  
  setnames(bdo, 'EDAD2','EDAD')
  
  bdo$anio <- anio  
  as.data.frame(bdo)
}

defb <- resdb(1998)  
for(i in 1999:2007){   defb <- rbind(resdb(i), defb)   }

resdc <- function(anio){
  fil <- paste("DEFU", anio, ".txt", sep="")
  bd <- fread(fil,  header = TRUE, colClasses = "string")
  bd <- data.table(bd)
  
  setnames(bd, names(bd), toupper(names(bd))   )
  if(any(names(bd) == "CAU_HOMO")) {setnames(bd, "CAU_HOMO", "CAU_HOMOL")}
  
  bd$EDAD <- as.numeric(bd$EDAD)
  bd$EDAD2 <- NA
  
  bd$EDAD2 <- recode( bd$EDAD, "0:4000 = 0;  c(4000,9999,4999)=NA;
                      4001=001 ; 4002=002 ; 4003=003 ; 4004=004 ; 4005=005 ; 4006=006 ; 4007=007 ; 4008=008 ; 4009=009 ; 4010=010 
                      ; 4011=011 ; 4012=012 ; 4013=013 ; 4014=014 ; 4015=015 ; 4016=016 ; 4017=017 ; 4018=018 ; 4019=019 ; 
                      4020=020 ; 4021=021 ; 4022=022 ; 4023=023 ; 4024=024 ; 4025=025 ; 4026=026 ; 4027=027 ; 4028=028 ; 4029=029 
                      ; 4030=030 ; 4031=031 ; 4032=032 ; 4033=033 ; 4034=034 ; 4035=035 ; 4036=036 ; 4037=037 ; 4038=038 ; 
                      4039=039 ; 4040=040 ; 4041=041 ; 4042=042 ; 4043=043 ; 4044=044 ; 4045=045 ; 4046=046 ; 4047=047 ; 4048=048 
                      ; 4049=049 ; 4050=050 ; 4051=051 ; 4052=052 ; 4053=053 ; 4054=054 ; 4055=055 ; 4056=056 ; 4057=057 ; 
                      4058=058 ; 4059=059 ; 4060=060 ; 4061=061 ; 4062=062 ; 4063=063 ; 4064=064 ; 4065=065 ; 4066=066 ; 4067=067 
                      ; 4068=068 ; 4069=069 ; 4070=070 ; 4071=071 ; 4072=072 ; 4073=073 ; 4074=074 ; 4075=075 ; 4076=076 ; 
                      4077=077 ; 4078=078 ; 4079=079 ; 4080=080 ; 4081=081 ; 4082=082 ; 4083=083 ; 4084=084 ; 4085=085 ; 4086=086 
                      ; 4087=087 ; 4088=088 ; 4089=089 ; 4090=090 ; 4091=091 ; 4092=092 ; 4093=093 ; 4094=094 ; 4095=095 ; 
                      4096=096 ; 4097=097 ; 4098=098 ; 4099=099 ; 4100=100 ; 4101=101 ; 4102=102 ; 4103=103 ; 4104=104 ; 4105=105 
                      ; 4106=106 ; 4107=107 ; 4108=108 ; 4109=109 ; 4110=110 ; 4111=111 ; 4112=112 ; 4113=113 ; 4114=114 ; 
                      4115=115 ; 4116=116 ; 4117=117 ; 4118=118 ; 4119=119 ; 4120=120")
  
  bdo <- bd[,.N, keyby = list(SEXO, CAU_HOMOL, EDAD2)]
  
  bdo$anio <- anio  
  
  setnames(bdo, 'EDAD2','EDAD')
  as.data.frame(bdo)
}

defc <- resdc(2008)  
for(i in 2009:2010){   defc <- rbind(resdc(i), defc)   }



# edad 0 ------------------------------------------------------------------


defd <- rbind(def,defb,defc)
cod <- read.xlsx2(file = "Lista_105_Colombia_CIE9-y-CIE10.xls",   1)
defd$CAU_HOMOL <- as.numeric(as.character(defd$CAU_HOMOL ))
cod$CAU_HOMOL <- as.numeric(as.character(cod$CAU_HOMOL ))



defd <- merge(defd, cod , by = 'CAU_HOMOL')

defd <- data.table(defd)
defd$SEXO <- factor(defd$SEXO, levels = 1:2, labels = c("Hombres", "Mujeres"))
defd$anio <- as.numeric(as.character(defd$anio))

ps <- fread('esimples8520.csv')
psm <- melt(ps, id.vars = "Edad")

psm$SEXO <- substring(psm$variable, 1, 7)
psm$anio <- substring(psm$variable, 9, 12)

psm$EDAD <- as.integer(psm$Edad)
psm$Edad <- NULL
psm$anio <- as.numeric(psm$anio)

defd0 <- defd[EDAD == 0]
psm0 <- psm[EDAD == 0]
b0 <- merge(defd0, psm0, by = c('SEXO', 'anio') )

b0gc <- b0[,list( sum(N), min(value)  ), keyby = list(SEXO , anio, Grupo) ]
b0gc[, tesp := V1 / V2]


b0gc$Grupo <- factor(b0gc$Grupo, levels = c(" Aparato digestivo", "Anomalías congénitas", 
                                            "Aparato circulatorio", "Aparato genitourinario", "Aparato respiratorio", 
                                            "Causas externas", "Endocrinas, nutricionales y metabólicas", 
                                            "Infecciosas y parasitarias", "Maternales y perinatales", "Otras causas", 
                                            "Tumores"),
                     labels = c(" Aparato digestivo", "Anomalías congénitas", 
                                "Aparato circulatorio", "Aparato genitourinario", "Aparato respiratorio", 
                                "Causas externas", "Nutricionales", 
                                "Infecciosas", "Perinatales", "Otras causas", 
                                "Tumores"))

sizet <- 11
p <- 
  ggplot(b0gc[Grupo != 'Otras causas' & anio != 1991], 
            aes(x = anio, y = tesp * 100000, colour = Grupo) ) +
  theme_bw() + 
  geom_line(size = 1.3) +
  #  geom_smooth(size = 1.3, span = .3, se = FALSE) +
  facet_wrap( ~ SEXO) +
  annotation_logticks(sides = "l") +
  scale_colour_tableau(  ) +
  scale_x_continuous(limits=c(1983, 2010), expand = c(0.1, 0.1)) +
  scale_y_log10() + 
  xlab('Año') + ylab('Tasa (por 100 mil)')    +
  theme(strip.background = element_rect(fill="white"), 
        axis.title.y=element_text(size = sizet, vjust = 0.9), 
        axis.title.x=element_text(size = sizet, vjust = 0.1),
        axis.text.x = element_text( size = sizet, family = "Helvetica"),
        axis.text.y = element_text(size = sizet, family = "Helvetica"), 
        legend.text = element_text(size = sizet - 2, family = "Helvetica"),
        strip.text.x = element_text(size = sizet + 2, family = "Helvetica") ,
        panel.margin = unit(1, "lines"),
        legend.position = '',
        panel.grid = element_blank() )  + 
  guides(colour = guide_legend(keywidth = 1, keyheight = 2)) +
  geom_text(data = b0gc[Grupo %in% c(  "Causas externas") & anio == 2004 & SEXO == 'Hombres'], 
            aes(x = anio, y = tesp * 100000, colour = Grupo, label = Grupo), vjust = 5, size = 4 )+  
  geom_text(data = b0gc[Grupo %in% c(  "Causas externas") & anio == 2004 & SEXO == 'Mujeres'], 
            aes(x = anio, y = tesp * 100000, colour = Grupo, label = Grupo), vjust = 5, size = 4 ) + 
  geom_text(data = b0gc[Grupo %in% c(  "Aparato circulatorio") & anio == 1998 & SEXO == 'Hombres'], 
            aes(x = anio, y = tesp * 100000, colour = Grupo, label = Grupo), vjust = 7, size = 4 )+  
  geom_text(data = b0gc[Grupo %in% c(  "Aparato circulatorio") & anio == 2000 & SEXO == 'Mujeres'], 
            aes(x = anio, y = tesp * 100000, colour = Grupo, label = Grupo), vjust = 8, size = 4 ) + 
  geom_text(data = b0gc[Grupo %in% c(  "Aparato genitourinario") & anio == 2004 & SEXO == 'Hombres'], 
            aes(x = anio, y = tesp * 100000, colour = Grupo, label = Grupo), vjust = 9, size = 4 )+  
  geom_text(data = b0gc[Grupo %in% c(  "Aparato genitourinario") & anio == 2004 & SEXO == 'Mujeres'], 
            aes(x = anio, y = tesp * 100000, colour = Grupo, label = Grupo), vjust = 9, size = 4 ) + 
  geom_text(data = b0gc[Grupo %in% c(  "Aparato respiratorio") & anio == 2005 & SEXO == 'Hombres'], 
            aes(x = anio, y = tesp * 100000, colour = Grupo, label = Grupo), vjust = -5, size = 4 )+  
  geom_text(data = b0gc[Grupo %in% c(  "Aparato respiratorio") & anio == 2005 & SEXO == 'Mujeres'], 
            aes(x = anio, y = tesp * 100000, colour = Grupo, label = Grupo), vjust = -5, size = 4 ) + 
  geom_text(data = b0gc[Grupo %in% c(  "Infecciosas") & anio == 1996 & SEXO == 'Hombres'], 
            aes(x = anio, y = tesp * 100000, colour = Grupo, label = Grupo), vjust = 2, size = 4 )+  
  geom_text(data = b0gc[Grupo %in% c(  "Infecciosas") & anio == 1996 & SEXO == 'Mujeres'], 
            aes(x = anio, y = tesp * 100000, colour = Grupo, label = Grupo), vjust = 2, size = 4 ) + 
  geom_text(data = b0gc[Grupo %in% c(  "Anomalías congénitas") & anio == 2004 & SEXO == 'Hombres'], 
            aes(x = anio, y = tesp * 100000, colour = Grupo, label = Grupo), vjust = -1, size = 4 )+  
  geom_text(data = b0gc[Grupo %in% c(  "Anomalías congénitas") & anio == 2004 & SEXO == 'Mujeres'], 
            aes(x = anio, y = tesp * 100000, colour = Grupo, label = Grupo), vjust = -1, size = 4 ) + 
  geom_text(data = b0gc[Grupo %in% c(  "Nutricionales") & anio == 1995 & SEXO == 'Hombres'], 
            aes(x = anio, y = tesp * 100000, colour = Grupo, label = Grupo), vjust = -5, size = 4 )+  
  geom_text(data = b0gc[Grupo %in% c(  "Nutricionales") & anio == 1995 & SEXO == 'Mujeres'], 
            aes(x = anio, y = tesp * 100000, colour = Grupo, label = Grupo), vjust = -8, size = 4 ) + 
  geom_text(data = b0gc[Grupo %in% c(  " Aparato digestivo") & anio == 2004 & SEXO == 'Hombres'], 
            aes(x = anio, y = tesp * 100000, colour = Grupo, label = Grupo), vjust = -1, size = 4 )+  
  geom_text(data = b0gc[Grupo %in% c(  " Aparato digestivo") & anio == 2002 & SEXO == 'Mujeres'], 
            aes(x = anio, y = tesp * 100000, colour = Grupo, label = Grupo), vjust = -2, size = 4 ) + 
  geom_text(data = b0gc[Grupo %in% c(  "Perinatales") & anio == 2004 & SEXO == 'Hombres'], 
            aes(x = anio, y = tesp * 100000, colour = Grupo, label = Grupo), vjust = -4, size = 4 )+  
  geom_text(data = b0gc[Grupo %in% c(  "Perinatales") & anio == 2004 & SEXO == 'Mujeres'], 
            aes(x = anio, y = tesp * 100000, colour = Grupo, label = Grupo), vjust = -4, size = 4 ) + 
  geom_text(data = b0gc[Grupo %in% c(  "Tumores") & anio == 1994 & SEXO == 'Hombres'], 
            aes(x = anio, y = tesp * 100000, colour = Grupo, label = Grupo), vjust = -2, size = 4 )+  
  geom_text(data = b0gc[Grupo %in% c(  "Tumores") & anio == 1994 & SEXO == 'Mujeres'], 
            aes(x = anio, y = tesp * 100000, colour = Grupo, label = Grupo), vjust = -1, size = 4 )

pdf(file = "testand_grandes_gred0.pdf", 
    width = 8,   height = 8, family = "Helvetica")
print(p )
dev.off()


dput(   unique(as.character(b0gc$Grupo))  )


b0gc[Grupo == 'Perinatales'][
  , round(tesp*100000), keyby = list( SEXO ,anio    ,   Grupo )] %>%
  dcast(   Grupo + anio    ~ SEXO, value.var = 'V1')



b0gc[Grupo == 'Perinatales' & anio != 1991][, list(maxtst = round(max(tesp) *100000),
                                                   amaxtst = anio[which.max(tesp)],
                                                   mintst = round(min(tesp)*100000),
                                                   amintst = anio[which.min(tesp)]),
                                            keyby = list(SEXO)]


b0gc[Grupo %in% c("Aparato respiratorio", "Anomalías congénitas") ][
  ,tesp100m := round(tesp * 100000)] %>%
  dcast( SEXO + anio  ~  Grupo, value.var= 'tesp100m')


b0gc[Grupo %in% c("Infecciosas", "Anomalías congénitas") ][
  ,tesp100m := round(tesp * 100000)] %>%
  dcast( SEXO + anio  ~  Grupo, value.var= 'tesp100m')



b0gc[Grupo == 'Anomalías congénitas'][, round(tesp * 100000),
                                      keyby = list(SEXO, anio, Grupo)][
                                        anio < 1998][,
 mean(V1) , keyby =   list(SEXO,  Grupo)     ]

b0gc[Grupo == 'Anomalías congénitas'][, round(tesp * 100000),
                                      keyby = list(SEXO, anio, Grupo)][
                                        anio > 1997][
                                          ,  mean(V1) , keyby =   list(SEXO,  Grupo) ]


b0gc[Grupo == 'Anomalías congénitas'][
  , round(tesp*100000), keyby = list( SEXO ,anio    ,   Grupo )] %>%
  dcast(   Grupo + anio    ~ SEXO, value.var = 'V1') %>%
  mutate( tc = (Hombres-Mujeres)*100/Mujeres   ) %>%
  summarise(min(tc), max(tc) , mean(tc) )
  

(
b0gc[Grupo == 'Aparato respiratorio' & anio != 1991][, list(maxtst = round(max(tesp) *100000),
                                                   amaxtst = anio[which.max(tesp)],
                                                   mintst = round(min(tesp)*100000),
                                                   amintst = anio[which.min(tesp)]),
                                            keyby = list(SEXO)][
                                              , tc :=   (maxtst - mintst) *100 / mintst   ]
)

(
  b0gc[Grupo == 'Infecciosas' & anio != 1991][, list(maxtst = round(max(tesp) *100000),
                                                              amaxtst = anio[which.max(tesp)],
                                                              mintst = round(min(tesp)*100000),
                                                              amintst = anio[which.min(tesp)]),
                                                       keyby = list(SEXO)][
                                                         , tc :=   (maxtst - mintst) *100 / mintst   ]
)



  b0gc[Grupo == 'Nutricionales' & anio != 1991][, tesp100m := round(tesp *100000)] %>% 
  dcast(Grupo + anio ~ SEXO, value.var = 'tesp100m')

b0gc[Grupo == 'Causas externas' & anio != 1991][, tesp100m := round(tesp *100000)] %>% 
  dcast(Grupo + anio ~ SEXO, value.var = 'tesp100m')

# edad 0 espec ------------------------------------------------------------------

defd <- rbind(def,defb,defc)
cod <- read.xlsx2(file = "Lista_105_Colombia_CIE9-y-CIE10.xls",   1)
defd$CAU_HOMOL <- as.numeric(as.character(defd$CAU_HOMOL ))
cod$CAU_HOMOL <- as.numeric(as.character(cod$CAU_HOMOL ))



defd <- merge(defd, cod , by = 'CAU_HOMOL')

defd <- data.table(defd)
defd$SEXO <- factor(defd$SEXO, levels = 1:2, labels = c("Hombres", "Mujeres"))
defd$anio <- as.numeric(as.character(defd$anio))

ps <- fread('esimples8520.csv')
psm <- melt(ps, id.vars = "Edad")

psm$SEXO <- substring(psm$variable, 1, 7)
psm$anio <- substring(psm$variable, 9, 12)

psm$EDAD <- as.integer(psm$Edad)
psm$Edad <- NULL
psm$anio <- as.numeric(psm$anio)

defd0 <- defd[EDAD == 0]
psm0 <- psm[EDAD == 0]
b0 <- merge(defd0, psm0, by = c('SEXO', 'anio') )

b0b <- b0[,list( sum(N), sum(value)  ), keyby = list( Grupo, Causa, anio) ]

b0b[, tesp := V1 / V2]


b0c <- b0b[anio %in% seq(1985, 2010, 5) 
           #            & 
           #              Causa %in% c('Enf. infecciosas intestinales', 'Neumonía', 
           #                           'Enf. del pulmón debidas a agentes externos'  )
           ][
             , tesp100m := round(tesp * 100000)]
b0c <- dcast(b0c, Causa ~anio, value.var = 'tesp100m')

unique(b0b[tesp >  10e-04, ]$Causa)

xtable(b0c, digits = 0)

sizet <- 12

dput(as.character(unique(b0b[Grupo %in% c("Maternales y perinatales")]$Causa)))


dput(
  b0b[Grupo %in% c("Infecciosas y parasitarias") & anio == 1985][order(-tesp)][
    , as.character(Causa)  ]
)

(b0b[Causa == "Enf. infecciosas intestinales"][
  ,   round(tesp * 100000), keyby = list( Causa , anio)]
)

levels(b0b$Causa)[levels(b0b$Causa)=="Septicemia, excepto neonatal"] <- 
  "Septicemia"
levels(b0b$Causa)[levels(b0b$Causa)=="Ciertas enfermedades inmunoprevenibles"] <- 
  "Ciertas enfermedades\n inmunoprevenibles"

p1 <-
  ggplot(b0b[Grupo %in% c("Infecciosas y parasitarias") & is.na(tesp) == F &
               Causa %in%  c("Enf. infecciosas intestinales", "Septicemia", 
                             "Ciertas enfermedades\n inmunoprevenibles")  & anio != 1991], 
         aes(x = anio, y = tesp * 100000, colour = Causa) ) +
  theme_bw() + geom_line(size = 1.3) +
  annotation_logticks(sides = "l") +
  #scale_colour_manual(values = c('#525252','#000000',  '#969696')  ) +
  scale_colour_tableau() +
  scale_x_continuous(limits=c(1983, 2010), expand = c(0.1, 0.1)) +
  scale_y_log10(lim = c(1, 300), expand = c(0.03, 0.03) ) + 
  xlab('Año') + ylab('Tasa (por 100 mil)') +
  theme(strip.background = element_rect(fill="white"), 
        axis.title.y=element_text(size = sizet, vjust = 0.9), 
        axis.title.x=element_text(size = sizet, vjust = 0.1),
        axis.text.x = element_text( size = sizet, family = "Helvetica"),
        axis.text.y = element_text(size = sizet, family = "Helvetica"), 
        legend.text = element_text(size = sizet - 2, family = "Helvetica"),
        strip.text.x = element_text(size = sizet + 2, family = "Helvetica") ,
        panel.margin = unit(1, "lines"),
        legend.position = '',
        panel.grid = element_blank() )  + 
  guides(colour = guide_legend(keywidth = 1, keyheight = 2)) +
  geom_text(data = b0b[Causa %in% c(  "Enf. infecciosas intestinales") & anio == 2000 ], 
            aes(x = anio, y = tesp * 100000, colour = Causa, label = Causa), vjust = - 4, size = 4 ) +
  geom_text(data = b0b[Causa %in% c(  "Septicemia") & anio == 1995 ], 
            aes(x = anio, y = tesp * 100000, colour = Causa, label = Causa), vjust = - 3, size = 4 ) +
  geom_text(data = b0b[Causa %in% c(  "Ciertas enfermedades\n inmunoprevenibles") & anio == 1995 ], 
            aes(x = anio, y = tesp * 100000, colour = Causa, label = Causa), vjust = 2, size = 4 ) +
  ggtitle('Principales enfermedades infecciosas')

dput(
  b0b[Grupo %in% c("Aparato respiratorio") & anio == 1985][order(-tesp)][
    , as.character(Causa)  ]
)


levels(b0b$Causa)[levels(b0b$Causa)=="Enf. del pulmón debidas a agentes externos"] <- 
  "Enf. del pulmón\n debidas a agentes externos"
levels(b0b$Causa)[levels(b0b$Causa)=="Enf. crónicas vías resp. inferiores"] <- 
  "Enf. crónicas\n vías resp. inferiores"



p2 <- 
  ggplot(b0b[Grupo %in% c("Aparato respiratorio") & is.na(tesp) == F &
               Causa != "Otras enf. del sistema respiratorio" & anio != 1991], 
         aes(x = anio, y = tesp * 100000, colour = Causa) ) +
  theme_bw() + geom_line(size = 1.3) +
  annotation_logticks(sides = "l") +
  scale_colour_manual(values = c('#88419d','#4d004b',  '#8c96c6')  ) +
  scale_x_continuous(limits=c(1983, 2010), expand = c(0.1, 0.1)) +
  scale_y_log10(lim = c(1, 300), expand = c(0.03, 0.03)) + 
  xlab('Año') + ylab('Tasa (por 100 mil)') +
  theme(strip.background = element_rect(fill="white"), 
        axis.title.y=element_text(size = sizet, vjust = 0.9), 
        axis.title.x=element_text(size = sizet, vjust = 0.1),
        axis.text.x = element_text( size = sizet, family = "Helvetica"),
        axis.text.y = element_text(size = sizet, family = "Helvetica"), 
        legend.text = element_text(size = sizet - 2, family = "Helvetica"),
        strip.text.x = element_text(size = sizet + 2, family = "Helvetica") ,
        panel.margin = unit(1, "lines"),
        legend.position = '',
        panel.grid = element_blank() )  + 
  guides(colour = guide_legend(keywidth = 1, keyheight = 2)) +
  geom_text(data = b0b[Causa %in% c(  "Neumonía") & anio == 2000 ], 
            aes(x = anio, y = tesp * 100000, colour = Causa, label = Causa), vjust = - 3, size = 4 ) +
  geom_text(data = b0b[Causa %in% c(  "Enf. del pulmón\n debidas a agentes externos") & anio == 1998 ], 
            aes(x = anio, y = tesp * 100000, colour = Causa, label = Causa), vjust = - 1, size = 4 ) +
  geom_text(data = b0b[Causa %in% c(  "Enf. crónicas\n vías resp. inferiores") & anio == 1988 ], 
            aes(x = anio, y = tesp * 100000, colour = Causa, label = Causa), vjust = - 1.5, size = 4 ) +
  ggtitle('Principales enfermedades respiratorias')



pdf(file = "testand_grandes_gred0esp.pdf", 
    width = 8,   height = 5.5, family = "Helvetica")
print(grid.arrange(p1, p2, ncol = 2))
dev.off()

b0b[Causa == "Neumonía"][ , tm := round(tesp * 100000)][
  ,c( 'Causa', 'anio', 'tm') , with = F][anio %in% c(1985, 2010)] %>% 
  dcast( Causa ~anio, value.var = 'tm') %>%
  setnames(2:3, c('a1985', 'a2010') ) %>%
  mutate(tc= round(  (a2010 - a1985)*100 / a1985) )
  

b0b[Causa == "Enf. del pulmón\n debidas a agentes externos"][
  , tm := round(tesp * 100000)][,c('Causa', 'anio', 'tm'), 
                                with =F][anio %in% c(1985, 2010)] %>% 
  dcast( Causa ~anio, value.var = 'tm') %>%
  setnames(2:3, c('a1985', 'a2010') ) %>%
  mutate( tc=round(  (a2010 - a1985)*100 / a1985) )




b0b[Causa == "Enf. infecciosas intestinales"][
  , tm := round(tesp * 100000)][,c('Causa', 'anio', 'tm'), with =F][anio %in% c(1985, 2010)] %>% 
  dcast( Causa ~anio, value.var = 'tm') %>%
  setnames(2:3, c('a1985', 'a2010') ) %>%
  mutate( tc = round(  (a2010 - a1985)*100 / a1985) )

b0b[Causa == "Enf. crónicas\n vías resp. inferiores"][
  , tm := round(tesp * 100000)][,c('Causa', 'anio', 'tm'), with =F][anio %in% c(1985, 2010)] %>% 
  dcast( Causa ~anio, value.var = 'tm') %>%
  setnames(2:3, c('a1985', 'a2010') ) %>%
  mutate( tc =round(  (a2010 - a1985)*100 / a1985) )

b0b[Causa == "Ciertas enfermedades\n inmunoprevenibles"][
  , tm := round(tesp * 100000)][,c('Causa', 'anio', 'tm'), with =F][anio %in% c(1985, 2010)] %>% 
  dcast( Causa ~anio, value.var = 'tm') %>%
  setnames(2:3, c('a1985', 'a2010') ) %>%
  mutate( round(  (a2010 - a1985)*100 / a1985) )


cod <- data.table(cod)

setnames(cod, 4:5, c('CIE10', 'CIE9') )

xtable(
cod[Causa %in% c("Enf. infecciosas intestinales", "Septicemia, excepto neonatal",
                 "Ciertas enfermedades inmunoprevenibles", 
                 "Neumonía", 
                 "Enf. del pulmón debidas a agentes externos", 
                 "Enf. crónicas vías resp. inferiores")][
                   ,  c('Causa', 'CIE10', 'CIE9'), with = F      ] )



xtable(
  cod[Causa %in% c("Accidentes de transporte de motor","Ahogamiento y sumersión accidentales", 
                   "Suicidios", "Homicidios" )][
                     ,  c('Causa', 'CIE10', 'CIE9'), with = F      ] )





# edad 1 14 ------------------------------------------------------------------

defd <- rbind(def,defb,defc)
cod <- read.xlsx2(file = "Lista_105_Colombia_CIE9-y-CIE10.xls",   1)
defd$CAU_HOMOL <- as.numeric(as.character(defd$CAU_HOMOL ))
cod$CAU_HOMOL <- as.numeric(as.character(cod$CAU_HOMOL ))



defd <- merge(defd, cod , by = 'CAU_HOMOL')

defd <- data.table(defd)
defd$SEXO <- factor(defd$SEXO, levels = 1:2, labels = c("Hombres", "Mujeres"))
defd$anio <- as.numeric(as.character(defd$anio))


ps <- fread('esimples8520.csv')
psm <- melt(ps, id.vars = "Edad")

psm$SEXO <- substring(psm$variable, 1, 7)
psm$anio <- substring(psm$variable, 9, 12)

psm$EDAD <- as.integer(psm$Edad)
psm$Edad <- NULL
psm$anio <- as.numeric(psm$anio)

defd14 <- defd[EDAD > 0 & EDAD < 15]
psm14 <- psm[EDAD > 0 & EDAD < 15]

defd14$Edadg <- cut(defd14$EDAD, breaks =  c(-1,  4, 9, 14 ) )

defd14$Edadg <- factor(defd14$Edadg, c("(-1,4]",      "(4,9]", "(9,14]")  ,   
                     c("1-4", "5-9", "10-14"    ) )

psm14$Edadg <- cut(psm14$EDAD, breaks =  c(-1,  4, 9, 14 ) )

psm14$Edadg <- factor(psm14$Edadg, c("(-1,4]",      "(4,9]", "(9,14]")  ,   
                       c("1-4", "5-9", "10-14"    ) )



defd14s <- defd14[, sum(N), keyby = list( SEXO, anio, Grupo, Edadg)]
psm14s <- psm14[, sum(value), keyby = list(   SEXO  ,  anio, Edadg) ]

psm14s$SEXO <- factor(psm14s$SEXO, c('Hombres', 'Mujeres') , c('Hombres', 'Mujeres')  )
# defd14s$SEXO <- factor(defd14s$SEXO, 1:2 , c('Hombres', 'Mujeres')  )

b14 <- merge(defd14s, psm14s, by = c('SEXO', 'anio', 'Edadg') )


b14[, tesp := V1.x / V1.y]

estr <- psm14s[anio == 2005][, sum(V1), keyby = .(Edadg)][, Pct := V1  / sum(V1)]

b14 <- merge(b14, estr, keyby = .( Edadg))

bteb <- b14[, list(tst = sum(tesp * Pct) * 100000), keyby = list(anio, SEXO,  Grupo )]



bteb[Grupo == 'Maternales y perinatales']$tst <- NA


bteb$Grupo <- factor(bteb$Grupo, levels = c(" Aparato digestivo", "Anomalías congénitas", 
                                            "Aparato circulatorio", "Aparato genitourinario", "Aparato respiratorio", 
                                            "Causas externas", "Endocrinas, nutricionales y metabólicas", 
                                            "Infecciosas y parasitarias", "Maternales y perinatales", "Otras causas", 
                                            "Sist. nervioso", "Trast. Mentales","Tumores"),
                     labels = c(" Ap. digestivo", "Congénitas", 
                                "Ap. circulatorio", "Ap. genitourinario", "Ap. respiratorio", 
                                "Causas externas", "Nutricionales", 
                                "Infecciosas", "Maternales", "Otras causas", 
                                "Sist. nervioso", "Trast. Mentales","Tumores"))

p <- 
  ggplot(bteb[Grupo != 'Otras causas'  &     
                Grupo != 'Trast. Mentales'   &      anio != 1991], 
         aes(x = anio, y = tst , colour = Grupo) ) +
  theme_bw() + geom_line(size = 1.3) +
  facet_wrap( ~ SEXO) +
  annotation_logticks(sides = "l") +
  scale_colour_manual(values = c("#1F77B4", "#FF7F0E", "#2CA02C", "#D62728", "#9467BD", "#8C564B", 
                                 "#E377C2", "#7F7F7F", "#BCBD22", "#AEC7E8", "#17BECF")  ) +
  scale_x_continuous(limits=c(1983, 2010), expand = c(0.1, 0.1)) +
  scale_y_log10() + 
  xlab('Año') + ylab('Tasa (por 100 mil)') +
  theme(strip.background = element_rect(fill="white"), 
        axis.title.y=element_text(size = sizet, vjust = 0.9), 
        axis.title.x=element_text(size = sizet, vjust = 0.1),
        axis.text.x = element_text( size = sizet, family = "Helvetica"),
        axis.text.y = element_text(size = sizet, family = "Helvetica"), 
        legend.text = element_text(size = sizet - 2, family = "Helvetica"),
        strip.text.x = element_text(size = sizet + 2, family = "Helvetica") ,
        panel.margin = unit(1, "lines"),
        legend.position = '',
        panel.grid = element_blank() )  + 
  guides(colour = guide_legend(keywidth = 1, keyheight = 2)) +
  geom_text(data = bteb[Grupo %in% c(  "Causas externas") & anio == 2000 & SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -2, size = 4 )+  
  geom_text(data = bteb[Grupo %in% c(  "Causas externas") & anio == 2000 & SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -3, size = 4 ) + 
  geom_text(data = bteb[Grupo %in% c(  "Ap. circulatorio") & anio == 1992 & SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -2, size = 4 )+  
  geom_text(data = bteb[Grupo %in% c(  "Ap. circulatorio") & anio == 2001 & SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = 3, size = 4 ) + 
  geom_text(data = bteb[Grupo %in% c(  "Ap. genitourinario") & anio == 1995 & SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = 2, size = 4 )+  
  geom_text(data = bteb[Grupo %in% c(  "Ap. genitourinario") & anio == 1989 & SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = 3, size = 4 ) + 
  geom_text(data = bteb[Grupo %in% c(  "Ap. respiratorio") & anio == 1994 & SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -4, size = 4 )+  
  geom_text(data = bteb[Grupo %in% c(  "Ap. respiratorio") & anio == 1994 & SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -4, size = 4 ) + 
  geom_text(data = bteb[Grupo %in% c(  "Infecciosas") & anio == 1985 & SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 )+  
  geom_text(data = bteb[Grupo %in% c(  "Infecciosas") & anio == 1985 & SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 ) + 
  geom_text(data = bteb[Grupo %in% c(  "Congénitas") & anio == 1996 & SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -2, size = 4 )+  
  geom_text(data = bteb[Grupo %in% c(  "Congénitas") & anio == 1987 & SEXO == 'Mujeres'], hjust = .8,
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 ) + 
  geom_text(data = bteb[Grupo %in% c(  "Nutricionales") & anio == 1985 & SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 )+  
  geom_text(data = bteb[Grupo %in% c(  "Nutricionales") & anio == 1985 & SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 ) + 
  geom_text(data = bteb[Grupo %in% c(  " Ap. digestivo") & anio == 2007 & SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = 3, size = 4 )+  
  geom_text(data = bteb[Grupo %in% c(  " Ap. digestivo") & anio == 2005 & SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = 4, size = 4 ) + 
  geom_text(data = bteb[Grupo %in% c(  "Tumores") & anio == 2009 & SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 )+  
  geom_text(data = bteb[Grupo %in% c(  "Tumores") & anio == 2009 & SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 ) +
  geom_text(data = bteb[Grupo %in% c(  "Sist. nervioso") & anio == 2003 & SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 )+  
  geom_text(data = bteb[Grupo %in% c(  "Sist. nervioso") & anio == 2003 & SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 )



pdf(file = "testand_grandes_gred114.pdf", 
    width = 8,   height = 8, family = "Helvetica")
print(p )
dev.off()

bteb[Grupo %in% c(  "Causas externas")][
  ,tstm := round(tst)][anio %in% c(1985, 2010)] %>%
  dcast( SEXO +           Grupo ~  anio,     value.var =  'tstm') %>%
  setnames(3:4, c('a1985', 'a2010')) %>%
  mutate(tc = (a2010 - a1985) * 100 / a1985)



bteb[Grupo %in% c(  "Sist. nervioso")][
  ,tstm := round(tst)][anio %in% c(1985, 2010)] %>%
  dcast( SEXO +           Grupo ~  anio,     value.var =  'tstm') %>%
  setnames(3:4, c('a1985', 'a2010')) %>%
  mutate(tc = (a2010 - a1985) * 100 / a1985)



bteb[Grupo %in% c(  "Infecciosas")][
  ,tstm := round(tst)][anio %in% c(1985, 2010)] %>%
  dcast( SEXO +           Grupo ~  anio,     value.var =  'tstm') %>%
  setnames(3:4, c('a1985', 'a2010')) %>%
  mutate(tc = (a2010 - a1985) * 100 / a1985)


bteb[Grupo %in% c(  "Ap. respiratorio")][
  ,tstm := round(tst)][anio %in% c(1985, 2010)] %>%
  dcast( SEXO +           Grupo ~  anio,     value.var =  'tstm') %>%
  setnames(3:4, c('a1985', 'a2010')) %>%
  mutate(tc = (a2010 - a1985) * 100 / a1985)


bteb[Grupo %in% c(  "Tumores")][
  ,tstm := round(tst)][anio %in% c(1985, 2010)] %>%
  dcast( SEXO +           Grupo ~  anio,     value.var =  'tstm') %>%
  setnames(3:4, c('a1985', 'a2010')) %>%
  mutate(tc = (a2010 - a1985) * 100 / a1985)

bteb[Grupo %in% c(  "Tumores")][
  ,tstm := round(tst)] %>%
  dcast( Grupo + anio   ~  SEXO ,     value.var =  'tstm') 
  

# edad 1 14 esp ------------------------------------------------------------------


defd <- rbind(def,defb,defc)
cod <- read.xlsx2(file = "Lista_105_Colombia_CIE9-y-CIE10.xls",   1)
defd$CAU_HOMOL <- as.numeric(as.character(defd$CAU_HOMOL ))
cod$CAU_HOMOL <- as.numeric(as.character(cod$CAU_HOMOL ))



defd <- merge(defd, cod , by = 'CAU_HOMOL')

defd <- data.table(defd)
defd$SEXO <- factor(defd$SEXO, levels = 1:2, labels = c("Hombres", "Mujeres"))
defd$anio <- as.numeric(as.character(defd$anio))


ps <- fread('esimples8520.csv')
psm <- melt(ps, id.vars = "Edad")

psm$SEXO <- substring(psm$variable, 1, 7)
psm$anio <- substring(psm$variable, 8, 11)

psm$EDAD <- as.integer(psm$Edad)
psm$Edad <- NULL
psm$anio <- as.numeric(psm$anio)

defd14 <- defd[EDAD > 0 & EDAD < 15]
psm14 <- psm[EDAD > 0 & EDAD < 15]

defd14$Edadg <- cut(defd14$EDAD, breaks =  c(-1,  4, 9, 14 ) )

defd14$Edadg <- factor(defd14$Edadg, c("(-1,4]",      "(4,9]", "(9,14]")  ,   
                       c("1-4", "5-9", "10-14"    ) )

psm14$Edadg <- cut(psm14$EDAD, breaks =  c(-1,  4, 9, 14 ) )

psm14$Edadg <- factor(psm14$Edadg, c("(-1,4]",      "(4,9]", "(9,14]")  ,   
                      c("1-4", "5-9", "10-14"    ) )



defd14s <- defd14[, sum(N), keyby = list( SEXO, anio, Grupo, Causa, Edadg)]
psm14s <- psm14[, sum(value), keyby = list(   SEXO  ,  anio, Edadg) ]

psm14s$SEXO <- factor(psm14s$SEXO, c('Hombres', 'Mujeres') , c('Hombres', 'Mujeres')  )
# defd14s$SEXO <- factor(defd14s$SEXO, 1:2 , c('Hombres', 'Mujeres')  )

b14 <- merge(defd14s, psm14s, by = c('SEXO', 'anio', 'Edadg') )


b14[, tesp := V1.x / V1.y]

estr <- psm14s[anio == 2005][, sum(V1), keyby = .(Edadg)][, Pct := V1  / sum(V1)]

b14 <- merge(b14, estr, keyby = .( Edadg))

bteb <- b14[, list(tst = sum(tesp * Pct) * 100000), keyby = list(anio, SEXO, Grupo,  Causa )]

bcesc <- bteb[Grupo == 'Causas externas'][,tstm := round(tst)] %>%
  dcast(  SEXO +  Grupo  +   Causa  ~ anio , value.var = 'tstm')

 bteb[Grupo == 'Aparato respiratorio'][
   ,tstm := round(tst)][Causa=='Neumonía'] %>%
  dcast(    Causa +anio     ~ SEXO , value.var = 'tstm')
  
bteb[Grupo == 'Infecciosas y parasitarias'][
  ,tstm := round(tst)][Causa=='Enf. infecciosas intestinales'] %>%
  dcast(    Causa +anio     ~ SEXO , value.var = 'tstm')


# 15 39 -------------------------------------------------------------------
bd <- read.xlsx2('pob.col.anual.sexo.edq.xlsx',1)

mbd <- melt(bd, id = 'Edadg')

mbd$sexo <- substr(mbd$variable, 1, 7)
mbd$anio <- substr(mbd$variable, 9, 12)

mbd <- data.table(mbd)

mbd$value <- as.numeric( as.character(mbd$value) )
mbd$anio <- as.numeric( as.character(mbd$anio) )

mbd$SEXO <- recode(mbd$sexo, " 'Hombres' = 1; 'Mujeres' = 2 ")

setnames(mbd, 'value', 'pob')

defd <- rbind(def,defb,defc)
cod <- read.xlsx2(file = "Lista_105_Colombia_CIE9-y-CIE10.xls",   1)
defd$CAU_HOMOL <- as.numeric(as.character(defd$CAU_HOMOL ))
cod$CAU_HOMOL <- as.numeric(as.character(cod$CAU_HOMOL ))



defd <- merge(defd, cod , by = 'CAU_HOMOL')

defd <- data.table(defd)
defd$SEXO <- as.numeric(as.character(defd$SEXO))
defd$SEXO <- factor(defd$SEXO, levels = 1:2, labels = c("Hombres", "Mujeres"))
defd$anio <- as.numeric(as.character(defd$anio))



defd$Edadg <- cut(defd$EDAD, breaks =  c(-1,  4, seq(9, 94, 5), 100 ) )

defd$Edadg <- factor(defd$Edadg, c("(-1,4]", 
                                   "(4,9]", "(9,14]", "(14,19]", "(19,24]", "(24,29]", "(29,34]", 
                                   "(34,39]", "(39,44]", "(44,49]", "(49,54]", "(54,59]", "(59,64]", 
                                   "(64,69]", "(69,74]", "(74,79]", "(79,84]", "(84,89]", "(89,94]", 
                                   "(94,100]")  ,   
                     c("0-4", "5-9", "10-14", "15-19", 
                       "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  
                       "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89","90-94", "95 Y MÁS"        ) )

defd <- data.table(defd)

defe <- defd[is.na(Edadg) == F, list(tdef = sum(N)), 
             keyby = list( SEXO,   anio,     Grupo, Edadg) ]
defe$SEXO <- as.numeric(defe$SEXO)

dcb <- merge(defe, mbd, by = c("SEXO" ,     "anio" ,  "Edadg") )

dcb[, tesp := tdef / pob ]

dcb$edadcl <- factor(dcb$Edadg, lev =  c("0-4", "5-9", "10-14", "15-19", 
                                         "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  
                                         "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", 
                                         "85-89","90-94", "95 Y MÁS"        ) ,
                     labels = c(seq(2.5, 92.5, 5), 102.5) )

dcb$edadcl <- as.numeric(as.character(dcb$edadcl) )

dcb1539 <- dcb[edadcl > 15 & edadcl < 39]

# Dist tipo col amb sex

bd <- read.xlsx2("poblacion.edades.simples.censos.xlsx", 1)
bd <- data.table(bd)
bd <- subset(bd, Dep == 'Colombia')

bd$Hombres <- as.numeric(as.character(bd$Hombres ))
bd$Mujeres <- as.numeric(as.character(bd$Mujeres))
bd$edad <- as.numeric(as.character(bd$edad))

bd[, Tot := round(Hombres + Mujeres)]


bd$edadcl <- cut(bd$edad, breaks = c(-1,  4, seq(9, 94, 5), 100 ) )
dput(levels(bd$edadcl))
bd$edadcl <- factor(bd$edadcl, c("(-1,4]", "(4,9]", "(9,14]", "(14,19]", "(19,24]", "(24,29]", 
                                 "(29,34]", "(34,39]", "(39,44]", "(44,49]", "(49,54]", "(54,59]", 
                                 "(59,64]", "(64,69]", "(69,74]", "(74,79]", "(79,84]", "(84,89]", 
                                 "(89,94]", "(94,100]")  ,   
                    c(seq(2.5, 92.5, 5), 102.5)
)

bd$edadcl <- as.numeric(as.character(bd$edadcl))
bd <- bd[edadcl > 15 & edadcl < 39]

bd1 <- bd[is.na(edadcl) == F,  sum(Tot) , keyby = list(anio, edadcl)][
  , Pct := V1  / sum(V1), keyby = list(anio)][anio == 2005, list(edadcl,  Pct)]

bd1$edadcl <- as.numeric(as.character(bd1$edadcl))

bd1539 <- bd1[edadcl > 15 & edadcl < 39]


bte1539 <- merge(dcb1539, bd1539, by = 'edadcl')

bteb <- bte1539[, list(tst = sum(tesp * Pct) * 100000), keyby = list(anio, SEXO,  Grupo )]

bteb$SEXO <- factor(bteb$SEXO, 1:2, c('H', 'M'   ))

bteb$SEXO <- factor(bteb$SEXO, levels = c("H", "M"), labels =c("Hombres", "Mujeres")  )

bteb$Grupo <- factor(bteb$Grupo, levels = c(" Aparato digestivo", "Anomalías congénitas", 
                                            "Aparato circulatorio", "Aparato genitourinario", "Aparato respiratorio", 
                                            "Causas externas", "Endocrinas, nutricionales y metabólicas", 
                                            "Infecciosas y parasitarias", "Maternales y perinatales", "Otras causas", 
                                            "Sist. nervioso", "Trast. Mentales","Tumores"),
                     labels = c(" Ap. digestivo", "Congénitas", 
                                "Ap. circulatorio", "Ap. genitourinario", "Ap. respiratorio", 
                                "Causas externas", "Nutricionales", 
                                "Infecciosas", "Maternales", "Otras causas", 
                                "Sist. nervioso", "Trast. Mentales","Tumores"))

sizet <- 11

bteb[Grupo == 'Maternales' & SEXO == 'Hombres']$tst <- NA
bteb[Grupo == 'Congénitas']$tst <- NA
bteb[Grupo == 'Trast. Mentales']$tst <- NA
bteb[Grupo == 'Sist. nervioso']$tst <- NA
bteb <- bteb[Grupo != 'Otras causas'  ]


g <- 
  ggplot(bteb, aes(x = anio, y = tst, colour = Grupo) ) + 
  facet_wrap( ~ SEXO) + 
  geom_line(size = 1.3 ) + 
  theme_bw(base_size = 10, base_family = "Helvetica") +
  scale_x_continuous(limits=c(1982, 2010), expand = c(0.1, 0.1)) +
  scale_y_log10() + 
  xlab('Año') + ylab('Tasa estandarizada (por 100 mil)') +
  theme(strip.background = element_rect(fill="white"), 
        axis.title.y=element_text(size = sizet, vjust = 0.9), 
        axis.title.x=element_text(size = sizet, vjust = 0.1),
        axis.text.x = element_text( size = sizet, family = "Helvetica"),
        axis.text.y = element_text(size = sizet, family = "Helvetica"), 
        legend.text = element_text(size = sizet, family = "Helvetica"),
        strip.text.x = element_text(size = sizet + 2, family = "Helvetica") ,
        panel.margin = unit(2, "lines"),
        legend.position = '',
        panel.grid = element_blank() ) +  
  geom_text(data = bteb[Grupo %in% c(  "Causas externas") & anio == 1993&
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c(  "Causas externas") & anio == 1993&
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c(     "Tumores") & anio == 1987&
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = 3, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c(     "Tumores") & anio == 1993&
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Ap. circulatorio") & anio == 1991&
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -2, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Ap. circulatorio") & anio == 2005&
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -2, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c(  "Ap. genitourinario") & anio == 2002 &
                          SEXO == 'Hombres' ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = 3, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c(  "Ap. genitourinario") & anio == 2000&
                          SEXO == 'Mujeres' ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = 3, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Ap. respiratorio") & anio == 2005&
                          SEXO == 'Mujeres'  ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Ap. respiratorio") & anio == 2005&
                          SEXO == 'Hombres'  ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = - 4, size = 4)  + 
  geom_text(data = bteb[Grupo %in% c( "Infecciosas") & anio == 2005 &
                          SEXO == 'Hombres'  ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -2, size = 4)  +
  geom_text(data = bteb[Grupo %in% c( "Infecciosas") & anio == 1994 &
                          SEXO == 'Mujeres'  ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust =  -3, size = 4)  +
  #   geom_text(data = bteb[Grupo %in% c( "Congénitas") & anio == 1991&
  #                           SEXO == 'Hombres'], 
  #             aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -5, size = 4 )  + 
  #   geom_text(data = bteb[Grupo %in% c( "Congénitas") & anio == 1991&
  #                           SEXO == 'Mujeres'], 
  #             aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -3, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Nutricionales") & anio == 1988 &
                          SEXO == 'Hombres'    ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = 3, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Nutricionales") & anio == 1992 &
                          SEXO == 'Mujeres'    ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = 4, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( " Ap. digestivo") & anio == 1995 &
                          SEXO == 'Hombres'    ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = 2, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( " Ap. digestivo") & anio == 2006 &
                          SEXO == 'Mujeres'    ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = 3, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Maternales") & anio == 2002 &
                          SEXO == 'Mujeres'    ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust =3, size = 4 )  + 
  annotation_logticks(sides = "l") +
  scale_colour_tableau(  )   

pdf(file = "testand_grandes_gr1539.pdf", 
    width = 8,   height = 8, family = "Helvetica")
print(g )
dev.off()


dput(unique(as.character(bteb$Grupo)))

bteb[Grupo == "Causas externas"][,rtst := round(tst)] %>%
  dcast( Grupo  + anio  ~  SEXO   , value.var =  'rtst'       ) %>%
  mutate( rz = Hombres  / Mujeres)

(    bteb[Grupo == 'Causas externas' ][, list(maxtst = round(max(tst) ),
                                                     amaxtst = anio[which.max(tst)],
                                                     mintst = round(min(tst) ),
                                                     amintst = anio[which.min(tst)]),
                                              keyby = list(SEXO)]   )

bteb[Grupo == "Ap. circulatorio"][,rtst := round(tst)] %>%
  dcast( Grupo  + anio  ~  SEXO   , value.var =  'rtst'       ) %>%
  mutate( rz = round((Hombres -Mujeres) * 100)  / Mujeres) %>%
  mutate( dif = Hombres -Mujeres )

bteb[Grupo == "Tumores"][,rtst := round(tst)] %>%
  dcast( Grupo  + anio  ~  SEXO   , value.var =  'rtst'       ) %>%
  mutate( rz =  round((Mujeres - Hombres) * 100)  / Hombres) %>%
   summarise( mean(rz))


bteb[Grupo == "Infecciosas"][,rtst := round(tst)] %>%
  dcast( Grupo  + anio  ~  SEXO   , value.var =  'rtst'       ) %>%
  mutate( rz = round((Hombres -Mujeres) * 100)  / Mujeres)

bteb[Grupo == "Maternales"][,rtst := round(tst)] %>%
  dcast( Grupo  + anio  ~  SEXO   , value.var =  'rtst'       ) 

bteb[Grupo == 'Maternales' ][, list(maxtst = round(max(tst) ),
                                         amaxtst = anio[which.max(tst)],
                                         mintst = round(min(tst) ),
                                         amintst = anio[which.min(tst)]),
                                  keyby = list(SEXO)] 



# 15 39 esp -------------------------------------------------------------------

bd <- read.xlsx2('pob.col.anual.sexo.edq.xlsx',1)

mbd <- melt(bd, id = 'Edadg')

mbd$sexo <- substr(mbd$variable, 1, 7)
mbd$anio <- substr(mbd$variable, 9, 12)

mbd <- data.table(mbd)

mbd$value <- as.numeric( as.character(mbd$value) )
mbd$anio <- as.numeric( as.character(mbd$anio) )

mbd$SEXO <- recode(mbd$sexo, " 'Hombres' = 1; 'Mujeres' = 2 ")

setnames(mbd, 'value', 'pob')

defd <- rbind(def,defb,defc)
cod <- read.xlsx2(file = "Lista_105_Colombia_CIE9-y-CIE10.xls",   1)
defd$CAU_HOMOL <- as.numeric(as.character(defd$CAU_HOMOL ))
cod$CAU_HOMOL <- as.numeric(as.character(cod$CAU_HOMOL ))



defd <- merge(defd, cod , by = 'CAU_HOMOL')

defd <- data.table(defd)
defd$SEXO <- as.numeric(as.character(defd$SEXO))
defd$SEXO <- factor(defd$SEXO, levels = 1:2, labels = c("Hombres", "Mujeres"))
defd$anio <- as.numeric(as.character(defd$anio))



defd$Edadg <- cut(defd$EDAD, breaks =  c(-1,  4, seq(9, 94, 5), 100 ) )

defd$Edadg <- factor(defd$Edadg, c("(-1,4]", 
                                   "(4,9]", "(9,14]", "(14,19]", "(19,24]", "(24,29]", "(29,34]", 
                                   "(34,39]", "(39,44]", "(44,49]", "(49,54]", "(54,59]", "(59,64]", 
                                   "(64,69]", "(69,74]", "(74,79]", "(79,84]", "(84,89]", "(89,94]", 
                                   "(94,100]")  ,   
                     c("0-4", "5-9", "10-14", "15-19", 
                       "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  
                       "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89","90-94", "95 Y MÁS"        ) )

defd <- data.table(defd)



defd$Edadg <- cut(defd$EDAD, breaks =  c(-1,  4, seq(9, 94, 5), 100 ) )

defd$Edadg <- factor(defd$Edadg, c("(-1,4]", 
                                   "(4,9]", "(9,14]", "(14,19]", "(19,24]", "(24,29]", "(29,34]", 
                                   "(34,39]", "(39,44]", "(44,49]", "(49,54]", "(54,59]", "(59,64]", 
                                   "(64,69]", "(69,74]", "(74,79]", "(79,84]", "(84,89]", "(89,94]", 
                                   "(94,100]")  ,   
                     c("0-4", "5-9", "10-14", "15-19", 
                       "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  
                       "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89","90-94", "95 Y MÁS"        ) )

defd <- data.table(defd)

defe <- defd[is.na(Edadg) == F, list(tdef = sum(N)), 
             keyby = list( SEXO,   anio,  Grupo,   Causa, Edadg) ]

defe$SEXO <- as.numeric(defe$SEXO)

dcb <- merge(defe, mbd, by = c("SEXO" ,     "anio" ,  "Edadg") )

dcb[, tesp := tdef / pob ]

dcb$edadcl <- factor(dcb$Edadg, lev =  c("0-4", "5-9", "10-14", "15-19", 
                                         "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  
                                         "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", 
                                         "85-89","90-94", "95 Y MÁS"        ) ,
                     labels = c(seq(2.5, 92.5, 5), 102.5) )

dcb$edadcl <- as.numeric(as.character(dcb$edadcl) )

dcb1539 <- dcb[edadcl > 15 & edadcl < 39]

# Dist tipo col amb sex

bd <- read.xlsx2("poblacion.edades.simples.censos.xlsx", 1)
bd <- data.table(bd)
bd <- subset(bd, Dep == 'Colombia')

bd$Hombres <- as.numeric(as.character(bd$Hombres ))
bd$Mujeres <- as.numeric(as.character(bd$Mujeres))
bd$edad <- as.numeric(as.character(bd$edad))

bd[, Tot := round(Hombres + Mujeres)]


bd$edadcl <- cut(bd$edad, breaks = c(-1,  4, seq(9, 94, 5), 100 ) )
dput(levels(bd$edadcl))
bd$edadcl <- factor(bd$edadcl, c("(-1,4]", "(4,9]", "(9,14]", "(14,19]", "(19,24]", "(24,29]", 
                                 "(29,34]", "(34,39]", "(39,44]", "(44,49]", "(49,54]", "(54,59]", 
                                 "(59,64]", "(64,69]", "(69,74]", "(74,79]", "(79,84]", "(84,89]", 
                                 "(89,94]", "(94,100]")  ,   
                    c(seq(2.5, 92.5, 5), 102.5)
)

bd1 <- bd[is.na(edadcl) == F,  sum(Tot) , keyby = list(anio, edadcl)][
  , Pct := V1  / sum(V1), keyby = list(anio)][anio == 2005, list(edadcl,  Pct)]

bd1$edadcl <- as.numeric(as.character(bd1$edadcl))

bd1539 <- bd1[edadcl > 15 & edadcl < 39]


bte1539 <- merge(dcb1539, bd1539, by = 'edadcl')

bteb <- bte1539[, list(tst = sum(tesp * Pct) * 100000), keyby = list(anio, SEXO, Grupo, Causa )]

bteb$SEXO <- factor(bteb$SEXO, 1:2, c('H', 'M'   ))

bteb$SEXO <- factor(bteb$SEXO, levels = c("H", "M"), labels =c("Hombres", "Mujeres")  )

bteb$cse <- paste(bteb$Causa, bteb$SEXO)

sizet <-12

dput(
  bteb[Grupo %in% c("Causas externas") & anio == 1985 & SEXO == 'Hombres'][order(-tst)][
    , as.character(Causa)  ]
)

p <-
  ggplot(bteb[Grupo %in% c("Causas externas") & 
                Causa %in% c('Homicidios', 'Accidentes de transporte de motor',
                             "Ahogamiento y sumersión accidentales", 'Suicidios'       ) ], 
         aes(x = anio, y = tst, colour = Causa) ) +
  theme_bw() + geom_line(size = 1.3) + facet_wrap(~SEXO) +
  annotation_logticks(sides = "l") +
  scale_colour_tableau() +
  scale_x_continuous(limits=c(1983, 2010), expand = c(0.1, 0.1)) +
  scale_y_log10() + 
  xlab('Año') + ylab('Tasa (por 100 mil)') +
  theme(strip.background = element_rect(fill="white"), 
        axis.title.y=element_text(size = sizet, vjust = 0.9), 
        axis.title.x=element_text(size = sizet, vjust = 0.1),
        axis.text.x = element_text( size = sizet, family = "Helvetica"),
        axis.text.y = element_text(size = sizet, family = "Helvetica"), 
        legend.text = element_text(size = sizet - 2, family = "Helvetica"),
        strip.text.x = element_text(size = sizet + 2, family = "Helvetica") ,
        panel.margin = unit(1, "lines"),
        legend.position = '',
        panel.grid = element_blank() )  +
  geom_text(data = bteb[Causa %in% c(  "Homicidios") & 
                          anio == 1986 & SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -3, size = 4 ) +
  geom_text(data = bteb[Causa %in% c(  "Accidentes de transporte de motor") & 
                          anio == 2000 & SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -2, size = 4 )  +
  geom_text(data = bteb[Causa %in% c(  "Ahogamiento y sumersión accidentales") & 
                          anio == 1995 & SEXO == 'Hombres' ], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = 6, size = 4 )  +
  geom_text(data = bteb[Causa %in% c(  "Suicidios") & 
                          anio == 1992 & SEXO == 'Hombres' ], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -2, size = 4 )  +
  geom_text(data = bteb[Causa %in% c(  "Homicidios") & 
                          anio == 1986 & SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -4, size = 4 ) +
  geom_text(data = bteb[Causa %in% c(  "Accidentes de transporte de motor") & 
                          anio == 2000 & SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -1, size = 4 )  +
  geom_text(data = bteb[Causa %in% c(  "Ahogamiento y sumersión accidentales") & 
                          anio == 1995 & SEXO == 'Mujeres' ], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = 7, size = 4 )  +
  geom_text(data = bteb[Causa %in% c(  "Suicidios") & 
                          anio == 1992 & SEXO == 'Mujeres' ], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -2, size = 4 )


pdf(file = "testand_grandes_gred1539esp.pdf", 
    width = 8,   height = 6, family = "Helvetica")
print(p)
dev.off()

bteb[Causa == "Homicidios"][, tstr := round(tst)] %>%
  dcast(Causa   +  anio ~SEXO , value.var = 'tstr') %>%
  mutate(raz= round(Hombres / Mujeres)  )


bteb[Causa == "Accidentes de transporte de motor"][, tstr := round(tst)] %>%
  dcast(Causa   +  anio ~SEXO , value.var = 'tstr') %>%
  mutate(raz= round(Hombres / Mujeres)  ) %>%
  summarise(min(Hombres),  max(Hombres), min(Mujeres), max(Mujeres))



bteb[Causa == "Ahogamiento y sumersión accidentales"][, tstr := round(tst)] %>%
  dcast(Causa   +  anio ~SEXO , value.var = 'tstr') %>%
  mutate(raz= round(Hombres / Mujeres)  )


bteb[Causa == "Suicidios"][, tstr := round(tst)] %>%
  dcast(Causa   +  anio ~SEXO , value.var = 'tstr') %>%
  mutate(raz= round(Hombres / Mujeres)  ) %>%
  summarise(minh = min(Hombres), maxh = max(Hombres), 
            minm = min(Mujeres), maxm = max(Mujeres))


cod <- data.table(cod)

setnames(cod, 4:5, c('CIE10', 'CIE9') )

xtable(
  cod[Causa %in% c("Accidentes de transporte de motor","Ahogamiento y sumersión accidentales", 
                   "Suicidios", "Homicidios" )][
                     ,  c('Causa', 'CIE10', 'CIE9'), with = F      ] )


# 40 64 -------------------------------------------------------------------

bd <- read.xlsx2('pob.col.anual.sexo.edq.xlsx',1)

mbd <- melt(bd, id = 'Edadg')

mbd$sexo <- substr(mbd$variable, 1, 7)
mbd$anio <- substr(mbd$variable, 9, 12)

mbd <- data.table(mbd)

mbd$value <- as.numeric( as.character(mbd$value) )
mbd$anio <- as.numeric( as.character(mbd$anio) )

mbd$SEXO <- recode(mbd$sexo, " 'Hombres' = 1; 'Mujeres' = 2 ")

setnames(mbd, 'value', 'pob')

defd <- rbind(def,defb,defc)
cod <- read.xlsx2(file = "Lista_105_Colombia_CIE9-y-CIE10.xls",   1)
defd$CAU_HOMOL <- as.numeric(as.character(defd$CAU_HOMOL ))
cod$CAU_HOMOL <- as.numeric(as.character(cod$CAU_HOMOL ))



defd <- merge(defd, cod , by = 'CAU_HOMOL')

defd <- data.table(defd)
defd$SEXO <- as.numeric(as.character(defd$SEXO))
defd$SEXO <- factor(defd$SEXO, levels = 1:2, labels = c("Hombres", "Mujeres"))
defd$anio <- as.numeric(as.character(defd$anio))


defd$Edadg <- cut(defd$EDAD, breaks =  c(-1,  4, seq(9, 94, 5), 100 ) )

defd$Edadg <- factor(defd$Edadg, c("(-1,4]", 
                                   "(4,9]", "(9,14]", "(14,19]", "(19,24]", "(24,29]", "(29,34]", 
                                   "(34,39]", "(39,44]", "(44,49]", "(49,54]", "(54,59]", "(59,64]", 
                                   "(64,69]", "(69,74]", "(74,79]", "(79,84]", "(84,89]", "(89,94]", 
                                   "(94,100]")  ,   
                     c("0-4", "5-9", "10-14", "15-19", 
                       "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  
                       "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89","90-94", "95 Y MÁS"        ) )

defd <- data.table(defd)

defe <- defd[is.na(Edadg) == F, list(tdef = sum(N)), 
             keyby = list( SEXO,   anio,     Grupo, Edadg) ]
defe$SEXO <- as.numeric(defe$SEXO)

dcb <- merge(defe, mbd, by = c("SEXO" ,     "anio" ,  "Edadg") )

dcb[, tesp := tdef / pob ]

dcb$edadcl <- factor(dcb$Edadg, lev =  c("0-4", "5-9", "10-14", "15-19", 
                                         "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  
                                         "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", 
                                         "85-89","90-94", "95 Y MÁS"        ) ,
                     labels = c(seq(2.5, 92.5, 5), 102.5) )

dcb$edadcl <- as.numeric(as.character(dcb$edadcl) )

dcb4064 <- dcb[edadcl > 40 & edadcl < 64]

# Dist tipo col amb sex

bd <- read.xlsx2("poblacion.edades.simples.censos.xlsx", 1)
bd <- data.table(bd)
bd <- subset(bd, Dep == 'Colombia')

bd$Hombres <- as.numeric(as.character(bd$Hombres ))
bd$Mujeres <- as.numeric(as.character(bd$Mujeres))
bd$edad <- as.numeric(as.character(bd$edad))

bd[, Tot := round(Hombres + Mujeres)]


bd$edadcl <- cut(bd$edad, breaks = c(-1,  4, seq(9, 94, 5), 100 ) )
dput(levels(bd$edadcl))
bd$edadcl <- factor(bd$edadcl, c("(-1,4]", "(4,9]", "(9,14]", "(14,19]", "(19,24]", "(24,29]", 
                                 "(29,34]", "(34,39]", "(39,44]", "(44,49]", "(49,54]", "(54,59]", 
                                 "(59,64]", "(64,69]", "(69,74]", "(74,79]", "(79,84]", "(84,89]", 
                                 "(89,94]", "(94,100]")  ,   
                    c(seq(2.5, 92.5, 5), 102.5)
)

bd$edadcl <- as.numeric(as.character(bd$edadcl))

bd <- bd[edadcl > 40 & edadcl < 64]


bd1 <- bd[is.na(edadcl) == F,  sum(Tot) , keyby = list(anio, edadcl)][
  , Pct := V1  / sum(V1), keyby = list(anio)][anio == 2005, list(edadcl,  Pct)]




bte4064 <- merge(dcb4064, bd1, by = 'edadcl')

bteb <- bte4064[, list(tst = sum(tesp * Pct) * 100000), keyby = list(anio, SEXO,  Grupo )]

bteb$SEXO <- factor(bteb$SEXO, 1:2, c('H', 'M'   ))

bteb$SEXO <- factor(bteb$SEXO, levels = c("H", "M"), labels =c("Hombres", "Mujeres")  )

bteb$Grupo <- factor(bteb$Grupo, levels = c(" Aparato digestivo", "Anomalías congénitas", 
                                            "Aparato circulatorio", "Aparato genitourinario", "Aparato respiratorio", 
                                            "Causas externas", "Endocrinas, nutricionales y metabólicas", 
                                            "Infecciosas y parasitarias", "Maternales y perinatales", "Otras causas", 
                                            "Sist. nervioso", "Trast. Mentales","Tumores"),
                     labels = c(" Ap. digestivo", "Congénitas", 
                                "Ap. circulatorio", "Ap. genitourinario", "Ap. respiratorio", 
                                "Causas externas", "Nutricionales", 
                                "Infecciosas", "Maternales", "Otras causas", 
                                "Sist. nervioso", "Trast. Mentales","Tumores"))

sizet <- 11

bteb[Grupo == 'Maternales']$tst <- NA
bteb[Grupo == 'Congénitas']$tst <- NA
bteb[Grupo == 'Sist. nervioso']$tst <- NA
bteb[Grupo == 'Trast. Mentales']$tst <- NA
bteb <- bteb[Grupo != 'Otras causas'  ]


g <- 
  ggplot(bteb, aes(x = anio, y = tst, colour = Grupo) ) + 
  facet_wrap( ~ SEXO) + 
  geom_line(size = 1.3 ) + 
  theme_bw(base_size = 10, base_family = "Helvetica") +
  scale_x_continuous(limits=c(1982, 2010), expand = c(0.05, 0.05)) +
  scale_y_log10() + 
  xlab('Año') + ylab('Tasa estandarizada (por 100 mil)') +
  theme(strip.background = element_rect(fill="white"), 
        axis.title.y=element_text(size = sizet, vjust = 0.9), 
        axis.title.x=element_text(size = sizet, vjust = 0.1),
        axis.text.x = element_text( size = sizet, family = "Helvetica"),
        axis.text.y = element_text(size = sizet, family = "Helvetica"), 
        legend.text = element_text(size = sizet, family = "Helvetica"),
        strip.text.x = element_text(size = sizet + 2, family = "Helvetica") ,
        panel.margin = unit(2, "lines"),
        legend.position = '',
        panel.grid = element_blank() ) +  
  geom_text(data = bteb[Grupo %in% c(  "Causas externas") & anio == 1993&
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c(  "Causas externas") & anio == 1993&
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c(     "Tumores") & anio == 1987&
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c(     "Tumores") & anio == 2002&
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Ap. circulatorio") & anio == 1991&
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = 2, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Ap. circulatorio") & anio == 1988 &
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -3, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c(  "Ap. genitourinario") & anio == 1988 &
                          SEXO == 'Hombres' ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -4, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c(  "Ap. genitourinario") & anio == 1993&
                          SEXO == 'Mujeres' ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = 2, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Ap. respiratorio") & anio == 1997&
                          SEXO == 'Mujeres'  ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = 4, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Ap. respiratorio") & anio == 1996&
                          SEXO == 'Hombres'  ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = - 2, size = 4)  + 
  geom_text(data = bteb[Grupo %in% c( "Infecciosas") & anio == 1987 &
                          SEXO == 'Hombres'  ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4)  +
  geom_text(data = bteb[Grupo %in% c( "Infecciosas") & anio == 1988 &
                          SEXO == 'Mujeres'  ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust =  -3, size = 4)  +
  #   geom_text(data = bteb[Grupo %in% c( "Congénitas") & anio == 1991&
  #                           SEXO == 'Hombres'], 
  #             aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -5, size = 4 )  + 
  #   geom_text(data = bteb[Grupo %in% c( "Congénitas") & anio == 1991&
  #                           SEXO == 'Mujeres'], 
  #             aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -3, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Nutricionales") & anio == 1988 &
                          SEXO == 'Hombres'    ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = 2, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Nutricionales") & anio == 2004 &
                          SEXO == 'Mujeres'    ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -4, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( " Ap. digestivo") & anio == 1986 &
                          SEXO == 'Hombres'    ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -4, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( " Ap. digestivo") & anio == 2006 &
                          SEXO == 'Mujeres'    ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = 3, size = 4 )  + 
  #   geom_text(data = bteb[Grupo %in% c( "Maternales") & anio == 2002 &
  #                           SEXO == 'Mujeres'    ], 
  #             aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust =3, size = 4 )  + 
  annotation_logticks(sides = "l") +
  scale_colour_tableau(  )   

pdf(file = "testand_grandes_gr4064.pdf", 
    width = 8,   height = 8, family = "Helvetica")
print(g )
dev.off()

bteb[Grupo == "Causas externas"][, tstm := round(tst) ] %>%
  dcast( anio   +       Grupo ~ SEXO     , value.var= 'tstm')

bteb[, list(Grupo,rank(-tst)), keyby = .(anio ,   SEXO  ) ][
  Grupo == "Causas externas"] %>%
  dcast(Grupo + anio  ~  SEXO   ,   value.var = 'V2')



bteb[, list(Grupo,rank(-tst)), keyby = .(anio ,   SEXO  ) ][
  Grupo == "Ap. circulatorio"] %>%
  dcast(Grupo + anio  ~  SEXO   ,   value.var = 'V2')

bteb[Grupo == "Ap. circulatorio"][, tstm := round(tst) ] %>%
   filter(anio %in% c(1985, 2010)) %>%
dcast( SEXO      +      Grupo ~ anio, value.var="tstm" ) %>%
setnames(3:4, c('a1985', 'a2010'))  %>%
  mutate( r= round((a2010 - a1985) * 100 / a1985))
  
  
bteb[Grupo == "Tumores"][, tstm := round(tst) ] %>%
  dcast( anio   +       Grupo ~ SEXO     , value.var= 'tstm')

bteb[Grupo == "Tumores"][, tstm := round(tst) ] %>%
  filter(anio %in% c(1985, 2010)) %>%
  dcast( SEXO      +      Grupo ~ anio, value.var="tstm" ) %>%
  setnames(3:4, c('a1985', 'a2010'))  %>%
  mutate( r= round((a2010 - a1985) * 100 / a1985))

bteb[Grupo == " Ap. digestivo"][, tstm := round(tst) ] %>%
  dcast( anio   +       Grupo ~ SEXO     , value.var= 'tstm')



# 40 64 esp -------------------------------------------------------------------

bd <- read.xlsx2('pob.col.anual.sexo.edq.xlsx',1)

mbd <- melt(bd, id = 'Edadg')

mbd$sexo <- substr(mbd$variable, 1, 7)
mbd$anio <- substr(mbd$variable, 9, 12)

mbd <- data.table(mbd)

mbd$value <- as.numeric( as.character(mbd$value) )
mbd$anio <- as.numeric( as.character(mbd$anio) )

mbd$SEXO <- recode(mbd$sexo, " 'Hombres' = 1; 'Mujeres' = 2 ")

setnames(mbd, 'value', 'pob')

defd <- rbind(def,defb,defc)
cod <- read.xlsx2(file = "Lista_105_Colombia_CIE9-y-CIE10.xls",   1)
defd$CAU_HOMOL <- as.numeric(as.character(defd$CAU_HOMOL ))
cod$CAU_HOMOL <- as.numeric(as.character(cod$CAU_HOMOL ))



defd <- merge(defd, cod , by = 'CAU_HOMOL')

defd <- data.table(defd)
defd$SEXO <- as.numeric(as.character(defd$SEXO))
defd$SEXO <- factor(defd$SEXO, levels = 1:2, labels = c("Hombres", "Mujeres"))
defd$anio <- as.numeric(as.character(defd$anio))


defd$Edadg <- cut(defd$EDAD, breaks =  c(-1,  4, seq(9, 94, 5), 100 ) )

defd$Edadg <- factor(defd$Edadg, c("(-1,4]", 
                                   "(4,9]", "(9,14]", "(14,19]", "(19,24]", "(24,29]", "(29,34]", 
                                   "(34,39]", "(39,44]", "(44,49]", "(49,54]", "(54,59]", "(59,64]", 
                                   "(64,69]", "(69,74]", "(74,79]", "(79,84]", "(84,89]", "(89,94]", 
                                   "(94,100]")  ,   
                     c("0-4", "5-9", "10-14", "15-19", 
                       "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  
                       "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89","90-94", "95 Y MÁS"        ) )

defd <- data.table(defd)

defe <- defd[is.na(Edadg) == F, list(tdef = sum(N)), 
             keyby = list( SEXO,   anio,     Grupo, Causa, Edadg) ]
defe$SEXO <- as.numeric(defe$SEXO)

dcb <- merge(defe, mbd, by = c("SEXO" ,     "anio" ,  "Edadg") )

dcb[, tesp := tdef / pob ]

dcb$edadcl <- factor(dcb$Edadg, lev =  c("0-4", "5-9", "10-14", "15-19", 
                                         "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  
                                         "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", 
                                         "85-89","90-94", "95 Y MÁS"        ) ,
                     labels = c(seq(2.5, 92.5, 5), 102.5) )

dcb$edadcl <- as.numeric(as.character(dcb$edadcl) )

dcb4064 <- dcb[edadcl > 40 & edadcl < 64]

# Dist tipo col amb sex

bd <- read.xlsx2("poblacion.edades.simples.censos.xlsx", 1)
bd <- data.table(bd)
bd <- subset(bd, Dep == 'Colombia')

bd$Hombres <- as.numeric(as.character(bd$Hombres ))
bd$Mujeres <- as.numeric(as.character(bd$Mujeres))
bd$edad <- as.numeric(as.character(bd$edad))

bd[, Tot := round(Hombres + Mujeres)]


bd$edadcl <- cut(bd$edad, breaks = c(-1,  4, seq(9, 94, 5), 100 ) )
dput(levels(bd$edadcl))
bd$edadcl <- factor(bd$edadcl, c("(-1,4]", "(4,9]", "(9,14]", "(14,19]", "(19,24]", "(24,29]", 
                                 "(29,34]", "(34,39]", "(39,44]", "(44,49]", "(49,54]", "(54,59]", 
                                 "(59,64]", "(64,69]", "(69,74]", "(74,79]", "(79,84]", "(84,89]", 
                                 "(89,94]", "(94,100]")  ,   
                    c(seq(2.5, 92.5, 5), 102.5)
)

bd$edadcl <- as.numeric(as.character(bd$edadcl))

bd <- bd[edadcl > 40 & edadcl < 64]


bd1 <- bd[is.na(edadcl) == F,  sum(Tot) , keyby = list(anio, edadcl)][
  , Pct := V1  / sum(V1), keyby = list(anio)][anio == 2005, list(edadcl,  Pct)]




bte4064 <- merge(dcb4064, bd1, by = 'edadcl')

bteb <- bte4064[, list(tst = sum(tesp * Pct) * 100000), 
                keyby = list(anio, SEXO,  Grupo, Causa )]

bteb$SEXO <- factor(bteb$SEXO, 1:2, c('H', 'M'   ))

bteb$SEXO <- factor(bteb$SEXO, levels = c("H", "M"), labels =c("Hombres", "Mujeres")  )

bteb$Grupo <- factor(bteb$Grupo, levels = c(" Aparato digestivo", "Anomalías congénitas", 
                                            "Aparato circulatorio", "Aparato genitourinario", "Aparato respiratorio", 
                                            "Causas externas", "Endocrinas, nutricionales y metabólicas", 
                                            "Infecciosas y parasitarias", "Maternales y perinatales", "Otras causas", 
                                            "Sist. nervioso", "Trast. Mentales","Tumores"),
                     labels = c(" Ap. digestivo", "Congénitas", 
                                "Ap. circulatorio", "Ap. genitourinario", "Ap. respiratorio", 
                                "Causas externas", "Nutricionales", 
                                "Infecciosas", "Maternales", "Otras causas", 
                                "Sist. nervioso", "Trast. Mentales","Tumores"))

sizet <- 11

bteb[Grupo == 'Maternales']$tst <- NA
bteb[Grupo == 'Congénitas']$tst <- NA

bteb <- bteb[Grupo != 'Otras causas'  ]


g <- 
  ggplot(bteb[Grupo == 'Causas externas' & Causa %in% 
                c("Homicidios", "Accidentes de transporte de motor",  "Suicidios") ], 
         aes(x = anio, y = tst, colour = Causa) ) + 
  facet_wrap( ~ SEXO) + 
  geom_line(size = 1.3 ) + 
  theme_bw(base_size = 10, base_family = "Helvetica") +
  scale_x_continuous(limits=c(1982, 2010), expand = c(0.05, 0.05)) +
  scale_y_log10() + 
  xlab('Año') + ylab('Tasa estandarizada (por 100 mil)') +
  theme(strip.background = element_rect(fill="white"), 
        axis.title.y=element_text(size = sizet, vjust = 0.9), 
        axis.title.x=element_text(size = sizet, vjust = 0.1),
        axis.text.x = element_text( size = sizet, family = "Helvetica"),
        axis.text.y = element_text(size = sizet, family = "Helvetica"), 
        legend.text = element_text(size = sizet, family = "Helvetica"),
        strip.text.x = element_text(size = sizet + 2, family = "Helvetica") ,
        panel.margin = unit(2, "lines"),
        legend.position = '',
        panel.grid = element_blank() ) +  
  geom_text(data = bteb[Causa %in% c(  "Homicidios") & anio == 1985&
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -3, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(  "Homicidios") & anio == 1993&
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -2, size = 4 ) +   
  geom_text(data = bteb[Causa %in% c(  "Accidentes de transporte de motor") & anio == 1993&
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -2, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(  "Accidentes de transporte de motor") & anio == 1993&
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = 4, size = 4 ) +   
  geom_text(data = bteb[Causa %in% c(  "Suicidios") & anio == 1993&
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -2, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(  "Suicidios") & anio == 1993&
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -3, size = 4 ) +   
  annotation_logticks(sides = "l") +
  scale_colour_tableau(  )   

pdf(file = "testand_esp_gr4064.pdf", 
    width = 8,   height = 5, family = "Helvetica")
print(g )
dev.off()



bteb[Causa == "Homicidios"][, tstr := round(tst)] %>%
  dcast(Causa   +  anio ~SEXO , value.var = 'tstr') %>%
  mutate(raz= round(Hombres / Mujeres)  )

bteb[Causa == "Homicidios"][ , tstr := round(tst)][
  ,c( 'Causa', 'SEXO','anio', 'tstr') , with = F][anio %in% c(2001, 2010)] %>% 
  dcast( Causa + SEXO ~anio, value.var = 'tstr') %>%
  setnames(3:4, c('a2001', 'a2010') ) %>%
  mutate(tc= round(  (a2010 - a2001)*100 / a2001) )


bteb[Causa == "Accidentes de transporte de motor"][, tstr := round(tst)] %>%
  dcast(Causa   +  anio ~SEXO , value.var = 'tstr') %>%
  mutate(raz= round(Hombres / Mujeres)  ) %>%
  summarise(min(Hombres),  max(Hombres), min(Mujeres), max(Mujeres))



bteb[Causa == "Ahogamiento y sumersión accidentales"][, tstr := round(tst)] %>%
  dcast(Causa   +  anio ~SEXO , value.var = 'tstr') %>%
  mutate(raz= round(Hombres / Mujeres)  )


bteb[Causa == "Suicidios"][, tstr := round(tst)] %>%
  dcast(Causa   +  anio ~SEXO , value.var = 'tstr') %>%
  mutate(raz= round(Hombres / Mujeres)  ) %>%
  summarise(mi = min(raz), ma = max(raz) )

bteb[Causa == "Suicidios"][, tstr := round(tst)] %>%
  dcast(Causa   +  anio ~SEXO , value.var = 'tstr') %>%
  mutate(raz= round(Hombres / Mujeres)  ) %>%
  summarise(minh = min(Hombres), maxh = max(Hombres), 
            minm = min(Mujeres), maxm = max(Mujeres))


bteb[Grupo == 'Nutricionales' & Causa == 'Diabetes mellitus'][
  , tstm := round(tst)] %>%
  dcast(anio + Grupo  + Causa ~ SEXO , value.var = 'tstm')


g <- 
  ggplot(bteb[Grupo == 'Ap. circulatorio' & Causa %in% 
                c("Enf. isquémicas del corazón", "Enf. cerebrovasculares", 
                  "Enf. hipertensivas", 
                  "Insuficiencia cardíaca") ], 
         aes(x = anio, y = tst, colour = Causa) ) + 
  facet_wrap( ~ SEXO) + 
  geom_line(size = 1.3 ) + 
  theme_bw(base_size = 10, base_family = "Helvetica") +
  scale_x_continuous(limits=c(1982, 2010), expand = c(0.05, 0.05)) +
  scale_y_log10() + 
  xlab('Año') + ylab('Tasa estandarizada (por 100 mil)') +
  theme(strip.background = element_rect(fill="white"), 
        axis.title.y=element_text(size = sizet, vjust = 0.9), 
        axis.title.x=element_text(size = sizet, vjust = 0.1),
        axis.text.x = element_text( size = sizet, family = "Helvetica"),
        axis.text.y = element_text(size = sizet, family = "Helvetica"), 
        legend.text = element_text(size = sizet, family = "Helvetica"),
        strip.text.x = element_text(size = sizet + 2, family = "Helvetica") ,
        panel.margin = unit(2, "lines"),
        legend.position = '',
        panel.grid = element_blank() ) +  
  geom_text(data = bteb[Causa %in% c(  "Enf. isquémicas del corazón") & anio == 2000 &
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -2, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(  "Enf. isquémicas del corazón") & anio == 2000 &
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -3, size = 4 ) +   
  geom_text(data = bteb[Causa %in% c(  "Enf. cerebrovasculares") & anio == 1993&
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -2, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(  "Enf. cerebrovasculares") & anio == 1993&
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = 3, size = 4 ) +   
  geom_text(data = bteb[Causa %in% c(  "Enf. hipertensivas") & anio == 1999 &
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -3, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(  "Enf. hipertensivas") & anio == 1999 &
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -3, size = 4 ) +   
  geom_text(data = bteb[Causa %in% c(  "Insuficiencia cardíaca") & anio == 2001 &
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = 2, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(  "Insuficiencia cardíaca") & anio == 2001 &
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = 2, size = 4 ) +   
  annotation_logticks(sides = "l") +
  scale_colour_tableau(  )   

pdf(file = "testand_espb_gr4064.pdf", 
    width = 8,   height = 5, family = "Helvetica")
print(g )
dev.off()


bteb[Causa == "Enf. isquémicas del corazón"][, tstr := round(tst)][
  ,c( 'Causa', 'SEXO','anio', 'tstr') , with = F][anio %in% c(1985, 2010)] %>%
  dcast(Causa   + SEXO  ~  anio, value.var = 'tstr') %>%
  setnames(3:4, c('a1985', 'a2010') )%>%
  mutate(tc= round(  (a2010 - a1985)*100 / a1985) )


bteb[Causa == "Enf. cerebrovasculares"][, tstr := round(tst)][
  ,c( 'Causa', 'SEXO','anio', 'tstr') , with = F][anio %in% c(1985, 2010)] %>%
  dcast(Causa   + SEXO  ~  anio, value.var = 'tstr') %>%
  setnames(3:4, c('a1985', 'a2010') )%>%
  mutate(tc= round(  (a2010 - a1985)*100 / a1985) )




bteb$Causa <- revalue(bteb$Causa, c("Tumor maligno de mama" = "Mama", 
                      "Tumor malig. del cuello del útero" = "Cuello del útero", 
                      "Tumor maligno del estómago" = "Estómago", 
                      "Tumor malig. de tráq., bronq. y pulmón" = "Tráq., bronq. y pulmón", 
                      "Tumor malig. del colon, recto y ano" = "Colon, recto y ano", 
                      "Tumor maligno del hígado" = "Hígado")  )

g <- 
  ggplot(bteb[Grupo == 'Tumores' & Causa %in% 
                c("Mama", "Cuello del útero", 
                  "Estómago", "Tráq., bronq. y pulmón", 
                  "Colon, recto y ano", 
                        "Hígado") ], 
         aes(x = anio, y = tst, colour = Causa) ) + 
  facet_wrap( ~ SEXO) + 
  geom_line(size = 1.3 ) + 
  theme_bw(base_size = 10, base_family = "Helvetica") +
  scale_x_continuous(limits=c(1982, 2010), expand = c(0.05, 0.05)) +
  scale_y_log10() + 
  xlab('Año') + ylab('Tasa estandarizada (por 100 mil)') +
  theme(strip.background = element_rect(fill="white"), 
        axis.title.y=element_text(size = sizet, vjust = 0.9), 
        axis.title.x=element_text(size = sizet, vjust = 0.1),
        axis.text.x = element_text( size = sizet, family = "Helvetica"),
        axis.text.y = element_text(size = sizet, family = "Helvetica"), 
        legend.text = element_text(size = sizet, family = "Helvetica"),
        strip.text.x = element_text(size = sizet + 2, family = "Helvetica") ,
        panel.margin = unit(2, "lines"),
        legend.position = '',
        panel.grid = element_blank() ) +  
  geom_text(data = bteb[Causa %in% c(  "Estómago") & anio == 2000 &
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -2, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(  "Estómago") & anio == 2000 &
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -2, size = 4 ) +   
  geom_text(data = bteb[Causa %in% c(  "Tráq., bronq. y pulmón") & anio == 1993&
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -1, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(  "Tráq., bronq. y pulmón") & anio == 1993 &
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -2, size = 4 ) +   
  geom_text(data = bteb[Causa %in% c(  "Colon, recto y ano") & anio == 1997 &
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = 8, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(  "Colon, recto y ano") & anio == 1995 &
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = 6, size = 4 ) +   
  geom_text(data = bteb[Causa %in% c(  "Hígado") & anio == 1993&
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -3, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(  "Hígado") & anio == 2005 &
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -2, size = 4 ) +   
  geom_text(data = bteb[Causa %in% c(  "Mama") & anio == 2000 &
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -3, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(  "Cuello del útero") & anio == 1990 &
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -4, size = 4 ) +   
  annotation_logticks(sides = "l") +
  scale_colour_tableau(  )   

pdf(file = "testand_espc_gr4064.pdf", 
    width = 8,   height = 5, family = "Helvetica")
print(g )
dev.off()


bteb[Grupo == "Tumores" & anio == 2010] %>%
dcast( anio   +  Grupo+ Causa ~  SEXO  , value.var = 'tst') %>%
   arrange(desc(Mujeres)) %>% head(.) %>%
  mutate(a = as.character(Causa)) %>% select(a) %>% dput(.)

bteb[Causa == 'Cuello del útero'][, tsm := round(tst)][anio %in% c(1985, 2010)] %>%
  dcast(Causa + SEXO ~anio , value.var='tsm') %>%
  setnames(3:4, c('a1985', 'a2010') ) %>%
  mutate(tc= round(  (a2010 - a1985)*100 / a1985) )


bteb[Causa == 'Mama'][, tsm := round(tst)][anio %in% c(1985, 2010)] %>%
  dcast(Causa + SEXO ~anio , value.var='tsm') %>%
  setnames(3:4, c('a1985', 'a2010') ) %>%
  mutate(tc= round(  (a2010 - a1985)*100 / a1985) )


bteb[Causa == 'Tráq., bronq. y pulmón'][, tsm := round(tst)] %>%
  dcast(Causa +anio  ~SEXO , value.var='tsm') %>%
mutate(raz = round(Hombres / Mujeres, 2))  %>%
  summarise(mi = min(raz), ma = max(raz), av = mean(raz))

cod <- data.table(cod)

setnames(cod, 4:5, c('CIE10', 'CIE9') )

xtable(
  cod[Causa %in% c("Tumor maligno de mama" , "Tumor malig. del cuello del útero" , 
                   "Tumor maligno del estómago", 
                   "Tumor malig. de tráq., bronq. y pulmón" , 
                   "Tumor malig. del colon, recto y ano" , 
                   "Tumor maligno del hígado" )][
                     ,  c('Causa', 'CIE10', 'CIE9'), with = F      ] )


xtable(
  cod[Causa %in% c("Enf. isquémicas del corazón", "Enf. cerebrovasculares", 
                   "Enf. hipertensivas", 
                   "Insuficiencia cardíaca" )][
                     ,  c('Causa', 'CIE10', 'CIE9'), with = F      ] )



# 65m -------------------------------------------------------------------
bd <- read.xlsx2('pob.col.anual.sexo.edq.xlsx',1)

mbd <- melt(bd, id = 'Edadg')

mbd$sexo <- substr(mbd$variable, 1, 7)
mbd$anio <- substr(mbd$variable, 9, 12)

mbd <- data.table(mbd)

mbd$value <- as.numeric( as.character(mbd$value) )
mbd$anio <- as.numeric( as.character(mbd$anio) )

mbd$SEXO <- recode(mbd$sexo, " 'Hombres' = 1; 'Mujeres' = 2 ")

setnames(mbd, 'value', 'pob')

defd <- rbind(def,defb,defc)
cod <- read.xlsx2(file = "Lista_105_Colombia_CIE9-y-CIE10.xls",   1)
defd$CAU_HOMOL <- as.numeric(as.character(defd$CAU_HOMOL ))
cod$CAU_HOMOL <- as.numeric(as.character(cod$CAU_HOMOL ))



defd <- merge(defd, cod , by = 'CAU_HOMOL')

defd <- data.table(defd)
defd$SEXO <- as.numeric(as.character(defd$SEXO))
defd$SEXO <- factor(defd$SEXO, levels = 1:2, labels = c("Hombres", "Mujeres"))
defd$anio <- as.numeric(as.character(defd$anio))





defd <- rbind(def,defb,defc)
cod <- read.xlsx2(file = "Lista_105_Colombia_CIE9-y-CIE10.xls",   1)
defd$CAU_HOMOL <- as.numeric(as.character(defd$CAU_HOMOL ))
cod$CAU_HOMOL <- as.numeric(as.character(cod$CAU_HOMOL ))

defd <- merge(defd, cod , by = 'CAU_HOMOL')

defd$Edadg <- cut(defd$EDAD, breaks =  c(-1,  4, seq(9, 79, 5), 100 ) )

dput(unique(defd$Edadg))
dput(unique(mbd$Edadg))

defd$Edadg <- factor(defd$Edadg, c("(-1,4]", "(4,9]", "(9,14]", 
                                   "(14,19]", "(19,24]", "(24,29]", "(29,34]", "(34,39]", "(39,44]", 
                                   "(44,49]", "(49,54]", "(54,59]", "(59,64]", "(64,69]", "(69,74]", 
                                   "(74,79]", "(79,100]")  ,   
                     c("0-4", "5-9", "10-14", "15-19", 
                       "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  
                       "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80 Y MÁS"       ) )

defd <- data.table(defd)

defe <- defd[is.na(Edadg) == F, list(tdef = sum(N)), 
             keyby = list( SEXO,   anio,     Grupo, Edadg) ]
defe$SEXO <- as.numeric(defe$SEXO)

dcb <- merge(defe, mbd, by = c("SEXO" ,     "anio" ,  "Edadg") )

dcb[, tesp := tdef / pob ]

dcb$edadcl <- factor(dcb$Edadg, lev =  c("0-4", "5-9", "10-14", "15-19", 
                                         "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  
                                         "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", 
                                         "80 Y MÁS"     ) ,
                     labels = c(seq(2.5, 77.5, 5), 90) )

dcb$edadcl <- as.numeric(as.character(dcb$edadcl) )

dcb65m <- dcb[edadcl > 65]

# Dist tipo col amb sex

bd <- read.xlsx2("poblacion.edades.simples.censos.xlsx", 1)
bd <- data.table(bd)
bd <- subset(bd, Dep == 'Colombia')

bd$Hombres <- as.numeric(as.character(bd$Hombres ))
bd$Mujeres <- as.numeric(as.character(bd$Mujeres))
bd$edad <- as.numeric(as.character(bd$edad))

bd[, Tot := round(Hombres + Mujeres)]


bd$edadcl <- cut(bd$edad, breaks = c(-1,  4, seq(9, 79, 5), 100 ) )
dput(levels(bd$edadcl))
bd$edadcl <- factor(bd$edadcl, c("(-1,4]", "(4,9]", "(9,14]", "(14,19]", "(19,24]", "(24,29]", 
                                 "(29,34]", "(34,39]", "(39,44]", "(44,49]", "(49,54]", "(54,59]", 
                                 "(59,64]", "(64,69]", "(69,74]", "(74,79]", "(79,100]")  ,   
                    c(seq(2.5, 77.5, 5), 90) )

bd$edadcl <- as.numeric(as.character(bd$edadcl))

bd <- bd[edadcl > 65]

bd1 <- bd[is.na(edadcl) == F,  sum(Tot) , keyby = list(anio, edadcl)][
  , Pct := V1  / sum(V1), keyby = list(anio)][anio == 2005, list(edadcl,  Pct)]

bd1$edadcl <- as.numeric(as.character(bd1$edadcl))

bd65m <- bd1[edadcl > 65]


bt65m <- merge(dcb65m, bd65m, by = 'edadcl')

bteb <- bt65m[, list(tst = sum(tesp * Pct) * 100000), keyby = list(anio, SEXO,  Grupo )]

bteb$SEXO <- factor(bteb$SEXO, 1:2, c('H', 'M'   ))

bteb$SEXO <- factor(bteb$SEXO, levels = c("H", "M"), labels =c("Hombres", "Mujeres")  )

bteb$Grupo <- factor(bteb$Grupo, levels = c(" Aparato digestivo", "Anomalías congénitas", 
                                            "Aparato circulatorio", "Aparato genitourinario", "Aparato respiratorio", 
                                            "Causas externas", "Endocrinas, nutricionales y metabólicas", 
                                            "Infecciosas y parasitarias", "Maternales y perinatales", "Otras causas", 
                                            "Sist. nervioso", "Trast. Mentales", "Tumores"),
                     labels = c(" Ap. digestivo", "Congénitas", 
                                "Ap. circulatorio", "Ap. genitourinario", "Ap. respiratorio", 
                                "Causas externas", "Nutricionales", 
                                "Infecciosas", "Maternales", "Otras causas", 
                                "Sist. nervioso", "Trast. Mentales", "Tumores"))

sizet <- 11

bteb[Grupo == 'Maternales' ]$tst <- NA
bteb[Grupo == 'Congénitas']$tst <- NA

bteb <- bteb[Grupo != 'Otras causas' & Grupo != 'Sist. nervioso' & Grupo != 'Trast. Mentales'  ]


g <- 
  ggplot(bteb, aes(x = anio, y = tst, colour = Grupo) ) + 
  facet_wrap( ~ SEXO) + 
  geom_line(size = 1.3 ) + 
  theme_bw(base_size = 10, base_family = "Helvetica") +
  scale_x_continuous(limits=c(1982, 2010), expand = c(0.1, 0.1)) +
  scale_y_log10() + 
  xlab('Año') + ylab('Tasa estandarizada (por 100 mil)') +
  theme(strip.background = element_rect(fill="white"), 
        axis.title.y=element_text(size = sizet, vjust = 0.9), 
        axis.title.x=element_text(size = sizet, vjust = 0.1),
        axis.text.x = element_text( size = sizet, family = "Helvetica"),
        axis.text.y = element_text(size = sizet, family = "Helvetica"), 
        legend.text = element_text(size = sizet, family = "Helvetica"),
        strip.text.x = element_text(size = sizet + 2, family = "Helvetica") ,
        panel.margin = unit(2, "lines"),
        legend.position = '',
        panel.grid = element_blank() ) +  
  geom_text(data = bteb[Grupo %in% c(  "Causas externas") & anio == 1993&
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c(  "Causas externas") & anio == 1993&
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c(     "Tumores") & anio == 1986&
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -2, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c(     "Tumores") & anio == 1986&
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -2, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Ap. circulatorio") & anio == 1986&
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -3,  size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Ap. circulatorio") & anio == 1986&
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -3,   size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c(  "Ap. genitourinario") & anio == 1995 &
                          SEXO == 'Hombres' ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = 2,size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c(  "Ap. genitourinario") & anio == 2005&
                          SEXO == 'Mujeres' ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -5, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Ap. respiratorio") & anio == 1988&
                          SEXO == 'Mujeres'  ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Ap. respiratorio") & anio == 1988&
                          SEXO == 'Hombres'  ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = - 1, size = 4)  + 
  geom_text(data = bteb[Grupo %in% c( "Infecciosas") & anio == 2008 &
                          SEXO == 'Hombres'  ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -3, size = 4)  +
  geom_text(data = bteb[Grupo %in% c( "Infecciosas") & anio == 2007 &
                          SEXO == 'Mujeres'  ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust =  -2, size = 4)  +
  #   geom_text(data = bteb[Grupo %in% c( "Congénitas") & anio == 1991&
  #                           SEXO == 'Hombres'], 
  #             aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -5, size = 4 )  + 
  #   geom_text(data = bteb[Grupo %in% c( "Congénitas") & anio == 1991&
  #                           SEXO == 'Mujeres'], 
  #             aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -3, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Nutricionales") & anio == 1988 &
                          SEXO == 'Hombres'    ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -1, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( "Nutricionales") & anio == 1992 &
                          SEXO == 'Mujeres'    ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -4, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( " Ap. digestivo") & anio == 2006 &
                          SEXO == 'Hombres'    ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = -2, size = 4 )  + 
  geom_text(data = bteb[Grupo %in% c( " Ap. digestivo") & anio == 2006 &
                          SEXO == 'Mujeres'    ], 
            aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust = 3, size = 4 )  + 
  #   geom_text(data = bteb[Grupo %in% c( "Maternales") & anio == 2002 &
  #                           SEXO == 'Mujeres'    ], 
  #             aes(x = anio, y = tst, colour = Grupo, label = Grupo), vjust =3, size = 4 )  + 
  annotation_logticks(sides = "l") +
  scale_colour_tableau(  )   

pdf(file = "testand_grandes_gr65m.pdf", 
    width = 8,   height = 8, family = "Helvetica")
print(g )
dev.off()


bteb[Grupo == "Ap. circulatorio"][, tstm := round(tst) ] %>%
  dcast( anio   +       Grupo ~ SEXO     , value.var= 'tstm')


bteb[Grupo == "Ap. circulatorio"][, tstm := round(tst) ][
   anio %in% c(1985,2010)] %>%
dcast( SEXO + Grupo ~ anio , value.var = 'tstm') %>%
  setnames(3:4, c( 'a1985','a2010' ))  %>%
  mutate(tc= round((a2010 - a1985) *100/ a1985))
  


bteb[Grupo == "Tumores"][, tstm := round(tst) ] %>%
  dcast( anio   +       Grupo ~ SEXO     , value.var= 'tstm')


bteb[Grupo == "Tumores"][, tstm := round(tst) ][
  anio %in% c(1985,2010)] %>%
  dcast( SEXO + Grupo ~ anio , value.var = 'tstm') %>%
  setnames(3:4, c( 'a1985','a2010' ))  %>%
  mutate(tc= round((a2010 - a1985) *100/ a1985))


bteb[Grupo == "Ap. respiratorio"][, tstm := round(tst) ][
  anio %in% c(1985,2010)] %>%
  dcast( SEXO + Grupo ~ anio , value.var = 'tstm') %>%
  setnames(3:4, c( 'a1985','a2010' ))  %>%
  mutate(tc= round((a2010 - a1985) *100/ a1985))


bteb[, r1 := rank(-tst), keyby = .(anio, SEXO)][
  Grupo == 'Nutricionales'][order( SEXO  ,  anio  ,      Grupo)]

bteb[, r1 := rank(-tst), keyby = .(anio, SEXO)][
  Grupo == ' Ap. digestivo'][order( SEXO  ,  anio  ,      Grupo)]


bteb[, r1 := rank(-tst), keyby = .(anio, SEXO)][
  Grupo == 'Causas externas'][order( SEXO  ,  anio  ,      Grupo)]


# 65m esp  -------------------------------------------------------------------

bd <- read.xlsx2('pob.col.anual.sexo.edq.xlsx',1)

mbd <- melt(bd, id = 'Edadg')

mbd$sexo <- substr(mbd$variable, 1, 7)
mbd$anio <- substr(mbd$variable, 9, 12)

mbd <- data.table(mbd)

mbd$value <- as.numeric( as.character(mbd$value) )
mbd$anio <- as.numeric( as.character(mbd$anio) )

mbd$SEXO <- recode(mbd$sexo, " 'Hombres' = 1; 'Mujeres' = 2 ")

setnames(mbd, 'value', 'pob')

defd <- rbind(def,defb,defc)
cod <- read.xlsx2(file = "Lista_105_Colombia_CIE9-y-CIE10.xls",   1)
defd$CAU_HOMOL <- as.numeric(as.character(defd$CAU_HOMOL ))
cod$CAU_HOMOL <- as.numeric(as.character(cod$CAU_HOMOL ))



defd <- merge(defd, cod , by = 'CAU_HOMOL')

defd <- data.table(defd)
defd$SEXO <- as.numeric(as.character(defd$SEXO))
defd$SEXO <- factor(defd$SEXO, levels = 1:2, labels = c("Hombres", "Mujeres"))
defd$anio <- as.numeric(as.character(defd$anio))





defd <- rbind(def,defb,defc)
cod <- read.xlsx2(file = "Lista_105_Colombia_CIE9-y-CIE10.xls",   1)
defd$CAU_HOMOL <- as.numeric(as.character(defd$CAU_HOMOL ))
cod$CAU_HOMOL <- as.numeric(as.character(cod$CAU_HOMOL ))

defd <- merge(defd, cod , by = 'CAU_HOMOL')

defd$Edadg <- cut(defd$EDAD, breaks =  c(-1,  4, seq(9, 79, 5), 100 ) )

dput(unique(defd$Edadg))
dput(unique(mbd$Edadg))

defd$Edadg <- factor(defd$Edadg, c("(-1,4]", "(4,9]", "(9,14]", 
                                   "(14,19]", "(19,24]", "(24,29]", "(29,34]", "(34,39]", "(39,44]", 
                                   "(44,49]", "(49,54]", "(54,59]", "(59,64]", "(64,69]", "(69,74]", 
                                   "(74,79]", "(79,100]")  ,   
                     c("0-4", "5-9", "10-14", "15-19", 
                       "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  
                       "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80 Y MÁS"       ) )

defd <- data.table(defd)

defe <- defd[is.na(Edadg) == F, list(tdef = sum(N)), 
             keyby = list( SEXO,   anio,     Grupo, Causa, Edadg) ]
defe$SEXO <- as.numeric(defe$SEXO)

dcb <- merge(defe, mbd, by = c("SEXO" ,     "anio" ,  "Edadg") )

dcb[, tesp := tdef / pob ]

dcb$edadcl <- factor(dcb$Edadg, lev =  c("0-4", "5-9", "10-14", "15-19", 
                                         "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", 
                                         "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80 Y MÁS"    ) ,
                     labels = c(seq(2.5, 77.5, 5), 90) )

dcb$edadcl <- as.numeric(as.character(dcb$edadcl) )

dcb65m <- dcb[edadcl > 65]

# Dist tipo col amb sex

bd <- read.xlsx2("poblacion.edades.simples.censos.xlsx", 1)
bd <- data.table(bd)
bd <- subset(bd, Dep == 'Colombia')

bd$Hombres <- as.numeric(as.character(bd$Hombres ))
bd$Mujeres <- as.numeric(as.character(bd$Mujeres))
bd$edad <- as.numeric(as.character(bd$edad))

bd[, Tot := round(Hombres + Mujeres)]



bd$edadcl <- cut(bd$edad, breaks = c(-1,  4, seq(9, 79, 5), 100 ) )
dput(levels(bd$edadcl))
bd$edadcl <- factor(bd$edadcl, c("(-1,4]", "(4,9]", "(9,14]", "(14,19]", "(19,24]", "(24,29]", 
                                 "(29,34]", "(34,39]", "(39,44]", "(44,49]", "(49,54]", "(54,59]", 
                                 "(59,64]", "(64,69]", "(69,74]", "(74,79]", "(79,100]")  ,   
                    c(seq(2.5, 77.5, 5), 90) )

bd$edadcl <- as.numeric(as.character(bd$edadcl))

bd <- bd[edadcl > 65]

bd1 <- bd[is.na(edadcl) == F,  sum(Tot) , keyby = list(anio, edadcl)][
  , Pct := V1  / sum(V1), keyby = list(anio)][anio == 2005, list(edadcl,  Pct)]

bd1$edadcl <- as.numeric(as.character(bd1$edadcl))

bd65m <- bd1[edadcl > 65]


bt65m <- merge(dcb65m, bd65m, by = 'edadcl')

bteb <- bt65m[, list(tst = sum(tesp * Pct) * 100000), 
              keyby = list(anio, SEXO,  Grupo, Causa )]

bteb$SEXO <- factor(bteb$SEXO, 1:2, c('H', 'M'   ))

bteb$SEXO <- factor(bteb$SEXO, levels = c("H", "M"), labels =c("Hombres", "Mujeres")  )

bteb$Grupo <- factor(bteb$Grupo, levels = c(" Aparato digestivo", "Anomalías congénitas", 
                                            "Aparato circulatorio", "Aparato genitourinario", "Aparato respiratorio", 
                                            "Causas externas", "Endocrinas, nutricionales y metabólicas", 
                                            "Infecciosas y parasitarias", "Maternales y perinatales", "Otras causas", 
                                            "Tumores"),
                     labels = c(" Ap. digestivo", "Congénitas", 
                                "Ap. circulatorio", "Ap. genitourinario", "Ap. respiratorio", 
                                "Causas externas", "Nutricionales", 
                                "Infecciosas", "Maternales", "Otras causas", 
                                "Tumores"))

sizet <- 11

bteb[Grupo == 'Maternales' ]$tst <- NA
bteb[Grupo == 'Congénitas']$tst <- NA

bteb <- bteb[Grupo != 'Otras causas'  ]


bteb$Causa <- revalue(bteb$Causa, c("Enf. de los vasos sanguíneos y otras del sist. circulatorio" =
                        "Enf. de los vasos sanguíneos y otras") )

g <- 
  ggplot(bteb[Grupo == 'Ap. circulatorio' & 
                Causa %in% c("Enf. isquémicas del corazón", "Enf. cerebrovasculares", 
                                                         "Enf. hipertensivas", 
                                                         "Insuficiencia cardíaca", "Aneurisma aortico", 
                                                         "Enf. de los vasos sanguíneos y otras")],
         aes(x = anio, y = tst, colour = Causa) ) + 
  facet_wrap( ~ SEXO) + 
  geom_line(size = 1.3 ) + 
  theme_bw(base_size = 10, base_family = "Helvetica") +
  scale_x_continuous(limits=c(1982, 2010), expand = c(0.1, 0.1)) +
  scale_y_log10() + 
  xlab('Año') + ylab('Tasa estandarizada (por 100 mil)') +
  theme(strip.background = element_rect(fill="white"), 
        axis.title.y=element_text(size = sizet, vjust = 0.9), 
        axis.title.x=element_text(size = sizet, vjust = 0.1),
        axis.text.x = element_text( size = sizet, family = "Helvetica"),
        axis.text.y = element_text(size = sizet, family = "Helvetica"), 
        legend.text = element_text(size = sizet, family = "Helvetica"),
        strip.text.x = element_text(size = sizet + 2, family = "Helvetica") ,
        panel.margin = unit(2, "lines"),
        legend.position = '',
        panel.grid = element_blank() ) +  
  geom_text(data = bteb[Causa %in% c(  "Enf. isquémicas del corazón") & anio == 1993&
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -2, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(  "Enf. isquémicas del corazón") & anio == 1993&
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -1, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(     "Enf. cerebrovasculares") & anio == 1995&
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -2, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(     "Enf. cerebrovasculares") & anio == 1998 &
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -2, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c( "Enf. hipertensivas") & anio == 2005 &
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -3,  size = 4 )  + 
  geom_text(data = bteb[Causa %in% c( "Enf. hipertensivas") & anio == 2005 &
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -3,   size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(  "Insuficiencia cardíaca") & anio == 2001 &
                          SEXO == 'Hombres' ], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = 3,size = 4 )  + 
  geom_text(data = bteb[Causa %in% c( "Insuficiencia cardíaca") & anio == 1994&
                          SEXO == 'Mujeres' ], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -6, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c( "Aneurisma aortico") & anio == 2000 &
                          SEXO == 'Mujeres'  ], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = 4, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c("Aneurisma aortico") & anio == 2000 &
                          SEXO == 'Hombres'  ], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -4, size = 4)  + 
  geom_text(data = bteb[Causa %in% c( "Enf. de los vasos sanguíneos y otras") & 
                          anio == 1999 &                     SEXO == 'Hombres'  ], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = 5, size = 4)  +
  geom_text(data = bteb[Causa %in% c( "Enf. de los vasos sanguíneos y otras") & 
                          anio == 1998 &                   SEXO == 'Mujeres'  ], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -6, size = 4) + annotation_logticks(sides = "l") +
  scale_colour_tableau(  )   

pdf(file = "testand_espa_gr65m.pdf", 
    width = 8,   height = 8, family = "Helvetica")
print(g )
dev.off()


bteb[Causa == 'Enf. isquémicas del corazón'][, tstr := round(tst)] %>%
  dcast( Causa + anio ~ SEXO, value.var = 'tstr' ) %>%
mutate(raz = round(Hombres / Mujeres, 2) )


bteb[Causa == 'Enf. cerebrovasculares'][, tstr := round(tst)] %>%
  dcast( Causa + anio ~ SEXO, value.var = 'tstr' ) %>%
  mutate(raz = round(Hombres / Mujeres, 2) )


bteb[Causa %in% c('Enf. isquémicas del corazón', 'Enf. cerebrovasculares', 'Enf. hipertensivas')][
  , tstr := round(tst)][anio %in% c(1985,2010)] %>%
  dcast( Causa + SEXO  ~  anio, value.var = 'tstr' ) %>%
  setnames(3:4, c('a1985', 'a2010')) %>%
  mutate(tc = (a2010-a1985)* 100 / a1985)



bteb[Causa %in% c('Insuficiencia cardíaca')][
  , tstr := round(tst)][anio %in% c(1985,2010)] %>%
  dcast( Causa + SEXO  ~  anio, value.var = 'tstr' ) %>%
  setnames(3:4, c('a1985', 'a2010')) %>%
  mutate(tc = (a2010-a1985)* 100 / a1985)


bteb[Causa == 'Enf. hipertensivas'][, tstr := round(tst)] %>%
  dcast( Causa + anio ~ SEXO, value.var = 'tstr' ) %>%
  mutate(raz = round(Hombres / Mujeres, 2) )


bteb[Causa == 'Insuficiencia cardíaca'][, tstr := round(tst)] %>%
  dcast( Causa + anio ~ SEXO, value.var = 'tstr' ) %>%
  mutate(raz = round(Hombres / Mujeres, 2) )


bteb$Causa <- revalue(bteb$Causa, c("Tumor maligno de mama" = "Mama", 
                                    "Tumor malig. del cuello del útero" = "Cuello del útero", 
                                    "Tumor maligno del estómago" = "Estómago", 
                                    "Tumor malig. de tráq., bronq. y pulmón" = "Tráq., bronq. y pulmón", 
                                    "Tumor malig. del colon, recto y ano" = "Colon, recto y ano", 
                                    "Tumor maligno del hígado" = "Hígado",
                                    'Tumor maligno de la próstata' = 'Próstata')  )






g <- 
  ggplot(bteb[Grupo == 'Tumores' & Causa %in% c("Estómago", "Tráq., bronq. y pulmón", 
                                                "Próstata", "Colon, recto y ano",
                                                "Hígado", "Mama", "Cuello del útero")],
         aes(x = anio, y = tst, colour = Causa) ) + 
  facet_wrap( ~ SEXO) + 
  geom_line(size = 1.3 ) + 
  theme_bw(base_size = 10, base_family = "Helvetica") +
  scale_x_continuous(limits=c(1982, 2010), expand = c(0.1, 0.1)) +
  scale_y_log10() + 
  xlab('Año') + ylab('Tasa estandarizada (por 100 mil)') +
  theme(strip.background = element_rect(fill="white"), 
        axis.title.y=element_text(size = sizet, vjust = 0.9), 
        axis.title.x=element_text(size = sizet, vjust = 0.1),
        axis.text.x = element_text( size = sizet, family = "Helvetica"),
        axis.text.y = element_text(size = sizet, family = "Helvetica"), 
        legend.text = element_text(size = sizet, family = "Helvetica"),
        strip.text.x = element_text(size = sizet + 2, family = "Helvetica") ,
        panel.margin = unit(2, "lines"),
        legend.position = '',
        panel.grid = element_blank() ) +  
  geom_text(data = bteb[Causa %in% c(  "Estómago") & anio == 1988&
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -5, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(  "Estómago") & anio == 1988&
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -5, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(     "Tráq., bronq. y pulmón") & anio == 1988 &
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -3, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(     "Tráq., bronq. y pulmón") & anio == 1994 &
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -10, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c( "Próstata") & anio == 1988 &
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -4,  size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(  "Colon, recto y ano") & anio == 2006 &
                          SEXO == 'Hombres' ], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -2,size = 4 )  + 
  geom_text(data = bteb[Causa %in% c( "Colon, recto y ano") & anio == 2006 &
                          SEXO == 'Mujeres' ], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -4, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c( "Hígado") & anio == 1985&
                          SEXO == 'Hombres'  ], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -2, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c("Hígado") & anio == 1998 &
                          SEXO == 'Mujeres'  ], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = 2, size = 4)  + 
  geom_text(data = bteb[Causa %in% c("Cuello del útero") & anio == 2007 &
                          SEXO == 'Mujeres'  ], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = 7, size = 4)  + 
  geom_text(data = bteb[Causa %in% c("Mama") & anio == 2008 &
                          SEXO == 'Mujeres'  ], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = 3, size = 4)  + 
  annotation_logticks(sides = "l") +
  scale_colour_tableau(  )   

pdf(file = "testand_espb_gr65m.pdf", 
    width = 8,   height = 8, family = "Helvetica")
print(g )
dev.off()



bteb[Causa %in% c("Estómago", "Tráq., bronq. y pulmón", 
                  "Próstata", "Colon, recto y ano",
                  "Hígado", "Mama", "Cuello del útero")][
  , tstr := round(tst)][anio %in% c(1985,2010)] %>%
  dcast( Causa + SEXO  ~  anio, value.var = 'tstr' ) %>%
  setnames(3:4, c('a1985', 'a2010')) %>%
  mutate(tc = (a2010-a1985)* 100 / a1985) %>%
  arrange(SEXO, tc)





g <- 
  ggplot(bteb[Grupo == 'Ap. respiratorio' & 
                Causa %in% c("Enf. crónicas vías resp. inferiores", "Neumonía",
                             "Otras enf. del sistema respiratorio", 
                             "Enf. del pulmón debidas a agentes externos" )],
         aes(x = anio, y = tst, colour = Causa) ) + 
  facet_wrap( ~ SEXO) + 
  geom_line(size = 1.3 ) + 
  theme_bw(base_size = 10, base_family = "Helvetica") +
  scale_x_continuous(limits=c(1982, 2010), expand = c(0.1, 0.1)) +
  scale_y_log10() + 
  xlab('Año') + ylab('Tasa estandarizada (por 100 mil)') +
  theme(strip.background = element_rect(fill="white"), 
        axis.title.y=element_text(size = sizet, vjust = 0.9), 
        axis.title.x=element_text(size = sizet, vjust = 0.1),
        axis.text.x = element_text( size = sizet, family = "Helvetica"),
        axis.text.y = element_text(size = sizet, family = "Helvetica"), 
        legend.text = element_text(size = sizet, family = "Helvetica"),
        strip.text.x = element_text(size = sizet + 2, family = "Helvetica") ,
        panel.margin = unit(2, "lines"),
        legend.position = '',
        panel.grid = element_blank() ) +  
  geom_text(data = bteb[Causa %in% c(  "Enf. crónicas vías resp. inferiores") & anio == 1993&
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -5, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(  "Enf. crónicas vías resp. inferiores") & anio == 1993&
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -6, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(     "Neumonía") & anio == 1988 &
                          SEXO == 'Hombres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -2, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(     "Neumonía") & anio == 1988 &
                          SEXO == 'Mujeres'], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = 6, size = 4 )  + 
   geom_text(data = bteb[Causa %in% c(  "Otras enf. del sistema respiratorio") & anio == 1992 &
                          SEXO == 'Hombres' ], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -7, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c( "Otras enf. del sistema respiratorio") & anio == 1992 &
                          SEXO == 'Mujeres' ], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -7, size = 4 )  + 
  geom_text(data = bteb[Causa %in% c(  "Enf. del pulmón debidas a agentes externos") & anio == 1997 &
                          SEXO == 'Hombres' ], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -5,size = 4 )  + 
  geom_text(data = bteb[Causa %in% c( "Enf. del pulmón debidas a agentes externos") & anio == 1997 &
                          SEXO == 'Mujeres' ], 
            aes(x = anio, y = tst, colour = Causa, label = Causa), vjust = -6, size = 4 )  + 
  annotation_logticks(sides = "l") +
  scale_colour_tableau(  )   

pdf(file = "testand_espc_gr65m.pdf", 
    width = 8,   height = 8, family = "Helvetica")
print(g )
dev.off()


bteb[Grupo == "Ap. respiratorio"][anio == 2010] %>%
  dcast(anio  +   Grupo  +    Causa  ~ SEXO     , value.var= 'tst') %>%
  arrange( desc(Hombres) ) %>%  mutate(a = as.character(Causa)) %>%
  select(a) %>% dput(.)


bteb[Causa %in% c("Enf. crónicas vías resp. inferiores", "Neumonía",
                  "Otras enf. del sistema respiratorio", 
                  "Enf. del pulmón debidas a agentes externos")][
                    , tstr := round(tst)][anio %in% c(1985,2010)] %>%
  dcast( Causa + SEXO  ~  anio, value.var = 'tstr' ) %>%
  setnames(3:4, c('a1985', 'a2010')) %>%
  mutate(tc = (a2010-a1985)* 100 / a1985) %>%
  arrange(SEXO, tc)


bteb[Causa %in% c("Neumonía")][
                    , tstr := round(tst)] %>%
  dcast( Causa + anio  ~ SEXO , value.var = 'tstr' ) %>%
  filter(anio < 1998) %>%
 summarise( mih = min(Hombres), mah = max(Hombres), avh = round(mean(Hombres)),
            mim = min(Mujeres), mam = max(Mujeres), avm = round(mean(Mujeres)))

bteb[Causa %in% c("Neumonía")][
  , tstr := round(tst)] %>%
  dcast( Causa + anio  ~ SEXO , value.var = 'tstr' ) %>%
  filter(anio > 1997 & anio < 2005) %>%
  summarise( mih = min(Hombres), mah = max(Hombres), avh = round(mean(Hombres)),
             mim = min(Mujeres), mam = max(Mujeres), avm = round(mean(Mujeres)))


bteb[Causa %in% c("Neumonía")][
  , tstr := round(tst)] %>%
  dcast( Causa + anio  ~ SEXO , value.var = 'tstr' ) %>%
  filter(anio > 2004) %>%
  summarise( mih = min(Hombres), mah = max(Hombres), avh = round(mean(Hombres)),
             mim = min(Mujeres), mam = max(Mujeres), avm = round(mean(Mujeres)))


bteb[Causa %in% c("Otras enf. del sistema respiratorio")][
  , tstr := round(tst)] %>%
  dcast( Causa + anio  ~ SEXO , value.var = 'tstr' )


# brecha sexo causas especificas -----------------------------------------

defd <- rbind(def,defb,defc)
cod <- read.xlsx2(file = "Lista_105_Colombia_CIE9-y-CIE10.xls",   1)
defd$CAU_HOMOL <- as.numeric(as.character(defd$CAU_HOMOL ))
cod$CAU_HOMOL <- as.numeric(as.character(cod$CAU_HOMOL ))

defd <- merge(defd, cod , by = 'CAU_HOMOL')

defd$Edadg <- cut(defd$EDAD, breaks =  c(-1,  4, seq(9, 79, 5), 100 ) )

dput(unique(defd$Edadg))
dput(unique(mbd$Edadg))

defd$Edadg <- factor(defd$Edadg, c("(-1,4]", 
                                   "(4,9]", "(9,14]", "(14,19]", "(19,24]", "(24,29]", "(29,34]", 
                                   "(34,39]", "(39,44]", "(44,49]", "(49,54]", "(54,59]", "(59,64]", 
                                   "(64,69]", "(69,74]", "(74,79]", "(79,100]")  ,   
                     c("0-4", "5-9", "10-14", "15-19", 
                       "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", 
                       "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80 Y MÁS"
                     ) )

defd <- data.table(defd)

defd$Grupo <-  defd$Grupob

defe <- defd[is.na(Edadg) == F, list(tdef = sum(N)), 
             keyby = list( SEXO,   anio,     Grupo, Edadg) ]
defe$SEXO <- as.numeric(defe$SEXO)

dcb <- merge(defe, mbd, by = c("SEXO" ,     "anio" ,  "Edadg") )

#pr <-dcb[,sum(pob), keyby = list(anio,     Grupo)]
dcb[, tesp := tdef / pob ]

dcb$edadcl <- factor(dcb$Edadg, lev =  c("0-4", "5-9", "10-14", "15-19", 
                                         "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  
                                         "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80 Y MÁS"     ) ,
                     labels = c(seq(2.5, 77.5, 5), 90) )

dcb$edadcl <- as.numeric(as.character(dcb$edadcl) )


defev <- defd[is.na(Edadg) == F, list(tdef = sum(N)), 
              keyby = list( SEXO,   anio,      Edadg) ]
defev$SEXO <- as.numeric(defev$SEXO)

dcbv <- merge(defev, mbd, by = c("SEXO" ,     "anio" ,  "Edadg") )

#pr <-dcb[,sum(pob), keyby = list(anio,     Grupo)]
dcbv[, tespt := tdef / pob ]

dcbv$edadcl <- factor(dcbv$Edadg,  lev =  c("0-4", "5-9", "10-14", "15-19", 
                                            "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  
                                            "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80 Y MÁS"     ) ,
                      labels = c(seq(2.5, 77.5, 5), 90) )

dcbv$edadcl <- as.numeric(as.character(dcbv$edadcl) )

dcbv <- dcbv[, Grupo := 'Total'][,c("Edadg", "anio", "SEXO","Grupo",  "tdef", "variable", "pob", "sexo", 
                                    "tespt", "edadcl"), with = F]

mdcb <- 
  dcb[, c('Edadg' , 'anio', 'Grupo', 'sexo' , 'tesp'), with = F] %>% 
  dcast( Edadg + anio + Grupo  ~  sexo  , value.var = 'tesp', fun=mean) %>%
  setnames(4:5, c( 'EspH', 'EspM'))

mdcbv <- 
  dcbv[, c('Edadg' , 'anio','Grupo', 'sexo' , 'tespt'), with = F] %>% 
  dcast( Edadg + anio + Grupo  ~  sexo  , value.var = 'tespt', fun=mean) %>%
  setnames(4:5, c( 'TotH', 'TotM'))

df <- 
  merge(mdcbv, mdcb, by = c("Edadg", "anio")) %>% filter(anio %in% seq(1987, 2007, 5) )


mah <- fread('tvhombres.csv')
mam <- fread('tvmujeres.csv')

mah$sexo <- "H" ; mam$sexo <- "M"

setnames(mah, c(3, 8, 9, 11, 13, 14, 15, 18, 19) , c( "region", "Edad","Intervalo", 'qxn', 
                                                      "lx", "dxn" , "Lxn", "ex", "axn")) 

setnames(mam, c(3, 8, 9, 11, 13, 14, 15, 18, 19) , c( "region", "Edad","Intervalo", 'qxn', 
                                                      "lx", "dxn" , "Lxn", "ex", "axn")) 

ma <- merge(mam, mah,  by = c("region", "Codigo","Period", "Edad")  )
ma <- data.table(ma)

mas <- ma[Edad  %in%  seq(0, 80, 5)  ,
          c("region", "Codigo","Period", "Edad", "lx.x", "lx.y" , "ex.x" ,  "ex.y",
            "sexo.x", "sexo.y") , with = F]

mas$clasep <- factor(mas$Period, levels = c("1950-1955", "1955-1960", "1960-1965", 
                                            "1965-1970", "1970-1975", "1975-1980", "1980-1985", "1985-1990", 
                                            "1990-1995", "1995-2000", "2000-2005", "2005-2010"),
                     labels = seq(1952.5, 2007.5, 5) )

mas[ , lxad.x := c( lx.x[2:length(lx.x)] , 0  ) , keyby = list(region, Codigo, Period ) ]
mas[ , exad.x := c( ex.x[2:length(ex.x)] , 0  ) , keyby = list(region, Codigo, Period ) ]
mas[ , lxad.y := c( lx.y[2:length(lx.y)] , 0  ) , keyby = list(region, Codigo, Period ) ]
mas[ , exad.y := c( ex.y[2:length(ex.y)] , 0  ) , keyby = list(region, Codigo, Period ) ]

mas[, arria3.tot := (lx.y + lx.x) * (ex.x - ex.y) / (2 * 100000) - 
      (lxad.y + lxad.x) * (exad.x - exad.y) / (2 * 100000)  ]

a <- mas[,  list(  sum(arria3.tot) ),     keyby = list(region, Codigo, Period ) ]
b <- mas[Edad == 0, c('region', 'Codigo', 'Period',  'ex.x','ex.y' ) , with = F][
  , dif := ex.x - ex.y]
c <- merge(a, b, by = c('region', 'Codigo', 'Period')   )

mass <- mas[ Codigo %in% c("CO") & Period %in% c("1985-1990", "1990-1995", "1995-2000", 
                                                 "2000-2005", "2005-2010")]

dput(mass[Edad == 0 & Period == '2005-2010', ][order(ex.x -ex.y), ][,"Codigo", with = F])


mass$Edadg <- recode(mass$Edad, " 0 = '0-4'; 5 = '5-9'; 10 = '10-14'; 15 = '15-19' ; 
                     20 = '20-24'; 25 = '25-29'; 30 = '30-34'; 35 = '35-39'; 40 = '40-44'; 45 = '45-49'; 
                     50 = '50-54'; 55 = '55-59'; 60 = '60-64'; 65 = '65-69'; 70 = '70-74'; 75 = '75-79'; 80 = '80 Y MÁS'"   )

mass$clasep <- as.numeric(as.character(mass$clasep))

mass$anio <- recode(mass$Period , "  '1985-1990' = 1987; '1990-1995' = 1992; '1995-2000' = 1997; 
                    '2000-2005' = 2002; '2005-2010' = 2007  " )

bf <- merge(mass, df , by = c('Edadg' , 'anio'))

bf[is.na(EspH) == T]$EspH <- 0

bf <- bf[, ContCaus := (EspH - EspM) * arria3.tot / (TotH - TotM )][
  Period %in% c("1985-1990",  "1995-2000",  "2005-2010")]

sizet <-11

p <- ggplot() + geom_blank( data = bf[] , aes(Edadg, ContCaus) ) +  theme_bw()  +
  geom_bar( data = bf[ ContCaus > 0] , 
            aes(Edadg, ContCaus,  fill = Grupo.y), stat= 'Identity',
            position = 'stack', width = .75 ) + 
  geom_bar( data = bf[ ContCaus < 0] , 
            aes(Edadg, ContCaus,  fill = Grupo.y), stat= 'Identity',
            position = 'stack', width = .75 ) + 
  scale_fill_manual(name = '', values = c('#33a02c', '#b2df8a','#1f78b4', '#a6cee3', '#fb9a99','#e31a1c',
                                     '#fdbf6f','#ff7f00','#cab2d6','#6a3d9a','#b15928'  ) ) + 
  facet_wrap( ~ Period, nrow = 1)  + 
  theme(strip.background = element_rect(fill="white"), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.title = element_text(size = sizet + 1, family="Helvetica", face = 'plain'),
        legend.text = element_text(size = sizet, family="Helvetica"),
        strip.text = element_text(size = sizet + 1) ,
        panel.margin = unit(0, "lines"), legend.position="bottom",
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.ticks.x = element_blank()) +
  xlab('Edad') + ylab('Contribución') +
  geom_hline(yintercept = 0, colour = 'gray') + 
  guides(fill=guide_legend(nrow = 4, byrow = TRUE))



grid.newpage()
pdf(file = "contrcausasbrechasexo.pdf",  width = 8,  height = 7, family = "Helvetica")
print(p)
dev.off()




bf[  , sum(ContCaus, na.rm = T), keyby = .(anio)]

bf[  , sum(ContCaus, na.rm = T), keyby = .(anio, Grupo.y)] %>% 
  dcast(     Grupo.y    ~anio     ,   value.var=   'V1') %>%
  setnames(2:4, c('a1987', 'a1997', 'a2007')) %>%
arrange(a2007)

bf[Grupo.y   == 'Causas externas' & Edadg %in% c('15-19', '20-24', '25-29',
                                                 '30-34', '35-39' )][ 
  , sum(ContCaus, na.rm = T), keyby = .(anio, Grupo.y)]


(bf[Grupo.y   == 'Maternales y perinatales' &
     Edadg %in% c('0-4' )][ 
       , sum(ContCaus, na.rm = T), keyby = .(anio, Grupo.y)][
         , cd := V1 * 365][, cm := V1 * 12])



(bf[Grupo.y   != 'Causas externas' &
      Edadg %in% c('0-4' )][ 
        , sum(ContCaus, na.rm = T), keyby = .(anio)][
          , cd := V1 * 365][, cm := V1 * 12])

(bf[Grupo.y   == 'Tumores' &
     Edadg %in% c("35-39", "40-44", "45-49", "50-54", "55-59" )][ 
       , sum(ContCaus, na.rm = T), keyby = .(anio)][
         , cd := V1 * 365][, cm := V1 * 12])


(bf[Grupo.y   == 'Tumores' &
      Edadg %in% c("60-64", "65-69", "70-74", "75-79", "80 Y MÁS")][ 
        , sum(ContCaus, na.rm = T), keyby = .(anio)][
          , cd := V1 * 365][, cm := V1 * 12])


(bf[Grupo.y   == 'Aparato circulatorio'][ 
        , sum(ContCaus, na.rm = T), keyby = .(anio)][
          , cd := V1 * 365][, cm := V1 * 12])

(bf[Grupo.y   == 'Aparato circulatorio' &
      Edadg %in% c("60-64", "65-69", "70-74", "75-79", "80 Y MÁS")][ 
        , sum(ContCaus, na.rm = T), keyby = .(anio)][
          , cd := V1 * 365][, cm := V1 * 12])


t1 <- bf[Period == '1985-1990' & Edad < 45] %>%
  mutate( ContCausm = round(ContCaus, 4)* 100) %>%
  dcast(Grupo.y~Edadg, value.var = 'ContCausm') 

print(xtable(t1,  booktabs = TRUE, digits = 2), 
include.rownames=FALSE, hline.after = NULL)


t1 <- bf[Period == '1985-1990' & Edad > 44] %>%
  mutate( ContCausm = round(ContCaus, 4)* 100) %>%
  dcast(Grupo.y~Edadg, value.var = 'ContCausm') 

print(xtable(t1,  booktabs = TRUE, digits = 2), 
      include.rownames=FALSE, hline.after = NULL)




t1 <- bf[Period == '1985-1990' & Edad < 30] %>%
  mutate( ContCausm = round(ContCaus, 4)* 100) %>%
  dcast(Grupo.y~Edadg, value.var = 'ContCausm') 

print(xtable(t1,  booktabs = TRUE, digits = 2), 
      include.rownames=FALSE, hline.after = NULL)


t1 <- bf[Period == '1985-1990' & Edad > 29 & Edad < 60] %>%
  mutate( ContCausm = round(ContCaus, 4)* 100) %>%
  dcast(Grupo.y~Edadg, value.var = 'ContCausm') 

print(xtable(t1,  booktabs = TRUE, digits = 2), 
      include.rownames=FALSE, hline.after = NULL)


t1 <- bf[Period == '1985-1990' & Edad > 59] %>%
  mutate( ContCausm = round(ContCaus, 4)* 100) %>%
  dcast(Grupo.y~Edadg, value.var = 'ContCausm') 

print(xtable(t1,  booktabs = TRUE, digits = 2), 
      include.rownames=FALSE, hline.after = NULL)



t1 <- bf[Period == '2005-2010' & Edad < 30] %>%
  mutate( ContCausm = round(ContCaus, 4)* 100) %>%
  dcast(Grupo.y~Edadg, value.var = 'ContCausm') 

print(xtable(t1,  booktabs = TRUE, digits = 2), 
      include.rownames=FALSE, hline.after = NULL)


t1 <- bf[Period == '2005-2010' & Edad > 29 & Edad < 60] %>%
  mutate( ContCausm = round(ContCaus, 4)* 100) %>%
  dcast(Grupo.y~Edadg, value.var = 'ContCausm') 

print(xtable(t1,  booktabs = TRUE, digits = 2), 
      include.rownames=FALSE, hline.after = NULL)


t1 <- bf[Period == '2005-2010' & Edad > 59] %>%
  mutate( ContCausm = round(ContCaus, 4)* 100) %>%
  dcast(Grupo.y~Edadg, value.var = 'ContCausm') 

print(xtable(t1,  booktabs = TRUE, digits = 2), 
      include.rownames=FALSE, hline.after = NULL)




# brecha sexo causas especificas b-----------------------------------------

defd <- rbind(def,defb,defc)
cod <- read.xlsx2(file = "Lista_105_Colombia_CIE9-y-CIE10.xls",   1)
defd$CAU_HOMOL <- as.numeric(as.character(defd$CAU_HOMOL ))
cod$CAU_HOMOL <- as.numeric(as.character(cod$CAU_HOMOL ))

defd <- merge(defd, cod , by = 'CAU_HOMOL')

defd$Edadg <- cut(defd$EDAD, breaks =  c(-1,  4, seq(9, 79, 5), 100 ) )

dput(unique(defd$Edadg))
dput(unique(mbd$Edadg))

defd$Edadg <- factor(defd$Edadg, c("(-1,4]", 
                                   "(4,9]", "(9,14]", "(14,19]", "(19,24]", "(24,29]", "(29,34]", 
                                   "(34,39]", "(39,44]", "(44,49]", "(49,54]", "(54,59]", "(59,64]", 
                                   "(64,69]", "(69,74]", "(74,79]", "(79,100]")  ,   
                     c("0-4", "5-9", "10-14", "15-19", 
                       "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", 
                       "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80 Y MÁS"
                     ) )

defd <- data.table(defd)

defe <- defd[is.na(Edadg) == F, list(tdef = sum(N)), 
             keyby = list( SEXO,   anio,     Causa, Edadg) ]
defe$SEXO <- as.numeric(defe$SEXO)

dcb <- merge(defe, mbd, by = c("SEXO" ,     "anio" ,  "Edadg") )

#pr <-dcb[,sum(pob), keyby = list(anio,     Causa)]
dcb[, tesp := tdef / pob ]

dcb$edadcl <- factor(dcb$Edadg, lev =  c("0-4", "5-9", "10-14", "15-19", 
                                         "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  
                                         "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80 Y MÁS"     ) ,
                     labels = c(seq(2.5, 77.5, 5), 90) )

dcb$edadcl <- as.numeric(as.character(dcb$edadcl) )


defev <- defd[is.na(Edadg) == F, list(tdef = sum(N)), 
              keyby = list( SEXO,   anio,      Edadg) ]
defev$SEXO <- as.numeric(defev$SEXO)

dcbv <- merge(defev, mbd, by = c("SEXO" ,     "anio" ,  "Edadg") )

#pr <-dcb[,sum(pob), keyby = list(anio,     Causa)]
dcbv[, tespt := tdef / pob ]

dcbv$edadcl <- factor(dcbv$Edadg,  lev =  c("0-4", "5-9", "10-14", "15-19", 
                                            "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  
                                            "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80 Y MÁS"     ) ,
                      labels = c(seq(2.5, 77.5, 5), 90) )

dcbv$edadcl <- as.numeric(as.character(dcbv$edadcl) )

dcbv <- dcbv[, Causa := 'Total'][,c("Edadg", "anio", "SEXO","Causa",  "tdef", "variable", "pob", "sexo", 
                                    "tespt", "edadcl"), with = F]

mdcb <- 
  dcb[, c('Edadg' , 'anio', 'Causa', 'sexo' , 'tesp'), with = F] %>% 
  dcast( Edadg + anio + Causa  ~  sexo  , value.var = 'tesp', fun=mean) %>%
  setnames(4:5, c( 'EspH', 'EspM'))

mdcbv <- 
  dcbv[, c('Edadg' , 'anio','Causa', 'sexo' , 'tespt'), with = F] %>% 
  dcast( Edadg + anio + Causa  ~  sexo  , value.var = 'tespt', fun=mean) %>%
  setnames(4:5, c( 'TotH', 'TotM'))

df <- 
  merge(mdcbv, mdcb, by = c("Edadg", "anio")) %>% filter(anio %in% seq(1987, 2007, 5) )


mah <- fread('mortadulthom.csv')
mam <- fread('mortadultmuj.csv')

mah$sexo <- "H" ; mam$sexo <- "M"

setnames(mah, c(3, 8, 9, 11, 13, 14, 15, 18, 19) , c( "region", "Edad","Intervalo", 'qxn', 
                                                      "lx", "dxn" , "Lxn", "ex", "axn")) 

setnames(mam, c(3, 8, 9, 11, 13, 14, 15, 18, 19) , c( "region", "Edad","Intervalo", 'qxn', 
                                                      "lx", "dxn" , "Lxn", "ex", "axn")) 

ma <- merge(mam, mah,  by = c("region", "Codigo","Period", "Edad")  )
ma <- data.table(ma)

mas <- ma[Edad  %in%  seq(0, 80, 5)  ,
          c("region", "Codigo","Period", "Edad", "lx.x", "lx.y" , "ex.x" ,  "ex.y",
            "sexo.x", "sexo.y") , with = F]

mas$clasep <- factor(mas$Period, levels = c("1950-1955", "1955-1960", "1960-1965", 
                                            "1965-1970", "1970-1975", "1975-1980", "1980-1985", "1985-1990", 
                                            "1990-1995", "1995-2000", "2000-2005", "2005-2010"),
                     labels = seq(1952.5, 2007.5, 5) )

mas[ , lxad.x := c( lx.x[2:length(lx.x)] , 0  ) , keyby = list(region, Codigo, Period ) ]
mas[ , exad.x := c( ex.x[2:length(ex.x)] , 0  ) , keyby = list(region, Codigo, Period ) ]
mas[ , lxad.y := c( lx.y[2:length(lx.y)] , 0  ) , keyby = list(region, Codigo, Period ) ]
mas[ , exad.y := c( ex.y[2:length(ex.y)] , 0  ) , keyby = list(region, Codigo, Period ) ]

mas[, arria3.tot := (lx.y + lx.x) * (ex.x - ex.y) / (2 * 100000) - 
      (lxad.y + lxad.x) * (exad.x - exad.y) / (2 * 100000)  ]

a <- mas[,  list(  sum(arria3.tot) ),     keyby = list(region, Codigo, Period ) ]
b <- mas[Edad == 0, c('region', 'Codigo', 'Period',  'ex.x','ex.y' ) , with = F][
  , dif := ex.x - ex.y]
c <- merge(a, b, by = c('region', 'Codigo', 'Period')   )

mass <- mas[ Codigo %in% c("CO") & Period %in% c("1985-1990", "1990-1995", "1995-2000", 
                                                 "2000-2005", "2005-2010")]

dput(mass[Edad == 0 & Period == '2005-2010', ][order(ex.x -ex.y), ][,"Codigo", with = F])


mass$Edadg <- recode(mass$Edad, " 0 = '0-4'; 5 = '5-9'; 10 = '10-14'; 15 = '15-19' ; 
                     20 = '20-24'; 25 = '25-29'; 30 = '30-34'; 35 = '35-39'; 40 = '40-44'; 45 = '45-49'; 
                     50 = '50-54'; 55 = '55-59'; 60 = '60-64'; 65 = '65-69'; 70 = '70-74'; 75 = '75-79'; 80 = '80 Y MÁS'"   )

mass$clasep <- as.numeric(as.character(mass$clasep))

mass$anio <- recode(mass$Period , "  '1985-1990' = 1987; '1990-1995' = 1992; '1995-2000' = 1997; 
                    '2000-2005' = 2002; '2005-2010' = 2007  " )

bf <- merge(mass, df , by = c('Edadg' , 'anio'))

bf <- bf[, ContCaus := (EspH - EspM) * arria3.tot / (TotH - TotM )][
  Period %in% c("1985-1990",  "1995-2000",  "2005-2010")]

sizet <-11

p <- ggplot() + geom_blank( data = bf[] , aes(Edadg, ContCaus) ) +  theme_bw()  +
  geom_bar( data = bf[ ContCaus > 0] , 
            aes(Edadg, ContCaus,  fill = Causa.y), stat= 'Identity',
            position = 'stack', width = .75 ) + 
  geom_bar( data = bf[ ContCaus < 0] , 
            aes(Edadg, ContCaus,  fill = Causa.y), stat= 'Identity',
            position = 'stack', width = .75 ) + 
  scale_fill_manual(name = '', values = c('#33a02c', '#b2df8a','#1f78b4', '#a6cee3', '#fb9a99','#e31a1c',
                                          '#fdbf6f','#ff7f00','#cab2d6','#6a3d9a','#b15928'  ) ) + 
  facet_wrap( ~ Period, nrow = 1)  + 
  theme(strip.background = element_rect(fill="white"), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.title = element_text(size = sizet + 1, family="Helvetica", face = 'plain'),
        legend.text = element_text(size = sizet, family="Helvetica"),
        strip.text = element_text(size = sizet + 1) ,
        panel.margin = unit(0, "lines"), legend.position="bottom",
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.ticks.x = element_blank()) +
  xlab('Edad') + ylab('Contribución') +
  geom_hline(yintercept = 0, colour = 'gray') + 
  guides(fill=guide_legend(nrow = 4, byrow = TRUE))



# grid.newpage()
# pdf(file = "contrcausasbrechasexo.pdf",  width = 8,  height = 7, family = "Helvetica")
# print(p)
# dev.off()




bf[  , sum(ContCaus, na.rm = T), keyby = .(anio)]

prc <- bf[  , round(sum(ContCaus, na.rm = T), 2), keyby = .(anio, Causa.y)] %>% 
  dcast(     Causa.y    ~anio     ,   value.var=   'V1') %>%
  setnames(2:4, c('a1987', 'a1997', 'a2007')) %>%
  arrange(a2007)

bf[Causa.y == 'Homicidios' & Edadg %in% c("15-19", "20-24", 
                                          "25-29", "30-34", "35-39")][
  , c( 'Edadg', 'anio', 'ContCaus'), with = FALSE][
    , sum(ContCaus), keyby = .(anio)]



bf[Causa.y == 'Homicidios' & Edadg %in% c("15-19", "20-24", 
                                          "25-29", "30-34", "35-39")][
                                            , c( 'Edadg', 'anio', 'ContCaus'), with = FALSE][
                                              , sum(ContCaus), keyby = .(anio)]

bf[Causa.y == 'Homicidios' & Edadg %in% c("40-44", "45-49", "50-54", "55-59", 
                                          "60-64")][
                                            , c( 'Edadg', 'anio', 'ContCaus'), with = FALSE][
                                              , sum(ContCaus), keyby = .(anio)]

bf[Causa.y == 'Accidentes de transporte de motor' & Edadg %in% c("15-19", "20-24", 
                                          "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", 
                                          "60-64")][
                                            , c( 'Edadg', 'anio', 'ContCaus'), with = FALSE][
                                              , sum(ContCaus), keyby = .(anio)]



#*** COL ANALISIS TERRITORIAL ***------------------------------------------------

# # COL E0 micromapas ------------------------------------------------------------

colm <- readOGR("co.shp", layer = "co", verbose = TRUE, stringsAsFactors = FALSE)
pds <- fortify(colm, region = 'FIPS_ADMIN')
#plot(colm)


tv <- fread('tv.proy.col.csv',  header = TRUE)

tv$clasep <- recode(tv$Periodo, " '1985 a 1990' = 1987.5; '1990 a 1995' = 1992.5; 
                    '1995 a 2000' = 1997.5; '2000 a 2005' = 2002.5; 
                    '2005 a 2010' = 2007.5; '2010 a 2015' = 2012.5; '2015 a 2020' = 2017.5   ")

tv$DPTO <- factor(tv$DPTO, c("5", "81", "8", "11", "13", "15", "17", "18", "85", "19", "20", 
                             "27", "23", "25", "91", "41", "44", "47", "50", "#N/A", "52", 
                             "54", "86", "63", "66", "88", "68", "70", "73", "76", 
                             "95", "97", "99", "94"),
                  c("05", "81", "08", "11", "13", "15", "17", "18", "85", "19", "20", 
                    "27", "23", "25", "91", "41", "44", "47", "50", "#N/A", "52", 
                    "54", "86", "63", "66", "88", "68", "70", "73", "76",  
                    "95", "97", "99", "94"))

tvh <- tv[Periodo %in% c('1985 a 1990' , '2005 a 2010') & Dep != 'Colombia' & 
            Sexo == 'Hombres' & edad == 0]

dtvh <- dcast(tvh, DPTO +  Depb  + Depc + fips
              ~ Periodo, value.var = 'ex')

row.names(dtvh) <- dtvh$DPTO
dtvh <- data.frame(dtvh)

colp <- create_map_table(colm, 'FIPS_ADMIN')

p1 <- 
  mmplot(stat.data = dtvh,
         map.data = colp , median.text.label="Mediana",
         panel.types = c('labels', 'dot', 'map'),
         panel.data = list('Depb','X1985.a.1990', NA),
         colors = c("#e41a1c","#ff7f00","#4daf4a","#377eb8", '#984ea3', '#ffff33', '#a65628', '#f781bf'),       
         ord.by ='X1985.a.1990', rev.ord=T,   
         grouping =  8, median.row=T, plot.height = 10, plot.width = 4,
         map.link = c('fips',  'ID'),
         panel.att=list(list(1,  header='Departamentos'),
                        list(2, header='Esperanza de vida\n1985 a 1990' , point.size=1.5 ),
                        list(3, header='Cuartiles\n (Acumulativo)') ))  

p2 <- 
  mmplot(stat.data = dtvh,
         map.data = colp , median.text.label="Mediana",
         panel.types = c('labels', 'dot', 'map'),
         panel.data = list('Depb','X2005.a.2010', NA),
         colors = c("#e41a1c","#ff7f00","#4daf4a","#377eb8", '#984ea3', '#ffff33', '#a65628', '#f781bf'),       
         ord.by ='X2005.a.2010', rev.ord=T,   
         grouping =  8, median.row=T, plot.height = 10, plot.width = 4,
         map.link = c('fips',  'ID'),
         panel.att=list(list(1,  header='Departamentos'),
                        list(2, header='Esperanza de vida\n2005 a 2010' , point.size=1.5 ),
                        list(3, header='Cuartiles\n (Acumulativo)') ))  


print(p1, name= "prmic.png", res=300)
print(p2, name= "prmicb.png", res=300)


tvm <- tv[Periodo %in% c('1985 a 1990' , '2005 a 2010') & Dep != 'Colombia' & 
            Sexo == 'Mujeres' & edad == 0]

dtvm <- dcast(tvm, DPTO +  Depb  + fips
              ~ Periodo, value.var = 'ex')

row.names(dtvm) <- dtvm$DPTO
dtvm <- data.frame(dtvm)

colp <- create_map_table(colm, 'FIPS_ADMIN')

p1 <- 
  mmplot(stat.data = dtvm,
         map.data = colp , median.text.label="Mediana",
         panel.types = c('labels', 'dot', 'map'),
         panel.data = list('Depb','X1985.a.1990', NA),
         colors = c("#e41a1c","#ff7f00","#4daf4a","#377eb8", '#984ea3', '#ffff33', '#a65628', '#f781bf'),       
         ord.by ='X1985.a.1990', rev.ord=T,   
         grouping =  8, median.row=T, plot.height = 10, plot.width = 4,
         map.link = c('fips',  'ID'),
         panel.att=list(list(1,  header='Departamentos'),
                        list(2, header='Esperanza de vida\n1985 a 1990' , point.size=1.5 ),
                        list(3, header='Cuartiles\n (Acumulativo)') ))  

p2 <- 
  mmplot(stat.data = dtvm,
         map.data = colp , median.text.label="Mediana",
         panel.types = c('labels', 'dot', 'map'),
         panel.data = list('Depb','X2005.a.2010', NA),
         colors = c("#e41a1c","#ff7f00","#4daf4a","#377eb8", '#984ea3', '#ffff33', '#a65628', '#f781bf'),       
         ord.by ='X2005.a.2010', rev.ord=T,   
         grouping =  8, median.row=T, plot.height = 10, plot.width = 4,
         map.link = c('fips',  'ID'),
         panel.att=list(list(1,  header='Departamentos'),
                        list(2, header='Esperanza de vida\n2005 a 2010' , point.size=1.5 ),
                        list(3, header='Cuartiles\n (Acumulativo)') ))  


print(p1, name= "prmicm.png", res=300)
print(p2, name= "prmicmb.png", res=300)



# # COL dep brecha sexo e0 -------------------------------------------------------------

tv <- fread('tv.proy.col.csv',  header = TRUE)

tv$clasep <- recode(tv$Periodo, " '1985 a 1990' = 1987.5; '1990 a 1995' = 1992.5; 
                    '1995 a 2000' = 1997.5; '2000 a 2005' = 2002.5; 
                    '2005 a 2010' = 2007.5; '2010 a 2015' = 2012.5; '2015 a 2020' = 2017.5   ")

tve0 <- tv[edad == 0 & Periodo %in% c('1985 a 1990', '1995 a 2000', '2005 a 2010') &
             Depb %in%  c("ANT", "ARA", "ATL", "BOG", "BOL", "BOY", "CAL", "CAQ", "CAS", 
                          "CAU", "CES", "CHO", "COR", "CUN", "AMA", "HUI", "LAG", "MAG", 
                          "MET",  "NAR", "NSA", "PUT", "QUI", "RIS", "SAP", "SAN", 
                          "SUC", "TOL", "VAC")]

tvd <- dcast.data.table(tve0, DPTO +  Depb  + fips +  Periodo  ~ Sexo, value.var = 'ex'  )

tvd$Dif <- tvd$Mujeres - tvd$Hombres 

tvd$Periodo <- factor(tvd$Periodo, levels = c("1985 a 1990", "1995 a 2000", "2005 a 2010"),
                      labels = c("85/90", "95/00", "05/10"))

sizet <- 14

# Normalize coordinates to maintain constant aspect ratio
x.fact <- 100 / max(tvd$Hombres)
y.fact <- 100 / max(tvd$Dif)

# Repel points
coords <-   FFieldPtRep(coords = cbind(tvd$Hombres * x.fact,    tvd$Dif * y.fact),
                        rep.fact = 1)

# Convert back to plot coordinates
x.t <- coords$x / x.fact
y.t <- coords$y / y.fact

scatter <- ggplot(data = tvd,  aes( Hombres, Dif, colour = Periodo, label = tvd$Depb ) ) +
  theme_bw(base_size =  sizet) +
  #geom_point(size = 1) + geom_segment(data = tvd, aes(xend = x.t,  yend = y.t)) + 
  geom_text(aes(x = x.t, y = y.t, size = Periodo )  ) +
  scale_size_manual(values= c(3, 3.5, 4)) + 
  scale_colour_manual(name = 'Periodo', values = c('#bdbdbd', '#ec7014' ,'#54278f')) +
  scale_y_continuous(lim = c(2.6, 12.6) ) +
  scale_x_continuous(breaks = seq(50, 75, 5), lim = c(50, 75) )  + 
  ylab('Diferencia entre sexos') +
  xlab('Esperanza de vida de los hombres') +
  theme(axis.text.x = element_text( size = sizet, family = "Helvetica"),
        axis.text.y = element_text(size = sizet, family = "Helvetica"),  
        axis.title.x = element_text(vjust = -1, size = sizet + 2, family = "Helvetica"),
        panel.margin = unit(0, "lines"),
        axis.title.y = element_text(size = sizet + 2 , family = "Helvetica")) +
  guides(colour = FALSE, size = F)

#marginal density of x - plot on top
plot_top <- ggplot(tvd, aes(  Periodo, Hombres, colour = Periodo)) + 
  geom_boxplot() + coord_flip( ) +
  theme_bw(base_size = sizet) +
  theme(axis.title.x = element_blank()) +
  scale_colour_manual(values = c('#bdbdbd', '#ec7014' ,'#54278f')) + 
  #scale_y_continuous(lim = c(0,.12), breaks = c(.03,.06,.09, .12) ) +
  scale_y_continuous(breaks = seq(50, 75, 5), lim = c(50, 75) ) +
  theme(legend.position = "", 
        axis.text.x = element_text(size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet + 2, family="Helvetica"),
        panel.margin = unit(0, "lines"),
        axis.title.y = element_text(vjust = 1, size = sizet + 2, family="Helvetica"))  + 
  ylab('') + xlab('Periodo')

#marginal density of y - plot on the right
plot_right <- ggplot(tvd, aes(Periodo, Dif, colour = Periodo)) + 
  geom_boxplot() + 
  theme_bw(base_size = sizet) + 
  theme(axis.title.y = element_blank()) +
  scale_colour_manual(name = '', values = c('#bdbdbd', '#ec7014' ,'#54278f')) + 
  # scale_x_continuous(breaks = seq(3, 14, 1) ) +
  scale_y_continuous( lim = c(2.6, 12.6) ) +
  theme( axis.text.x = element_text(size = sizet, family="Helvetica"),
         axis.text.y = element_text(size = sizet, family="Helvetica"),  
         axis.title.x = element_text(vjust = -1, size = sizet+ 2, family="Helvetica"),
         axis.title.y = element_text(size = sizet+ 2, family="Helvetica"),
         legend.position = '',
         panel.margin = unit(0, "lines") )  + 
  xlab('Periodo') + ylab('')

#placeholder plot - prints nothing at all
empty <-  ggplot(tvd, aes(Periodo, Dif, colour = Periodo))  + geom_blank( ) +
  theme(                              
    plot.background = element_blank(), 
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    panel.margin = unit(0, "lines"),
    legend.position = c(.5,.5)
  )

gA <- ggplotGrob(plot_top)
gB <- ggplotGrob(direct.label(scatter, "extreme.grid"))
maxWidth = grid::unit.pmax(gA$widths[2:5], gB$widths[2:5])
gA$widths[2:5] <- as.list(maxWidth)
gB$widths[2:5] <- as.list(maxWidth)

gC <- ggplotGrob(plot_right)
maxheights = grid::unit.pmax(gC$heights[2:5], gB$heights[2:5])
gC$heights[2:5] <- as.list(maxheights)
gB$heights[2:5] <- as.list(maxheights)


#arrange the plots together, with appropriate height and width for each row and column

pdf(file = "brechdepcol.pdf",    width = 11,   height = 8, family = "Helvetica")
grid.arrange(gA,       empty,        gB, gC  , ncol = 2, nrow = 2,
             widths = c( 3.8, 1.2), heights = c(1.4, 3.6) )
dev.off()



# # COL q0 micromapas ------------------------------------------------------------

colm <- readOGR("co.shp", layer = "co", verbose = TRUE, stringsAsFactors = FALSE)
pds <- fortify(colm, region = 'FIPS_ADMIN')
#plot(colm)


tv <- fread('tv.proy.col.csv',  header = TRUE)

tv$clasep <- recode(tv$Periodo, " '1985 a 1990' = 1987.5; '1990 a 1995' = 1992.5; 
                    '1995 a 2000' = 1997.5; '2000 a 2005' = 2002.5; 
                    '2005 a 2010' = 2007.5; '2010 a 2015' = 2012.5; '2015 a 2020' = 2017.5   ")

tv$DPTO <- factor(tv$DPTO, c("5", "81", "8", "11", "13", "15", "17", "18", "85", "19", "20", 
                             "27", "23", "25", "91", "41", "44", "47", "50", "#N/A", "52", 
                             "54", "86", "63", "66", "88", "68", "70", "73", "76", 
                             "95", "97", "99", "94"),
                  c("05", "81", "08", "11", "13", "15", "17", "18", "85", "19", "20", 
                    "27", "23", "25", "91", "41", "44", "47", "50", "#N/A", "52", 
                    "54", "86", "63", "66", "88", "68", "70", "73", "76",  
                    "95", "97", "99", "94"))

tvh <- tv[Periodo %in% c('1985 a 1990', '2005 a 2010') & Dep != 'Colombia' & 
            Sexo == 'Hombres' & edad == 0]

dtvh <- dcast(tvh, DPTO +  Depb  + Depc + fips
              ~ Periodo, value.var = 'qx')

row.names(dtvh) <- dtvh$DPTO
dtvh <- data.frame(dtvh)

colp <- create_map_table(colm, 'FIPS_ADMIN')

p1 <- 
  mmplot(stat.data = dtvh,
         map.data = colp , median.text.label="Mediana",
         panel.types = c('labels', 'dot', 'map'),
         panel.data = list('Depb','X1985.a.1990', NA),
         colors = c("#e41a1c","#ff7f00","#4daf4a","#377eb8", '#984ea3', '#ffff33', '#a65628', '#f781bf'),       
         ord.by ='X1985.a.1990', rev.ord=T,   
         grouping =  8, median.row=T, plot.height = 10, plot.width = 4,
         map.link = c('fips',  'ID'),
         panel.att=list(list(1,  header='Departamentos'),
                        list(2, header='Mortalidad infantil\n1985 a 1990' , point.size=1.5 ),
                        list(3, header='Cuartiles\n (Acumulativo)') ))  

p2 <- 
  mmplot(stat.data = dtvh,
         map.data = colp , median.text.label="Mediana",
         panel.types = c('labels', 'dot', 'map'),
         panel.data = list('Depb','X2005.a.2010', NA),
         colors = c("#e41a1c","#ff7f00","#4daf4a","#377eb8", '#984ea3', '#ffff33', '#a65628', '#f781bf'),       
         ord.by ='X2005.a.2010', rev.ord=T,   
         grouping =  8, median.row=T, plot.height = 10, plot.width = 4,
         map.link = c('fips',  'ID'),
         panel.att=list(list(1,  header='Departamentos'),
                        list(2, header='Mortalidad infantil\n2005 a 2010' , point.size=1.5 ),
                        list(3, header='Cuartiles\n (Acumulativo)') ))  


print(p1, name= "colminf1.png", res=300)
print(p2, name= "colminf2.png", res=300)


tvm <- tv[Periodo %in% c('1985 a 1990', '2005 a 2010') & Dep != 'Colombia' & 
            Sexo == 'Mujeres' & edad == 0]

dtvm <- dcast(tvm, DPTO +  Depb  + Depc + fips
              ~ Periodo, value.var = 'qx')

row.names(dtvm) <- dtvm$DPTO
dtvm <- data.frame(dtvm)

colp <- create_map_table(colm, 'FIPS_ADMIN')

p1 <- 
  mmplot(stat.data = dtvm,
         map.data = colp , median.text.label="Mediana",
         panel.types = c('labels', 'dot', 'map'),
         panel.data = list('Depb','X1985.a.1990', NA),
         colors = c("#e41a1c","#ff7f00","#4daf4a","#377eb8", '#984ea3', '#ffff33', '#a65628', '#f781bf'),       
         ord.by ='X1985.a.1990', rev.ord=T,   
         grouping =  8, median.row=T, plot.height = 10, plot.width = 4,
         map.link = c('fips',  'ID'),
         panel.att=list(list(1,  header='Departamentos'),
                        list(2, header='Mortalidad infantil\n1985 a 1990' , point.size=1.5 ),
                        list(3, header='Cuartiles\n (Acumulativo)') ))  

p2 <- 
  mmplot(stat.data = dtvm,
         map.data = colp , median.text.label="Mediana",
         panel.types = c('labels', 'dot', 'map'),
         panel.data = list('Depb','X2005.a.2010', NA),
         colors = c("#e41a1c","#ff7f00","#4daf4a","#377eb8", '#984ea3', '#ffff33', '#a65628', '#f781bf'),       
         ord.by ='X2005.a.2010', rev.ord=T,   
         grouping =  8, median.row=T, plot.height = 10, plot.width = 4,
         map.link = c('fips',  'ID'),
         panel.att=list(list(1,  header='Departamentos'),
                        list(2, header='Mortalidad infantil\n2005 a 2010' , point.size=1.5 ),
                        list(3, header='Cuartiles\n (Acumulativo)') ))  


print(p1, name= "colminf1b.png", res=300)
print(p2, name= "colminf2b.png", res=300)




# sobremortalidad 2 ------------------------------------------------------------------

colm <- readOGR("deptovl.shp", layer = "deptovl", verbose = TRUE, stringsAsFactors = FALSE)
pds <- fortify(colm, region = "DPTO")


tv <- fread('tv.proy.col.csv',  header = TRUE)

tv$clasep <- recode(tv$Periodo, " '1985 a 1990' = 1987.5; '1990 a 1995' = 1992.5; 
                    '1995 a 2000' = 1997.5; '2000 a 2005' = 2002.5; 
                    '2005 a 2010' = 2007.5; '2010 a 2015' = 2012.5; '2015 a 2020' = 2017.5   ")

tvd <- dcast.data.table(tv, DPTO + Dep +  Periodo + edad + edadm ~ Sexo, 
                        value.var = 'qx', fun=mean  )



dput(unique( tvd[edadm == 22.5 & Periodo == "2005 a 2010" ][
  , sm := Hombres / Mujeres][order(sm)][  , 'Dep', with = F]))

dput(  tvd[Periodo == "2005 a 2010" ][ , sm := Hombres / Mujeres][
  ,list( edadm[which.max(sm)],  max(sm)  ) , keyby = list( Dep ,    Periodo )][
    order(V2)][  , 'Dep', with = F]   )

dput(  tvd[Periodo == "2005 a 2010" ][ , sm := Hombres / Mujeres][
  ,list( edadm[which.max(sm)],  max(sm)  ) , keyby = list(DPTO ,    Periodo )][
    order(V2)][  , 'DPTO', with = F]   )

tvd <- tvd[Dep != 'Colombia']

tvd$Dep <- factor( tvd$Dep, levels = rev( c("Bolívar", "Boyacá", "Atlántico", 
                                            "Cundinamarca", 
                                            "Bogotá", "Santander", "Cauca", 
                                            "Nariño", "Magdalena", "Tolima", 
                                            "Córdoba", "San Andrés", "Huila", 
                                            "Chocó", "Caquetá", 
                                            "Sucre", "Arauca", "Meta", 
                                            "Antioquia", "Quindío", "Putumayo", 
                                            "Amazonia", "Norte", "Casanare", 
                                            "Risaralda", "Cesar", "Valle", 
                                            "La Guajira", "Caldas") ) )

tvd$DPTO <- factor(tvd$DPTO, c("13", "15", "8", "25", "11", "68", "19", 
                               "52", "47", "73", "23", "88", "41",  "27", "18", "70", 
                               "81", "50", "5", "63", "86", "91", "94", "95", "97", "99", "54", 
                               "85", "66", "20", "76", "44", "17"),
                   c("13", "15", "08", "25", "11", "68", "19", 
                     "52", "47", "73", "23", "88", "41",  "27", "18", "70", 
                     "81", "50", "05", "63", "86", "91", "94", "95", "97", "99", "54", 
                     "85", "66", "20", "76", "44", "17"))




sizet <- 10

p <- 
  ggplot(tvd[is.na(edadm) == F & Periodo %in% c("1985 a 1990",    "2005 a 2010"        )], 
         aes(edadm , Hombres / Mujeres, colour = DPTO, linetype = Periodo) ) + 
  geom_vline(xintercept = seq(0, 80,  10), colour = '#EAEAEA', linetype = '22') + 
  geom_hline(yintercept = seq(0, 8, 2.5), colour = '#EAEAEA', linetype = '22') +
  geom_vline(xintercept = seq(0, 80,  20 ), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = seq(0, 8, 5), colour = '#E4E4E4', linetype = '22') +
#   geom_rect( aes(ymin = -Inf, ymax = Inf, xmin = 20, xmax = 30, fill =DPTO),    alpha = .02,
#              colour = 'white') +
  geom_line(size = 1) +
  # annotate(   'rect',  ymin = -Inf, ymax = Inf, xmin = 20, xmax = 30,    alpha = .15  ) +
  scale_colour_manual(values = rev(rep(c("#e41a1c","#377eb8",'#984ea3','#ff7f00','#a65628'), 7)) ) +
  scale_x_continuous(lim = c(0, 80), expand = c(.1, .1)) +
  scale_linetype_manual(values = c("11", "solid") ) +
  facet_wrap( ~ Dep, ncol = 5 ) + theme_bw(base_size = sizet) +
  xlab('Edad') + ylab(expression( paste(''[n], q[x]^H) / paste(''[n], q[x]^M)    )) +    
  theme(axis.text = element_text(size = sizet) ,
        axis.title = element_text(size = sizet) ,
        legend.text = element_text(size = sizet) ,
        legend.title = element_text(size = sizet) ,
        strip.background = element_rect(fill="white"), 
        panel.margin = unit(0, "lines"), 
        panel.grid = element_blank(),
        strip.text = element_text(size = sizet) ,
        legend.position = '') 


or <- tvd[,  unique(Dep) , keyby = .(DPTO)]

or$Dep <- factor( or$V1, levels = rev( c("Bolívar", "Boyacá", "Atlántico", 
                                         "Cundinamarca", 
                                         "Bogotá", "Santander", "Cauca", 
                                         "Nariño", "Magdalena", "Tolima", 
                                         "Córdoba", "San Andrés", "Huila", 
                                         "Chocó", "Caquetá", 
                                         "Sucre", "Arauca", "Meta", 
                                         "Antioquia", "Quindío", "Putumayo", 
                                         "Amazonia", "Norte", "Casanare", 
                                         "Risaralda", "Cesar", "Valle", 
                                         "La Guajira", "Caldas", "Colombia") ) )

or <- or[order(Dep)][, pGrp := c(rep(1, 5 ), rep(2, 9 ),  rep(3:6, each =5  )) ]

bdfa <- expand.grid(levels(or$DPTO), unique(or$pGrp)  )
setnames(bdfa, 1:2, c('DPTO','pGrp'))

bdfa$pGrp <- factor(bdfa$pGrp, 1:6, 
                    c('Grupo 1', 'Grupo 2','Grupo 3','Grupo 4','Grupo 5','Grupo 6') )
or$pGrp <- factor(or$pGrp, 1:6, 
                  c('Grupo 1', 'Grupo 2','Grupo 3','Grupo 4','Grupo 5','Grupo 6') )

p2 <- 
  ggplot() + coord_fixed() + 
  # guides(colour = F) + 
  expand_limits(x =  pds$long, y = pds$lat)  +
  geom_map(data = bdfa,  fill = 'white', colour = 'gray',
           map = pds, size = .2, aes(map_id = DPTO)) + 
  geom_map(data = or,  colour = 'gray', 
           map = pds, size = .2, aes(map_id = DPTO, fill = DPTO)) + 
  facet_wrap(   ~ pGrp, ncol = 1 ) + xlab("") + ylab("") + 
  scale_fill_manual(values = rev(rep(c("#e41a1c","#377eb8",'#984ea3','#ff7f00','#a65628'), 7)) ) +
    theme_tufte(base_size = sizet) +    
  theme(axis.text = element_blank(), legend.position = '',
        strip.background = element_rect(colour = 'white' , fill="white"), 
        strip.text = element_text(size = sizet, family="Helvetica") ,
        strip.text = element_blank(), panel.margin = unit(0, "lines"), 
        panel.grid.minor=element_blank(),  panel.grid.major=element_blank(), 
        legend.text = element_text(size = sizet - 2, family="Helvetica"),
        legend.title = element_text(size = sizet - 2, family="Helvetica", face = 'plain'),
        axis.ticks = element_blank())

gA <- ggplotGrob(p)
gB <- ggplotGrob(p2)
# maxheights = grid::unit.pmax(gA$heights[2:5], gB$heights[2:5])
# gA$heights[2:5] <- as.list(maxheights)
# gB$heights[2:5] <- as.list(maxheights)
# maxWidth = grid::unit.pmax(gA$widths[2:5], gB$widths[2:5])
# gA$widths[2:5] <- as.list(maxWidth)
# gB$widths[2:5] <- as.list(maxWidth)
# 
# gB[["grobs"]][[4]][["children"]][["axis"]] <- NULL
# gB[["widths"]][3] <- list(unit(0, "line"))

fak <- 
  ggplot(tvd[is.na(edadm) == F & Periodo %in% c("1985 a 1990",    "2005 a 2010"        )], 
         aes(edadm , Hombres / Mujeres, colour = Periodo, linetype = Periodo) ) + 
  geom_vline(xintercept = seq(0, 80,  10), colour = '#EAEAEA', linetype = '22') + 
  geom_hline(yintercept = seq(0, 8, 2.5), colour = '#EAEAEA', linetype = '22') +
  geom_vline(xintercept = seq(0, 80,  20 ), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = seq(0, 8, 5), colour = '#E4E4E4', linetype = '22') +
  geom_line(size = 1) +
  annotate('rect',  ymin = -Inf, ymax = Inf, xmin = 20, xmax = 30,    alpha = .15 ) +
  scale_colour_manual(values = c("black","black") ) +
  scale_x_continuous(lim = c(0, 80), expand = c(.1, .1)) +
  scale_linetype_manual(values = c("11", "solid") ) +
  facet_wrap( ~ Dep, ncol = 5 ) + theme_bw(base_size = sizet) +
  xlab('Edad') + ylab(expression( paste(''[n], q[x]^H) / paste(''[n], q[x]^M)    )) +    
  theme(axis.text = element_text(size = sizet) ,
        axis.title = element_text(size = sizet) ,
        legend.text = element_text(size = sizet) ,
        legend.title = element_text(size = sizet) ,
        strip.background = element_rect(fill="white"), 
        panel.margin = unit(0, "lines"), 
        panel.grid = element_blank(),
        strip.text = element_text(size = sizet) ,
        legend.position = 'bottom') 

g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

mylegend_1<-g_legend(fak)



grid.newpage()
pdf(file = "prsobrem.pdf",
    width = 8,   height = 10, family = "Helvetica")

grid.arrange( arrangeGrob ( cbind(gA,gB,  size="first"),  
                            cbind(mylegend_1,  size="first") ,  
                            nrow = 2, heights=c(9.5, .5))   ) 

dev.off()


# COL dep sobremort masc --------------------------------------------------------

tv <- fread('tv.proy.col.csv',  header = TRUE)

tv$clasep <- recode(tv$Periodo, " '1985 a 1990' = 1987.5; '1990 a 1995' = 1992.5; 
                    '1995 a 2000' = 1997.5; '2000 a 2005' = 2002.5; 
                    '2005 a 2010' = 2007.5; '2010 a 2015' = 2012.5; '2015 a 2020' = 2017.5   ")

tvd <- dcast.data.table(tv, Dep + Depb + Depc + Periodo + edad + edadm ~ Sexo, 
                        value.var = 'qx', fun=mean  )


dput(unique( tvd[edadm == 22.5 & Periodo == "2005 a 2010" ][
  , sm := Hombres / Mujeres][order(sm)][  , 'Depc', with = F]))

dput(  tvd[Periodo == "2005 a 2010" ][ , sm := Hombres / Mujeres][
  ,list( edadm[which.max(sm)],  max(sm)  ) , keyby = list( Depb ,    Periodo )][
    order(V2)][  , 'Depb', with = F]   )

tvd$Depb <- as.character(tvd$Depb)

tvd <- tvd[Depc %in%  c("BOL", "BOY", "ATL", "CUN", "BOG", "SAN", 
                        "CAU", "NAR", "MAG", "TOL", "COR", "SAP", "HUI", "COL", "CHO", 
                        "CAQ", "SUC", "ARA", "MET", "ANT", "QUI", "PUT", "AMA", "GUA", 
                        "GUV", "VAU", "VID", "NSA", "CAS", "RIS", "CES", "VAC", "LAG", 
                        "CAL"
)]

tvd$Depc <- factor( tvd$Depc, 
                    levels = rev(  c("Bolívar", "Boyacá", "Atlántico", "Cundinamarca", 
                                     "Bogotá", "Santander", "Cauca", "Nariño", "Magdalena", "Tolima", 
                                     "Córdoba", "San Andrés", "Huila",  "Chocó", "Caquetá", 
                                     "Sucre", "Arauca", "Meta", "Antioquia", "Quindío", "Putumayo", 
                                     "Amazonas",  "Norte", 
                                     "Casanare", "Risaralda", "Cesar", "Valle", "La Guajira", 
                                     "Caldas", "Colombia"
                    ) ) )

sizet <- 11

p <-
  ggplot(tvd[is.na(edadm) == F & Periodo %in% c("1985 a 1990",    "2005 a 2010"        )], 
            aes(edadm , Hombres / Mujeres, colour = Periodo, linetype = Periodo) ) + 
  geom_vline(xintercept = seq(0, 80,  10), colour = '#EAEAEA', linetype = '22') + 
  geom_hline(yintercept = seq(0, 8, 2.5), colour = '#EAEAEA', linetype = '22') +
  geom_vline(xintercept = seq(0, 80,  20 ), colour = '#E4E4E4', linetype = '22') + 
  geom_hline(yintercept = seq(0, 8, 5), colour = '#E4E4E4', linetype = '22') +
  geom_line(size = 1) +
  scale_colour_manual(values = c("#d7301f","#7f0000") ) +
  scale_x_continuous(lim = c(0, 80), expand = c(.1, .1)) +
  scale_linetype_manual(values = c("11", "solid") ) +
  facet_wrap( ~ Depc, ncol = 5 ) + theme_bw() +
  xlab('Edad') + ylab(expression( paste(''[n], q[x]^H) / paste(''[n], q[x]^M)    )) +    
  theme(axis.text = element_text(size = sizet) ,
        axis.title = element_text(size = sizet) ,
        legend.text = element_text(size = sizet) ,
        legend.title = element_text(size = sizet) ,
        strip.background = element_rect(fill="white"), 
        panel.margin = unit(0, "lines"), 
        panel.grid = element_blank(),
        strip.text = element_text(size = sizet + 1) ,
        legend.position = 'bottom') +
  scale_y_continuous(breaks = seq(0, 8, 2) )

grid.newpage()
pdf(file = "sobmortmasproy.pdf",  width = 8,  height = 10, family = "Helvetica")
print(p)
dev.off()




# mort edades -------------------------------------------------------------


tv <- fread('tv.proy.col.csv',  header = TRUE)

tv$clasep <- recode(tv$Periodo, " '1985 a 1990' = 1987.5; '1990 a 1995' = 1992.5; 
                    '1995 a 2000' = 1997.5; '2000 a 2005' = 2002.5; 
                    '2005 a 2010' = 2007.5; '2010 a 2015' = 2012.5; '2015 a 2020' = 2017.5   ")

tv$DPTO <- factor(tv$DPTO, c("5", "81", "8", "11", "13", "15", "17", "18", "85", "19", "20", 
                             "27", "23", "25", "91", "41", "44", "47", "50", "#N/A", "52", 
                             "54", "86", "63", "66", "88", "68", "70", "73", "76", 
                             "95", "97", "99", "94"),
                  c("05", "81", "08", "11", "13", "15", "17", "18", "85", "19", "20", 
                    "27", "23", "25", "91", "41", "44", "47", "50", "#N/A", "52", 
                    "54", "86", "63", "66", "88", "68", "70", "73", "76",  
                    "95", "97", "99", "94"))

tvf <- tv[edadm > 5  & edadm < 79 & Periodo %in% c('1985 a 1990' ,   '2005 a 2010')]

tvf$edad <- factor(as.character(tvf$edad), levels = c("5 a 9", "10 a 14", "15 a 19", "20 a 24", "25 a 29", "30 a 34", 
                                                      "35 a 39", "40 a 44", "45 a 49", "50 a 54", "55 a 59", "60 a 64", 
                                                      "65 a 69", "70 a 74", "75 a 79"))

sizet  <- 12

p <- ggplot(na.omit(tvf), aes(edad, qx, colour = Sexo) ) + geom_boxplot() + 
  theme_bw() + facet_wrap(~ Periodo) + xlab('Edad') +
  scale_y_log10(name = expression(log(paste(''[n], q[x])  ) ) ) +
  scale_colour_manual(values = (c('#081d58', '#ef6548'))  ) +
  scale_x_discrete(expand = c(.1, .1)) +
  theme( strip.background = element_rect(colour = '#525252' , fill="white"),
         legend.title = element_blank(), legend.position = 'bottom',
         axis.text.x = element_text( size = sizet, family="Helvetica", vjust = .5, angle = 90),
         axis.text.y = element_text(size = sizet, family="Helvetica" ),  
         axis.title.x = element_text(size = sizet, family="Helvetica"),
         axis.title.y = element_text(size = sizet, family="Helvetica"),
         legend.text = element_text(size = sizet, family="Helvetica"),
         strip.text.x = element_text(size = sizet + 1, family="Helvetica"),
         panel.margin = unit(0, "lines"), panel.grid = element_blank()  ) + 
  annotation_logticks(sides = "l") 


cairo_pdf(file = "gredadboxcol.pdf",  family = "Helvetica",
          width = 8, height = 6)
print(p)
dev.off()


# descomposicion avance decenal --------------------------------------------------------

tv <- fread('tv.proy.col.csv',  header = TRUE)

tv$clasep <- recode(tv$Periodo, " '1985 a 1990' = 1987.5; '1990 a 1995' = 1992.5; 
                    '1995 a 2000' = 1997.5; '2000 a 2005' = 2002.5; 
                    '2005 a 2010' = 2007.5; '2010 a 2015' = 2012.5; '2015 a 2020' = 2017.5   ")

tv$DPTO <- factor(tv$DPTO, c("5", "81", "8", "11", "13", "15", "17", "18", "85", "19", "20", 
                             "27", "23", "25", "91", "41", "44", "47", "50", "#N/A", "52", 
                             "54", "86", "63", "66", "88", "68", "70", "73", "76", 
                             "95", "97", "99", "94"),
                  c("05", "81", "08", "11", "13", "15", "17", "18", "85", "19", "20", 
                    "27", "23", "25", "91", "41", "44", "47", "50", "#N/A", "52", 
                    "54", "86", "63", "66", "88", "68", "70", "73", "76",  
                    "95", "97", "99", "94"))

tv$edadi <- factor( tv$edad, c("0", "1 a 4", "5 a 9", "10 a 14", "15 a 19", "20 a 24", "25 a 29", 
                               "30 a 34", "35 a 39", "40 a 44", "45 a 49", "50 a 54", "55 a 59", 
                               "60 a 64", "65 a 69", "70 a 74", "75 a 79", "80 y +"),
                    c("0", "1", "5", "10", "15", "20", "25", 
                      "30", "35", "40", "45", "50", "55", 
                      "60", "65", "70", "75", "80")  )

tv$edadi <- as.numeric(as.character(tv$edadi))


tv1 <- tv[Periodo %in% c('1985 a 1990', '1995 a 2000', '2005 a 2010' )  ][
  edadi  %in% c(0, 15, 40, 65) ]



tv1 <- tv1[order(DPTO, Periodo, Sexo )][ , lxad := c( lx[2:length(lx)] , 0  ) , keyby = list(DPTO, Periodo, Sexo ) ]
tv1 <- tv1[order(DPTO, Periodo, Sexo )][ , exad := c( ex[2:length(ex)] , 0  ) , keyby = list(DPTO, Periodo, Sexo ) ]


tv1c <- tv1
tv1c$clasep <- factor(tv1$Periodo, levels = c('1985 a 1990', '1995 a 2000', '2005 a 2010'),
                      labels = c(1997.5, 2007.5, NA) )

tv1c$clasep <- as.numeric(as.character(tv1c$clasep))


tv1 <- merge(tv1, tv1c,  by = c("DPTO", "Sexo", "clasep",  "edad")   )

tv1 <- tv1[order(DPTO,  Periodo.x, Sexo, edad) ][
  , arria3.tot := (lx.y + lx.x) * (ex.x - ex.y) / (2 * 100000) - 
    (lxad.y + lxad.x) * (exad.x - exad.y) / (2 * 100000)  ]


a <- tv1[,  list(  sum(arria3.tot) ),     keyby = list(Depc.x, Periodo.x, Sexo ) ]
b <- tv1[edadi.x == 0, c( 'Depc.x', 'Periodo.x', 'Sexo', 'ex.x','ex.y' ) , with = F][
  , dif := ex.x-ex.y]
c <- merge(a, b, by = c('Depc.x', 'Periodo.x', 'Sexo')   )




tv1$Edadg <- recode(tv1$edadi.x, " 0 = '0-14'; 15 = '15-39' ; 40 = '40-64'; 65 = '65 y más'    " )

tv1$Edadg <- factor(tv1$Edadg, lev = rev(c('0-14', '15-39', '40-64', '65 y más' )) )


tv1[Periodo.x == '2005 a 2010' & Sexo == 'Hombres' & edadi.x == 0][order(-ex.x+ ex.y)][
  , 'Depc.x', with = F] %>%
  dput(.)



tv1[, acum := sum(arria3.tot), keyby = .(Depc.x, Periodo.x, Sexo) ]



ht <- tv1

ht$Periodo.x <- factor(ht$Periodo.x, c("1995 a 2000", "2005 a 2010"), 
                       c("1987 a 1997", "1997 a 2007"))


colm <- readOGR("deptovl.shp", layer = "deptovl", verbose = TRUE, stringsAsFactors = FALSE)
pds <- fortify(colm, region = "DPTO")

ht$clam <- cut_number( ht$arria3.tot, n = 5)

sizet <- 12

ht$Edadg <- factor(ht$Edadg, lev = rev(c("65 y más", "40-64", "15-39", "0-14")))

display.brewer.all() 
dev.off()
dput(brewer.pal(9, 'RdBu'))
dput(brewer.pal(9, 'Blues'))

colorRampPalette(c('#67001F', '#fddbc7'))( 4 )
dput(colorRampPalette(c('#d1e5f0', '#053061'))( 7 ))

# intervalos iguales
ht$inti <- cut(ht$arria3.tot, breaks = seq(-3, 6, .75)  )


# paleta int iguales
intipal <- c("#67001F", "#994957", "#CB928F", "#FDDBC7", "#D1E5F0", "#AFC6D8", 
             "#8DA8C0", "#6B8AA8", "#496C90", "#274E78", 
             "#053061" )



p1 <- ggplot(ht[Sexo == 'Hombres'], aes(map_id = DPTO)) + coord_fixed() + 
  geom_map(aes(fill = inti , colour = ''), map = pds, size = .2) + 
  guides(colour = F) + scale_colour_manual(values = '#d9d9d9') + 
  expand_limits(x =  pds$long, y = pds$lat) +
  facet_grid(Edadg ~ Sexo +Periodo.x   ) + xlab("") + ylab("") +
  theme_bw(base_size = 12) +
  scale_fill_manual(name = 'Grupos',  values =  c("(-3,-2.25]" =intipal[1]  ,
                                                  "(-2.25,-1.5]"=intipal[2] ,
                                                  "(-1.5,-0.75]"=intipal[3] ,
                                                  "(-0.75,0]"=intipal[4] , 
                                                  "(0,0.75]" =intipal[5], 
                                                  "(0.75,1.5]"=intipal[6], 
                                                  "(1.5,2.25]"=intipal[7], 
                                                  "(2.25,3]"=intipal[8], 
                                                  "(3,3.75]"=intipal[9], 
                                                  "(3.75,4.5]"=intipal[10], 
                                                  "(4.5,5.25]"=intipal[11], 
                                                  "(5.25,6]" =intipal[12])) +
  theme(axis.text = element_blank(), legend.position = '',
        strip.background = element_rect(colour = 'gray' , fill="white"), 
        strip.text = element_text(size = sizet, family="Helvetica"),
        panel.margin = unit(0, "lines") ,
        panel.grid.minor=element_blank(),  panel.grid.major=element_blank(), 
        legend.text = element_text(size = sizet - 2, family="Helvetica"),
        legend.title = element_text(size = sizet - 2, family="Helvetica", face = 'plain'),
        axis.ticks = element_blank()) 



p2 <- 
  ggplot(ht[Sexo == 'Mujeres'], aes(map_id = DPTO)) + coord_fixed() + 
  geom_map(aes(fill = inti , colour = ''), map = pds, size = .2) + 
  guides(colour = F) + scale_colour_manual(values = '#d9d9d9') + 
  expand_limits(x =  pds$long, y = pds$lat) +
  facet_grid(Edadg ~ Sexo +Periodo.x   ) + xlab("") + ylab("") +
  theme_bw(base_size = 12) +
  scale_fill_manual(name = 'Grupos',  values =  c("(-3,-2.25]" =intipal[1]  ,
                                                  "(-2.25,-1.5]"=intipal[2] ,
                                                  "(-1.5,-0.75]"=intipal[3] ,
                                                  "(-0.75,0]"=intipal[4] , 
                                                  "(0,0.75]" =intipal[5], 
                                                  "(0.75,1.5]"=intipal[6], 
                                                  "(1.5,2.25]"=intipal[7], 
                                                  "(2.25,3]"=intipal[8], 
                                                  "(3,3.75]"=intipal[9], 
                                                  "(3.75,4.5]"=intipal[10], 
                                                  "(4.5,5.25]"=intipal[11], 
                                                  "(5.25,6]" =intipal[12])) +
  theme(axis.text = element_blank(), legend.position = '',
        strip.background = element_rect(colour = 'gray' , fill="white"), 
        strip.text = element_text(size = sizet, family="Helvetica"),
        panel.margin = unit(0, "lines") ,
        panel.grid.minor=element_blank(),  panel.grid.major=element_blank(), 
        legend.text = element_text(size = sizet - 2, family="Helvetica"),
        legend.title = element_text(size = sizet - 2, family="Helvetica", face = 'plain'),
        axis.ticks = element_blank()) 
  

pg <- 
  ggplot(ht[Sexo == 'Hombres'], aes(map_id = DPTO)) + coord_fixed() + 
  geom_map(aes(fill = inti , colour = ''), map = pds, size = .2) + 
  guides(colour = F) + scale_colour_manual(values = '#d9d9d9') + 
  expand_limits(x =  pds$long, y = pds$lat) +
  facet_grid(Edadg ~ Sexo +Periodo.x   ) + xlab("") + ylab("") +
  theme_bw(base_size = 12) +
  scale_fill_manual(name = 'Grupos',  values =  c("(-3,-2.25]" =intipal[1]  ,
                                                  "(-2.25,-1.5]"=intipal[2] ,
                                                  "(-1.5,-0.75]"=intipal[3] ,
                                                  "(-0.75,0]"=intipal[4] , 
                                                  "(0,0.75]" =intipal[5], 
                                                  "(0.75,1.5]"=intipal[6], 
                                                  "(1.5,2.25]"=intipal[7], 
                                                  "(2.25,3]"=intipal[8], 
                                                  "(3,3.75]"=intipal[9], 
                                                  "(3.75,4.5]"=intipal[10], 
                                                  "(4.5,5.25]"=intipal[11], 
                                                  "(5.25,6]" =intipal[12])) +
  theme(axis.text = element_blank(), legend.position = 'right',
        strip.background = element_rect(colour = 'gray' , fill="white"), 
        strip.text = element_text(size = sizet, family="Helvetica"),
        panel.margin = unit(0, "lines") ,
        panel.grid.minor=element_blank(),  panel.grid.major=element_blank(), 
        legend.text = element_text(size = sizet - 2, family="Helvetica"),
        legend.title = element_text(size = sizet - 2, family="Helvetica", face = 'plain'),
        axis.ticks = element_blank()) 




g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

mylegend_1 <- g_legend(pg)



cairo_pdf(file = "mapavancedecenale0col.pdf",  family = "Helvetica",
          width = 8, height = 7.5)
grid.arrange(p1,p2, mylegend_1, nrow = 1 )
dev.off()




# descomposicion brecha e0 sexo --------------------------------------------------------

tv <- fread('tv.proy.col.csv',  header = TRUE)

tv$clasep <- recode(tv$Periodo, " '1985 a 1990' = 1987.5; '1990 a 1995' = 1992.5; 
                    '1995 a 2000' = 1997.5; '2000 a 2005' = 2002.5; 
                    '2005 a 2010' = 2007.5; '2010 a 2015' = 2012.5; '2015 a 2020' = 2017.5   ")

tv$DPTO <- factor(tv$DPTO, c("5", "81", "8", "11", "13", "15", "17", "18", "85", "19", "20", 
                             "27", "23", "25", "91", "41", "44", "47", "50", "#N/A", "52", 
                             "54", "86", "63", "66", "88", "68", "70", "73", "76", 
                             "95", "97", "99", "94"),
                  c("05", "81", "08", "11", "13", "15", "17", "18", "85", "19", "20", 
                    "27", "23", "25", "91", "41", "44", "47", "50", "#N/A", "52", 
                    "54", "86", "63", "66", "88", "68", "70", "73", "76",  
                    "95", "97", "99", "94"))

tv$edadi <- factor( tv$edad, c("0", "1 a 4", "5 a 9", "10 a 14", "15 a 19", "20 a 24", "25 a 29", 
                               "30 a 34", "35 a 39", "40 a 44", "45 a 49", "50 a 54", "55 a 59", 
                               "60 a 64", "65 a 69", "70 a 74", "75 a 79", "80 y +"),
                    c("0", "1", "5", "10", "15", "20", "25", 
                      "30", "35", "40", "45", "50", "55", 
                      "60", "65", "70", "75", "80")  )

tv$edadi <- as.numeric(as.character(tv$edadi))


tv1 <- tv[ Periodo %in% c("1985 a 1990", "1990 a 1995", "1995 a 2000", "2000 a 2005", 
                          "2005 a 2010" ) & edadi  %in% c(0, 15, 40, 65) ]



tv1 <- tv1[order(DPTO, Periodo, Sexo )][ , lxad := c( lx[2:length(lx)] , 0  ) ,
                                         keyby = list(DPTO, Periodo, Sexo ) ]
tv1 <- tv1[order(DPTO, Periodo, Sexo )][ , exad := c( ex[2:length(ex)] , 0  ) , 
                                         keyby = list(DPTO, Periodo, Sexo ) ]


tv1h <- tv1[Sexo == 'Hombres']
tv1m <- tv1[Sexo == 'Mujeres']

tvf <- merge(tv1m, tv1h , by = c('Depc', 'Periodo', 'edad') )


tvf <- tvf[order(Depc,  Periodo, edad) ][
  , arria3.tot := (lx.y + lx.x) * (ex.x - ex.y) / (2 * 100000) - 
    (lxad.y + lxad.x) * (exad.x - exad.y) / (2 * 100000)  ]


a <- tvf[,  list(  sum(arria3.tot) ),     keyby = list(Depc, Periodo) ]
b <- tvf[edadi.x == 0, c( 'Depc', 'Periodo',  'ex.x','ex.y' ) , with = F][
  , dif := ex.x-ex.y]
c <- merge(a, b, by = c('Depc', 'Periodo')   )


tvf$Edadg <- recode(tvf$edadi.x, " 0 = '0-14'; 15 = '15-39' ; 40 = '40-64'; 65 = '65 y más'    " )

tvf$Edadg <- factor(tvf$Edadg, lev = c('0-14', '15-39', '40-64', '65 y más' ) )

ht <- tvf
p.data <- tvf
p.data$arria3.tot[p.data$arria3.tot < 0] <- 0
n.data <- tvf
n.data$arria3.tot[n.data$arria3.tot > 0] <- 0

sizet <- 9
tp <- unique(tvf[, c('Sexo.x', 'Depc'), with = F])


colm <- readOGR("deptovl.shp", layer = "deptovl", verbose = TRUE, stringsAsFactors = FALSE)
pds <- fortify(colm, region = "DPTO")

ht$clam <- cut_number( ht$arria3.tot, n = 20)

sizet <- 12

ht$Edadg <- factor(ht$Edadg, lev = rev(c("65 y más", "40-64", "15-39", "0-14")))

colorRampPalette(c('#fde0dd', '#49006a'))( 8 )


ht$op2 <- cut(ht$arria3.tot, breaks = seq(-2.5, 10, 1.25)  )

p2 <- 
  ggplot(ht, aes(map_id = DPTO.x)) + coord_fixed() + 
  geom_map(aes(fill = op2, colour = ''), map = pds, size = .2) + 
  guides(colour = F) + scale_colour_manual(values = '#d9d9d9') + 
  expand_limits(x =  pds$long, y = pds$lat) +
  facet_grid(Edadg ~ Periodo   ) + xlab("") + ylab("") +
  theme_bw(base_size = 12) +
 scale_fill_manual(name = '',  values = c("(-2.5,-1.25]"='#d0d1e6' , 
                                          "(-1.25,0]"='#ece7f2', 
                                          "(0,1.25]" ="#FDE0DD", 
                                          "(1.25,2.5]"="#E3C0CC", 
                                          "(2.5,3.75]"= "#C9A0BC", 
                                          "(3.75,5]"="#AF80AB", 
                                          "(5,6.25]"="#96609B", 
                                          "(6.25,7.5]"="#7C408A", 
                                          "(7.5,8.75]"="#62207A", 
                                          "(8.75,10]"="#49006A")) +
  theme(axis.text = element_blank(), legend.position = 'bottom',
        strip.background = element_rect(colour = 'gray' , fill="white"), 
        strip.text = element_text(size = sizet, family="Helvetica"),
        panel.margin = unit(0, "lines") ,
        panel.grid.minor=element_blank(),  panel.grid.major=element_blank(), 
        legend.text = element_text(size = sizet - 2, family="Helvetica"),
        legend.title = element_text(size = sizet - 2, family="Helvetica", face = 'plain'),
        axis.ticks = element_blank()) 


cairo_pdf(file = "Descsexoe0.pdf",  family = "Helvetica",
          width = 8, height = 8)
print( p2  )
dev.off()


# descomposicion brecha dep col --------------------------------------------------------

tv <- fread('tv.proy.col.csv',  header = TRUE)

tv$clasep <- recode(tv$Periodo, " '1985 a 1990' = 1987.5; '1990 a 1995' = 1992.5; 
                    '1995 a 2000' = 1997.5; '2000 a 2005' = 2002.5; 
                    '2005 a 2010' = 2007.5; '2010 a 2015' = 2012.5; '2015 a 2020' = 2017.5   ")

tv$DPTO <- factor(tv$DPTO, c("5", "81", "8", "11", "13", "15", "17", "18", "85", "19", "20", 
                             "27", "23", "25", "91", "41", "44", "47", "50", "#N/A", "52", 
                             "54", "86", "63", "66", "88", "68", "70", "73", "76", 
                             "95", "97", "99", "94"),
                  c("05", "81", "08", "11", "13", "15", "17", "18", "85", "19", "20", 
                    "27", "23", "25", "91", "41", "44", "47", "50", "#N/A", "52", 
                    "54", "86", "63", "66", "88", "68", "70", "73", "76",  
                    "95", "97", "99", "94"))

tv$edadi <- factor( tv$edad, c("0", "1 a 4", "5 a 9", "10 a 14", "15 a 19", "20 a 24", "25 a 29", 
                               "30 a 34", "35 a 39", "40 a 44", "45 a 49", "50 a 54", "55 a 59", 
                               "60 a 64", "65 a 69", "70 a 74", "75 a 79", "80 y +"),
                    c("0", "1", "5", "10", "15", "20", "25", 
                      "30", "35", "40", "45", "50", "55", 
                      "60", "65", "70", "75", "80")  )

tv$edadi <- as.numeric(as.character(tv$edadi))


tv1 <- tv[ Periodo %in%  c("1985 a 1990",  "1995 a 2000",   "2005 a 2010") & 
             edadi  %in% c(0, 15, 40, 65) ]



tv1 <- tv1[order(DPTO, Periodo, Sexo )][ , lxad := c( lx[2:length(lx)] , 0  ) ,
                                         keyby = list(DPTO, Periodo, Sexo ) ]
tv1 <- tv1[order(DPTO, Periodo, Sexo )][ , exad := c( ex[2:length(ex)] , 0  ) , 
                                         keyby = list(DPTO, Periodo, Sexo ) ]


tv1co <- tv1[Dep == 'Colombia']
tv1nco <- tv1[Dep != 'Colombia']

tvf <- merge(tv1nco , tv1co,  by = c( 'Periodo', 'Sexo','edad') )


tvf <- tvf[order(Depc.y,  Periodo, Sexo, edad) ][
  , arria3.tot := (lx.y + lx.x) * (ex.x - ex.y) / (2 * 100000) - 
    (lxad.y + lxad.x) * (exad.x - exad.y) / (2 * 100000)  ]


a <- tvf[,  list(  sum(arria3.tot) ),     keyby = list(Sexo, Depc.x, Periodo) ]
b <- tvf[edadi.x == 0, c('Sexo', 'Depc.x', 'Periodo',  'ex.x','ex.y' ) , with = F][
  , dif := ex.x-ex.y]
c <- merge(a, b, by = c('Sexo', 'Depc.x', 'Periodo')   )


tvf$Edadg <- recode(tvf$edadi.y, " 0 = '0-14'; 15 = '15-39' ; 40 = '40-64'; 65 = '65 y más'    " )

tvf$Edadg <- factor(tvf$Edadg, lev = c('0-14', '15-39', '40-64', '65 y más' ) )


tvf[edadi.y == 0][,mean(ex.x - ex.y), keyby = .(Depc.x)  ][order(V1)][
  , 'Depc.x', with = F] %>%
  dput(.)


tvf$Periodo <- factor(tvf$Periodo, c("1985 a 1990",  "1995 a 2000", 
                                         "2005 a 2010"))


ht <- tvf
p.data <- tvf
p.data$arria3.tot[p.data$arria3.tot < 0] <- 0
n.data <- tvf
n.data$arria3.tot[n.data$arria3.tot > 0] <- 0


sizet <- 9
tp <- unique(tvf[, c('Sexo', 'Depc.y'), with = F])



colm <- readOGR("deptovl.shp", layer = "deptovl", verbose = TRUE, stringsAsFactors = FALSE)
pds <- fortify(colm, region = "DPTO")



colorRampPalette(c('#a50026', '#ffffbf'))( 9 ) %>% dput(.)
colorRampPalette(c('#d9ef8b', '#006837'))( 3 ) %>% dput(.)




ht$clam <- cut_number( ht$arria3.tot, n = 10)
ht$op2 <- cut(ht$arria3.tot, breaks = seq(-9, 3, 1)  )

sizet <- 10

ht$Edadg <- factor(ht$Edadg, lev = rev(c("65 y más", "40-64", "15-39", "0-14")))



p1 <- 
  ggplot(ht[Sexo == 'Mujeres'], aes(map_id = DPTO.x)) + coord_fixed() + 
   geom_map(aes(fill = op2 , colour = ''), map = pds, size = .2) + 
  guides(colour = F) + scale_colour_manual(values = '#d9d9d9') + 
  expand_limits(x =  pds$long, y = pds$lat) +
  facet_grid(Edadg ~ Sexo  + Periodo  ) + xlab("") + ylab("") +
  theme_bw(base_size = 12) +
  scale_fill_manual(name = 'Grupos', 
                    values = c("(-9,-8]" = "#A50026", 
                               "(-8,-7]" = "#B01F39", 
                               "(-7,-6]" = "#BB3F4C", 
                               "(-6,-5]" = "#C65F5F", 
                               "(-5,-4]" = "#D27F72", 
                               "(-4,-3]" = "#DD9F85", 
                               "(-3,-2]" = "#E8BF98", 
                               "(-2,-1]" = "#F3DFAB", 
                               "(-1,0]" = "#FFFFBF", 
                               "(0,1]" = "#D9EF8B", 
                               "(1,2]" = "#6CAB61", 
                               "(2,3]" = "#006837")    ) +
  theme(axis.text = element_blank(), legend.position = '',
        strip.background = element_rect(colour = 'gray' , fill="white"), 
        strip.text = element_text(size = sizet, family="Helvetica"),
        panel.margin = unit(0, "lines") ,
        panel.grid.minor=element_blank(),  panel.grid.major=element_blank(), 
        legend.text = element_text(size = sizet - 2, family="Helvetica"),
        legend.title = element_text(size = sizet - 2, family="Helvetica", face = 'plain'),
        axis.ticks = element_blank(),
        plot.margin=unit(c(.1,.1,.1,.1), "cm") ) 

p2 <- 
  ggplot(ht[Sexo == 'Hombres'], aes(map_id = DPTO.x)) +  coord_fixed() + 
  geom_map(aes(fill = op2 , colour = ''), map = pds, size = .2) + 
  guides(colour = F) + scale_colour_manual(values = '#d9d9d9') + 
  expand_limits(x =  pds$long, y = pds$lat) +
  facet_grid(Edadg ~ Sexo  + Periodo  ) + xlab("") + ylab("") +
  theme_bw(base_size = 12) +
  scale_fill_manual(name = 'Grupos', 
                    values = c("(-9,-8]" = "#A50026", 
                               "(-8,-7]" = "#B01F39", 
                               "(-7,-6]" = "#BB3F4C", 
                               "(-6,-5]" = "#C65F5F", 
                               "(-5,-4]" = "#D27F72", 
                               "(-4,-3]" = "#DD9F85", 
                               "(-3,-2]" = "#E8BF98", 
                               "(-2,-1]" = "#F3DFAB", 
                               "(-1,0]" = "#FFFFBF", 
                               "(0,1]" = "#D9EF8B", 
                               "(1,2]" = "#6CAB61", 
                               "(2,3]" = "#006837")    ) +
  theme(axis.text = element_blank(), legend.position = '',
        strip.background = element_rect(colour = 'gray' , fill="white"), 
        strip.text = element_text(size = sizet, family="Helvetica"),
        panel.margin = unit(0, "lines") ,
        panel.grid.minor=element_blank(),  panel.grid.major=element_blank(), 
        legend.text = element_text(size = sizet - 2, family="Helvetica"),
        legend.title = element_text(size = sizet - 2, family="Helvetica", face = 'plain'),
        axis.ticks = element_blank(),
        plot.margin=unit(c(.1,.1,.1,.1), "cm") )  

pg <- 
  ggplot(ht[Sexo == 'Hombres'], aes(map_id = DPTO.x)) + coord_fixed() + 
  geom_map(aes(fill = op2 , colour = ''), map = pds, size = .2) + 
  guides(colour = F) + scale_colour_manual(values = '#d9d9d9') + 
  expand_limits(x =  pds$long, y = pds$lat) +
  facet_grid(Edadg ~ Sexo  + Periodo  ) + xlab("") + ylab("") +
  theme_bw(base_size = 12) +
  scale_fill_manual(name = 'Grupos', 
                    values = c("(-9,-8]" = "#A50026", 
                               "(-8,-7]" = "#B01F39", 
                               "(-7,-6]" = "#BB3F4C", 
                               "(-6,-5]" = "#C65F5F", 
                               "(-5,-4]" = "#D27F72", 
                               "(-4,-3]" = "#DD9F85", 
                               "(-3,-2]" = "#E8BF98", 
                               "(-2,-1]" = "#F3DFAB", 
                               "(-1,0]" = "#FFFFBF", 
                               "(0,1]" = "#D9EF8B", 
                               "(1,2]" = "#6CAB61", 
                               "(2,3]" = "#006837")    ) +
  theme(axis.text = element_blank(), legend.position = 'right',
        strip.background = element_rect(colour = 'gray' , fill="white"), 
        strip.text = element_text(size = sizet, family="Helvetica"),
        panel.margin = unit(0, "lines") ,
        panel.grid.minor=element_blank(),  panel.grid.major=element_blank(), 
        legend.text = element_text(size = sizet - 2, family="Helvetica"),
        legend.title = element_text(size = sizet - 2, family="Helvetica", face = 'plain'),
        axis.ticks = element_blank()) 



g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

mylegend_1 <- g_legend(pg)

cairo_pdf(file = "DescDepae0B.pdf",  family = "Helvetica",
          width = 8, height = 6)
grid.arrange(  p2, p1, mylegend_1,nrow = 1, widths = c(.38,.38,.14)   )
dev.off()



# ajuste hombres dep col-----------------------------------------------------------------

tm <- fread('tv.proy.col.csv',  header = TRUE)

tm$clasep <- recode(tm$Periodo, " '1985 a 1990' = 1987.5; '1990 a 1995' = 1992.5; 
                    '1995 a 2000' = 1997.5; '2000 a 2005' = 2002.5; 
                    '2005 a 2010' = 2007.5; '2010 a 2015' = 2012.5; '2015 a 2020' = 2017.5   ")

tm$DPTO <- factor(tm$DPTO, c("5", "81", "8", "11", "13", "15", "17", "18", "85", "19", "20", 
                             "27", "23", "25", "91", "41", "44", "47", "50", "#N/A", "52", 
                             "54", "86", "63", "66", "88", "68", "70", "73", "76", 
                             "95", "97", "99", "94"),
                  c("05", "81", "08", "11", "13", "15", "17", "18", "85", "19", "20", 
                    "27", "23", "25", "91", "41", "44", "47", "50", "#N/A", "52", 
                    "54", "86", "63", "66", "88", "68", "70", "73", "76",  
                    "95", "97", "99", "94"))

tm$edadi <- factor( tm$edad, c("0", "1 a 4", "5 a 9", "10 a 14", "15 a 19", "20 a 24", "25 a 29", 
                               "30 a 34", "35 a 39", "40 a 44", "45 a 49", "50 a 54", "55 a 59", 
                               "60 a 64", "65 a 69", "70 a 74", "75 a 79", "80 y +"),
                    c("0", "1", "5", "10", "15", "20", "25", 
                      "30", "35", "40", "45", "50", "55", 
                      "60", "65", "70", "75", "80")  )

tm$edadi <- as.numeric(as.character(tm$edadi))


tm1 <- tm[Periodo %in% c('1985 a 1990', '1995 a 2000', '2005 a 2010' ) & edadi <80 & Depc != '#N/A']

parConv <- c(a = 0.0005893,b = 0.0043836, c = 0.0828424,   d = 0.000706,e = 9.927863, 
             f = 22.197312, g = 0.00004948, h = 1.10003);       
parStart <- parConv; 

HP8 <- function(parS,x) 
  with(as.list(parS),   ifelse(x == 0, a ^ ((x + b) ^ c) + g * h ^ x, 
                               a ^ ((x + b) ^ c) + d * exp(-e * (log(x / f))^2) + g * h ^ x))
## Define qx = HP8/(1+HP8)
qxPred <- function(parS, x) { h <- HP8(parS, x);         h / (1 + h)  }
nqxPred <- function(parS,x)
  ifelse(x == 0, 1 -(1 - qxPred(parS, x))   ,
         ifelse(x == 1, 1 -(1 - qxPred(parS, x)) * 
                  (1 - qxPred(parS, x + 1))* 
                  (1 - qxPred(parS, x + 2)) * 
                  (1 - qxPred(parS, x + 3))    ,   
                (1 -(1 - qxPred(parS, x)) * 
                   (1 - qxPred(parS, x + 1)) * 
                   (1 - qxPred(parS, x + 2)) * 
                   (1 - qxPred(parS, x + 3)) * 
                   (1 - qxPred(parS, x + 4))  )                  
         )
  )
##Define Residual Function, the relative squared distance is minimized  

ResidFun <- function(parS, Observed, x) (nqxPred(parS, x)/ Observed - 1)
ssqfun <- function(parS, Observed, x) { sum(ResidFun(parS, Observed, x) ^ 2) }

# Periode = '1985 a 1990'; sexoe = 'Hombres';  depce = 'ANT'


no <- function (Periode, sexoe, depce)
{
  massu <- subset(tm1, Periodo == Periode  & Sexo == sexoe & Depc == depce)
  opt2 <- nlminb(start = parStart, objective = ssqfun,    Observed = massu$qx, x = massu$edadi,                 
                 control= list(eval.max = 200, iter.max = 200  )
                 #                  ,                 lower = c(0,0,0,0,0, 15,0,0), 
                 #                  upper = c(.25, 1, 1, .25, Inf, 55, .01, 1.5) 
  )
  #   parNLM <- opt2$par;      
  #   
  #   
  #   pred2 <- nqxPred(as.list(parNLM), massu$edadi)
  #   dPred <- with(massu,  data.frame(edadi, qx = pred2, w="nlminb"))
  #   #list( opt2$par, data.frame(nqxPred(as.list(opt2$par), massu$edadi), massu$edadi, massu$qx)  )
  #   ajust <- data.frame(matrix(ncol = 1, nrow = length( c(0,1, seq(5, 100, 5)) ) ))
  #   ajust$edadi <- c(0,1, seq(5, 100, 5))
  #   ajust$pred2 <- nqxPred(as.list(parNLM), ajust$edadi )
  #   ajust$Periodo <- unique(massu$Periodo)
  #   ajust$Depc <- unique(massu$Depc)
  #   ajust$Sexo <- unique(massu$Sexo)  
  #   
  #   dPred <- merge(massu, ajust, by = c('edadi', 'Periodo', 'Depc', 'Sexo'), all = T )
  list( opt2$par ) 
}

tm1$qx <- ceiling(tm1$qx * 10000) / 10000

mas1 <- subset(tm1,   Sexo == "Hombres")
heligm <- function () {
  ddply(mas1, .(Periodo, Sexo, Depc), function(massu)
  {opt2 <- nlminb(start = parStart, objective = ssqfun,    Observed = massu$qx, x = massu$edadi,                 
                  control= list(eval.max = 200, iter.max = 200  )
                  #                   ,                 lower = c(0,0,0,0,0, 15,0,0), 
                  #                   upper = c(.25, 1, 1, .25, Inf, 55, .01, 1.5) 
  )
  parNLM <- opt2$par
  
  pred2 <- nqxPred(as.list(parNLM), massu$edadi)
  dPred <- with(massu,  data.frame(edadi, qxn = pred2, w="nlminb"))
  list( opt2$par, data.frame(nqxPred(as.list(opt2$par), massu$edadi), massu$edadi, massu$qx)  )
  ajust <- data.frame(matrix(ncol = 1, nrow = length(c(0,1, seq(5, 100, 5)) ) ))
  ajust$edadi <- c(0,1, seq(5, 100, 5))
  ajust$pred2 <- nqxPred(as.list(parNLM), ajust$edadi )
  ajust$Periodo <- unique(massu$Periodo)
  ajust$Depc <- unique(massu$Depc)
  ajust$Sexo <- unique(massu$Sexo)  
  
  dPred <- merge(massu, ajust, by = c('edadi', 'Periodo', 'Depc', 'Sexo'), all = T )
  data.frame(  t(opt2$par), 
               subset(dPred, select = c('edadi', 'pred2', 'qx',
                                        'Periodo', 'Depc', 'Sexo')  ), opt2$objective)
  })
}

hstart <- no("2005 a 2010","Hombres","BOG"); parStart <- hstart[[1]]; resb <- heligm()
hstart <- no("1995 a 2000","Hombres","BOG"); parStart <- hstart[[1]]; resb2 <- heligm()
hstart <- no("1985 a 1990","Hombres","BOG"); parStart <- hstart[[1]]; resb3 <- heligm()
hstart <- no("2005 a 2010","Hombres","ANT"); parStart <- hstart[[1]]; resb4 <- heligm()
hstart <- no("1995 a 2000","Hombres","ANT"); parStart <- hstart[[1]]; resb5 <- heligm()
hstart <- no("1985 a 1990","Hombres","ANT"); parStart <- hstart[[1]]; resb6 <- heligm()
hstart <- no("2005 a 2010","Hombres","ATL"); parStart <- hstart[[1]]; resb7 <- heligm()
hstart <- no("1995 a 2000","Hombres","ATL"); parStart <- hstart[[1]]; resb8 <- heligm()
hstart <- no("1985 a 1990","Hombres","ATL"); parStart <- hstart[[1]]; resb9 <- heligm()
hstart <- no("2005 a 2010","Hombres","VAC"); parStart <- hstart[[1]]; resb10 <- heligm()
hstart <- no("1995 a 2000","Hombres","VAC"); parStart <- hstart[[1]]; resb11 <- heligm()
hstart <- no("1985 a 1990","Hombres","VAC"); parStart <- hstart[[1]]; resb12 <- heligm()
hstart <- no("2005 a 2010","Hombres","NSA"); parStart <- hstart[[1]]; resb13 <- heligm()
hstart <- no("1995 a 2000","Hombres","NSA"); parStart <- hstart[[1]]; resb14 <- heligm()
hstart <- no("1985 a 1990","Hombres","NSA"); parStart <- hstart[[1]]; resb15 <- heligm()
hstart <- no("2005 a 2010","Hombres","COR"); parStart <- hstart[[1]]; resb16 <- heligm()
hstart <- no("1995 a 2000","Hombres","COR"); parStart <- hstart[[1]]; resb17 <- heligm()
hstart <- no("1985 a 1990","Hombres","COR"); parStart <- hstart[[1]]; resb18 <- heligm()
hstart <- no("2005 a 2010","Hombres","MAG"); parStart <- hstart[[1]]; resb19 <- heligm()
hstart <- no("1995 a 2000","Hombres","MAG"); parStart <- hstart[[1]]; resb20 <- heligm()
hstart <- no("1985 a 1990","Hombres","MAG"); parStart <- hstart[[1]]; resb21 <- heligm()
hstart <- no("2005 a 2010","Hombres","CUN"); parStart <- hstart[[1]]; resb22 <- heligm()
hstart <- no("1995 a 2000","Hombres","CUN"); parStart <- hstart[[1]]; resb23 <- heligm()
hstart <- no("1985 a 1990","Hombres","CUN"); parStart <- hstart[[1]]; resb24 <- heligm()
hstart <- no("2005 a 2010","Hombres","BOL"); parStart <- hstart[[1]]; resb25 <- heligm()
hstart <- no("1995 a 2000","Hombres","BOL"); parStart <- hstart[[1]]; resb26 <- heligm()
hstart <- no("1985 a 1990","Hombres","BOL"); parStart <- hstart[[1]]; resb27 <- heligm()
hstart <- no("2005 a 2010","Hombres","SAN"); parStart <- hstart[[1]]; resb28 <- heligm()
hstart <- no("1995 a 2000","Hombres","SAN"); parStart <- hstart[[1]]; resb29 <- heligm()
hstart <- no("1985 a 1990","Hombres","SAN"); parStart <- hstart[[1]]; resb30 <- heligm()
hstart <- no("2005 a 2010","Hombres","NAR"); parStart <- hstart[[1]]; resb31 <- heligm()
hstart <- no("1995 a 2000","Hombres","NAR"); parStart <- hstart[[1]]; resb32 <- heligm()
hstart <- no("1985 a 1990","Hombres","NAR"); parStart <- hstart[[1]]; resb33 <- heligm()
hstart <- no("2005 a 2010","Hombres","BOY"); parStart <- hstart[[1]]; resb34 <- heligm()
hstart <- no("1995 a 2000","Hombres","BOY"); parStart <- hstart[[1]]; resb35 <- heligm()
hstart <- no("1985 a 1990","Hombres","BOY"); parStart <- hstart[[1]]; resb36 <- heligm()
hstart <- no("2005 a 2010","Hombres","QUI"); parStart <- hstart[[1]]; resb37 <- heligm()
hstart <- no("1995 a 2000","Hombres","QUI"); parStart <- hstart[[1]]; resb38 <- heligm()
hstart <- no("1985 a 1990","Hombres","QUI"); parStart <- hstart[[1]]; resb39 <- heligm()
hstart <- no("2005 a 2010","Hombres","RIS"); parStart <- hstart[[1]]; resb40 <- heligm()
hstart <- no("1995 a 2000","Hombres","RIS"); parStart <- hstart[[1]]; resb41 <- heligm()
hstart <- no("1985 a 1990","Hombres","RIS"); parStart <- hstart[[1]]; resb42 <- heligm()
hstart <- no("2005 a 2010","Hombres","TOL"); parStart <- hstart[[1]]; resb43 <- heligm()
hstart <- no("1995 a 2000","Hombres","TOL"); parStart <- hstart[[1]]; resb44 <- heligm()
hstart <- no("1985 a 1990","Hombres","TOL"); parStart <- hstart[[1]]; resb45 <- heligm()
hstart <- no("2005 a 2010","Hombres","CAL"); parStart <- hstart[[1]]; resb46 <- heligm()
hstart <- no("1995 a 2000","Hombres","CAL"); parStart <- hstart[[1]]; resb47 <- heligm()
hstart <- no("1985 a 1990","Hombres","CAL"); parStart <- hstart[[1]]; resb48 <- heligm()
hstart <- no("2005 a 2010","Hombres","HUI"); parStart <- hstart[[1]]; resb49 <- heligm()
hstart <- no("1995 a 2000","Hombres","HUI"); parStart <- hstart[[1]]; resb50 <- heligm()
hstart <- no("1985 a 1990","Hombres","HUI"); parStart <- hstart[[1]]; resb51 <- heligm()
hstart <- no("2005 a 2010","Hombres","CAU"); parStart <- hstart[[1]]; resb52 <- heligm()
hstart <- no("1995 a 2000","Hombres","CAU"); parStart <- hstart[[1]]; resb53 <- heligm()
hstart <- no("1985 a 1990","Hombres","CAU"); parStart <- hstart[[1]]; resb54 <- heligm()
hstart <- no("2005 a 2010","Hombres","SAP"); parStart <- hstart[[1]]; resb55 <- heligm()
hstart <- no("1995 a 2000","Hombres","SAP"); parStart <- hstart[[1]]; resb56 <- heligm()
hstart <- no("1985 a 1990","Hombres","SAP"); parStart <- hstart[[1]]; resb57 <- heligm()
hstart <- no("2005 a 2010","Hombres","CHO"); parStart <- hstart[[1]]; resb58 <- heligm()
hstart <- no("1995 a 2000","Hombres","CHO"); parStart <- hstart[[1]]; resb59 <- heligm()
hstart <- no("1985 a 1990","Hombres","CHO"); parStart <- hstart[[1]]; resb60 <- heligm()
hstart <- no("2005 a 2010","Hombres","PUT"); parStart <- hstart[[1]]; resb61 <- heligm()
hstart <- no("1995 a 2000","Hombres","PUT"); parStart <- hstart[[1]]; resb62 <- heligm()
hstart <- no("1985 a 1990","Hombres","PUT"); parStart <- hstart[[1]]; resb63 <- heligm()
hstart <- no("2005 a 2010","Hombres","CAQ"); parStart <- hstart[[1]]; resb64 <- heligm()
hstart <- no("1995 a 2000","Hombres","CAQ"); parStart <- hstart[[1]]; resb65 <- heligm()
hstart <- no("1985 a 1990","Hombres","CAQ"); parStart <- hstart[[1]]; resb66 <- heligm()
hstart <- no("2005 a 2010","Hombres","LAG"); parStart <- hstart[[1]]; resb67 <- heligm()
hstart <- no("1995 a 2000","Hombres","LAG"); parStart <- hstart[[1]]; resb68 <- heligm()
hstart <- no("1985 a 1990","Hombres","LAG"); parStart <- hstart[[1]]; resb69 <- heligm()
hstart <- no("2005 a 2010","Hombres","SUC"); parStart <- hstart[[1]]; resb70 <- heligm()
hstart <- no("1995 a 2000","Hombres","SUC"); parStart <- hstart[[1]]; resb71 <- heligm()
hstart <- no("1985 a 1990","Hombres","SUC"); parStart <- hstart[[1]]; resb72 <- heligm()
hstart <- no("2005 a 2010","Hombres","AMA"); parStart <- hstart[[1]]; resb73 <- heligm()
hstart <- no("1995 a 2000","Hombres","AMA"); parStart <- hstart[[1]]; resb74 <- heligm()
hstart <- no("1985 a 1990","Hombres","AMA"); parStart <- hstart[[1]]; resb75 <- heligm()
hstart <- no("2005 a 2010","Hombres","CES"); parStart <- hstart[[1]]; resb76 <- heligm()
hstart <- no("1995 a 2000","Hombres","CES"); parStart <- hstart[[1]]; resb77 <- heligm()
hstart <- no("1985 a 1990","Hombres","CES"); parStart <- hstart[[1]]; resb78 <- heligm()
hstart <- no("2005 a 2010","Hombres","MET"); parStart <- hstart[[1]]; resb79 <- heligm()
hstart <- no("1995 a 2000","Hombres","MET"); parStart <- hstart[[1]]; resb80 <- heligm()
hstart <- no("1985 a 1990","Hombres","MET"); parStart <- hstart[[1]]; resb81 <- heligm()
hstart <- no("2005 a 2010","Hombres","ARA"); parStart <- hstart[[1]]; resb82 <- heligm()
hstart <- no("1995 a 2000","Hombres","ARA"); parStart <- hstart[[1]]; resb83 <- heligm()
hstart <- no("1985 a 1990","Hombres","ARA"); parStart <- hstart[[1]]; resb84 <- heligm()


tb <- rbind(resb, resb2, resb3, resb4, resb5, resb6, resb7, resb8, resb9, resb10, resb11, resb12,
            resb13, resb14,   resb15, resb16, resb17, resb18, resb19, resb20, resb21, 
            resb22, resb23, resb24, resb25, resb26, resb27, resb28, resb29, resb30, resb31, 
            resb32, resb33, resb34, resb35, resb36, resb37, resb38, resb39, resb40, resb41, 
            resb42, resb43, resb44, resb45, resb46, resb47, resb48, resb49, resb50, resb51, 
            resb52,  resb53, resb54, resb55, resb56, resb57, resb58, resb59, resb60, resb61, 
            resb62, resb63, resb64, resb65, resb66, resb67, resb68, resb69, resb70, resb71, 
            resb72, resb73, resb74, resb75, resb76, resb77, resb78, resb79, resb80, resb81, 
            resb82, resb83, resb84 )

tb <- data.table(tb)
tb1 <- tb[, min(opt2.objective), keyby = .(Periodo, Depc, Sexo) ]
setnames(tb1, 4, 'opt2.objective')


tb2 <- merge(tb, tb1, by = c('Periodo', 'Depc', 'Sexo', 'opt2.objective'))

partb <- tb2[,list(min(a), min(b), min(c), min(d), min(e), min(f), min(g), min(h) ), 
             keyby = .(Periodo, Depc, Sexo)] %>% 
  setnames(. , 4:11, c('a', 'b','c', 'd', 'e','f', 'g', 'h') )



tb2[, difporc :=  abs (round( (  (pred2 / qx) - 1  ) * 100 ) )]

er.h <- tb2[, list(round(mean(difporc, na.rm = T), 1)  ) , keyby = list(Depc, Periodo) ]


tv <- ddply(partb, .(Sexo, Periodo, Depc  ) , function(bd)   {  
  data.frame (0:130, qxPred(as.list(bd[,c('a', 'b','c','d','e','f','g','h')]),   0:130) )
}  )

setnames(tv, c(2,4,5), c('Periodo','edadi', 'qx') )
tv <- data.table(tv);    

# tv$qx <- ceiling(tv$qx * 10000) / 10000


a0s <- tm1[edadi == '0',   c( 'Sexo' ,'edadi' ,  'Periodo', 'Depc','axn' )  , with = F]
tv <- merge(tv, a0s, by =  c('Sexo'  ,  'Periodo','edadi', 'Depc'), all.x = T )
tv$axn[is.na(tv$axn)== T] <- 1/ 2
tv[edadi == 1]$axn <- 0.41
tv[edadi == 2]$axn <- 0.47
tv[edadi == 3]$axn <- 0.48
tv[edadi == 4]$axn <- 0.48


tv$mxn <- 2 *  tv$qx / (2- tv$qx) 

tv[, lxn := round(c(100000, cumprod(1 - qx) * 100000))  , keyby = list(Sexo , Periodo, Depc )]
tv$dxn <- round(tv$lxn * tv$qx);    
tv$Lxn <- tv$lxn - tv$axn * tv$dxn

tv[, Txn := rev( cumsum(rev(Lxn)   )   ) , keyby = list(Sexo , Periodo, Depc)]
tv$exn <- tv$Txn / tv$Lxn 

tvh <- tv



estimate_mode <- function(x) {    d <- density(x) ;   d$x[which.max(d$y)]     }

med <- tv[, wtd.quantile(edadi, .5, weights = dxn) , 
          keyby = list( Periodo, Depc)]
mod <- tv[edadi > 5][, round(estimate_mode(rep(edadi, dxn)),1 ) , 
                     keyby = list( Periodo, Depc )]
ev <- tv[edadi==0][, c('Periodo', 'Depc', 'exn'), with = F][
  , exr := round(exn,1)][ ,c('Periodo', 'Depc', 'exr'), with = F]

iqr <- tv[, list (wtd.quantile(edadi, .25, weights = dxn), wtd.quantile(edadi, .75, weights = dxn)) ,
          keyby = list(Periodo, Depc  )][,IQR := V2-V1][ ,c('Periodo', 'Depc', 'IQR'), with = F]

d10 <- tv[edadi > 10][, round(sqrt(wtd.var( edadi, weights = dxn)),1)  , keyby = list(Periodo, Depc )]


su <- Reduce(function(...) merge(..., by=c('Periodo', 'Depc' ), all=T), list(ev, med, mod, iqr, d10)  )
setnames(su, 3:7, c('ex', 'Med', 'Moda', 'IQR', 'SD10')  )

suh <- su


prueb <- merge(tm1[Sexo == 'Hombres'], suh, by = c('Periodo', 'Depc') )
prueb <- prueb[edadi == 0][, dif := ex.x - ex.y]

sizet <- 10.5




# ajuste mujeres dep col -----------------------------------------------------------------

tm <- fread('tv.proy.col.csv',  header = TRUE)

tm$clasep <- recode(tm$Periodo, " '1985 a 1990' = 1987.5; '1990 a 1995' = 1992.5; 
                    '1995 a 2000' = 1997.5; '2000 a 2005' = 2002.5; 
                    '2005 a 2010' = 2007.5; '2010 a 2015' = 2012.5; '2015 a 2020' = 2017.5   ")

tm$DPTO <- factor(tm$DPTO, c("5", "81", "8", "11", "13", "15", "17", "18", "85", "19", "20", 
                             "27", "23", "25", "91", "41", "44", "47", "50", "#N/A", "52", 
                             "54", "86", "63", "66", "88", "68", "70", "73", "76", 
                             "95", "97", "99", "94"),
                  c("05", "81", "08", "11", "13", "15", "17", "18", "85", "19", "20", 
                    "27", "23", "25", "91", "41", "44", "47", "50", "#N/A", "52", 
                    "54", "86", "63", "66", "88", "68", "70", "73", "76",  
                    "95", "97", "99", "94"))

tm$edadi <- factor( tm$edad, c("0", "1 a 4", "5 a 9", "10 a 14", "15 a 19", "20 a 24", "25 a 29", 
                               "30 a 34", "35 a 39", "40 a 44", "45 a 49", "50 a 54", "55 a 59", 
                               "60 a 64", "65 a 69", "70 a 74", "75 a 79", "80 y +"),
                    c("0", "1", "5", "10", "15", "20", "25", 
                      "30", "35", "40", "45", "50", "55", 
                      "60", "65", "70", "75", "80")  )

tm$edadi <- as.numeric(as.character(tm$edadi))


tm1 <- tm[Periodo %in% c('1985 a 1990', '1995 a 2000', '2005 a 2010' ) & edadi <80 & Depc != '#N/A']

parConv <- c(a = 0.0005893,b = 0.0043836, c = 0.0828424,   d = 0.000706,e = 9.927863, 
             f = 22.197312, g = 0.00004948, h = 1.10003);       
parStart <- parConv; 

HP8 <- function(parS,x) 
  with(as.list(parS),   ifelse(x == 0, a ^ ((x + b) ^ c) + g * h ^ x, 
                               a ^ ((x + b) ^ c) + d * exp(-e * (log(x / f))^2) + g * h ^ x))
## Define qx = HP8/(1+HP8)
qxPred <- function(parS, x) { h <- HP8(parS, x);         h / (1 + h)  }
nqxPred <- function(parS,x)
  ifelse(x == 0, 1 -(1 - qxPred(parS, x))   ,
         ifelse(x == 1, 1 -(1 - qxPred(parS, x)) * 
                  (1 - qxPred(parS, x + 1))* 
                  (1 - qxPred(parS, x + 2)) * 
                  (1 - qxPred(parS, x + 3))    ,   
                (1 -(1 - qxPred(parS, x)) * 
                   (1 - qxPred(parS, x + 1)) * 
                   (1 - qxPred(parS, x + 2)) * 
                   (1 - qxPred(parS, x + 3)) * 
                   (1 - qxPred(parS, x + 4))  )                  
         )
  )
##Define Residual Function, the relative squared distance is minimized  

ResidFun <- function(parS, Observed, x) (nqxPred(parS, x)/ Observed - 1)
ssqfun <- function(parS, Observed, x) { sum(ResidFun(parS, Observed, x) ^ 2) }



no <- function (Periode, sexoe, depce)
{
  massu <- subset(tm1, Periodo == Periode  & Sexo == sexoe & Depc == depce)
  opt2 <- nlminb(start = parStart, objective = ssqfun,    Observed = massu$qx, x = massu$edadi,                 
                 control= list(eval.max = 200, iter.max = 200  )
                 #                  ,                 lower = c(0,0,0,0,0, 15,0,0), 
                 #                  upper = c(.25, 1, 1, .25, Inf, 55, .01, 1.5) 
  )
  #   parNLM <- opt2$par;      
  #   
  #   
  #   pred2 <- nqxPred(as.list(parNLM), massu$edadi)
  #   dPred <- with(massu,  data.frame(edadi, qx = pred2, w="nlminb"))
  #   #list( opt2$par, data.frame(nqxPred(as.list(opt2$par), massu$edadi), massu$edadi, massu$qx)  )
  #   ajust <- data.frame(matrix(ncol = 1, nrow = length( c(0,1, seq(5, 100, 5)) ) ))
  #   ajust$edadi <- c(0,1, seq(5, 100, 5))
  #   ajust$pred2 <- nqxPred(as.list(parNLM), ajust$edadi )
  #   ajust$Periodo <- unique(massu$Periodo)
  #   ajust$Depc <- unique(massu$Depc)
  #   ajust$Sexo <- unique(massu$Sexo)  
  #   
  #   dPred <- merge(massu, ajust, by = c('edadi', 'Periodo', 'Depc', 'Sexo'), all = T )
  list( opt2$par ) 
}

tm1$qx <- ceiling(tm1$qx * 10000) / 10000

mas1 <- subset(tm1,   Sexo == "Mujeres")
heligm <- function () {
  ddply(mas1, .(Periodo, Sexo, Depc), function(massu)
  {opt2 <- nlminb(start = parStart, objective = ssqfun,    Observed = massu$qx, x = massu$edadi,                 
                  control= list(eval.max = 200, iter.max = 200  )
                  #                   ,                 lower = c(0,0,0,0,0, 15,0,0), 
                  #                   upper = c(.25, 1, 1, .25, Inf, 55, .01, 1.5) 
  )
  parNLM <- opt2$par
  
  pred2 <- nqxPred(as.list(parNLM), massu$edadi)
  dPred <- with(massu,  data.frame(edadi, qxn = pred2, w="nlminb"))
  list( opt2$par, data.frame(nqxPred(as.list(opt2$par), massu$edadi), massu$edadi, massu$qx)  )
  ajust <- data.frame(matrix(ncol = 1, nrow = length(c(0,1, seq(5, 100, 5)) ) ))
  ajust$edadi <- c(0,1, seq(5, 100, 5))
  ajust$pred2 <- nqxPred(as.list(parNLM), ajust$edadi )
  ajust$Periodo <- unique(massu$Periodo)
  ajust$Depc <- unique(massu$Depc)
  ajust$Sexo <- unique(massu$Sexo)  
  
  dPred <- merge(massu, ajust, by = c('edadi', 'Periodo', 'Depc', 'Sexo'), all = T )
  data.frame(  t(opt2$par), 
               subset(dPred, select = c('edadi', 'pred2', 'qx',
                                        'Periodo', 'Depc', 'Sexo')  ), opt2$objective)
  })
}

hstart <- no("2005 a 2010","Mujeres","BOG"); parStart <- hstart[[1]]; resbm <- heligm()
hstart <- no("1995 a 2000","Mujeres","BOG"); parStart <- hstart[[1]]; resbm2 <- heligm()
hstart <- no("1985 a 1990","Mujeres","BOG"); parStart <- hstart[[1]]; resbm3 <- heligm()
hstart <- no("2005 a 2010","Mujeres","ANT"); parStart <- hstart[[1]]; resbm4 <- heligm()
hstart <- no("1995 a 2000","Mujeres","ANT"); parStart <- hstart[[1]]; resbm5 <- heligm()
hstart <- no("1985 a 1990","Mujeres","ANT"); parStart <- hstart[[1]]; resbm6 <- heligm()
hstart <- no("2005 a 2010","Mujeres","ATL"); parStart <- hstart[[1]]; resbm7 <- heligm()
hstart <- no("1995 a 2000","Mujeres","ATL"); parStart <- hstart[[1]]; resbm8 <- heligm()
hstart <- no("1985 a 1990","Mujeres","ATL"); parStart <- hstart[[1]]; resbm9 <- heligm()
hstart <- no("2005 a 2010","Mujeres","VAC"); parStart <- hstart[[1]]; resbm10 <- heligm()
hstart <- no("1995 a 2000","Mujeres","VAC"); parStart <- hstart[[1]]; resbm11 <- heligm()
hstart <- no("1985 a 1990","Mujeres","VAC"); parStart <- hstart[[1]]; resbm12 <- heligm()
hstart <- no("2005 a 2010","Mujeres","NSA"); parStart <- hstart[[1]]; resbm13 <- heligm()
hstart <- no("1995 a 2000","Mujeres","NSA"); parStart <- hstart[[1]]; resbm14 <- heligm()
hstart <- no("1985 a 1990","Mujeres","NSA"); parStart <- hstart[[1]]; resbm15 <- heligm()
hstart <- no("2005 a 2010","Mujeres","COR"); parStart <- hstart[[1]]; resbm16 <- heligm()
hstart <- no("1995 a 2000","Mujeres","COR"); parStart <- hstart[[1]]; resbm17 <- heligm()
hstart <- no("1985 a 1990","Mujeres","COR"); parStart <- hstart[[1]]; resbm18 <- heligm()
hstart <- no("2005 a 2010","Mujeres","MAG"); parStart <- hstart[[1]]; resbm19 <- heligm()
hstart <- no("1995 a 2000","Mujeres","MAG"); parStart <- hstart[[1]]; resbm20 <- heligm()
hstart <- no("1985 a 1990","Mujeres","MAG"); parStart <- hstart[[1]]; resbm21 <- heligm()
hstart <- no("2005 a 2010","Mujeres","CUN"); parStart <- hstart[[1]]; resbm22 <- heligm()
hstart <- no("1995 a 2000","Mujeres","CUN"); parStart <- hstart[[1]]; resbm23 <- heligm()
hstart <- no("1985 a 1990","Mujeres","CUN"); parStart <- hstart[[1]]; resbm24 <- heligm()
hstart <- no("2005 a 2010","Mujeres","BOL"); parStart <- hstart[[1]]; resbm25 <- heligm()
hstart <- no("1995 a 2000","Mujeres","BOL"); parStart <- hstart[[1]]; resbm26 <- heligm()
hstart <- no("1985 a 1990","Mujeres","BOL"); parStart <- hstart[[1]]; resbm27 <- heligm()
hstart <- no("2005 a 2010","Mujeres","SAN"); parStart <- hstart[[1]]; resbm28 <- heligm()
hstart <- no("1995 a 2000","Mujeres","SAN"); parStart <- hstart[[1]]; resbm29 <- heligm()
hstart <- no("1985 a 1990","Mujeres","SAN"); parStart <- hstart[[1]]; resbm30 <- heligm()
hstart <- no("2005 a 2010","Mujeres","NAR"); parStart <- hstart[[1]]; resbm31 <- heligm()
hstart <- no("1995 a 2000","Mujeres","NAR"); parStart <- hstart[[1]]; resbm32 <- heligm()
hstart <- no("1985 a 1990","Mujeres","NAR"); parStart <- hstart[[1]]; resbm33 <- heligm()
hstart <- no("2005 a 2010","Mujeres","BOY"); parStart <- hstart[[1]]; resbm34 <- heligm()
hstart <- no("1995 a 2000","Mujeres","BOY"); parStart <- hstart[[1]]; resbm35 <- heligm()
hstart <- no("1985 a 1990","Mujeres","BOY"); parStart <- hstart[[1]]; resbm36 <- heligm()
hstart <- no("2005 a 2010","Mujeres","QUI"); parStart <- hstart[[1]]; resbm37 <- heligm()
hstart <- no("1995 a 2000","Mujeres","QUI"); parStart <- hstart[[1]]; resbm38 <- heligm()
hstart <- no("1985 a 1990","Mujeres","QUI"); parStart <- hstart[[1]]; resbm39 <- heligm()
hstart <- no("2005 a 2010","Mujeres","RIS"); parStart <- hstart[[1]]; resbm40 <- heligm()
hstart <- no("1995 a 2000","Mujeres","RIS"); parStart <- hstart[[1]]; resbm41 <- heligm()
hstart <- no("1985 a 1990","Mujeres","RIS"); parStart <- hstart[[1]]; resbm42 <- heligm()
hstart <- no("2005 a 2010","Mujeres","TOL"); parStart <- hstart[[1]]; resbm43 <- heligm()
hstart <- no("1995 a 2000","Mujeres","TOL"); parStart <- hstart[[1]]; resbm44 <- heligm()
hstart <- no("1985 a 1990","Mujeres","TOL"); parStart <- hstart[[1]]; resbm45 <- heligm()
hstart <- no("2005 a 2010","Mujeres","CAL"); parStart <- hstart[[1]]; resbm46 <- heligm()
hstart <- no("1995 a 2000","Mujeres","CAL"); parStart <- hstart[[1]]; resbm47 <- heligm()
hstart <- no("1985 a 1990","Mujeres","CAL"); parStart <- hstart[[1]]; resbm48 <- heligm()
hstart <- no("2005 a 2010","Mujeres","HUI"); parStart <- hstart[[1]]; resbm49 <- heligm()
hstart <- no("1995 a 2000","Mujeres","HUI"); parStart <- hstart[[1]]; resbm50 <- heligm()
hstart <- no("1985 a 1990","Mujeres","HUI"); parStart <- hstart[[1]]; resbm51 <- heligm()
hstart <- no("2005 a 2010","Mujeres","CAU"); parStart <- hstart[[1]]; resbm52 <- heligm()
hstart <- no("1995 a 2000","Mujeres","CAU"); parStart <- hstart[[1]]; resbm53 <- heligm()
hstart <- no("1985 a 1990","Mujeres","CAU"); parStart <- hstart[[1]]; resbm54 <- heligm()
hstart <- no("2005 a 2010","Mujeres","SAP"); parStart <- hstart[[1]]; resbm55 <- heligm()
hstart <- no("1995 a 2000","Mujeres","SAP"); parStart <- hstart[[1]]; resbm56 <- heligm()
hstart <- no("1985 a 1990","Mujeres","SAP"); parStart <- hstart[[1]]; resbm57 <- heligm()
hstart <- no("2005 a 2010","Mujeres","CHO"); parStart <- hstart[[1]]; resbm58 <- heligm()
hstart <- no("1995 a 2000","Mujeres","CHO"); parStart <- hstart[[1]]; resbm59 <- heligm()
hstart <- no("1985 a 1990","Mujeres","CHO"); parStart <- hstart[[1]]; resbm60 <- heligm()
hstart <- no("2005 a 2010","Mujeres","PUT"); parStart <- hstart[[1]]; resbm61 <- heligm()
hstart <- no("1995 a 2000","Mujeres","PUT"); parStart <- hstart[[1]]; resbm62 <- heligm()
hstart <- no("1985 a 1990","Mujeres","PUT"); parStart <- hstart[[1]]; resbm63 <- heligm()
hstart <- no("2005 a 2010","Mujeres","CAQ"); parStart <- hstart[[1]]; resbm64 <- heligm()
hstart <- no("1995 a 2000","Mujeres","CAQ"); parStart <- hstart[[1]]; resbm65 <- heligm()
hstart <- no("1985 a 1990","Mujeres","CAQ"); parStart <- hstart[[1]]; resbm66 <- heligm()
hstart <- no("2005 a 2010","Mujeres","LAG"); parStart <- hstart[[1]]; resbm67 <- heligm()
hstart <- no("1995 a 2000","Mujeres","LAG"); parStart <- hstart[[1]]; resbm68 <- heligm()
hstart <- no("1985 a 1990","Mujeres","LAG"); parStart <- hstart[[1]]; resbm69 <- heligm()
hstart <- no("2005 a 2010","Mujeres","SUC"); parStart <- hstart[[1]]; resbm70 <- heligm()
hstart <- no("1995 a 2000","Mujeres","SUC"); parStart <- hstart[[1]]; resbm71 <- heligm()
hstart <- no("1985 a 1990","Mujeres","SUC"); parStart <- hstart[[1]]; resbm72 <- heligm()
hstart <- no("2005 a 2010","Mujeres","AMA"); parStart <- hstart[[1]]; resbm73 <- heligm()
hstart <- no("1995 a 2000","Mujeres","AMA"); parStart <- hstart[[1]]; resbm74 <- heligm()
hstart <- no("1985 a 1990","Mujeres","AMA"); parStart <- hstart[[1]]; resbm75 <- heligm()
hstart <- no("2005 a 2010","Mujeres","CES"); parStart <- hstart[[1]]; resbm76 <- heligm()
hstart <- no("1995 a 2000","Mujeres","CES"); parStart <- hstart[[1]]; resbm77 <- heligm()
hstart <- no("1985 a 1990","Mujeres","CES"); parStart <- hstart[[1]]; resbm78 <- heligm()
hstart <- no("2005 a 2010","Mujeres","MET"); parStart <- hstart[[1]]; resbm79 <- heligm()
hstart <- no("1995 a 2000","Mujeres","MET"); parStart <- hstart[[1]]; resbm80 <- heligm()
hstart <- no("1985 a 1990","Mujeres","MET"); parStart <- hstart[[1]]; resbm81 <- heligm()
hstart <- no("2005 a 2010","Mujeres","ARA"); parStart <- hstart[[1]]; resbm82 <- heligm()
hstart <- no("1995 a 2000","Mujeres","ARA"); parStart <- hstart[[1]]; resbm83 <- heligm()
hstart <- no("1985 a 1990","Mujeres","ARA"); parStart <- hstart[[1]]; resbm84 <- heligm()


tbm <- rbind(resbm, resbm2, resbm3, resbm4, resbm5, resbm6, resbm7, resbm8, resbm9, resbm10, resbm11, resbm12,
             resbm13, resbm14,   resbm15, resbm16, resbm17, resbm18, resbm19, resbm20, resbm21, 
             resbm22, resbm23, resbm24, resbm25, resbm26, resbm27, resbm28, resbm29, resbm30, resbm31, 
             resbm32, resbm33, resbm34, resbm35, resbm36, resbm37, resbm38, resbm39, resbm40, resbm41, 
             resbm42, resbm43, resbm44, resbm45, resbm46, resbm47, resbm48, resbm49, resbm50, resbm51, 
             resbm52,  resbm53, resbm54, resbm55, resbm56, resbm57, resbm58, resbm59, resbm60, resbm61, 
             resbm62, resbm63, resbm64, resbm65, resbm66, resbm67, resbm68, resbm69, resbm70, resbm71, 
             resbm72, resbm73, resbm74, resbm75, resbm76, resbm77, resbm78, resbm79, resbm80, resbm81, 
             resbm82, resbm83, resbm84 )

tbm <- data.table(tbm)
tbm1 <- tbm[, min(opt2.objective), keyby = .(Periodo, Depc, Sexo) ]
setnames(tbm1, 4, 'opt2.objective')


tbm2 <- merge(tbm, tbm1, by = c('Periodo', 'Depc', 'Sexo', 'opt2.objective'))

partbm <- tbm2[,list(min(a), min(b), min(c), min(d), min(e), min(f), min(g), min(h) ), 
               keyby = .(Periodo, Depc, Sexo)] %>% 
  setnames(. , 4:11, c('a', 'b','c', 'd', 'e','f', 'g', 'h') )



tbm2[, difporc :=  abs (round( (  (pred2 / qx) - 1  ) * 100 ) )]

er.m <- tbm2[, list(round(mean(difporc, na.rm = T), 1)  ) , keyby = list(Depc, Periodo) ]


tv <- ddply(partbm, .(Sexo, Periodo, Depc  ) , function(bd)   {  
  data.frame (0:130, qxPred(as.list(bd[,c('a', 'b','c','d','e','f','g','h')]),   0:130) )
}  )

setnames(tv, c(2,4,5), c('Periodo','edadi', 'qx') )
tv <- data.table(tv);    

# tv$qx <- ceiling(tv$qx * 100000) / 100000


a0s <- tm1[edadi == '0',   c( 'Sexo' ,'edadi' ,  'Periodo', 'Depc','axn' )  , with = F]
tv <- merge(tv, a0s, by =  c('Sexo'  ,  'Periodo','edadi', 'Depc'), all.x = T )
tv$axn[is.na(tv$axn)== T] <- 1/ 2
tv[edadi == 1]$axn <- 0.41
tv[edadi == 2]$axn <- 0.47
tv[edadi == 3]$axn <- 0.48
tv[edadi == 4]$axn <- 0.48


tv$mxn <- 2 *  tv$qx / (2- tv$qx) 

tv[, lxn := round(c(100000, cumprod(1 - qx) * 100000))  , keyby = list(Sexo , Periodo, Depc )]
tv$dxn <- round(tv$lxn * tv$qx);    
tv$Lxn <- tv$lxn - tv$axn * tv$dxn

tv[, Txn := rev( cumsum(rev(Lxn)   )   ) , keyby = list(Sexo , Periodo, Depc)]
tv$exn <- tv$Txn / tv$Lxn 

tvm <- tv



estimate_mode <- function(x) {    d <- density(x) ;   d$x[which.max(d$y)]     }

med <- tv[, wtd.quantile(edadi, .5, weights = dxn) , 
          keyby = list( Periodo, Depc)]
mod <- tv[edadi > 5][, round(estimate_mode(rep(edadi, dxn)),1 ) , 
                     keyby = list( Periodo, Depc )]
ev <- tv[edadi==0][, c('Periodo', 'Depc', 'exn'), with = F][
  , exr := round(exn,1)][ ,c('Periodo', 'Depc', 'exr'), with = F]

iqr <- tv[, list (wtd.quantile(edadi, .25, weights = dxn), wtd.quantile(edadi, .75, weights = dxn)) ,
          keyby = list(Periodo, Depc  )][,IQR := V2-V1][ ,c('Periodo', 'Depc', 'IQR'), with = F]

d10 <- tv[edadi > 10][, round(sqrt(wtd.var( edadi, weights = dxn)),1)  , keyby = list(Periodo, Depc )]


su <- Reduce(function(...) merge(..., by=c('Periodo', 'Depc' ), all=T), list(ev, med, mod, iqr, d10)  )
setnames(su, 3:7, c('ex', 'Med', 'Moda', 'IQR', 'SD10')  )

sum <- su


pruebm <- merge(tm1[Sexo == 'Mujeres'], suh, by = c('Periodo', 'Depc') )
pruebm <- pruebm[edadi == 0][, dif := ex.x - ex.y]

sizet <- 10.5

tbgr <- rbind(tb2, tbm2)


tbgr[, min(opt2.objective), keyby = .(Depc)][order(V1)][, 1, with =F] %>% dput(.)




p<- 
  ggplot(tbgr[Depc %in% c("ANT", "BOG", "VAC", "NSA", "ATL")],  aes(edadi, qx))  + 
  facet_wrap( ~ Depc + Periodo, ncol = 3 ) +    
  geom_vline(xintercept = seq(0, 100, 5), colour = '#f0f0f0', linetype = '22') +   
  geom_vline(xintercept = seq(0, 100, 10), colour = '#EAEAEA', linetype = '22') +   
  geom_vline(xintercept = seq(0, 100, 20), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = c(.001, .001, .01, .1, 1), colour = '#E4E4E4', linetype = '22') + 
  geom_point(size = 2.5, aes(colour = Sexo)) +  
  geom_point( size = 1.5, colour = "white") + 
  geom_line( aes(edadi, pred2, colour = Sexo), size = .8) +
  theme_bw(base_size = 10.5) +   theme(legend.position = 'bottom') +   
  scale_x_continuous(name = "Edad", breaks = seq(0, 100, 20), 
                     limit = c(0, 100), expand = c(.2, 0) ) + 
  scale_y_log10(name=expression(log(paste(''[n], q[x])  ) ) , expand = c(.15, .15),
                limits = c(0.0008, 1), breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))   )  +
  scale_colour_tableau()+
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.text = element_text(size = sizet, family="Helvetica"),  
        legend.title = element_text(size = sizet, family="Helvetica"),
        strip.text = element_text(size = sizet + 1, family="Helvetica"),
        strip.background = element_rect( fill = "white"), panel.margin = unit(0, "lines") ,
        panel.grid = element_blank() ) + annotation_logticks(sides = "l")


p2 <- 
  ggplot(tbgr[Depc %in% c( "CAU",     "BOL", "SAN", "HUI", "MAG")],  aes(edadi, qx))  + 
  facet_wrap( ~ Depc + Periodo, ncol = 3 ) +    
  geom_vline(xintercept = seq(0, 100, 5), colour = '#f0f0f0', linetype = '22') +   
  geom_vline(xintercept = seq(0, 100, 10), colour = '#EAEAEA', linetype = '22') +   
  geom_vline(xintercept = seq(0, 100, 20), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = c(.001, .001, .01, .1, 1), colour = '#E4E4E4', linetype = '22') + 
  geom_point(size = 2.5, aes(colour = Sexo)) +  
  geom_point( size = 1.5, colour = "white") + 
  geom_line( aes(edadi, pred2, colour = Sexo), size = .8) +
  theme_bw(base_size = 10.5) +   theme(legend.position = 'bottom') +   
  scale_x_continuous(name = "Edad", breaks = seq(0, 100, 20), 
                     limit = c(0, 100), expand = c(.2, 0) ) + 
  scale_y_log10(name=expression(log(paste(''[n], q[x])  ) ) , expand = c(.15, .15),
                limits = c(0.0008, 1), breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))   )  +
  scale_colour_tableau()+
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.text = element_text(size = sizet, family="Helvetica"),  
        legend.title = element_text(size = sizet, family="Helvetica"),
        strip.text = element_text(size = sizet + 1, family="Helvetica"),
        strip.background = element_rect( fill = "white"), panel.margin = unit(0, "lines") ,
        panel.grid = element_blank() ) + annotation_logticks(sides = "l")



p3 <- 
  ggplot(tbgr[Depc %in% c("CUN", "BOY", "COR", "CES", "NAR")],  aes(edadi, qx))  + 
  facet_wrap( ~ Depc + Periodo, ncol = 3 ) +    
  geom_vline(xintercept = seq(0, 100, 5), colour = '#f0f0f0', linetype = '22') +   
  geom_vline(xintercept = seq(0, 100, 10), colour = '#EAEAEA', linetype = '22') +   
  geom_vline(xintercept = seq(0, 100, 20), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = c(.001, .001, .01, .1, 1), colour = '#E4E4E4', linetype = '22') + 
  geom_point(size = 2.5, aes(colour = Sexo)) +  
  geom_point( size = 1.5, colour = "white") + 
  geom_line( aes(edadi, pred2, colour = Sexo), size = .8) +
  theme_bw(base_size = 10.5) +   theme(legend.position = 'bottom') +   
  scale_x_continuous(name = "Edad", breaks = seq(0, 100, 20), 
                     limit = c(0, 100), expand = c(.2, 0) ) + 
  scale_y_log10(name=expression(log(paste(''[n], q[x])  ) ) , expand = c(.15, .15),
                limits = c(0.0008, 1), breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))   )  +
  scale_colour_tableau()+
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.text = element_text(size = sizet, family="Helvetica"),  
        legend.title = element_text(size = sizet, family="Helvetica"),
        strip.text = element_text(size = sizet + 1, family="Helvetica"),
        strip.background = element_rect( fill = "white"), panel.margin = unit(0, "lines") ,
        panel.grid = element_blank() ) + annotation_logticks(sides = "l")



p4 <- 
  ggplot(tbgr[Depc %in% c("QUI", "SUC", "CAL", "RIS", "LAG")],  aes(edadi, qx))  + 
  facet_wrap( ~ Depc + Periodo, ncol = 3 ) +    
  geom_vline(xintercept = seq(0, 100, 5), colour = '#f0f0f0', linetype = '22') +   
  geom_vline(xintercept = seq(0, 100, 10), colour = '#EAEAEA', linetype = '22') +   
  geom_vline(xintercept = seq(0, 100, 20), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = c(.001, .001, .01, .1, 1), colour = '#E4E4E4', linetype = '22') + 
  geom_point(size = 2.5, aes(colour = Sexo)) +  
  geom_point( size = 1.5, colour = "white") + 
  geom_line( aes(edadi, pred2, colour = Sexo), size = .8) +
  theme_bw(base_size = 10.5) +   theme(legend.position = 'bottom') +   
  scale_x_continuous(name = "Edad", breaks = seq(0, 100, 20), 
                     limit = c(0, 100), expand = c(.2, 0) ) + 
  scale_y_log10(name=expression(log(paste(''[n], q[x])  ) ) , expand = c(.15, .15),
                limits = c(0.0008, 1), breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))   )  +
  scale_colour_tableau()+
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.text = element_text(size = sizet, family="Helvetica"),  
        legend.title = element_text(size = sizet, family="Helvetica"),
        strip.text = element_text(size = sizet + 1, family="Helvetica"),
        strip.background = element_rect( fill = "white"), panel.margin = unit(0, "lines") ,
        panel.grid = element_blank() ) + annotation_logticks(sides = "l")



p5 <- 
  ggplot(tbgr[Depc %in% c("TOL", "CAQ", "CHO", "PUT",   "MET")],  aes(edadi, qx))  + 
  facet_wrap( ~ Depc + Periodo, ncol = 3 ) +    
  geom_vline(xintercept = seq(0, 100, 5), colour = '#f0f0f0', linetype = '22') +   
  geom_vline(xintercept = seq(0, 100, 10), colour = '#EAEAEA', linetype = '22') +   
  geom_vline(xintercept = seq(0, 100, 20), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = c(.001, .001, .01, .1, 1), colour = '#E4E4E4', linetype = '22') + 
  geom_point(size = 2.5, aes(colour = Sexo)) +  
  geom_point( size = 1.5, colour = "white") + 
  geom_line( aes(edadi, pred2, colour = Sexo), size = .8) +
  theme_bw(base_size = 10.5) +   theme(legend.position = 'bottom') +   
  scale_x_continuous(name = "Edad", breaks = seq(0, 100, 20), 
                     limit = c(0, 100), expand = c(.2, 0) ) + 
  scale_y_log10(name=expression(log(paste(''[n], q[x])  ) ) , expand = c(.15, .15),
                limits = c(0.0008, 1), breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))   )  +
  scale_colour_tableau()+
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.text = element_text(size = sizet, family="Helvetica"),  
        legend.title = element_text(size = sizet, family="Helvetica"),
        strip.text = element_text(size = sizet + 1, family="Helvetica"),
        strip.background = element_rect( fill = "white"), panel.margin = unit(0, "lines") ,
        panel.grid = element_blank() ) + annotation_logticks(sides = "l")



p6 <- 
  ggplot(tbgr[Depc %in% c("AMA", "CAS", "ARA", "SAP")],  aes(edadi, qx))  + 
  facet_wrap( ~ Depc + Periodo, ncol = 3 ) +    
  geom_vline(xintercept = seq(0, 100, 5), colour = '#f0f0f0', linetype = '22') +   
  geom_vline(xintercept = seq(0, 100, 10), colour = '#EAEAEA', linetype = '22') +   
  geom_vline(xintercept = seq(0, 100, 20), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = c(.001, .001, .01, .1, 1), colour = '#E4E4E4', linetype = '22') + 
  geom_point(size = 2.5, aes(colour = Sexo)) +  
  geom_point( size = 1.5, colour = "white") + 
  geom_line( aes(edadi, pred2, colour = Sexo), size = .8) +
  theme_bw(base_size = 10.5) +   theme(legend.position = 'bottom') +   
  scale_x_continuous(name = "Edad", breaks = seq(0, 100, 20), 
                     limit = c(0, 100), expand = c(.2, 0) ) + 
  scale_y_log10(name=expression(log(paste(''[n], q[x])  ) ) , expand = c(.15, .15),
                limits = c(0.0008, 1), breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))   )  +
  scale_colour_tableau()+
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.text = element_text(size = sizet, family="Helvetica"),  
        legend.title = element_text(size = sizet, family="Helvetica"),
        strip.text = element_text(size = sizet + 1, family="Helvetica"),
        strip.background = element_rect( fill = "white"), panel.margin = unit(0, "lines") ,
        panel.grid = element_blank() ) + annotation_logticks(sides = "l")




cairo_pdf(file = "ajusheldepcol1.pdf",  family = "Helvetica",
          width = 8, height = 11.2)
print(p)
dev.off()


cairo_pdf(file = "ajusheldepcol2.pdf",  family = "Helvetica",
          width = 8, height = 11.2)
print(p2)
dev.off()

cairo_pdf(file = "ajusheldepcol3.pdf",  family = "Helvetica",
          width = 8, height = 11.2)
print(p3)
dev.off()


cairo_pdf(file = "ajusheldepcol4.pdf",  family = "Helvetica",
          width = 8, height = 11.2)
print(p4)
dev.off()

cairo_pdf(file = "ajusheldepcol5.pdf",  family = "Helvetica",
          width = 8, height = 11.2)
print(p5)
dev.off()

cairo_pdf(file = "ajusheldepcol6.pdf",  family = "Helvetica",
          width = 8, height = 11.2)
print(p6)
dev.off()


print(xtable(
  partb[, !'Sexo', with =F][order(Depc)][0:33],
  booktabs = TRUE, digits = c(0,0,0,4,4,4,4,3,3,5,3)   ) , 
      include.rownames=FALSE, hline.after = NULL,
      add.to.row = list(pos = list(seq(3, 33,3 )), 
                        command = c(" \\rule{0pt}{3ex}\\noindent")))

print(xtable(
  partb[, !'Sexo', with =F][order(Depc)][34:66],
  booktabs = TRUE, digits = c(0,0,0,4,4,4,4,3,3,5,3)   ) , 
  include.rownames=FALSE, hline.after = NULL,
  add.to.row = list(pos = list(seq(3, 33,3 )), 
                    command = c(" \\rule{0pt}{3ex}\\noindent")))

print(xtable(
  partb[, !'Sexo', with =F][order(Depc)][67:99],
  booktabs = TRUE, digits = c(0,0,0,4,4,4,4,3,3,5,3)   ) , 
  include.rownames=FALSE, hline.after = NULL,
  add.to.row = list(pos = list(seq(3, 33,3 )), 
                    command = c(" \\rule{0pt}{3ex}\\noindent")))


print(xtable(
  partbm[, !'Sexo', with =F][order(Depc)][0:33],
  booktabs = TRUE, digits = c(0,0,0,4,4,4,4,3,3,5,3)   ) , 
  include.rownames=FALSE, hline.after = NULL,
  add.to.row = list(pos = list(seq(3, 33,3 )), 
                    command = c(" \\rule{0pt}{3ex}\\noindent")))

print(xtable(
  partbm[, !'Sexo', with =F][order(Depc)][34:66],
  booktabs = TRUE, digits = c(0,0,0,4,4,4,4,3,3,5,3)   ) , 
  include.rownames=FALSE, hline.after = NULL,
  add.to.row = list(pos = list(seq(3, 33,3 )), 
                    command = c(" \\rule{0pt}{3ex}\\noindent")))

print(xtable(
  partbm[, !'Sexo', with =F][order(Depc)][67:99],
  booktabs = TRUE, digits = c(0,0,0,4,4,4,4,3,3,5,3)   ) , 
  include.rownames=FALSE, hline.after = NULL,
  add.to.row = list(pos = list(seq(3, 33,3 )), 
                    command = c(" \\rule{0pt}{3ex}\\noindent")))

# partb$Periodo <- factor(partb$Periodo, c("1985 a 1990", "1995 a 2000", "2005 a 2010"),
#                         c("85/90", "95/00", "05/10") )

# 
# pmc <-  rbind(partb, partbm) %>%  melt(.) %>%
# dcast(., Depc ~ Sexo + Periodo + variable) 
#   row.names(pmc) <- pmc$Depc
#   setnames(pmc, )
#   pmc <- subset(pmc, select = -c(Depc))
# 
# MFA(pmc, group = c( rep(8, 2*3) ), type = c(  rep('c', 6 ) ), ncp = 2,
#     name.group=c("H85/90","H95/00","H05/10",
#                  "M85/90","M95/00","M05/10") )
# 
# 
#   pmch <-partb %>%  melt(.) %>%
#     dcast(., Depc ~ Sexo + Periodo + variable) 
#   row.names(pmch) <- pmch$Depc
#   pmch <- subset(pmch, select = -c(Depc))
#   
#   MFA(pmch, group = c( rep(8, 3) ), type = c(  rep('c', 3 ) ), ncp = 2,
#       name.group=c("H_1985/90","H_1995/00","H_2005/10") )
  
  
setnames(partb, 4:11, c('A', 'B', 'C', 'D', 'E', 'F', 'G', 'H')  )
setnames(partbm, 4:11, c('A', 'B', 'C', 'D', 'E', 'F', 'G', 'H')  )

res85h.pca <- PCA( partb[Periodo == '1985 a 1990' ][,4:11, with = F]  )
res95h.pca <- PCA( partb[Periodo == '1995 a 2000' ][,4:11, with = F]  )
res05h.pca <- PCA( partb[Periodo == '2005 a 2010' ][,4:11, with = F] )
res85m.pca <- PCA( partbm[Periodo == '1985 a 1990' ][,4:11, with = F]  )
res95m.pca <- PCA( partbm[Periodo == '1995 a 2000' ][,4:11, with = F]  )
res05m.pca <- PCA( partbm[Periodo == '2005 a 2010' ][,4:11, with = F] )



# plot(res85h.pca, quali.sup=2)



cairo_pdf(file = "factorialpar.pdf",  family = "Helvetica",
          width = 8, height = 6)
par(mfrow=c(2, 3))
plot(res85h.pca, choix="var", title = 'Hombres. 1985/90')
plot(res95h.pca, choix="var", title = 'Hombres. 1995/00')
plot(res05h.pca, choix="var", title = 'Hombres. 2005/10')
plot(res85m.pca, choix="var", title = 'Mujeres. 1985/90')
plot(res95m.pca, choix="var", title = 'Mujeres. 1995/00')
plot(res05m.pca, choix="var", title = 'Mujeres. 2005/10')
dev.off()

library(ggdendro)

h85 <- partb[Periodo == '1985 a 1990' ]
h85 <- data.frame(h85)
row.names(h85) <- h85$Depc
  h85 <- scale(h85[, c(4,7,10)] )
hc85h <- hclust(dist(h85))
p1 <- 
  ggdendrogram(hc85h, rotate = T) + ggtitle ('1985/90') + 
  theme(axis.text.y = element_text(size = sizet,  family="Helvetica",
                                   colour =  rev(c("#1f78b4", "black", "black", "#1f78b4", "black", "#33a02c", "#33a02c", 
                                               "#33a02c", "#33a02c", "#33a02c", "#33a02c", "#33a02c", "black", "#33a02c", 
                                               "#e31a1c", "#e31a1c", "#33a02c", "#33a02c", "black", "#e31a1c", "#e31a1c", 
                                               "#e31a1c", "#6a3d9a", "#6a3d9a", "#6a3d9a", "#6a3d9a", "#6a3d9a", "black", 
                                               "#b15928", "#b15928", "black", "black", "black") )) ,
        title = element_text(size = sizet + 1, family="Helvetica",colour = '#252525'),
        axis.text.x = element_text(size = sizet,  family="Helvetica")  ) +
  geom_hline(yintercept = 2, colour = '#b2182b', linetype = 'dashed')

h95 <- partb[Periodo == '1995 a 2000' ]
h95 <- data.frame(h95)
row.names(h95) <- h95$Depc
h95 <- scale(h95[, c(4,7,10)] )
hc95h <- hclust(dist(h95))
p2 <-
  ggdendrogram(hc95h, rotate = T) + ggtitle ('1995/00')+ 
  theme(axis.text.y = element_text(size = sizet,  family="Helvetica",
                                   colour =  rev(c("#6a3d9a", "#6a3d9a", "#6a3d9a", "#6a3d9a", "#6a3d9a", "black", "black", 
                                                   "black", "#e31a1c", "#b15928", "#e31a1c", "#e31a1c", "#e31a1c", "#1f78b4", 
                                                   "#b15928", "black", "black", "black", "#e31a1c", "#1f78b4", "black", 
                                                   "#33a02c", "#33a02c", "#33a02c", "#33a02c", "#33a02c", "#33a02c", "#33a02c", 
                                                   "#33a02c", "#33a02c", "#33a02c", "black", "black") )) ,
        title = element_text(size = sizet + 1, family="Helvetica",colour = '#252525'),
        axis.text.x = element_text(size = sizet,  family="Helvetica")  )  +
  geom_hline(yintercept = 2, colour = '#b2182b', linetype = 'dashed')

h05 <- partb[Periodo == '2005 a 2010' ]
h05 <- data.frame(h05)
row.names(h05) <- h05$Depc
h05 <-  scale(h05[, c(4,7,10)] )
hc05h <- hclust(dist(h05))
p3 <-
  ggdendrogram(hc05h, rotate = T) + ggtitle ('2005/10')+ 
  theme(axis.text.y = element_text(size = sizet,  family="Helvetica",
                                   colour =  rev(c("#b15928", "#e31a1c", "#e31a1c", "#e31a1c", "#e31a1c", "black", "#b15928", 
                                                   "black", "#e31a1c", "black", "black", "#33a02c", "#33a02c", "#33a02c", 
                                                   "#33a02c", "#33a02c", "#33a02c", "#33a02c", "black", "black", "#33a02c", 
                                                   "#1f78b4", "#1f78b4", "#33a02c", "#33a02c", "#6a3d9a", "#6a3d9a", "#6a3d9a", 
                                                   "#6a3d9a", "#6a3d9a", "black", "black", "black") )) ,
        title = element_text(size = sizet + 1, family="Helvetica",colour = '#252525'),
        axis.text.x = element_text(size = sizet,  family="Helvetica")  )  +
  geom_hline(yintercept = 2, colour = '#b2182b', linetype = 'dashed')

m85 <- partbm[Periodo == '1985 a 1990' ]
m85 <- data.frame(m85)
row.names(m85) <- m85$Depc
m85 <-  scale(m85[, c(4,7,10)] )
hc85m <- hclust(dist(m85))
p4 <- ggdendrogram(hc85m, rotate = T) + ggtitle ('1985/90')+ 
  theme(axis.text.y = element_text(size = sizet,  family="Helvetica",
                                   colour =  rev(c("#6a3d9a", "#6a3d9a", "#6a3d9a", "#6a3d9a", "#6a3d9a", "black", "black", 
                                                   "black", "#33a02c", "#33a02c", "#33a02c", "black", "black", "#33a02c", 
                                                   "#33a02c", "#33a02c", "black", "#33a02c", "#33a02c", "#33a02c", "#33a02c", 
                                                   "#33a02c", "#33a02c", "#33a02c", "black", "#e31a1c", "black", "#e31a1c", 
                                                   "#b15928", "black", "#b15928", "black", "black") )) ,
        title = element_text(size = sizet + 1, family="Helvetica",colour = '#252525'),
        axis.text.x = element_text(size = sizet,  family="Helvetica")  )  +
  geom_hline(yintercept = 2, colour = '#b2182b', linetype = 'dashed')

m95 <- partbm[Periodo == '1995 a 2000' ]
m95 <- data.frame(m95)
row.names(m95) <- m95$Depc
m95 <-  scale(m95[, c(4,7,10)] )
hc95m <- hclust(dist(m95))
p5 <- 
  ggdendrogram(hc95m, rotate = T) + ggtitle ('1995/00')+ 
  theme(axis.text.y = element_text(size = sizet,  family="Helvetica",
                                   colour =  rev(c("#33a02c", "#e31a1c", "#33a02c", "#33a02c", "#33a02c", "black", "black", 
                  "black", "black", "#33a02c", "black", "black", "#33a02c", "#33a02c", 
                  "#33a02c", "#33a02c",  "#33a02c","#e31a1c", "#33a02c", "#33a02c", "#33a02c", 
                  "black", "#6a3d9a", "#6a3d9a", "#6a3d9a", "#6a3d9a", "#6a3d9a", "black", 
                  "#b15928", "black", "#b15928", "black", "black") )) ,
title = element_text(size = sizet + 1, family="Helvetica",colour = '#252525'),
        axis.text.x = element_text(size = sizet,  family="Helvetica")  )  +
  geom_hline(yintercept = 2, colour = '#b2182b', linetype = 'dashed')

m05 <- partbm[Periodo == '2005 a 2010' ]
m05 <- data.frame(m05)
row.names(m05) <- m05$Depc
m05 <-  scale(m05[, c(4,7,10)] )
hc05m <- hclust(dist(m05))
p6 <- 
  ggdendrogram(hc05m, rotate = T) + ggtitle ('2005/10')+ 
  theme(axis.text.y = element_text(size = sizet,  family="Helvetica",
                                   colour =  rev(c("#33a02c", "#33a02c", "#e31a1c", "#33a02c", "#33a02c", "#33a02c", "#e31a1c", 
                  "#33a02c", "#33a02c", "#33a02c", "#33a02c", "#33a02c", "#33a02c", "#33a02c", 
                  "#6a3d9a", "#6a3d9a", "#6a3d9a", "#6a3d9a", "#6a3d9a", "black", "black", 
                  "black", "#b15928", "black", "#b15928", "black", "black", "black", 
                  "#33a02c", "black", "black", "black", "black") )) ,
title = element_text(size = sizet + 1, family="Helvetica",colour = '#252525'),
        axis.text.x = element_text(size = sizet,  family="Helvetica")  ) +
  geom_hline(yintercept = 2, colour = '#b2182b', linetype = 'dashed')


sizet <- 12

p7 <- ggplot(  ) + theme_bw()   + 
  scale_colour_tableau() + facet_wrap( ~ Periodo) +
  geom_line(data = tvh,
            aes( edadi, qx, group = Depc, colour ='Grupo 1') , size = .5, colour = 'gray' )    +
   geom_line(data = tvh[  Depc %in% c('BOG', 'CUN', 'ATL', 'SUC', 'BOL', 'MAG', 'COR', 'NAR',
                                     'HUI', 'BOY')  ],
            aes( edadi, qx, group = Depc, colour ='Grupo 4') , size = .5, colour = '#33a02c' )  +
  geom_line(data = tvh[  Depc %in% c('RIS', 'CAL', 'VAC', 'NSA', 'QUI')  ],
            aes( edadi, qx, group = Depc, colour ='Grupo 2') , size = .5, colour = '#e31a1c' )  +
  geom_line(data = tvh[  Depc %in% c('CAS', 'MET')  ],
            aes( edadi, qx, group = Depc, colour ='Grupo 5') , size = .5, colour = '#b15928' )  + 
  geom_line(data = tvh[  Depc %in% c('AMA')  ],
            aes( edadi, qx, group = Depc, colour ='Grupo 6') , size = .5, colour = '#6a3d9a' )  + 
  geom_line(data = tvh[  Depc %in% c('CES', 'CAU')  ],
            aes( edadi, qx, group = Depc, colour ='Grupo 3') , size = .5, colour = '#1f78b4' ) +
    theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.text = element_text(size = sizet, family="Helvetica"),  
        legend.title = element_text(size = sizet, family="Helvetica"),
        strip.text = element_text(size = sizet + 1, family="Helvetica"),
        strip.background = element_rect( fill = "white"), panel.margin = unit(0, "lines") ,
        panel.grid = element_blank() ) + annotation_logticks(sides = "l") +
  scale_x_continuous(name = "Edad", breaks = seq(0, 100, 20), 
                     limit = c(0, 100), expand = c(.2, 0) ) + 
  scale_y_log10(name=expression(log(paste(''[n], q[x])  ) ) , expand = c(.1, .1),
                limits = c(0.0001, 1), breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))   ) 


p8 <- 
  ggplot(  ) + theme_bw()   + 
  scale_colour_tableau() + facet_wrap( ~ Periodo) +
  geom_line(data = tvm,
            aes( edadi, qx, group = Depc, colour ='Grupo 1') , size = .5, colour = 'gray' )    +
   geom_line(data = tvm[  Depc %in% c('SUC', 'BOG', 'SAN', 'BOY', 'NSA', 'CUN', 'QUI',
                                      'CAL', 'ANT', 'ATL', 'VAC', 'TOL', 'NAR')  ],
            aes( edadi, qx, group = Depc, colour ='Grupo 4') , size = .5, colour = '#33a02c' )  +
  geom_line(data = tvm[  Depc %in% c('RIS', 'CES')  ],
            aes( edadi, qx, group = Depc, colour ='Grupo 2') , size = .5, colour = '#e31a1c' )  +
  geom_line(data = tvm[  Depc %in% c('CAU', 'ARA')  ],
            aes( edadi, qx, group = Depc, colour ='Grupo 5') , size = .5, colour = '#b15928' )  + 
  geom_line(data = tvm[  Depc %in% c('AMA')  ],
            aes( edadi, qx, group = Depc, colour ='Grupo 6') , size = .5, colour = '#6a3d9a' )  + 
   theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.text = element_text(size = sizet, family="Helvetica"),  
        legend.title = element_text(size = sizet, family="Helvetica"),
        strip.text = element_text(size = sizet + 1, family="Helvetica"),
        strip.background = element_rect( fill = "white"), panel.margin = unit(0, "lines") ,
        panel.grid = element_blank() ) + annotation_logticks(sides = "l") +
  scale_x_continuous(name = "Edad", breaks = seq(0, 100, 20), 
                     limit = c(0, 100), expand = c(.2, 0) ) + 
  scale_y_log10(name=expression(log(paste(''[n], q[x])  ) ) , expand = c(.1, .1),
                limits = c(0.0001, 1), breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))   ) 
# grid.arrange( arrangeGrob(p1, p2, p3, nrow = 1), p7    )


cairo_pdf(file = "grpparhelhomdep.pdf",  family = "Helvetica",   width = 8, height = 7.5)
grid.arrange(p1, p2, p3, nrow = 1)
dev.off()

cairo_pdf(file = "grpparhelhomdep2.pdf",  family = "Helvetica",   width = 8, height = 3.5)
print(p7)
dev.off()

cairo_pdf(file = "grpparhelmujdep.pdf",  family = "Helvetica",     width = 8, height = 7.5)
grid.arrange(p4, p5,  p6, nrow = 1)
dev.off()

cairo_pdf(file = "grpparhelmujdep2.pdf",  family = "Helvetica",     width = 8, height = 3.5)
print(p8)
dev.off()


# ***PRUEBAS Y ANEXOS ***--------------------------------------------------------




# COL ranking enfermedades---------------------------------------------------------------

resd <- function(anio){
  fil <- paste("DEFU", anio, ".txt", sep="")
  bd <- fread(fil,  header = TRUE, colClasses = "string")
  bd <- data.table(bd)
  setnames(bd, names(bd), toupper(names(bd))   )
  
  if(any(names(bd) == "CAU_HOMO")) {setnames(bd, "CAU_HOMO", "CAU_HOMOL")}
  
  bdo <- bd[,.N, keyby = list(SEXO, CAU_HOMOL)][ 
    ,Porcentaje := N * 100  / sum(N), keyby = list(SEXO)]
  
  bdo$anio <- anio  
  print(as.data.frame(bdo))
}

def <- resd(1980)  
for(i in 1981:2010){   def <- rbind(resd(i), def)   }

cod <- read.xlsx2(file = "Lista_105_Colombia_CIE9-y-CIE10.xls",   1)
def$CAU_HOMOL <- as.numeric(as.character(def$CAU_HOMOL ))
cod$CAU_HOMOL <- as.numeric(as.character(cod$CAU_HOMOL ))

defb <- merge(def, cod , by = 'CAU_HOMOL')
defb$aniog <- cut(defb$anio, breaks = seq(1980,2010, 5))
defb$aniog <- factor(defb$aniog, c("(1980,1985]", "(1985,1990]", "(1990,1995]", "(1995,2000]", 
                                   "(2000,2005]",   "(2005,2010]"),
                     c("1981-1985","1986-1990", "1991-1995", "1996-2000", "2001-2005", "2006-2010"))
defb$SEXOb <- factor(defb$SEXO, 1:2, c('H','M'))
defb <- subset(defb, is.na(SEXOb) == FALSE & is.na(aniog) == FALSE )
defb <- data.table(defb)

defd <- defb[, sum(N), keyby = list(SEXOb, Causa, aniog)][ 
  ,Porcentaje := V1 * 100  / sum(V1), keyby = list(SEXOb, aniog)][
    Causa != "Signos, síntomas y afecciones mal definidas"]

pr1 <-defd[order(-Porcentaje, SEXOb, aniog)][, head(.SD,10), by=list(SEXOb, aniog)]

sizet <- 8

p1 <- ggplot(pr1[SEXOb == 'H' & aniog == "1981-1985"] , aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0,30,5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0,30,10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0,30), breaks = seq(0,30,5) )+
  theme_bw(base_size = sizet) + ylab('') +   
  geom_point(size = 3,   colour = rev(c( '#6a3d9a', 'black','#d7301f','black','#1f78b4',
                                 '#6a3d9a','#d7301f','#6a3d9a','#6a3d9a','#d7301f')) ) + 
  geom_point(size = 1.5, colour = 'white') +
theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                 colour = c( '#6a3d9a', 'black','#d7301f',  'black','#1f78b4',
                                               '#6a3d9a','#d7301f','#6a3d9a','#6a3d9a','#d7301f') ),
        axis.text.x = element_text(size = sizet, family="Helvetica" ),   panel.grid = element_blank(),
title = element_text(size = sizet + 1, family="Helvetica")  ) +   ggtitle('1981-1985') 

p2 <- ggplot(pr1[SEXOb == 'H' & aniog == "2001-2005"]  ,  
             aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0,30,5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0,30,10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0,30), breaks = seq(0,30,5))+
  theme_bw(base_size = sizet) + ylab('') + 
  geom_point(size = 3, colour = rev(c( 'black', '#6a3d9a','black','#1f78b4','#b15928',
                                       '#d7301f','#1f78b4','#6a3d9a','#6a3d9a','#d7301f'))) +   
  geom_point(size = 1.5, colour = 'white') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c( 'black', '#6a3d9a','black','#1f78b4','#b15928',
                                               '#d7301f','#1f78b4','#6a3d9a','#6a3d9a','#d7301f') ),
        axis.text.x = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank(),
        title = element_text(size = sizet + 1, family="Helvetica")   ) +
  ggtitle('2001-2005') 

p3 <- ggplot(pr1[SEXOb == 'H' & aniog == "1991-1995"]  ,  
             aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0,30,5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0,30,10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0,30), breaks = seq(0,30,5))+
  theme_bw(base_size = sizet) + ylab('') + 
  geom_point(size = 3, colour = rev(c( '#6a3d9a', 'black','#d7301f','#1f78b4','#6a3d9a',
                                       '#1f78b4','#d7301f','#6a3d9a','#6a3d9a','#d7301f'))) + 
  geom_point(size = 1.5, colour = 'white') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c( '#6a3d9a', 'black','#d7301f','#1f78b4','#6a3d9a',
                                               '#1f78b4','#d7301f','#6a3d9a','#6a3d9a','#d7301f') ),
        axis.text.x = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank(),
        title = element_text(size = sizet + 1, family="Helvetica")   ) +
  ggtitle('1991-1995') 

p4 <- ggplot(pr1[SEXOb == 'H' & aniog == "2006-2010"]  ,  
             aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0,30,5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0,30,10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0,30), breaks = seq(0,30,5))+
  theme_bw(base_size = sizet) + ylab('') + 
  geom_point(size = 3, colour = rev(c( 'black', '#6a3d9a','black','#b15928','#1f78b4',
                                       '#d7301f','#1f78b4','#6a3d9a','#6a3d9a','#d7301f'))) +   
  geom_point(size = 1.5, colour = 'white') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c( 'black', '#6a3d9a','black','#b15928','#1f78b4',
                                               '#d7301f','#1f78b4','#6a3d9a','#6a3d9a','#d7301f') ),
        axis.text.x = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank(),
        title = element_text(size = sizet + 1, family="Helvetica")   ) +
  ggtitle('2006-2010') 

# Arrange the two charts.
# The legend boxes are centered

cairo_pdf(file = "pruebaenf.pdf",   width = 8, height = 8,     family="Helvetica" )
grid.newpage()
grid.draw(cbind(rbind(ggplotGrob(p1), ggplotGrob(p2), size="last"), 
                rbind(ggplotGrob(p3), ggplotGrob(p4), size="last"), size = "first"))
dev.off()

pr1[SEXOb == 'H' & Causa == "Homicidios" & aniog %in% c('1981-1985', '1991-1995', '2001-2005',
                                                        '2006-2010')][order(aniog)]

pr1[SEXOb == 'H' & Causa == "Enf. isquémicas del corazón" & 
      aniog %in% c('1981-1985', '1991-1995', '2001-2005',      '2006-2010')][order(aniog)]

pr1[SEXOb == 'H' & Causa == "Enf. cerebrovasculares" & 
      aniog %in% c('1981-1985', '1991-1995', '2001-2005',      '2006-2010')][order(aniog)]


pr1[SEXOb == 'H' & Causa %in% c("Homicidios", "Accidentes de transporte de motor" ) & 
      aniog %in% c('1981-1985', '1991-1995', '2001-2005',      '2006-2010')][
        , sum(Porcentaje)      , keyby = list(aniog)]

pr1[SEXOb == 'H' & Causa %in% c("Enf. cerebrovasculares", "Enf. isquémicas del corazón", 
                                "Insuficiencia cardíaca") & 
      aniog %in% c('1981-1985', '1991-1995', '2001-2005',      '2006-2010')][
        , sum(Porcentaje)      , keyby = list(aniog)]



p1 <- ggplot(pr1[SEXOb == 'M' & aniog == "1981-1985"]  ,  
             aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0,30,5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0,30,10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0,30), breaks = seq(0,30,5) )+
  theme_bw(base_size = sizet) + ylab('') + 
  geom_point(size = 3, colour = rev(c( 'black', '#1f78b4','black','#b15928','black',
                                       '#6a3d9a','#1f78b4','#6a3d9a','#6a3d9a','#6a3d9a'))) + 
  geom_point(size = 1.5, colour = 'white') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c( 'black', '#1f78b4','black','#b15928','black',
                                               '#6a3d9a','#1f78b4','#6a3d9a','#6a3d9a','#6a3d9a') ),
        axis.text.x = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank(),
        title = element_text(size = sizet + 1, family="Helvetica") 
  ) +
  ggtitle('1981-1985') 

p2 <- ggplot(pr1[SEXOb == 'M' & aniog == "2001-2005"]  ,  
             aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0,30,5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0,30,10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0,30), breaks = seq(0,30,5))+
  theme_bw(base_size = sizet) + ylab('') + 
  geom_point(size = 3, colour = rev(c( 'black', 'black','black','#d7301f','#1f78b4',
                                       '#6a3d9a','#b15928','#1f78b4','#6a3d9a','#6a3d9a'))) + 
  geom_point(size = 1.5, colour = 'white') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c( 'black', 'black','black','#d7301f','#1f78b4',
                                               '#6a3d9a','#b15928','#1f78b4','#6a3d9a','#6a3d9a') ),
        axis.text.x = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank(),
        title = element_text(size = sizet + 1, family="Helvetica")   ) +
  ggtitle('2001-2005') 

p3 <- ggplot(pr1[SEXOb == 'M' & aniog == "1991-1995"]  ,  
             aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0,30,5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0,30,10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0,30), breaks = seq(0,30,5))+
  theme_bw(base_size = sizet) + ylab('') + 
  geom_point(size = 3, colour = rev(c( 'black', 'black','#d7301f','#b15928','#1f78b4',
                                       '#1f78b4','#6a3d9a','#6a3d9a','#6a3d9a','#6a3d9a'))) + 
  geom_point(size = 1.5, colour = 'white') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c( 'black', 'black','#d7301f','#b15928','#1f78b4',
                                               '#1f78b4','#6a3d9a','#6a3d9a','#6a3d9a','#6a3d9a') ),
        axis.text.x = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank(),
        title = element_text(size = sizet + 1, family="Helvetica")   ) +
  ggtitle('1991-1995') 

p4 <- ggplot(pr1[SEXOb == 'M' & aniog == "2006-2010"]  ,  
             aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0,30,5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0,30,10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0,30), breaks = seq(0,30,5))+
  theme_bw(base_size = sizet) + ylab('') + 
  geom_point(size = 3, colour = rev(c( 'black', '#6a3d9a','black','black','#1f78b4',
                                       '#6a3d9a','#b15928','#1f78b4','#6a3d9a','#6a3d9a'))) + 
  geom_point(size = 1.5, colour = 'white') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c( 'black', '#6a3d9a','black','black','#1f78b4',
                                               '#6a3d9a','#b15928','#1f78b4','#6a3d9a','#6a3d9a') ),
        axis.text.x = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank(),
        title = element_text(size = sizet + 1, family="Helvetica")   ) +
  ggtitle('2006-2010') 

# Arrange the two charts.
# The legend boxes are centered

cairo_pdf(file = "pruebaenfmuj.pdf",   width = 8, height = 8,     family="Helvetica" )
grid.newpage()
grid.draw(cbind(rbind(ggplotGrob(p1), ggplotGrob(p2), size="last"), 
                rbind(ggplotGrob(p3), ggplotGrob(p4), size="last"), size = "first"))
dev.off()

pr1[SEXOb == 'M' & Causa == "Enf. cerebrovasculares" & 
      aniog %in% c('1981-1985', '1991-1995', '2001-2005',      '2006-2010')][order(aniog)]


pr1[SEXOb == 'M' & Causa == "Enf. isquémicas del corazón" & 
      aniog %in% c('1981-1985', '1991-1995', '2001-2005',      '2006-2010')][order(aniog)]

pr1[SEXOb == 'M' & Causa == "Insuficiencia cardíaca" & aniog %in% c('1981-1985', '1991-1995', '2001-2005',
                                                        '2006-2010')][order(aniog)]

pr1[SEXOb == 'M' & Causa == "Enf. Crónicas vías resp. inferiores" & aniog %in% c('1981-1985', '1991-1995', '2001-2005',
                                                                    '2006-2010')][order(aniog)]

pr1[SEXOb == 'M' & Causa == "Homicidios" & 
      aniog %in% c('1981-1985', '1991-1995', '2001-2005',
                   '2006-2010')][order(aniog)]

pr1[SEXOb == 'M' & Causa %in% c("Homicidios", "Accidentes de transporte de motor" ) & 
      aniog %in% c('1981-1985', '1991-1995', '2001-2005',      '2006-2010')][
        , sum(Porcentaje)      , keyby = list(aniog)]

pr1[SEXOb == 'M' & Causa %in% c("Enf. cerebrovasculares ", "Enf. isquémicas del corazón ", 
                                "Insuficiencia cardíaca") & 
      aniog %in% c('1981-1985', '1991-1995', '2001-2005',      '2006-2010')][
        , sum(Porcentaje)      , keyby = list(aniog)]


# COL ranking enfermedades edad ---------------------------------------------------------------
resd <- function(anio){
  fil <- paste("DEFU", anio, ".txt", sep="")
  bd <- fread(fil,  header = TRUE, colClasses = "string")
  bd <- data.table(bd)
  
  setnames(bd, names(bd), toupper(names(bd))   )
  
  bd$EDAD <- as.numeric(bd$EDAD)
  
  bd <- as.data.frame(bd)
  bd$EDAD2 <- rep(NA,nrow(bd))
  
  bd[which( bd$EDAD %in% 1:99 ), ]$EDAD2  <- bd[which( bd$EDAD %in% 1:99 ), ]$EDAD
  bd[which( bd$GRU_ED1 %in% c('01','02','03','04','05') ), ]$EDAD2  <- 0
  
  bd <- data.table(bd)
  bd$EDAD <- bd$EDAD2
  
  bdo <- bd[,.N, keyby = list(SEXO, CAU_HOMOL, EDAD)]
  
  bdo$anio <- anio  
  print(as.data.frame(bdo))
}

def <- resd(1980)  
for(i in 1981:1997){   def <- rbind(resd(i), def)   }

resdb <- function(anio){
  fil <- paste("DEFU", anio, ".txt", sep="")
  bd <- fread(fil,  header = TRUE, colClasses = "string")
  bd <- data.table(bd)
  
  setnames(bd, names(bd), toupper(names(bd))   )
  
  bd$EDAD <- as.numeric(bd$EDAD)
  
  bd$EDAD2 <- NA  
  bd$EDAD2 <- recode( bd$EDAD, "100:311 = 0; 312:399=1; c(400,499,999)=NA;
                      402 =02 ; 403 =03 ; 404 =04 ; 405 =05 ; 406 =06 ;
                      407 =07 ; 408 =08 ; 409 =09 ; 410 =10 ; 411 =11 ; 412 =12 
                      ; 413 =13 ; 414 =14 ; 415 =15 ; 416 =16 ; 417 =17 ; 418 =18 ; 419 =19 ;
                      420 =20 ; 421 =21 ; 422 =22 ; 423 
                      =23 ; 424 =24 ; 425 =25 ; 426 =26 ; 427 =27 ; 428 =28 ; 429 =29 ; 430 =30 ; 
                      431 =31 ; 432 =32 ; 433 =33 ; 
                      434 =34 ; 435 =35 ; 436 =36 ; 437 =37 ; 438 =38 ; 439 =39 ; 440 =40 ; 441 =41 ;
                      442 =42 ; 443 =43 ; 444 =44 
                      ; 445 =45 ; 446 =46 ; 447 =47 ; 448 =48 ; 449 =49 ; 450 =50 ; 451 =51 ; 452 =52 ;
                      453 =53 ; 454 =54 ; 455 
                      =55 ; 456 =56 ; 457 =57 ; 458 =58 ; 459 =59 ; 460 =60 ; 461 =61 ; 462 =62 ; 463 =63 ; 
                      464 =64 ; 465 =65 ; 
                      466 =66 ; 467 =67 ; 468 =68 ; 469 =69 ; 470 =70 ; 471 =71 ; 472 =72 ; 473 =73 ; 
                      474 =74 ; 475 =75 ; 476 =76 
                      ; 477 =77 ; 478 =78 ; 479 =79 ; 480 =80 ; 481 =81 ; 482 =82 ; 483 =83 ; 484 =84 ; 
                      485 =85 ; 486 =86 ; 487 
                      =87 ; 488 =88 ; 489 =89 ; 490 =90 ; 491 =91 ; 492 =92 ; 493 =93 ; 494 =94 ;
                      495 =95 ; 496 =96 ; 497 =97 ; 
                      498 =98")
  
  
  bdo <- bd[,.N, keyby = list(SEXO, CAU_HOMOL, EDAD2)]
  
  setnames(bdo, 'EDAD2','EDAD')
  
  bdo$anio <- anio  
  print(as.data.frame(bdo))
}

defb <- resdb(1998)  
for(i in 1999:2007){   defb <- rbind(resdb(i), defb)   }

resdc <- function(anio){
  fil <- paste("DEFU", anio, ".txt", sep="")
  bd <- fread(fil,  header = TRUE, colClasses = "string")
  bd <- data.table(bd)
  
  setnames(bd, names(bd), toupper(names(bd))   )
  if(any(names(bd) == "CAU_HOMO")) {setnames(bd, "CAU_HOMO", "CAU_HOMOL")}
  
  bd$EDAD <- as.numeric(bd$EDAD)
  bd$EDAD2 <- NA
  
  bd$EDAD2 <- recode( bd$EDAD, "0:4000 = 0;  c(4000,9999,4999)=NA;
                      4001=001 ; 4002=002 ; 4003=003 ; 4004=004 ; 4005=005 ; 4006=006 ; 4007=007 ; 4008=008 ; 4009=009 ; 4010=010 
                      ; 4011=011 ; 4012=012 ; 4013=013 ; 4014=014 ; 4015=015 ; 4016=016 ; 4017=017 ; 4018=018 ; 4019=019 ; 
                      4020=020 ; 4021=021 ; 4022=022 ; 4023=023 ; 4024=024 ; 4025=025 ; 4026=026 ; 4027=027 ; 4028=028 ; 4029=029 
                      ; 4030=030 ; 4031=031 ; 4032=032 ; 4033=033 ; 4034=034 ; 4035=035 ; 4036=036 ; 4037=037 ; 4038=038 ; 
                      4039=039 ; 4040=040 ; 4041=041 ; 4042=042 ; 4043=043 ; 4044=044 ; 4045=045 ; 4046=046 ; 4047=047 ; 4048=048 
                      ; 4049=049 ; 4050=050 ; 4051=051 ; 4052=052 ; 4053=053 ; 4054=054 ; 4055=055 ; 4056=056 ; 4057=057 ; 
                      4058=058 ; 4059=059 ; 4060=060 ; 4061=061 ; 4062=062 ; 4063=063 ; 4064=064 ; 4065=065 ; 4066=066 ; 4067=067 
                      ; 4068=068 ; 4069=069 ; 4070=070 ; 4071=071 ; 4072=072 ; 4073=073 ; 4074=074 ; 4075=075 ; 4076=076 ; 
                      4077=077 ; 4078=078 ; 4079=079 ; 4080=080 ; 4081=081 ; 4082=082 ; 4083=083 ; 4084=084 ; 4085=085 ; 4086=086 
                      ; 4087=087 ; 4088=088 ; 4089=089 ; 4090=090 ; 4091=091 ; 4092=092 ; 4093=093 ; 4094=094 ; 4095=095 ; 
                      4096=096 ; 4097=097 ; 4098=098 ; 4099=099 ; 4100=100 ; 4101=101 ; 4102=102 ; 4103=103 ; 4104=104 ; 4105=105 
                      ; 4106=106 ; 4107=107 ; 4108=108 ; 4109=109 ; 4110=110 ; 4111=111 ; 4112=112 ; 4113=113 ; 4114=114 ; 
                      4115=115 ; 4116=116 ; 4117=117 ; 4118=118 ; 4119=119 ; 4120=120")
  
  bdo <- bd[,.N, keyby = list(SEXO, CAU_HOMOL, EDAD2)]
  #bdo$EDAD <- as.numeric(bdo$EDAD)
  setnames(bdo, 'EDAD2','EDAD')
  bdo$anio <- anio  
  print(as.data.frame(bdo))
}

defc <- resdc(2008)  
for(i in 2009:2010){   defc <- rbind(resdc(i), defc)   }


defd <- rbind(def,defb,defc)
cod <- read.xlsx2(file = "Lista_105_Colombia_CIE9-y-CIE10.xls",   1)
defd$CAU_HOMOL <- as.numeric(as.character(defd$CAU_HOMOL ))
cod$CAU_HOMOL <- as.numeric(as.character(cod$CAU_HOMOL ))

defd <- merge(defd, cod , by = 'CAU_HOMOL')
defd$aniog <- cut(defd$anio, breaks = seq(1980,2010, 5))
defd$aniog <- factor(defd$aniog, c("(1980,1985]", "(1985,1990]", "(1990,1995]", "(1995,2000]", 
                                   "(2000,2005]",   "(2005,2010]"),
                     c("1981-1985","1986-1990", "1991-1995", "1996-2000", "2001-2005", "2006-2010"))


defd$EDADg <- cut(defd$EDAD, breaks = c(-1,0, 4, 14, 39, 64,  99) )
defd$EDADg <- factor(defd$EDADg, c("(-1,0]", "(0,4]", "(4,14]", "(14,39]", "(39,64]", "(64,99]"), 
                     c("0", "1-4",  "5-14", 
                       "15-39",  "40-64",  "65-99") )

defd$SEXOb <- factor(defd$SEXO, 1:2, c('H','M'))
defd <- subset(defd, is.na(SEXOb) == FALSE & is.na(aniog) == FALSE &  is.na(EDADg) == FALSE)
defd <- data.table(defd)


# mort prop ninez ---------------------------------------------------------


defe <- defd[EDADg %in% c("0", '1-4')][, sum(N), keyby = list(EDADg, Causa, aniog)][ 
  ,Porcentaje := V1 * 100  / sum(V1), keyby = list(EDADg, aniog)][
    Causa != "Signos, síntomas y afecciones mal definidas"]

pr1 <- defe[order(-Porcentaje, aniog, EDADg)][, head(.SD,10), by=list(aniog, EDADg)]

sizet <- 8

p1 <- ggplot(pr1[EDADg == "0" & aniog == "1981-1985"]  ,  
             aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0,25,5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0,25,10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0,25), breaks = seq(0,25,5) )+
  theme_bw(base_size = sizet) + ylab('') + 
  geom_point(size = 3, colour = rev(c( '#cc4c02', 'black','#cc4c02','#7a0177','#7a0177',
                                       'black','#cc4c02','black','black','#cc4c02'))) + 
  geom_point(size = 1.5, colour = 'white') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c( '#cc4c02', 'black','#cc4c02','#7a0177','#7a0177',
                                               'black','#cc4c02','black','black','#cc4c02') ),
        axis.text.x = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank(),
        title = element_text(size = sizet + 1, family="Helvetica")  ) +
  ggtitle('1981-1985') 

p2 <- ggplot(pr1[EDADg == "0" & aniog == "2006-2010"]  ,  
             aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0,25,5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0,25,10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0,25), breaks = seq(0,25,5))+
  theme_bw(base_size = sizet) + ylab('') + 
  geom_point(size = 3, colour = rev(c( 'black', 'black','#cc4c02','#cc4c02','#cc4c02',
                                       'black','#cc4c02','#7a0177','#7a0177','#cc4c02'))) + 
  geom_point(size = 1.5, colour = 'white') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c( 'black', 'black','#cc4c02','#cc4c02','#cc4c02',
                                               'black','#cc4c02','#7a0177','#7a0177','#cc4c02') ),
        axis.text.x = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank() ,
        title = element_text(size = sizet + 1, family="Helvetica") ) +
  ggtitle('2006-2010') 

# Arrange the two charts.
# The legend boxes are centered

cairo_pdf(file = "cero epi.pdf",   width = 8, height = 4,     family="Helvetica" )
grid.newpage()
grid.draw(cbind(ggplotGrob(p1), ggplotGrob(p2), size="last"))
dev.off()

pr1[EDADg == "0" & aniog %in% c("1981-1985", "2006-2010")][
  Causa == 'Trastornos resp. período perinatal', ][order(aniog)]

pr1[EDADg == "0" & aniog %in% c("1981-1985", "2006-2010")][
  Causa == 'Enf. infecciosas intestinales', ][order(aniog)]

pr1[EDADg == "0" & aniog %in% c("1981-1985", "2006-2010")][
  Causa == 'Malf. congénitas del sistema circulatorio', ][order(aniog)]

pr1[EDADg == "0" & aniog %in% c("1981-1985", "2006-2010")][
  Causa == 'Neumonía', ][order(aniog)]

#pr1[grep("^Otras", pr1$Causa),]
pr1[EDADg == "0" & aniog %in% c("1981-1985", "2006-2010")][
  Causa == 'Otras malformaciones y anomalias congénitas', ][order(aniog)]



p3 <- ggplot(pr1[EDADg == "1-4" & aniog == "1981-1985"]  ,  
             aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0,25,5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0,25,10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0,25), breaks = seq(0,25,5))+
  theme_bw(base_size = sizet) + ylab('') + 
  geom_point(size = 3, colour = rev(c(  '#d7301f', 'black','black','black','#d7301f',
                                        'black','#d7301f','black','black','black' ))) + 
  geom_point(size = 1.5, colour = 'white') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c( '#d7301f', 'black','black','black','#d7301f',
                                               'black','#d7301f','black','black','black') ),
        axis.text.x = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank() ,
        title = element_text(size = sizet + 1, family="Helvetica") ) +
  ggtitle('1981-1985') 

p4 <- ggplot(pr1[EDADg == "1-4" & aniog == "2006-2010"]  ,   
             aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0,25,5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0,25,10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0,25), breaks = seq(0,25,5))+
  theme_bw(base_size = sizet) + ylab('') + 
  geom_point(size = 3, colour = rev( c( 'black', 'black','black','#d7301f','#d7301f',
                                        'black','black','black','#d7301f','black') )) + 
  geom_point(size = 1.5, colour = 'white') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c( 'black', 'black','black','#d7301f','#d7301f',
                                               'black','black','black','#d7301f','black') ),
        axis.text.x = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank() ,
        title = element_text(size = sizet + 1, family="Helvetica") ) +
  ggtitle('2006-2010') 


grid.newpage()
cairo_pdf(file = "uno epi.pdf",   width = 8, height = 4,     family="Helvetica" )
grid.draw(cbind(ggplotGrob(p3), ggplotGrob(p4), size="last"))
dev.off()


# # de 15 a 39 ------------------------------------------------------------


defe <- defd[EDADg %in% c("15-39")][, sum(N), keyby = list(SEXOb, EDADg, Causa, aniog)][ 
  ,Porcentaje := V1 * 100  / sum(V1), keyby = list(SEXOb, EDADg, aniog)][
    Causa != "Signos, síntomas y afecciones mal definidas"]

pr1 <- defe[order(-Porcentaje, aniog, EDADg, SEXOb)][, head(.SD,10), by=list(aniog, EDADg, SEXOb)]

p1 <- ggplot(pr1[SEXOb == "H" & aniog == "1981-1985"]  ,  
             aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0,55,5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0,55,10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0,55), breaks = seq(5,55,10) )+
  theme_bw(base_size = sizet) + ylab('') + 
  geom_point(size = 3, colour = rev(c(  'black', 'black','#d7301f','#d7301f','#d7301f',
                                        '#d7301f','#d7301f','#d7301f','#d7301f','#d7301f'))) + 
  geom_point(size = 1.5, colour = 'white') +
    theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c( 'black', 'black','#d7301f','#d7301f','#d7301f',
                                               '#d7301f','#d7301f','#d7301f','#d7301f','#d7301f') ),
        axis.text.x = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank(),
        title = element_text(size = sizet + 1, family="Helvetica")   ) +
  ggtitle('Hombres. 1981-1985') 

p2 <- ggplot(pr1[SEXOb == "H" & aniog == "2006-2010"]  ,  
             aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0,55,5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0,55,10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0,55), breaks = seq(5,55,10) )+
  theme_bw(base_size = sizet) + ylab('') + 
  geom_point(size = 3, colour = rev(c(  '#d7301f', 'black','#d7301f','#d7301f','#d7301f',
                                        '#d7301f','#01665e','#d7301f','#d7301f','#d7301f'))) + 
  geom_point(size = 1.5, colour = 'white') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c( '#d7301f', 'black','#d7301f','#d7301f','#d7301f',
                                               '#d7301f','#01665e','#d7301f','#d7301f','#d7301f') ),
        axis.text.x = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank() ,
        title = element_text(size = sizet + 1, family="Helvetica")  ) +
  ggtitle('Hombres. 2006-2010') 


p3 <- ggplot(pr1[SEXOb == "M" & aniog == "1981-1985"]  ,  
             aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0,55,5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0,55,10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0,55), breaks = seq(5,55,10) )+
  theme_bw(base_size = sizet) + ylab('') + 
  geom_point(size = 3, colour = rev(c(  'black', 'black','#d7301f','#d7301f','black',
                                        'black','black','#d7301f','#d7301f','#fd8d3c'))) + 
  geom_point(size = 1.5, colour = 'white') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c( 'black', 'black','#d7301f','#d7301f','black',
                                               'black','black','#d7301f','#d7301f','#fd8d3c') ),
        axis.text.x = element_text(size = sizet, family="Helvetica") ,
        panel.grid = element_blank(),
        title = element_text(size = sizet + 1, family="Helvetica")  ) +
  ggtitle('Mujeres. 1981-1985') 

p4 <- ggplot(pr1[SEXOb == "M" & aniog == "2006-2010"]  ,  
             aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0,55,5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0,55,10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0,55), breaks = seq(5,55,10) )+
  theme_bw(base_size = sizet) + ylab('') + 
  geom_point(size = 3, colour = rev(c(  'black', 'black','black','black','black',
                                        '#01665e','#d7301f','#fd8d3c','#d7301f','#d7301f'))) + 
  geom_point(size = 1.5, colour = 'white') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c( 'black', 'black','black','black','black',
                                               '#01665e','#d7301f','#fd8d3c','#d7301f','#d7301f') ),
        axis.text.x = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank() ,
        title = element_text(size = sizet + 1, family="Helvetica")  ) +
  ggtitle('Mujeres. 2006-2010') 

cairo_pdf(file = "enf1539.pdf",   width = 8, height = 8,     family="Helvetica" )
grid.newpage()
grid.draw(cbind(rbind(ggplotGrob(p1), ggplotGrob(p3), size="last"), 
                rbind(ggplotGrob(p2), ggplotGrob(p4), size="last"), size = "first"))
dev.off()

pr1[SEXOb == "H" & aniog %in% c("1981-1985", '2006-2010') & Causa 
    %in% c('Homicidios', 'Accidentes de transporte de motor', 'Suicidios',
           'Eventos de intención no determinada', 'Intervención legal y operaciones de guerra',
           'Ahogamiento y sumersión accidentales', 'Otros accidentes y secuelas',
           'Caídas ', 'Accid. por disparo de arma de fuego ')][
             , sum(Porcentaje), keyby = list(aniog, EDADg , SEXOb)]

pr1[SEXOb == "H" & aniog %in% c("1981-1985", '2006-2010')& Causa == 'Homicidios'  ]

pr1[SEXOb == "H" & aniog %in% c("1981-1985", '2006-2010')& Causa == 'Accidentes de transporte de motor'  ]


pr1[SEXOb == "M" & aniog %in% c("1981-1985", '2006-2010') & Causa 
    %in% c('Homicidios', 'Accidentes de transporte de motor', 'Suicidios')][
             , sum(Porcentaje), keyby = list(aniog, EDADg , SEXOb)]

pr1[SEXOb == "M" & aniog %in% c("1981-1985", '2006-2010')& Causa == 'Embarazo, parto y puerperio'  ][
  order(aniog)]

pr1[Causa == 'Enfermedad por el VIH (SIDA) '][order(SEXOb, aniog)]




# # de 40 a 64 ------------------------------------------------------------


defe <- defd[EDADg %in% c("40-64")][, sum(N), keyby = list(SEXOb, EDADg, Causa, aniog)][ 
  ,Porcentaje := V1 * 100  / sum(V1), keyby = list(SEXOb, EDADg, aniog)][
    Causa != "Signos, síntomas y afecciones mal definidas"]

pr1 <- defe[order(-Porcentaje, aniog, EDADg, SEXOb)][, head(.SD,10), by=list(aniog, EDADg, SEXOb)]

p1 <- ggplot(pr1[SEXOb == "H" & aniog == "1981-1985"]  ,  
             aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0, 20, 5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0, 20, 10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0, 20), breaks = seq(0, 20 ,5) )+
  theme_bw(base_size = sizet) + ylab('') + 
  geom_point(size = 3, colour = rev(c( '#525252', 'black','#d7301f','#6a3d9a','#6a3d9a',
                                       '#525252','#d7301f','#6a3d9a','#d7301f','#6a3d9a')  )) + 
  geom_point(size = 1.5, colour = 'white') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c( '#525252', 'black','#d7301f','#6a3d9a','#6a3d9a',
                                               '#525252','#d7301f','#6a3d9a','#d7301f','#6a3d9a') ),
        axis.text.x = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank(),
        title = element_text(size = sizet + 1, family="Helvetica")   ) +
  ggtitle('Hombres. 1981-1985') 

p2 <- ggplot(pr1[SEXOb == "H" & aniog == "2006-2010"]  ,  
             aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0, 20, 5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0, 20, 10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0, 20), breaks = seq(0, 20, 5) )+
  theme_bw(base_size = sizet) + ylab('') + 
  geom_point(size = 3, colour = rev(c( 'black', 'black','#525252','black','black',
                                       '#525252','#6a3d9a','#d7301f','#d7301f','#6a3d9a') )) + 
  geom_point(size = 1.5, colour = 'white') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c( 'black', 'black','#525252','black','black',
                                               '#525252','#6a3d9a','#d7301f','#d7301f','#6a3d9a') ),
        axis.text.x = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank(),
        title = element_text(size = sizet + 1, family="Helvetica")   ) +
  ggtitle('Hombres. 2006-2010') 


p3 <- ggplot(pr1[SEXOb == "M" & aniog == "1981-1985"]  ,  
             aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0, 20, 5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0, 20, 10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0, 20), breaks = seq(0, 20, 5) )+
  theme_bw(base_size = sizet) + ylab('') + 
  geom_point(size = 3, colour = rev(c( 'black', 'black','#525252','black','#525252',
                                       '#6a3d9a','#525252','#6a3d9a','#6a3d9a','#6a3d9a') )) + 
  geom_point(size = 1.5, colour = 'white') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c( 'black', 'black','#525252','black','#525252',
                                               '#6a3d9a','#525252','#6a3d9a','#6a3d9a','#6a3d9a') ),
        axis.text.x = element_text(size = sizet, family="Helvetica") ,
        panel.grid = element_blank(),
        title = element_text(size = sizet + 1, family="Helvetica")  ) +
  ggtitle('Mujeres. 1981-1985') 

p4 <- ggplot(pr1[SEXOb == "M" & aniog == "2006-2010"]  ,  
             aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0, 20, 5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0, 20, 10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0, 20), breaks = seq(0, 20, 5) )+
  theme_bw(base_size = sizet) + ylab('') + 
  geom_point(size = 3, colour = rev(c( 'black', '#525252','#525252','black','#525252',
                                       '#525252','black','#525252','#6a3d9a','#6a3d9a'))) + 
  geom_point(size = 1.5, colour = 'white') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour =c( 'black', '#525252','#525252','black','#525252',
                                              '#525252','black','#525252','#6a3d9a','#6a3d9a') ),
        axis.text.x = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank() ,
        title = element_text(size = sizet + 1, family="Helvetica")  ) +
  ggtitle('Mujeres. 2006-2010') 

cairo_pdf(file = "enf4064.pdf",   width = 8, height = 8,     family="Helvetica" )
grid.newpage()
grid.draw(cbind(rbind(ggplotGrob(p1), ggplotGrob(p3), size="last"), 
                rbind(ggplotGrob(p2), ggplotGrob(p4), size="last"), size = "first"))
dev.off()




# # "65-99" ---------------------------------------------------------------

defe <- defd[EDADg %in% c("65-99")][, sum(N), keyby = list(SEXOb, EDADg, Causa, aniog)][ 
  ,Porcentaje := V1 * 100  / sum(V1), keyby = list(SEXOb, EDADg, aniog)][
    Causa != "Signos, síntomas y afecciones mal definidas"]

pr1 <- defe[order(-Porcentaje, aniog, EDADg, SEXOb)][, head(.SD, 10), by = list(aniog, EDADg, SEXOb)]

p1 <- ggplot(pr1[SEXOb == "H" & aniog == "1981-1985"]  ,  
             aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0, 25, 5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0, 25, 10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0, 25), breaks = seq(0, 25, 5) )+
  theme_bw(base_size = sizet) + ylab('') + 
  geom_point(size = 3, colour = rev(c( 'black', '#6a3d9a','black','#1f78b4','black',
                                       '#1f78b4','#6a3d9a','#6a3d9a','#6a3d9a','#6a3d9a'))) + 
  geom_point(size = 1.5, colour = 'white') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c( 'black', '#6a3d9a','black','#1f78b4','black',
                                               '#1f78b4','#6a3d9a','#6a3d9a','#6a3d9a','#6a3d9a') ),
        axis.text.x = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank() ,
        title = element_text(size = sizet + 1, family="Helvetica")  ) +
  ggtitle('Hombres. 1981-1985') 

p2 <- ggplot(pr1[SEXOb == "H" & aniog == "2006-2010"]  ,  
             aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0, 25, 5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0, 25, 10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0, 25), breaks = seq(0, 25, 5) )+
  theme_bw(base_size = sizet) + ylab('') + 
  geom_point(size = 3, colour = rev( c( '#6a3d9a', 'black','black','#1f78b4','black',
                                                'black','#6a3d9a','#6a3d9a','#1f78b4','#6a3d9a'))) + 
  geom_point(size = 1.5, colour = 'white') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c( '#6a3d9a', 'black','black','#1f78b4','black',
                                               'black','#6a3d9a','#6a3d9a','#1f78b4','#6a3d9a') ),
        axis.text.x = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank() ,
        title = element_text(size = sizet + 1, family="Helvetica")  ) +
  ggtitle('Hombres. 2006-2010') 


p3 <- ggplot(pr1[SEXOb == "M" & aniog == "1981-1985"]  ,  
             aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0, 25, 5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0, 25, 10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0, 25), breaks = seq(0, 25, 5) )+
  theme_bw(base_size = sizet) + ylab('') + 
  geom_point(size = 3, colour = rev(c( '#6a3d9a', '#6a3d9a','#1f78b4','black','#1f78b4',
                                       'black','#6a3d9a','#6a3d9a','#6a3d9a','#6a3d9a') )) + 
  geom_point(size = 1.5, colour = 'white') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c( '#6a3d9a', '#6a3d9a','#1f78b4','black','#1f78b4',
                                               'black','#6a3d9a','#6a3d9a','#6a3d9a','#6a3d9a') ),
        axis.text.x = element_text(size = sizet, family="Helvetica") ,
        panel.grid = element_blank() ,
        title = element_text(size = sizet + 1, family="Helvetica") ) +
  ggtitle('Mujeres. 1981-1985') 

p4 <- ggplot(pr1[SEXOb == "M" & aniog == "2006-2010"]  ,  
             aes( Porcentaje , reorder(Causa, Porcentaje) )) + 
  geom_vline(xintercept = seq(0, 25, 5), colour = '#f0f0f0', linetype = '22') + 
  geom_vline(xintercept = seq(0, 25, 10), colour = '#E4E4E4', linetype = '22') +
  scale_x_continuous(limits = c(0, 25), breaks = seq(0, 25, 5) )+
  theme_bw(base_size = sizet) + ylab('') + 
  geom_point(size = 3, colour = rev(c( 'black', '#6a3d9a','black','#6a3d9a','#1f78b4',
                                       '#6a3d9a','black','#1f78b4','#6a3d9a','#6a3d9a'))) + 
  geom_point(size = 1.5, colour = 'white') +
  theme(axis.text.y = element_text(size = sizet, family="Helvetica", 
                                   colour = c( 'black', '#6a3d9a','black','#6a3d9a','#1f78b4',
                                               '#6a3d9a','black','#1f78b4','#6a3d9a','#6a3d9a') ),
        axis.text.x = element_text(size = sizet, family="Helvetica"),
        panel.grid = element_blank() ,
        title = element_text(size = sizet + 1, family="Helvetica")  ) +
  ggtitle('Mujeres. 2006-2010') 

cairo_pdf(file = "enf65mas.pdf",   width = 8, height = 8,     family="Helvetica" )
grid.newpage()
grid.draw(cbind(rbind(ggplotGrob(p1), ggplotGrob(p3), size="last"), 
                rbind(ggplotGrob(p2), ggplotGrob(p4), size="last"), size = "first"))
dev.off()


# COL tasas estandarizadas 105-----------------------------------------------------

bd <- read.xlsx2('pob.col.anual.sexo.edq.xlsx',1)

mbd <- melt(bd, id = 'Edadg')

mbd$sexo <- substr(mbd$variable, 1, 7)
mbd$anio <- substr(mbd$variable, 8, 11)

mbd <- data.table(mbd)

mbd$value <- as.numeric( as.character(mbd$value) )
mbd$anio <- as.numeric( as.character(mbd$anio) )

mbd$SEXO <- recode(mbd$sexo, " 'Hombres' = 1; 'Mujeres' = 2 ")

setnames(mbd, 'value', 'pob')
#edad enf

resd <- function(anio){
  fil <- paste("DEFU", anio, ".txt", sep="")
  bd <- fread(fil,  header = TRUE, colClasses = "string")
  bd <- data.table(bd)
  
  setnames(bd, names(bd), toupper(names(bd))   )
  
  bd$EDAD <- as.numeric(bd$EDAD)
  
  bd <- as.data.frame(bd)
  bd$EDAD2 <- rep(NA,nrow(bd))
  
  bd[which( bd$EDAD %in% 1:99 ), ]$EDAD2  <- bd[which( bd$EDAD %in% 1:99 ), ]$EDAD
  bd[which( bd$GRU_ED1 %in% c('01','02','03','04','05') ), ]$EDAD2  <- 0
  
  bd <- data.table(bd)
  bd$EDAD <- bd$EDAD2
  
  bdo <- bd[,.N, keyby = list(SEXO, CAU_HOMOL, EDAD)]
  
  bdo$anio <- anio  
  print(as.data.frame(bdo))
}

def <- resd(1980)  
for(i in 1981:1997){   def <- rbind(resd(i), def)   }

resdb <- function(anio){
  fil <- paste("DEFU", anio, ".txt", sep="")
  bd <- fread(fil,  header = TRUE, colClasses = "string")
  bd <- data.table(bd)
  
  setnames(bd, names(bd), toupper(names(bd))   )
  
  bd$EDAD <- as.numeric(bd$EDAD)
  
  bd$EDAD2 <- NA  
  bd$EDAD2 <- recode( bd$EDAD, "100:311 = 0; 312:399=1; c(400,499,999)=NA;
                      402 =02 ; 403 =03 ; 404 =04 ; 405 =05 ; 406 =06 ;
                      407 =07 ; 408 =08 ; 409 =09 ; 410 =10 ; 411 =11 ; 412 =12 
                      ; 413 =13 ; 414 =14 ; 415 =15 ; 416 =16 ; 417 =17 ; 418 =18 ; 419 =19 ;
                      420 =20 ; 421 =21 ; 422 =22 ; 423 
                      =23 ; 424 =24 ; 425 =25 ; 426 =26 ; 427 =27 ; 428 =28 ; 429 =29 ; 430 =30 ; 
                      431 =31 ; 432 =32 ; 433 =33 ; 
                      434 =34 ; 435 =35 ; 436 =36 ; 437 =37 ; 438 =38 ; 439 =39 ; 440 =40 ; 441 =41 ;
                      442 =42 ; 443 =43 ; 444 =44 
                      ; 445 =45 ; 446 =46 ; 447 =47 ; 448 =48 ; 449 =49 ; 450 =50 ; 451 =51 ; 452 =52 ;
                      453 =53 ; 454 =54 ; 455 
                      =55 ; 456 =56 ; 457 =57 ; 458 =58 ; 459 =59 ; 460 =60 ; 461 =61 ; 462 =62 ; 463 =63 ; 
                      464 =64 ; 465 =65 ; 
                      466 =66 ; 467 =67 ; 468 =68 ; 469 =69 ; 470 =70 ; 471 =71 ; 472 =72 ; 473 =73 ; 
                      474 =74 ; 475 =75 ; 476 =76 
                      ; 477 =77 ; 478 =78 ; 479 =79 ; 480 =80 ; 481 =81 ; 482 =82 ; 483 =83 ; 484 =84 ; 
                      485 =85 ; 486 =86 ; 487 
                      =87 ; 488 =88 ; 489 =89 ; 490 =90 ; 491 =91 ; 492 =92 ; 493 =93 ; 494 =94 ;
                      495 =95 ; 496 =96 ; 497 =97 ; 
                      498 =98")
  
  
  bdo <- bd[,.N, keyby = list(SEXO, CAU_HOMOL, EDAD2)]
  
  setnames(bdo, 'EDAD2','EDAD')
  
  bdo$anio <- anio  
  print(as.data.frame(bdo))
}

defb <- resdb(1998)  
for(i in 1999:2007){   defb <- rbind(resdb(i), defb)   }

resdc <- function(anio){
  fil <- paste("DEFU", anio, ".txt", sep="")
  bd <- fread(fil,  header = TRUE, colClasses = "string")
  bd <- data.table(bd)
  
  setnames(bd, names(bd), toupper(names(bd))   )
  if(any(names(bd) == "CAU_HOMO")) {setnames(bd, "CAU_HOMO", "CAU_HOMOL")}
  
  bd$EDAD <- as.numeric(bd$EDAD)
  bd$EDAD2 <- NA
  
  bd$EDAD2 <- recode( bd$EDAD, "0:4000 = 0;  c(4000,9999,4999)=NA;
                      4001=001 ; 4002=002 ; 4003=003 ; 4004=004 ; 4005=005 ; 4006=006 ; 4007=007 ; 4008=008 ; 4009=009 ; 4010=010 
                      ; 4011=011 ; 4012=012 ; 4013=013 ; 4014=014 ; 4015=015 ; 4016=016 ; 4017=017 ; 4018=018 ; 4019=019 ; 
                      4020=020 ; 4021=021 ; 4022=022 ; 4023=023 ; 4024=024 ; 4025=025 ; 4026=026 ; 4027=027 ; 4028=028 ; 4029=029 
                      ; 4030=030 ; 4031=031 ; 4032=032 ; 4033=033 ; 4034=034 ; 4035=035 ; 4036=036 ; 4037=037 ; 4038=038 ; 
                      4039=039 ; 4040=040 ; 4041=041 ; 4042=042 ; 4043=043 ; 4044=044 ; 4045=045 ; 4046=046 ; 4047=047 ; 4048=048 
                      ; 4049=049 ; 4050=050 ; 4051=051 ; 4052=052 ; 4053=053 ; 4054=054 ; 4055=055 ; 4056=056 ; 4057=057 ; 
                      4058=058 ; 4059=059 ; 4060=060 ; 4061=061 ; 4062=062 ; 4063=063 ; 4064=064 ; 4065=065 ; 4066=066 ; 4067=067 
                      ; 4068=068 ; 4069=069 ; 4070=070 ; 4071=071 ; 4072=072 ; 4073=073 ; 4074=074 ; 4075=075 ; 4076=076 ; 
                      4077=077 ; 4078=078 ; 4079=079 ; 4080=080 ; 4081=081 ; 4082=082 ; 4083=083 ; 4084=084 ; 4085=085 ; 4086=086 
                      ; 4087=087 ; 4088=088 ; 4089=089 ; 4090=090 ; 4091=091 ; 4092=092 ; 4093=093 ; 4094=094 ; 4095=095 ; 
                      4096=096 ; 4097=097 ; 4098=098 ; 4099=099 ; 4100=100 ; 4101=101 ; 4102=102 ; 4103=103 ; 4104=104 ; 4105=105 
                      ; 4106=106 ; 4107=107 ; 4108=108 ; 4109=109 ; 4110=110 ; 4111=111 ; 4112=112 ; 4113=113 ; 4114=114 ; 
                      4115=115 ; 4116=116 ; 4117=117 ; 4118=118 ; 4119=119 ; 4120=120")
  
  bdo <- bd[,.N, keyby = list(SEXO, CAU_HOMOL, EDAD2)]
  
  bdo$anio <- anio  
  
  setnames(bdo, 'EDAD2','EDAD')
  print(as.data.frame(bdo))
}

defc <- resdc(2008)  
for(i in 2009:2010){   defc <- rbind(resdc(i), defc)   }


defd <- rbind(def,defb,defc)
cod <- read.xlsx2(file = "Lista_105_Colombia_CIE9-y-CIE10.xls",   1)
defd$CAU_HOMOL <- as.numeric(as.character(defd$CAU_HOMOL ))
cod$CAU_HOMOL <- as.numeric(as.character(cod$CAU_HOMOL ))

defd <- merge(defd, cod , by = 'CAU_HOMOL')

defd$Edadg <- cut(defd$EDAD, breaks =  c(-1,  4, seq(9, 94, 5), 100 ) )

dput(unique(defd$Edadg))
dput(unique(mbd$Edadg))

defd$Edadg <- factor(defd$Edadg, c("(-1,4]", 
                                   "(4,9]", "(9,14]", "(14,19]", "(19,24]", "(24,29]", "(29,34]", 
                                   "(34,39]", "(39,44]", "(44,49]", "(49,54]", "(54,59]", "(59,64]", 
                                   "(64,69]", "(69,74]", "(74,79]", "(79,84]", "(84,89]", "(89,94]", 
                                   "(94,100]")  ,   
                     c("0-4", "5-9", "10-14", "15-19", 
                       "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  
                       "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89","90-94", "95 Y MÁS"        ) )

defd <- data.table(defd)

defe <- defd[is.na(Edadg) == F, list(tdef = sum(N)), keyby = list(CAU_HOMOL, SEXO,   anio,  Causa,   Grupo, Edadg) ]
defe$SEXO <- as.numeric(defe$SEXO)

dcb <- merge(defe, mbd, by = c("SEXO" ,     "anio" ,  "Edadg") )

dcb[, tesp := tdef / pob ]

dcb$edadcl <- factor(dcb$Edadg, lev =  c("0-4", "5-9", "10-14", "15-19", 
                                         "20-24", "25-29", "30-34", "35-39", "40-44", "45-49",  
                                         "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", 
                                         "85-89","90-94", "95 Y MÁS"        ) ,
                     labels = c(seq(2.5, 92.5, 5), 102.5) )

dcb$edadcl <- as.numeric(as.character(dcb$edadcl) )

# Dist tipo col amb sex

bd <- read.xlsx2("poblacion.edades.simples.censos.xlsx", 1)
bd <- data.table(bd)
bd <- subset(bd, Dep == 'Colombia')

bd$Hombres <- as.numeric(as.character(bd$Hombres ))
bd$Mujeres <- as.numeric(as.character(bd$Mujeres))
bd$edad <- as.numeric(as.character(bd$edad))

bd[, Tot := round(Hombres + Mujeres)]


bd$edadcl <- cut(bd$edad, breaks = c(-1,  4, seq(9, 94, 5), 100 ) )
dput(levels(bd$edadcl))
bd$edadcl <- factor(bd$edadcl, c("(-1,4]", "(4,9]", "(9,14]", "(14,19]", "(19,24]", "(24,29]", 
                                 "(29,34]", "(34,39]", "(39,44]", "(44,49]", "(49,54]", "(54,59]", 
                                 "(59,64]", "(64,69]", "(69,74]", "(74,79]", "(79,84]", "(84,89]", 
                                 "(89,94]", "(94,100]")  ,   
                    c(seq(2.5, 92.5, 5), 102.5)
)

bd1 <- bd[is.na(edadcl) == F,  sum(Tot) , keyby = list(anio, edadcl)][
  , Pct := V1  / sum(V1), keyby = list(anio)][anio == 2005, list(edadcl,  Pct)]

bd1$edadcl <- as.numeric(as.character(bd1$edadcl))

bte <- merge(dcb, bd1, by = 'edadcl')

bteb <- bte[, list(tst = sum(tesp * Pct) * 100000), keyby = list(anio, SEXO,  Causa )]

bteb$SEXO <- factor(bteb$SEXO, 1:2, c('H', 'M'   ))



grcaus <- function ( cs) {
  ggplot(bteb[Causa == cs], aes(anio, tst, colour = SEXO) ) + 
    geom_vline(xintercept = seq(1985, 2010, 2.5), colour = '#f0f0f0', linetype = '22') + 
    geom_vline(xintercept = seq(1985, 2010, 5), colour = '#EAEAEA', linetype = '22') + 
    geom_vline(xintercept = seq(1985, 2010, 10), colour = '#E4E4E4', linetype = '22') + 
    geom_line(size = 1.3) + 
    geom_dl( aes(anio, tst, colour = SEXO, label = SEXO), list( 'last.qp', family = "Helvetica", hjust = -.6) ) +
    scale_x_continuous(name = 'Año', limits = c(1985, 2011), breaks = seq(1985, 2010, 5) ) +
    scale_y_continuous(name =  'Tasa estandarizada (por 100 mil)',
                       limits = c(0, max(bteb[Causa == cs]$tst ) ) ) +
    scale_colour_manual(values = c("#4292c6","red")) +
    theme_bw(base_size = 10, base_family = "Helvetica") +
    theme(strip.background = element_rect(fill="white"), 
          legend.position="right", panel.margin = unit(2, "lines") ,
          axis.title.y=element_text(size = 10, vjust=0.9), 
          axis.title.x=element_text(size = 10, vjust=0.1),
          axis.text.x = element_text( size = 10, family="Helvetica"),
          axis.text.y = element_text(size = 10, family="Helvetica"), 
          legend.text = element_text(size = 10, family="Helvetica"),
          strip.text.x = element_text(size = 10, family="Helvetica") ,
          panel.grid = element_blank() )  +
    ggtitle(cs)  + guides(colour = FALSE) 
}

# as.character(cod$Causa)[1]
# grcaus(as.character(cod$Causa)[1])


p <- list()
for(i in 1:105){   p[[i]] <- grcaus(as.character(cod$Causa)[i])   }



cairo_pdf(file = "testenfinfec.pdf",  width = 8, height = 8,   family = "Helvetica")
grid.arrange( p[[1]], p[[2]],   p[[9]], ncol = 2)
dev.off() 


p[[24]] <- p[[24]] + scale_colour_manual(values = c("red","red")) 
p[[25]] <- p[[25]] + scale_colour_manual(values = c("red","red"))

cairo_pdf(file = "testenftumores1.pdf",  width = 8, height = 8,   family = "Helvetica")
grid.arrange(p[[13]],    p[[20]], p[[24]], p[[25]]   ,    ncol = 2)
dev.off() 




cairo_pdf(file = "testenfnut.pdf",  width = 8, height = 4,   family = "Helvetica")
grid.arrange(p[[41]] ,    ncol = 2)
dev.off()

p[[65]]

cairo_pdf(file = "testenfcirc.pdf",  width = 8, height = 8,   family = "Helvetica")
grid.arrange(p[[50]], p[[51]], p[[54]], p[[55]], ncol = 2)
dev.off()


cairo_pdf(file = "testenfresp.pdf",  width = 8, height = 4,   family = "Helvetica")
grid.arrange(p[[59]], p[[60]], ncol = 2)
dev.off()


p[[78]] <- p[[78]] + scale_colour_manual(values = c("red","red")) 

cairo_pdf(file = "testenfemb.pdf",  width = 8, height = 4,   family = "Helvetica")
grid.arrange( p[[82]], ncol = 2)
dev.off()

cairo_pdf(file = "testenfext.pdf",  width = 8, height = 8,   family = "Helvetica")
grid.arrange(p[[90]],   p[[100]], p[[101]], ncol = 2)
dev.off()




# anex COL Myers edades comparacion  ------------------------------------------------------

bd <- read.xlsx2("poblacion.edades.simples.censos.xlsx",1)

bd$Hombres <- as.numeric(as.character(bd$Hombres ))
bd$Mujeres <- as.numeric(as.character(bd$Mujeres))
bd$edad <- as.numeric(as.character(bd$edad))

melt.pop <- melt(bd, id= c("Cod.Dep","Dep",  "edad", "anio" ) )

bds <- data.table(melt.pop)
bds$edad <- as.numeric(as.character(bds$edad)) 

bds$ld <-  bds$edad %% 10

bdc <- bds[edad >= 10 & edad <= 89,  sum(value , na.rm =T) , 
           keyby = list(Cod.Dep,  Dep,   anio,  variable, ld ) ][, lda := ld + 1][, ldb := 9 - ld]

bdcb <- bds[edad >= 20 & edad <= 89,  sum(value , na.rm =T) , 
            keyby = list(Cod.Dep,  Dep,   anio,  variable, ld ) ]

b <- merge( bdc , bdcb, by = c('Cod.Dep',  'Dep',   'anio',  'variable', 'ld') )

b$bp <- b$V1.x * b$lda  + b$V1.y * b$ldb

b[, di := bp *100 / sum(bp), keyby = list(Cod.Dep,  Dep,   anio,  variable) ][, dib := abs(di-10)]

s <- b[,sum(dib, na.rm = T) , keyby = list(Cod.Dep,  Dep,   anio,  variable)]

lab <- read.xlsx2(file = "omision_censal_col.xlsx",  sheetName = "2005")
lab <- lab[, c(1:2)]

setnames(s, 1, "cod_depto") 

s$cod_depto <- round(as.numeric(as.character(s$cod_depto)), 1)
lab$cod_depto <- round(as.numeric(as.character(lab$cod_depto)), 1)

s <- merge (s, lab, by = "cod_depto", all.y = TRUE)
s$ID_1 <- round(as.numeric(as.character(s$ID_1)), digits =0)

colm <- readOGR("cescm2Poly.shp", layer = "cescm2Poly", 
                verbose = TRUE, stringsAsFactors = FALSE)
pds <- fortify(colm, region="ID4")

setnames(s, 6, "id") 
ss <- subset(s, anio %in% c(1985,  1993, 2005 ))

p <- ggplot(ss, aes(map_id = id)) + coord_fixed() + 
  geom_map(aes(fill = V1, colour = ''), map = pds) + 
  guides(colour = F) + scale_colour_manual(values = '#d9d9d9')+
  expand_limits(x =  pds$long, y = pds$lat) +
  #   scale_fill_gradient( name = "", low = "white",  high = "#a50f15",
  #                        guide = "colorbar", breaks = seq(0,60,10) ) +
  scale_fill_gradient2(name = "", low = "white",  high = "#a50f15", mid = "#fed976",
                       space = "rgb", midpoint = 15, 
                       na.value = "grey50", guide = "colourbar") +
  facet_wrap( ~ variable + anio) + ylim(-4, 14)    + xlab("") + ylab("") + 
  geom_segment(x = -79, xend=-79,   y=9.5, yend = 13, colour = 'grey') +
  geom_segment(x = -77.7, xend=-77.7,   y=9.5, yend = 13, colour = 'grey') +
  geom_segment(x = -77.5, xend=-77.5,   y=10.5, yend = 13, colour = 'grey') +
  geom_segment(x = -76, xend=-76,   y=10.5, yend = 13, colour = 'grey') +
  geom_segment(x = -79, xend=-77.7,   y=13, yend = 13, colour = 'grey') +
  geom_segment(x = -79, xend=-77.7,   y=9.5, yend = 9.5, colour = 'grey') +
  geom_segment(x = -77.5, xend=-76,   y=13, yend = 13, colour = 'grey') +
  geom_segment(x = -77.5, xend=-76,   y=10.5, yend = 10.5, colour = 'grey')+
  theme_tufte(base_size = 12) +
  theme(axis.text = element_blank(), 
        strip.background = element_rect(colour = 'white' , fill="white"), 
        strip.text = element_text(face="bold",size = 12, family="Helvetica"),
        panel.grid.minor=element_blank(),  panel.grid.major=element_blank(), 
        legend.text = element_text(size = 12, family="Helvetica"),
        legend.title = element_text(size = 12, family="Helvetica"),
        axis.ticks = element_blank()) 


pdf(file = "map_col_myers.pdf", family = "Helvetica",    width = 8, height = 6)
print(p)
dev.off() 

s[,pct := round(V1)]



# anex ALC Descomp brecha e0 paises 1950 1955 --------------------------------------------------------------

mah <- fread('mortadulthom.csv')
mam <- fread('mortadultmuj.csv')

mah$sexo <- "H" ; mam$sexo <- "M"
ma <- rbind(mah, mam)

setnames(ma, c(3, 8, 9, 11, 13, 14, 15, 18, 19) , c( "region", "Edad","Intervalo", 'qxn', 
                                                     "lx", "dxn" , "Lxn", "ex", "axn")) 
ma <- data.table(ma)
ma$clasep <- factor(ma$Period, levels = c("1950-1955", "1955-1960", "1960-1965", 
                                          "1965-1970", "1970-1975", "1975-1980", "1980-1985", "1985-1990", 
                                          "1990-1995", "1995-2000", "2000-2005", "2005-2010"),
                    labels = seq(1952.5, 2007.5, 5) )

mas <- ma[Edad  %in% c(0,20,40,60,80), c("region", "Codigo", "Period", "Edad","Intervalo", 'qxn', 
                                         "lx", "dxn" , "Lxn", "ex", "axn", "sexo", "clasep"),
          with = F]

mas$lxad <-  c( mas[2:nrow(mas),]$lx, 0  ) 
mas[mas$Edad == 80, ]$lxad <- 0

mas$exad <-  c( mas[2:nrow(mas),]$ex, 0  ) 
mas[mas$Edad == 80, ]$exad <- 0

masco <- mas[Codigo == 'CO', ]

mas <- merge(mas, masco,  by = c("Period", "Edad", "sexo")   )

mas <- mas[order(region.x, Codigo.x, Period, sexo, Edad), ]


mas$arria3.tot <- (mas$lx.y + mas$lx.x) * (mas$ex.x - mas$ex.y) / 200000 - 
  (mas$lxad.y + mas$lxad.x) * (mas$exad.x - mas$exad.y) / 200000

a <- mas[,  list(  sum(arria3.tot) ),     keyby = list(region.x, Codigo.x, Period, sexo ) ]
b <- mas[Edad == 0, c('region.x', 'Codigo.x', 'Period', 'sexo', 'ex.x','ex.y' ) , with = F][
  , dif := ex.x-ex.y]
c <- merge(a, b, by = c('region.x', 'Codigo.x', 'Period', 'sexo')   )


mass <- mas[ Codigo.x %in% c("CR", "SV", "MX", "NI", "PA", "AR", "BR", "CL", "PY", "UY", 
                             "CU", "DO", "HT", "JM", "TT", "BO",  "EC", "PE", "VE", 
                             "GT", "HN") ,  ]

dput(mass[Edad == 0 & sexo == 'H' & Period == '1950-1955', ][order(ex.x), ][,"Codigo.x", with = F])

mass$Codigo.x <- factor( mass$Codigo.x, levels = c("HT", "BO", "HN", "NI", "GT", "PE", 
                                                   "SV", "DO", "EC", "MX", "BR", "CL", "VE", "PA", "CR", "JM", "TT", 
                                                   "CU", "AR", "PY", "UY") )

mass$Edadg <- recode(mass$Edad, " 0:19 = '0-19'; 20:39 = '20-39'  ; 40:59 = '40-59' ; 60:79= '60-79'; 
                     else = '80+' "               )

sizet <- 10

p1 <- ggplot( ) + 
  geom_blank(data = mass[sexo == 'H' & Period == '1950-1955' , ] ,  
             aes(x = Codigo.x, y = arria3.tot, fill = Edadg), stat= 'Identity'  ) +
  geom_vline( xintercept = seq(1.5, 20.5, 1), colour = '#f0f0f0', linetype = '22') +  
  geom_hline(yintercept = seq(-14, 18, 1),colour = '#f0f0f0', linetype = '22') +
  geom_vline( xintercept = seq(1.5, 20.5, 2), colour = '#EAEAEA', linetype = '22') +  
  geom_hline(yintercept = seq(-14, 18, 2),colour = '#EAEAEA', linetype = '22') +
  geom_vline( xintercept = seq(1.5, 20.5, 4), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = seq(-14, 18, 4),colour = '#E4E4E4', linetype = '22') +
  geom_bar(data = mass[sexo == 'H' & Period == '1950-1955' & arria3.tot > 0 , ] ,  
           aes(x = Codigo.x, y = arria3.tot, fill = Edadg), stat= 'Identity', width = .75) +
  geom_bar(data = mass[sexo == 'H' & Period == '1950-1955' & arria3.tot < 0, ] ,  
           aes(x = Codigo.x, y = arria3.tot, fill = Edadg), stat= 'Identity', width = .75) +
  theme_bw(base_size = sizet) + 
  ggtitle('En la esperanza de vida de los hombres') + 
  xlab('País') +
  scale_fill_manual(name = "Edad" , values = c('#a6bddb', '#67a9cf', '#3690c0', '#02818a', '#016450') ) +
  scale_y_continuous(name = "Contribución", breaks = seq(-14, 18, 2)) +
  geom_hline(yintercept = 0, colour = '#252525') +
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.text = element_text(size = sizet, family="Helvetica"),
        legend.title = element_text(size = sizet, family="Helvetica", face = 'plain'),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.ticks.x = element_blank())

mass <- mas[ Codigo.x %in% c("CR", "SV", "MX", "NI", "PA", "AR", "BR", "CL", "PY", "UY", 
                             "CU", "DO", "HT", "JM", "TT", "BO",  "EC", "PE", "VE", 
                             "GT", "HN") ,  ]

dput(mass[Edad == 0 & sexo == 'M' & Period == '1950-1955', ][order(ex.x), ][,"Codigo.x", with = F])

mass$Codigo.x <- factor( mass$Codigo.x, levels =  c("HT", "GT", "BO", "HN", "NI", "PE", 
                                                    "SV", "DO", "EC", "MX", "BR", "VE", "CL", "PA", "CR", "TT", "JM", 
                                                    "CU", "PY", "AR", "UY") )

mass$Edadg <- recode(mass$Edad, " 0:19 = '0-19'; 20:39 = '20-39'  ; 40:59 = '40-59' ; 60:79= '60-79'; 
                     else = '80+' "               )

p2 <- ggplot( ) + 
  geom_blank(data = mass[sexo == 'M' & Period == '1950-1955' , ] ,  
             aes(x = Codigo.x, y = arria3.tot, fill = Edadg), stat= 'Identity'  ) +
  geom_vline( xintercept = seq(1.5, 20.5, 1), colour = '#f0f0f0', linetype = '22') +  
  geom_hline(yintercept = seq(-14, 18, 1),colour = '#f0f0f0', linetype = '22') +
  geom_vline( xintercept = seq(1.5, 20.5, 2), colour = '#EAEAEA', linetype = '22') +  
  geom_hline(yintercept = seq(-14, 18, 2),colour = '#EAEAEA', linetype = '22') +
  geom_vline( xintercept = seq(1.5, 20.5, 4), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = seq(-14, 18, 4),colour = '#E4E4E4', linetype = '22') +
  geom_bar(data = mass[sexo == 'M' & Period == '1950-1955' & arria3.tot > 0 , ] ,  
           aes(x = Codigo.x, y = arria3.tot, fill = Edadg), stat= 'Identity', width = .75) +
  geom_bar(data = mass[sexo == 'M' & Period == '1950-1955' & arria3.tot < 0, ] ,  
           aes(x = Codigo.x, y = arria3.tot, fill = Edadg), stat= 'Identity', width = .75) +
  theme_bw(base_size = sizet) + 
  ggtitle('En la esperanza de vida de las mujeres') + 
  xlab('País') +
  scale_fill_manual(name = "Edad", values = c('#c994c7', '#df65b0', '#e7298a', '#ce1256', '#91003f') ) +
  scale_y_continuous(name = "Contribución", breaks = seq(-14, 18, 2))  +
  geom_hline(yintercept = 0, colour = '#252525') +
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.text = element_text(size = sizet, family="Helvetica"),
        legend.title = element_text(size = sizet, family="Helvetica", face = 'plain'),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.ticks.x = element_blank())


#mass[sexo == 'M' & Period == '2005-2010' & Codigo.x == 'HN', ]

pdf(file = "GRexpcontdifpais5055.pdf", width = 7.8,   height = 9.8,  family = "Helvetica")
print(grid.arrange( p1, p2, nrow = 2)   )
dev.off()


# anex ALC Descomp brecha e0 paises 1980 1985 --------------------------------------------------------------

mah <- fread('mortadulthom.csv')
mam <- fread('mortadultmuj.csv')

mah$sexo <- "H" ; mam$sexo <- "M"
ma <- rbind(mah, mam)

setnames(ma, c(3, 8, 9, 11, 13, 14, 15, 18, 19) , c( "region", "Edad","Intervalo", 'qxn', 
                                                     "lx", "dxn" , "Lxn", "ex", "axn")) 
ma <- data.table(ma)
ma$clasep <- factor(ma$Period, levels = c("1950-1955", "1955-1960", "1960-1965", 
                                          "1965-1970", "1970-1975", "1975-1980", "1980-1985", "1985-1990", 
                                          "1990-1995", "1995-2000", "2000-2005", "2005-2010"),
                    labels = seq(1952.5, 2007.5, 5) )

mas <- ma[Edad  %in% c(0,20,40,60,80), c("region", "Codigo", "Period", "Edad","Intervalo", 'qxn', 
                                         "lx", "dxn" , "Lxn", "ex", "axn", "sexo", "clasep"),
          with = F]

mas$lxad <-  c( mas[2:nrow(mas),]$lx, 0  ) 
mas[mas$Edad == 80, ]$lxad <- 0

mas$exad <-  c( mas[2:nrow(mas),]$ex, 0  ) 
mas[mas$Edad == 80, ]$exad <- 0

masco <- mas[Codigo == 'CO', ]

mas <- merge(mas, masco,  by = c("Period", "Edad", "sexo")   )

mas <- mas[order(region.x, Codigo.x, Period, sexo, Edad), ]


mas$arria3.tot <- (mas$lx.y + mas$lx.x) * (mas$ex.x - mas$ex.y) / 200000 - 
  (mas$lxad.y + mas$lxad.x) * (mas$exad.x - mas$exad.y) / 200000

a <- mas[,  list(  sum(arria3.tot) ),     keyby = list(region.x, Codigo.x, Period, sexo ) ]
b <- mas[Edad == 0, c('region.x', 'Codigo.x', 'Period', 'sexo', 'ex.x','ex.y' ) , with = F][
  , dif := ex.x-ex.y]
c <- merge(a, b, by = c('region.x', 'Codigo.x', 'Period', 'sexo')   )


mass <- mas[ Codigo.x %in% c("CR", "SV", "MX", "NI", "PA", "AR", "BR", "CL", "PY", "UY", 
                             "CU", "DO", "HT", "JM", "TT", "BO",  "EC", "PE", "VE", 
                             "GT", "HN") ,  ]

dput(mass[Edad == 0 & sexo == 'H' & Period == '1980-1985', ][order(ex.x), ][,"Codigo.x", with = F])

mass$Codigo.x <- factor( mass$Codigo.x, levels = c("HT", "SV", "BO", "GT", "NI", "HN", 
                                                   "PE", "BR", "DO", "EC", "MX", "TT", "PY", "VE", "AR", "CL", "UY", 
                                                   "PA", "JM", "CR", "CU") )

mass$Edadg <- recode(mass$Edad, " 0:19 = '0-19'; 20:39 = '20-39'  ; 40:59 = '40-59' ; 60:79= '60-79'; 
                     else = '80+' "               )

sizet <- 10

p1 <- ggplot( ) + 
  geom_blank(data = mass[sexo == 'H' & Period == '1980-1985' , ] ,  
             aes(x = Codigo.x, y = arria3.tot, fill = Edadg), stat= 'Identity'  ) +
  geom_vline( xintercept = seq(1.5, 20.5, 1), colour = '#f0f0f0', linetype = '22') +  
  geom_hline(yintercept = seq(-18, 10, 1),colour = '#f0f0f0', linetype = '22') +
  geom_vline( xintercept = seq(1.5, 20.5, 2), colour = '#EAEAEA', linetype = '22') +  
  geom_hline(yintercept = seq(-18, 10, 2),colour = '#EAEAEA', linetype = '22') +
  geom_vline( xintercept = seq(1.5, 20.5, 4), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = seq(-18, 10, 4),colour = '#E4E4E4', linetype = '22') +
    geom_bar(data = mass[sexo == 'H' & Period == '1980-1985' & arria3.tot > 0 , ] ,  
           aes(x = Codigo.x, y = arria3.tot, fill = Edadg), stat= 'Identity', width = .75) +
  geom_bar(data = mass[sexo == 'H' & Period == '1980-1985' & arria3.tot < 0, ] ,  
           aes(x = Codigo.x, y = arria3.tot, fill = Edadg), stat= 'Identity', width = .75) +
  theme_bw(base_size = 10) + 
  ggtitle('En la esperanza de vida de los hombres') + 
  xlab('País') +
  scale_fill_manual(name = "Edad" , values = c('#a6bddb', '#67a9cf', '#3690c0', '#02818a', '#016450') ) +
  scale_y_continuous(name = "Contribución", limits = c(-18,10), breaks = seq(-20, 20, 2)) +
  geom_hline(yintercept = 0, colour = '#252525') +
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.text = element_text(size = sizet, family="Helvetica"),
        legend.title = element_text(size = sizet, family="Helvetica", face = 'plain'),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.ticks.x = element_blank())

mass <- mas[ Codigo.x %in% c("CR", "SV", "MX", "NI", "PA", "AR", "BR", "CL", "PY", "UY", 
                             "CU", "DO", "HT", "JM", "TT", "BO",  "EC", "PE", "VE", 
                             "GT", "HN") ,  ]

dput(mass[Edad == 0 & sexo == 'M' & Period == '1980-1985', ][order(ex.x), ][,"Codigo.x", with = F])

mass$Codigo.x <- factor( mass$Codigo.x, levels =  c("HT", "BO", "GT", "NI", "PE", "HN", 
                                                    "SV", "DO", "EC", "BR", "PY", "TT", "MX", "VE", "JM", "PA", "AR", 
                                                    "CL", "UY", "CU", "CR") )

mass$Edadg <- recode(mass$Edad, " 0:19 = '0-19'; 20:39 = '20-39'  ; 40:59 = '40-59' ; 60:79= '60-79'; 
                     else = '80+' "               )

p2 <- ggplot( ) + 
  geom_blank(data = mass[sexo == 'M' & Period == '1980-1985' , ] ,  
             aes(x = Codigo.x, y = arria3.tot, fill = Edadg), stat= 'Identity'  ) +
  geom_vline( xintercept = seq(1.5, 20.5, 1), colour = '#f0f0f0', linetype = '22') +  
  geom_hline(yintercept = seq(-18, 10, 1),colour = '#f0f0f0', linetype = '22') +
  geom_vline( xintercept = seq(1.5, 20.5, 2), colour = '#EAEAEA', linetype = '22') +  
  geom_hline(yintercept = seq(-18, 10, 2),colour = '#EAEAEA', linetype = '22') +
  geom_vline( xintercept = seq(1.5, 20.5, 4), colour = '#E4E4E4', linetype = '22') +  
  geom_hline(yintercept = seq(-18, 10, 4),colour = '#E4E4E4', linetype = '22') +
  geom_bar(data = mass[sexo == 'M' & Period == '1980-1985' & arria3.tot > 0 , ] ,  
           aes(x = Codigo.x, y = arria3.tot, fill = Edadg), stat= 'Identity') +
  geom_bar(data = mass[sexo == 'M' & Period == '1980-1985' & arria3.tot < 0, ] ,  
           aes(x = Codigo.x, y = arria3.tot, fill = Edadg), stat= 'Identity') +
  theme_bw(base_size = 10) + 
  ggtitle('En la esperanza de vida de las mujeres') + 
  xlab('País') +
  scale_fill_manual(name = "Edad", values = c('#c994c7', '#df65b0', '#e7298a', '#ce1256', '#91003f') ) +
  scale_y_continuous(name = "Contribución", limits = c(-18,10), breaks = seq(-20, 20, 2))  +
  geom_hline(yintercept = 0, colour = '#252525') +
  theme(axis.text.x = element_text( size = sizet, family="Helvetica"),
        axis.text.y = element_text(size = sizet, family="Helvetica"),  
        axis.title.x = element_text(size = sizet, family="Helvetica"),
        axis.title.y = element_text(size = sizet, family="Helvetica"),
        legend.text = element_text(size = sizet, family="Helvetica"),
        legend.title = element_text(size = sizet, family="Helvetica", face = 'plain'),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.ticks.x = element_blank())


#mass[sexo == 'M' & Period == '2005-2010' & Codigo.x == 'HN', ]

pdf(file = "GRexpcontdifpais8085.pdf", width = 7.8,   height = 9.8,  family = "Helvetica")
print(   grid.arrange( p1, p2, nrow=2)   )
dev.off()



# # anex nacimientos sexo ------------------------------------------------------

resd <- function(anio){
  fil <- paste("nac", anio, ".txt", sep="")
  bd <- fread(fil,  header = TRUE)
  bd <- data.table(bd)
  bdo <- bd[,.N, keyby = list(SEXO, COD_DPTO)]
  print(as.data.frame(bdo))
}

n1998 <- resd(1998); n1998$anio <- 1998
n1999 <- resd(1999); n1999$anio <- 1999
n2000 <- resd(2000); n2000$anio <- 2000
n2001 <- resd(2001); n2001$anio <- 2001
n2002 <- resd(2002); n2002$anio <- 2002
n2003 <- resd(2003); n2003$anio <- 2003
n2004 <- resd(2004); n2004$anio <- 2004
n2005 <- resd(2005); n2005$anio <- 2005
n2006 <- resd(2006); n2006$anio <- 2006
n2007 <- resd(2007); n2007$anio <- 2007
n2008 <- resd(2008); n2008$anio <- 2008
n2009 <- resd(2009); n2009$anio <- 2009
n2010 <- resd(2010); n2010$anio <- 2010
n2011 <- resd(2011); n2011$anio <- 2011
n2012 <- resd(2012); n2012$anio <- 2012

nt <- rbind(n1998, n1999,n2000,n2001,n2002,n2003,n2004,n2005,n2006,n2007,n2008,n2009,n2010,n2011,n2012)
ntd <- dcast(nt,COD_DPTO + anio ~ SEXO, value.var= 'N')
setnames(ntd, 3:4, c("H", "M"))

ntd <- data.table(ntd)
ntd[, im := round(H / M, 2)]


# defunciones por sexo anexo con fuetne -----------------------------------


defd[, sum(N) , keyby = .(anio, SEXO)] %>%
  dcast(anio ~ SEXO, value.var = 'V1')

df15ad <- fread('def 1915 2010 sexo.csv')
xtable(df15ad)
